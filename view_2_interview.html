<!DOCTYPE html>

<html lang="ru">
<head>
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<meta content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https: data:; connect-src 'self' https://script.google.com https://script.googleusercontent.com; img-src 'self' data: https:; frame-src https://script.google.com https://script.googleusercontent.com;" http-equiv="Content-Security-Policy"/>
<script src="config.js"></script>
<script src="question_bank.js"></script>
<meta charset="utf-8">
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>–ö–∞—Ä—Ç–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è + –ü–°–ò ‚Äî –ò–Ω—Ç–µ—Ä–≤—å—é</title>
<style>
:root{
  --brand-red:#ff0000;
  --brand-red-2:#e21d35;
  --bg:#ffffff;
  --surface:#ffffff;
  --text:#111827;
  --muted:#6b7280;
  --border:#D1D1D1;
  --field:#E4E4E4;
  --field-focus:#ffffff;
  --shadow: 0 10px 30px rgba(0,0,0,.08);
  font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,#f7f7f8 0%,#ffffff 60%);color:var(--text)}
.container{max-width:1480px;margin:22px auto;padding:0 14px} /* fixed too-wide */

/* ===== QuickDock (left, on all pages) ===== */
.quickDock{position:fixed;left:16px;top:16px;width:320px;z-index:50}
.quickDock .card{box-shadow:0 18px 50px rgba(15,23,42,.12)}
.dockTitle{font-weight:950;font-size:14px;margin:0 0 10px}
.dockSearchWrap{position:relative}
.dockIcon{position:absolute;left:12px;top:50%;transform:translateY(-50%);opacity:.7}
.dockSearch{width:100%;border:1px solid rgba(15,23,42,.12);background:#f2f4f8;padding:11px 12px 11px 38px;border-radius:12px;outline:none;font-size:14px}
.dockSuggest{margin-top:8px;border:1px solid rgba(15,23,42,.12);border-radius:12px;overflow:hidden;display:none;background:#fff}
.dockItem{padding:10px 12px;border-top:1px solid rgba(15,23,42,.06);cursor:pointer}
.dockItem:first-child{border-top:none}
.dockItem b{display:block}
.toolGrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:10px}
.tool{padding:12px;border:1px solid rgba(15,23,42,.12);border-radius:14px;background:#fff;display:flex;gap:10px;align-items:flex-start;text-decoration:none;color:inherit}
.tIcon{width:28px;height:28px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.18)}
.tName{font-weight:900;font-size:13px;line-height:1.15}
.tDesc{font-size:12px;color:var(--muted);margin-top:3px}
@media (max-width:1480px){.quickDock{position:static;width:auto;margin:0 14px 12px}}
@media (min-width:1101px){.container{padding-left:360px}}
header{display:flex;gap:14px;align-items:flex-start;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap}
h1{font-size:20px;margin:0}
.sub{color:var(--muted);font-size:13px;margin-top:6px;line-height:1.35;max-width:920px}
.grid{display:grid;grid-template-columns:1fr;gap:14px} /* no right sidebar now */

.card{background:var(--surface);border:1px solid #e5e7eb;border-radius:16px;padding:16px;box-shadow:var(--shadow)}
h2{font-size:15px;margin:0 0 10px}
h3{font-size:13px;margin:12px 0 8px;color:#334155}
.hr{height:1px;background:#e5e7eb;margin:12px -16px}

label{display:grid;gap:6px;font-size:13px}
input,select,textarea{
  width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);
  background:var(--field);color:var(--text);
}
input:focus,select:focus,textarea:focus{
  outline:none;background:var(--field-focus);
  border-color: rgba(255,0,0,.55);box-shadow:0 0 0 3px rgba(255,0,0,.12);
}
textarea{min-height:120px;resize:vertical}
/* ===== Synthetic marker (quick-mode auto-filled) ===== */
input[data-synthetic="1"], select[data-synthetic="1"], textarea[data-synthetic="1"]{
  border-color: rgba(59,130,246,.65) !important;
  box-shadow: 0 0 0 3px rgba(59,130,246,.14) !important;
  background-color: var(--field) !important;
  background-image:
    radial-gradient(circle at calc(100% - 14px) 14px, rgba(59,130,246,1) 0 4px, rgba(59,130,246,0) 5px);
  background-repeat:no-repeat;
}

.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:860px){.row{grid-template-columns:1fr}}
.small{font-size:12px;color:var(--muted);line-height:1.35}

.btns{display:flex;gap:10px;flex-wrap:wrap}
.btn{appearance:none;border:none;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:800;background:var(--brand-red);color:#fff}
.btn:hover{background:var(--brand-red-2)}
.btn.ghost{background:var(--field);border:1px solid var(--border);color:var(--text);font-weight:700}
.btn.ghost:hover{background:#dcdcdc}

.legend{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;color:#475569;font-size:12px}

/* KPI header row */
.kpiBar{
  width:100%;
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap:10px;
  margin-top:10px;
}
@media(max-width:1480px){.kpiBar{grid-template-columns:repeat(2, minmax(0,1fr))}}

/* Make the "–†–∏—Å–∫ –∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å" block always 2 columns (desktop/tablet) */
.kpiBar.riskReady{grid-template-columns:repeat(2, minmax(0,1fr))}
/* Ensure the nested riskReady grid spans full width of the outer KPI grid */
.kpiBar > .kpiBar.riskReady{grid-column:1 / -1; width:100%}
.kpiGroupTitle{grid-column:1 / -1}
.stat{
  background:var(--field);
  border:1px solid var(--border);
  border-radius:14px;
  padding:10px 12px;
}
.stat .label{color:#475569;font-size:12px}
.stat .value{font-size:18px;font-weight:900;margin-top:6px}
.mono{font-variant-numeric:tabular-nums}
.good{outline:2px solid rgba(16,185,129,.35)}
.warn{outline:2px solid rgba(245,158,11,.35)}
.bad{ outline:2px solid rgba(244,63,94,.35)}


.bar{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden;margin-top:6px}
.bar>span{display:block;height:100%;width:0%;background:rgba(255,0,0,.65)}

/* Tables */
.table-wrap{overflow:auto;border:1px solid #e5e7eb;border-radius:14px;background:#fff}
table{width:100%;border-collapse:collapse;font-size:13px;min-width:860px} /* smaller min width */
th,td{padding:10px;border-bottom:1px solid #e5e7eb;vertical-align:top}
th{text-align:left;color:#0f172a;font-weight:800;background:#f3f4f6;font-size:12px}
.right{text-align:right}
td input, td select, td textarea{padding:12px;border-radius:12px;border:1px solid var(--border);background:var(--field)}
td textarea{min-height:92px;height:92px;line-height:1.3}
.footer{margin:10px 0 0;color:var(--muted);font-size:12px;text-align:center}
@media print{
  header,.btns,.footer{display:none !important}.container{max-width:none;margin:0}.card{box-shadow:none}table{min-width:0}}

/* ===== PRINT (PDF) ===== */
@page{ size: A4 landscape; margin: 10mm; }
@media print{
  body{background:#fff}
  .container{max-width:none;margin:0;padding:0 8mm}
  .card{box-shadow:none}
  /* hide only controls, keep KPI */
  .btns{display:none !important}
  .legend{display:none !important}
  .kpiBar{grid-template-columns:repeat(6, minmax(0,1fr)); gap:6px; margin-top:6px}
  .stat{padding:8px}
  .stat .value{font-size:14px}
  .stat .label{font-size:10px}
  table{min-width:0}
}

/* ===== Modes ===== */
body.client-mode #projectRisksWrap{ display:none !important; }
body.client-mode #kRisk, body.client-mode #kFeas, body.client-mode #kProdFeas, body.client-mode #kReady, body.client-mode #kProb{ display:none !important; }
body.client-mode #clientSummaryBlock{ display:block !important; }
body.internal-mode #clientSummaryBlock{ display:none !important; }

body.quick-mode [data-mode="deep"]{ display:none !important; }




/* === Virt multiselect (native checkboxes) === */
.virt-wrapper{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
  gap:10px;
  margin-top:10px;
}
.virt-item{
  display:flex;
  align-items:center;
  gap:8px;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.06);
  cursor:pointer;
  font-weight:700;
}
.virt-item input{
  width:16px;
  height:16px;
  cursor:pointer;
}
.virt-hint{margin-top:8px;color:var(--muted);font-size:12px;}



/* === UI PATCH v7.15: resizable req metric + wider PSI match column === */
#reqTbody textarea{resize:both;}
#reqTbody td:nth-child(7) textarea, 
#reqTbody td:nth-child(7) input{
  width:100% !important;
  min-height:64px !important;
  resize:both !important;
}
/* PSI table: widen "–°–æ–æ—Ç–≤. (–î–∞/–ù–µ—Ç)" column */
#psiTable th:nth-child(6), #psiTable td:nth-child(6){
  min-width:130px !important;
  width:130px !important;
}
#psiTable td:nth-child(6) select{
  min-width:110px !important;
}

/* ===== Multi-page views (split tool) ===== */
body.view-indices #cardMaturity,
body.view-indices #cardFinance,
body.view-indices #cardReq,
body.view-indices #cardPSI,


body.view-interview #cardReq,
body.view-interview #cardPSI,


body.view-req #cardMaturity,
body.view-req #cardFinance,
body.view-req #cardPSI{ display:none !important; }

body.view-psi #cardMaturity,
body.view-psi #cardFinance,
body.view-psi #cardReq{ display:none !important; }

/* In focused views: collapse Passport card to only company (+industry) row */
body.view-indices #cardPassport .hr,
body.view-indices #cardPassport h3,
body.view-indices #cardPassport .small,
body.view-indices #cardPassport .virt-wrapper,
body.view-indices #cardPassport .virt-hint,
body.view-indices #cardPassport .row:not(:first-of-type){ display:none !important; }

body.view-req #cardPassport .hr,
body.view-req #cardPassport h3,
body.view-req #cardPassport .small,
body.view-req #cardPassport .virt-wrapper,
body.view-req #cardPassport .virt-hint,
body.view-req #cardPassport .row:not(:first-of-type){ display:none !important; }

body.view-psi #cardPassport .hr,
body.view-psi #cardPassport h3,
body.view-psi #cardPassport .small,
body.view-psi #cardPassport .virt-wrapper,
body.view-psi #cardPassport .virt-hint,
body.view-psi #cardPassport .row:not(:first-of-type){ display:none !important; }

/* Hide extended passport fields on focused pages */
body.view-indices #passportExtra,
body.view-req #passportExtra,
body.view-product #passportExtra,
body.view-psi #passportExtra{ display:none !important; }

/* Hide KPI bar + heatmap on focused pages except indices */
body.view-req .kpiBar,
body.view-req #riskHeatmapCard,
body.view-req #cLevelBlock{ display:none !important; }

body.view-product .kpiBar,
body.view-product #riskHeatmapCard,
body.view-product #cLevelBlock{ display:none !important; }

body.view-psi .kpiBar,
body.view-psi #riskHeatmapCard,
body.view-psi #cLevelBlock{ display:none !important; }

/* PSI focused view should not show product requirements & project risks */
body.view-psi #prodReqCard,
body.view-psi #projectRisksWrap{ display:none !important; }

/* Product-only view: show only 6) –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø—Ä–æ–¥—É–∫—Ç—É (prodReqCard) */
body.view-product #cardMaturity,
body.view-product #cardFinance,
body.view-product #cardReq{ display:none !important; }

/* Keep cardPSI container but hide PSI parts; show only nested prodReqCard */
body.view-product #cardPSI > h2,
body.view-product #cardPSI > .small,
body.view-product #cardPSI > .btns,
body.view-product #cardPSI > .table-wrap,
body.view-product #cardPSI > .hr,
body.view-product #projectRisksWrap{ display:none !important; }

body.view-product #prodReqCard{ margin-top:0 !important; }

/* Collapse Passport card to only company (+industry) row */
body.view-product #cardPassport .hr,
body.view-product #cardPassport h3,
body.view-product #cardPassport .small,
body.view-product #cardPassport .virt-wrapper,
body.view-product #cardPassport .virt-hint,
body.view-product #cardPassport .row:not(:first-of-type){ display:none !important; }


/* === Suggest timestamp formatting === */
.companySuggestMeta{display:flex;gap:10px;align-items:baseline;flex-wrap:wrap}
.companySuggestMeta .dt-date{font-weight:800}
.companySuggestMeta .dt-time{font-variant-numeric:tabular-nums;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
.companySuggestMeta .dt-tz{opacity:.8}

/* === View flags === */
body.no-kpi .kpiBar{display:none !important;}


    .kpiGroupTitle{
      grid-column: 1 / -1;
      font-weight: 950;
      font-size: 12px;
      color: var(--muted);
      margin: 2px 0 -6px;
      padding-left: 2px;
      letter-spacing:.2px;
      text-transform: uppercase;
    }
    

body{overflow-x:hidden;}
.demoSummary{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid rgba(15,23,42,.12);border-radius:999px;background:#fff;cursor:pointer;user-select:none;}
.demoSummary::marker{display:none;}
.demoDetails[open] .demoSummary{background:#f8fafc;}
.demoExtra{margin-top:8px;}

.benchWrap{display:none!important;}

#benchBadge,#benchTransparencyCard,#benchDetails,#benchProfileLabel{display:none!important;}

.dockLoadBtn{border:1px solid var(--border);background:var(--field);border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer}
.dockLoadBtn:hover{filter:brightness(0.98)}
.dockTop{display:flex;gap:10px;align-items:center}

/* v38: center questions/requirements blocks, prevent horizontal scroll */
body.view-pilot #cardReq,
body.view-pilot #cardMaturity,
body.view-product #prodReqCard,
body.view-psi #cardPSI,
body.view-full #cardMaturity,
body.view-full #cardReq,
body.view-full #prodReqCard,
body.view-full #cardPSI{
  max-width:1120px;
  margin-left:auto !important;
  margin-right:auto !important;
}

/* Keep interview page blocks aligned to the same content width */
body.view-interview #cardPassport,
body.view-interview #cardMaturity,
body.view-interview #cardFinance{
  max-width:1120px;
  margin-left:auto !important;
  margin-right:auto !important;
}
body.view-pilot table,
body.view-product table,
body.view-psi table,
body.view-full table{
  min-width:0 !important;
}
body.view-pilot .card,
body.view-product .card,
body.view-psi .card,
body.view-full .card{
  overflow-x:hidden;
}


/* ---- v40 layout & suggest fixes ---- */
:root{--pageMax:1120px;}
@media (min-width: 980px){
  header.topHeader, .grid{max-width: var(--pageMax); margin-left:auto; margin-right:auto;}
}
.grid{width:100%;}
/* Keep company search dropdown above cards */
.companySuggestWrap{position:relative; z-index:5000; overflow:visible;}
.companySuggestDropdown{position:absolute; left:0; right:0; top:calc(100% + 6px); z-index:99999;}
.companySuggestItem{position:relative; z-index:100000;}
/* Tables should fit the centered column without horizontal scroll */
.reqTable, .psiTable, .productTable{width:100%; table-layout:fixed; min-width:0 !important;}
.reqTable th, .reqTable td, .psiTable th, .psiTable td, .productTable th, .productTable td{white-space:normal; word-break:break-word;}
.reqTable textarea, .psiTable textarea, .productTable textarea{width:100%; box-sizing:border-box;}

/* === v41 unified width + floating company dropdown === */
:root{--content-max:1120px;}
.container{max-width:none !important;}
/* center ALL major blocks (including grids/tables) inside the padded container */
.container > .header,
.container > .grid,
.container > .card,
.container > .section,
.container > section,
.container > .tableWrap,
.container > .block,
.container > .hr,
.container > .divider{
  max-width:var(--content-max) !important;
  margin-left:auto !important;
  margin-right:auto !important;
  width:100% !important;
}
/* safety: keep inner wide wrappers constrained */
.wide, .wideWrap, .wideSection, .contentWide, .fullWidthBlock{
  max-width:var(--content-max) !important;
  margin-left:auto !important;
  margin-right:auto !important;
  width:100% !important;
}
/* tables should not force horizontal scroll unless truly necessary */
.tableWrap{overflow-x:auto;}

.companySuggestDropdown{z-index:999999 !important;}



/* v43b: hard unify width for passport + nested blocks (some blocks are not direct children) */
#cardPassport,
#passportCard,
.cardPassport,
.passportRow,
.passportWrap,
.passportExtra,
.passportBlock,
.container #cardPassport,
.container #passportCard,
.container .cardPassport,
.container .passportRow,
.container .passportWrap,
.container .passportExtra,
.container .passportBlock{
  max-width:var(--content-max) !important;
  width:100% !important;
  margin-left:auto !important;
  margin-right:auto !important;
}



/* UNIFIED_WIDTH_FIX_V44 */
/* Make all top-level blocks align perfectly under each other */
:root{ --pageMax: 1120px; }
.kpiBar{ max-width: var(--pageMax); margin-left:auto; margin-right:auto; }
.container > .card,
.container > section,
.container > .section,
.container > .tableWrap,
.container > .block,
.container > .blockWrap,
.container > .formSection{
  max-width: var(--pageMax);
  width: 100%;
  margin-left: auto;
  margin-right: auto;
}
/* allow dropdowns to overlay next blocks */
.card, .section, .tableWrap{ overflow: visible; }

/* Dock collapse */
.dockHeader{display:flex;align-items:center;justify-content:space-between;gap:10px}
body.dockCollapsed .quickDock .dockHeader{flex-direction:column;justify-content:flex-start;align-items:center;gap:8px;padding-top:8px}
body.dockCollapsed .quickDock .dockTitle{width:100%;text-align:center;font-weight:700;font-size:14px;line-height:1.1;white-space:normal}
body.dockCollapsed .quickDock .dockToggle{width:44px;height:34px;border-radius:12px;padding:0;display:flex;align-items:center;justify-content:center}
.dockToggle{border:1px solid rgba(0,0,0,.08);background:#fff;border-radius:10px;padding:6px 10px;cursor:pointer;font-weight:700;line-height:1;box-shadow:0 6px 20px rgba(0,0,0,.06)}
.dockToggle:hover{transform:translateY(-1px)}
/* --- QuickDock collapsed: icon-only, clean spacing --- */
body.dockCollapsed .quickDock{width:86px !important; overflow:hidden !important}
body.dockCollapsed .quickDock .dockSearchWrap,
body.dockCollapsed .quickDock .dockTitle:not(.dockHeader .dockTitle),
body.dockCollapsed .quickDock .dockDesc,
body.dockCollapsed .quickDock .dockToolsTitle,
body.dockCollapsed .quickDock .dockItemText,
body.dockCollapsed .quickDock .dockItemSub{display:none !important}
body.dockCollapsed .quickDock .dockCard{padding:12px !important}
body.dockCollapsed .quickDock .dockToolBtn{justify-content:center !important}
body.dockCollapsed .quickDock .dockToolBtn .dockIcon{margin-right:0 !important}

/* tools: single column, only icon */
body.dockCollapsed .quickDock .toolGrid{grid-template-columns:1fr !important; gap:10px !important}
body.dockCollapsed .quickDock a.tool{justify-content:center !important; padding:10px !important; gap:0 !important}
body.dockCollapsed .quickDock a.tool > div:not(.tIcon){display:none !important}
body.dockCollapsed .quickDock a.tool .tName,
body.dockCollapsed .quickDock a.tool .tDesc{display:none !important}
body.dockCollapsed .quickDock a.tool .tIcon{margin:0 !important; width:42px !important; height:42px !important; display:flex !important; align-items:center !important; justify-content:center !important; border-radius:14px !important}


/* Dock collapse (v2) */
.quickDock a.tool{display:flex;align-items:center;gap:10px}
.quickDock a.tool .toolIcon{flex:0 0 auto;width:28px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:10px;background:rgba(0,0,0,.04)}
.quickDock a.tool .toolText{display:flex;flex-direction:column;gap:2px}
.quickDock a.tool .toolText small{opacity:.7}
body.dockCollapsed .quickDock .dockTitle{display:none !important}
body.dockCollapsed .quickDock .dockHeader .dockTitle{display:block !important}
body.dockCollapsed .quickDock a.tool{justify-content:center !important}
body.dockCollapsed .quickDock a.tool .toolText{display:none !important}



  /* Dock expanded state must look like the original (wide, with text) */
  body:not(.dockCollapsed) .quickDock{ width:320px !important; max-width:320px !important; }
  body:not(.dockCollapsed) .quickDock .dockTitle{ white-space:nowrap; }
  body:not(.dockCollapsed) .quickDock a.tool{ flex-direction:row; justify-content:flex-start; }
  body:not(.dockCollapsed) .quickDock a.tool .tIcon{ margin-right:10px; }

</style>
<style id="kpi-modal-css">
/* ===== KPI explain modal ===== */
.kpiModal{position:fixed;inset:0;display:none;z-index:9999}
.kpiModal[aria-hidden="false"]{display:block}
.kpiModal .backdrop{position:absolute;inset:0;background:rgba(17,24,39,.45);backdrop-filter: blur(6px);}
.kpiModal .dialog{
  position:relative;max-width:920px;margin:6vh auto;background:#fff;border:1px solid #e5e7eb;border-radius:18px;
  box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden;
}
.kpiModal .head{display:flex;align-items:flex-start;justify-content:space-between;gap:14px;padding:16px 18px;background:#f8fafc;border-bottom:1px solid #e5e7eb}
.kpiModal .title{margin:0;font-size:16px;font-weight:900;color:#0f172a}
.kpiModal .sub{margin-top:6px;color:#64748b;font-size:12px;line-height:1.35}
.kpiModal .closeBtn{appearance:none;border:none;background:#e5e7eb;color:#0f172a;border-radius:12px;padding:8px 10px;cursor:pointer;font-weight:900}
.kpiModal .closeBtn:hover{background:#dcdcdc}
.kpiModal .body{padding:14px 18px 18px 18px;max-height:72vh;overflow:auto}
.kpiModal .sect{border:1px solid #e5e7eb;border-radius:14px;padding:12px 12px;margin-top:10px}
.kpiModal .sect h3{margin:0 0 6px 0;font-size:13px;color:#0f172a}
.kpiModal .sect p, .kpiModal .sect li{margin:0;color:#334155;font-size:13px;line-height:1.5}
.kpiModal .sect ul{margin:8px 0 0 18px}
.kpiModal .note{margin-top:10px;color:#64748b;font-size:12px}

/* demo plan list */
.miniList{margin:6px 0 0 18px; padding:0;}
.miniList li{margin:4px 0;}
/* Demo plan (compact) */
/* No inner scrollbars: top-3 + —Ä–∞—Å–∫—Ä—ã–≤–∞—à–∫–∞ keeps card tidy */
#demoFocusHint{padding-right:2px;}
.demoIntro{font-size:12px; opacity:.85; margin-bottom:8px;}
.demoSectionTitle{font-size:12px; font-weight:600; margin-top:8px;}
.demoList{margin:6px 0 0 0; padding:0; list-style:none;}
.demoList li{display:flex; gap:8px; align-items:flex-start; margin:6px 0;}
.demoList .prio{font-weight:700; white-space:nowrap; font-size:12px;}
.demoList .func{font-size:12px; line-height:1.25;}
.demoDetails{margin-top:6px;}
.demoDetails summary{
  cursor:pointer; font-size:12px; user-select:none;
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 10px; border-radius:999px;
  border:1px solid rgba(15,23,42,.12);
  background:rgba(255,255,255,.85);
}
.demoDetails summary::-webkit-details-marker{display:none}
.demoDetails summary:after{content:"‚ñæ"; opacity:.75; transform:translateY(-1px)}
.demoDetails[open] summary:after{content:"‚ñ¥"}
.demoDetails[open] summary{margin-bottom:6px;}
.kpi-clickable{cursor:pointer;user-select:none}
.kpi-clickable:active{transform:translateY(1px)}
</style>
<style id="gs-reverse-sync-css">
/* Reverse sync (Google Sheets) ‚Äî company autocomplete */
.companySuggestWrap{ position:relative; }
.companySuggestDropdown{
  position:absolute; left:0; right:0; top:100%;
  margin-top:6px;
  background:#ffffff;
  border:1px solid #e5e7eb;
  border-radius:14px;
  box-shadow:0 20px 40px rgba(0,0,0,.12);
  overflow:hidden;
  display:none;
  z-index:99999;
}
.companySuggestItem{
  padding:10px 12px;
  cursor:pointer;
  border-bottom:1px solid #eef2f7;
}
.companySuggestItem:last-child{ border-bottom:none; }
.companySuggestItem:hover{ background:#f8fafc; }
.companySuggestTitle{ font-weight:900; color:#0f172a; font-size:13px; }
.companySuggestMeta{ color:#64748b; font-size:12px; margin-top:3px; }
.companySuggestEmpty{
  padding:10px 12px;
  color:#64748b;
  font-size:12px;
}
</style>
<style id="global-loader-css">
#globalLoader{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:100000;background:rgba(255,255,255,.65);backdrop-filter: blur(6px);}
#globalLoader .box{background:#fff;border:1px solid #e5e7eb;border-radius:18px;box-shadow:0 20px 50px rgba(0,0,0,.18);padding:16px 18px;min-width:280px;max-width:520px;display:flex;gap:12px;align-items:center}
#globalLoader .spinner{width:22px;height:22px;border-radius:999px;border:3px solid #e5e7eb;border-top-color:#0ea5e9;animation:glspin 0.9s linear infinite}
#globalLoader .title{font-weight:900;color:#0f172a;font-size:13px;margin:0}
#globalLoader .sub{color:#64748b;font-size:12px;margin:2px 0 0 0;line-height:1.35}
@keyframes glspin{to{transform:rotate(360deg)}}
</style>
<style id="pageVisibilityRules">

/* Page: Interview */
#cardReq, #cardPSI, #prodReqCard, #projectRisksWrap, #riskHeatmapCard { display:none !important; }
/* Passport full visible */
.reqDot, .reqMark, .requiredDot, .required { display:none !important; }
label:has(#company) .reqDot, label:has(#company) .requiredDot, label:has(#company) .required{ display:inline-block !important; }
</style>
</meta>
<style id="unifiedWidthAndDropdownFix">
/* BUILD v61: unify content width across blocks + fix company dropdown clipping */
:root{
  --dockW: 340px;
  --contentW: 1120px;
  --pagePad: 24px;
}

/* Keep overall page layout (dock on left) but make ALL content blocks –æ–¥–∏–Ω–∞–∫–æ–≤–æ–π —à–∏—Ä–∏–Ω—ã */
.container{
  max-width: calc(var(--dockW) + var(--contentW) + (var(--pagePad) * 2));
  margin-left: auto;
  margin-right: auto;
}

/* Every direct block in the main column has the same width and left edge */
.container > header,
.container > .card,
.container > section,
.container > div{
  max-width: var(--contentW);
  width: 100%;
  margin-left: auto;
  margin-right: auto;
}

/* Don‚Äôt accidentally constrain the left dock itself */

/* Tables should not create horizontal page scroll; scroll only inside table card */
.tableWrap{ overflow-x:auto; }

/* Fix: company suggestions were hidden under card due to overflow:hidden */
.card{ overflow: visible; }
.dockSearchWrap{ overflow: visible; }
.companySuggest{ z-index: 99999; }

 (max-width: 1180px){
  :root{ --dockW: 0px; --contentW: 980px; }
  .container{ max-width:none; margin:0; }
  .container{ padding-left: 24px; }
}

/* === FORCE unified content width + alignment (v45) === */
:root{
  --contentW: 1120px;
  --contentPad: 22px;
}
.container{
  max-width: var(--contentW) !important;
  margin-left: auto !important;
  margin-right: auto !important;
  padding-left: 0 !important;
  padding-right: 0 !important;
}
.card, .section, .block, .panel, .kpiBar, .heatWrap, .tableWrap, .table-card, .grid, .grid2, .grid3, .wide, .content, .contentWrap{
  width: 100% !important;
  max-width: 100% !important;
  margin-left: 0 !important;
  margin-right: 0 !important;
}
#passportCard, #passportProject, .passportCard, .passport-project, .passport, .project-passport{
  width: 100% !important;
  max-width: 100% !important;
}
.center, .centerRow, .passportWrap, .passportRow, .rowCenter{
  justify-content: flex-start !important;
}
.searchWrap, .companySearch, .company-search, .quickSearch, .fastSearch, .inputWrap{
  position: relative !important;
  overflow: visible !important;
  z-index: 50 !important;
}
.suggestions, .dropdown, .autocomplete, .companyList, .suggestList{
  position: absolute !important;
  z-index: 9999 !important;
}
.card, .section, .block, .panel{
  overflow: visible !important;
}

</style>

<!-- FORCE_UNIFIED_LAYOUT_V46: make all content blocks same width & aligned -->
<style>
  :root{ --contentW: 1120px; }
  .container{ max-width:none !important; }
  .card, .section, .table-wrap, .form-grid, .grid, .reqBlock, .requirements, .maturity, .block, .panel{
    width: 100% !important;
    max-width: var(--contentW) !important;
    margin-left: auto !important;
    margin-right: auto !important;
    box-sizing: border-box;
  }
  .fullWidth, .wide, .wideBlock, .stretch{
    width: 100% !important;
    max-width: var(--contentW) !important;
    margin-left: auto !important;
    margin-right: auto !important;
  }
  body{ overflow-x: hidden; }
  #dockSuggest, .suggestions{ z-index: 20000 !important; }
</style>
</head>
<body class="view-interview pageMode-interview">

<div id="buildBadge" style="position:fixed;z-index:99999;bottom:12px;right:12px;background:#111827;color:#fff;padding:8px 10px;border-radius:10px;font:12px/1.2 system-ui;box-shadow:0 10px 30px rgba(0,0,0,.15);opacity:.92">
  BUILD <b>v42</b> ‚Ä¢ interview
</div>

<div class="quickDock" id="quickDock">
<div class="card pad">
<div class="dockHeader"><div class="dockTitle">–ë—ã—Å—Ç—Ä—ã–π –≤—Ö–æ–¥</div><button type="button" class="dockToggle" id="dockToggle" aria-label="–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –ø–∞–Ω–µ–ª—å" title="–°–≤–µ—Ä–Ω—É—Ç—å –ø–∞–Ω–µ–ª—å">‚óÄ</button></div>
<div class="dockSearchWrap dockTop">
<div class="dockIcon">üîé</div>
<input autocomplete="off" class="dockSearch" id="dockCompany" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–ø–∞–Ω–∏—é"/>
<button class="dockLoadBtn" id="dockLoadBtn" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å" type="button">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
</div>
<div class="dockSuggest" id="dockSuggest"></div>
<div style="height:12px"></div>
<div class="dockTitle" style="margin-bottom:0">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</div>
<div class="toolGrid">
<a class="tool" href="index.html?v=61"><div class="tIcon">üè†</div><div><div class="tName">–î–∞—à–±–æ—Ä–¥</div><div class="tDesc">PSI Control Center</div></div></a>
<a class="tool" href="view_1_indices.html?v=61"><div class="tIcon">üìä</div><div><div class="tName">–ò–Ω–¥–µ–∫—Å—ã</div><div class="tDesc">–∏—Ç–æ–≥–∏</div></div></a>
<a class="tool" href="view_2_interview.html?v=61"><div class="tIcon">üéØ</div><div><div class="tName">–ò–Ω—Ç–µ—Ä–≤—å—é</div><div class="tDesc">1‚Äì3</div></div></a>
<a class="tool" href="view_3_requirements.html?v=61"><div class="tIcon">üß™</div><div><div class="tName">–ü–∏–ª–æ—Ç</div><div class="tDesc">—Ä–∞–∑–¥–µ–ª 4</div></div></a>
<a class="tool" href="view_3b_product.html?v=61"><div class="tIcon">üß©</div><div><div class="tName">–ü—Ä–æ–¥—É–∫—Ç</div><div class="tDesc">—Ä–∞–∑–¥–µ–ª 6</div></div></a>
<a class="tool" href="view_4_psi.html?v=61"><div class="tIcon">üìà</div><div><div class="tName">–ü–°–ò</div><div class="tDesc">—Ä–∞–∑–¥–µ–ª 5</div></div></a>
<a class="tool" href="view_5_full.html?v=61"><div class="tIcon">üìÑ</div><div><div class="tName">–ü–æ–ª–Ω–∞—è –∫–∞—Ä—Ç–∞</div><div class="tDesc">–≤—Å—ë</div></div></a>
</div>
</div>
</div>
<div class="container">
<header>
<div>
<h1>–ö–∞—Ä—Ç–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è + –ü–°–ò (–ø–∏–ª–æ—Ç) ‚Äî –ò–Ω—Ñ–µ—Ä–∏—Ç –ò–¢–ú–µ–Ω</h1>
<div class="legend">
<span class="pill">–¢–µ—Ö/–ü—Ä–æ—Ü: 0 = –Ω–µ—Ç ¬∑ 1 = —á–∞—Å—Ç–∏—á–Ω–æ ¬∑ 2 = –µ—Å—Ç—å</span>
<span class="pill">–†–∏—Å–∫–∏: 1 = –¥–∞ ¬∑ 0 = –Ω–µ—Ç</span>
<span class="pill">–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å: –≤–ª–∏—è–µ—Ç –Ω–∞ ¬´–∏–Ω–¥–µ–∫—Å —Ä–µ–∞–ª–∏–∑—É–µ–º–æ—Å—Ç–∏¬ª</span>
<span class="pill">–ü–°–ò: ¬´–ü—Ä–∏–Ω—è–ª–∏?¬ª = –î–∞/–ù–µ—Ç</span>
</div>
</div>
<div class="btns">
<label style="display:grid;gap:6px;font-size:12px;min-width:180px">–í–µ—Ä—Å–∏—è PDF
        <select id="pdfMode" style="padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--field);font-weight:700">
<option value="internal">–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è</option>
<option value="client">–ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è</option>
</select>
</label>
<label style="display:grid;gap:6px;font-size:12px;min-width:180px">–†–µ–∂–∏–º –∏–Ω—Ç–µ—Ä–≤—å—é
        <select id="interviewMode" style="padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--field);font-weight:700">
<option value="quick">–ë—ã—Å—Ç—Ä—ã–π</option>
<option value="deep">–ì–ª—É–±–æ–∫–∏–π</option>
</select>
</label>
<input id="benchMode" type="hidden" value="client"/>
<div id="reqStatus" style="align-self:end;color:#b91c1c;font-size:12px;display:none;max-width:260px;line-height:1.2"></div>
<button class="btn ghost" id="btnLoadCompany">–ü–æ–¥–≥—Ä—É–∑–∏—Ç—å</button>
<button class="btn" id="btnRecalc">–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å</button>
<button class="btn ghost" id="btnPrint">–ü–µ—á–∞—Ç—å / PDF</button>
<button class="btn ghost" id="btnExportXlsx">–í—ã–≥—Ä—É–∑–∏—Ç—å Excel</button>
<button class="btn ghost" id="btnCLevel">C-level –≤—ã–≤–æ–¥</button>
</div>
<!-- KPI moved to header -->
<div class="kpiBar">
<div class="kpiGroupTitle">–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –∏–Ω–¥–µ–∫—Å—ã</div>
<div class="stat" id="kPSI">
<div class="label">PSI 2.0 (–∏—Ç–æ–≥)</div>
<div class="value mono" id="psi2Score">‚Äî%</div>
<div class="small" id="psi2Label">‚Äî</div>
</div>
<div class="stat" id="kCoI">
<div class="label">Cost of Inaction (‚ÇΩ/–≥–æ–¥)</div>
<div class="value mono" id="coiRub">‚Äî</div>
<div class="small">–ü–æ—Ç–µ—Ä–∏ –æ—Ç —Ä—É—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π, –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ –ü–û/VM –∏ –ø—Ä–æ—Å—Ç–æ–µ–≤.</div>
</div>
<div class="stat" id="kRecover">
<div class="label">–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –≤–æ–∑–≤—Ä–∞—Ç–∞ –±—é–¥–∂–µ—Ç–∞</div>
<div class="value mono" id="recoverIndex">‚Äî%</div>
<div class="small" id="recoverLabel">–õ–∏—Ü–µ–Ω–∑–∏–∏ –∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã.</div>
</div>
<div class="stat" id="kTech">
<div class="label">–ò–Ω–¥–µ–∫—Å —Ç–µ—Ö. –∑—Ä–µ–ª–æ—Å—Ç–∏</div>
<div class="value mono" id="techIndex">‚Äî%</div>
<div class="small">–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –ø–æ –¥–∞–Ω–Ω—ã–º/–∏—Å—Ç–æ—á–Ω–∏–∫–∞–º.</div>
</div>
<div class="stat" id="kProc">
<div class="label">–ò–Ω–¥–µ–∫—Å –ø—Ä–æ—Ü–µ—Å—Å–Ω–æ–π –∑—Ä–µ–ª–æ—Å—Ç–∏</div>
<div class="value mono" id="procIndex">‚Äî%</div>
<div class="small">–ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å –≤–Ω–µ–¥—Ä–µ–Ω–∏—è.</div>
</div>
<div class="kpiGroupTitle">–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∏–Ω–¥–µ–∫—Å—ã</div>
<div class="stat" id="kCrit">
<div class="label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞</div>
<div class="value mono" id="critScore">‚Äî%</div>
<div class="small" id="critLabel">‚Äî</div>
</div>
<div class="stat" id="kFeas">
<div class="label">–ò–Ω–¥–µ–∫—Å —Ä–µ–∞–ª–∏–∑—É–µ–º–æ—Å—Ç–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ –ø–∏–ª–æ—Ç—É</div>
<div class="value mono" id="feasScore">‚Äî%</div>
<div class="small">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª –ø–æ ¬´–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏¬ª (—Ä–∞–∑–¥–µ–ª 4).</div>
</div>
<div class="stat" id="kProdFeas">
<div class="label">–ò–Ω–¥–µ–∫—Å —Ä–µ–∞–ª–∏–∑—É–µ–º–æ—Å—Ç–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ –ø—Ä–æ–¥—É–∫—Ç—É</div>
<div class="value mono" id="prodFeasScore">‚Äî%</div>
<div class="small">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª –ø–æ ¬´–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏¬ª (—Ä–∞–∑–¥–µ–ª 6).</div>
</div>
<div class="stat" id="kPain">
<div class="label">–ò–Ω–¥–µ–∫—Å —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–≥–æ –¥–∞–≤–ª–µ–Ω–∏—è</div>
<div class="value mono" id="painIndex">‚Äî%</div>
<div class="small" id="painLabel">‚Äî</div>
</div>
<div class="stat" id="kProb">
<div class="label">–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Å–¥–µ–ª–∫–∏</div>
<div class="value mono" id="probIndex">‚Äî%</div>
<div class="small" id="probLabel">‚Äî</div>
</div>
<div class="kpiBar riskReady" style="margin-top:8px">
<div class="kpiGroupTitle">–†–∏—Å–∫ –∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å</div>
<div class="stat clickable" data-detail="pilot" id="kPilotReady">
<div class="label">Pilot Readiness Index</div>
<div class="value mono" id="pilotReady">‚Äî%</div>
<div class="small" id="pilotReadyLabel">‚Äî</div>
</div>
<div class="stat clickable" data-detail="problem" id="kMainProblem">
<div class="label">–û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞</div>
<div class="value" id="mainProblem">‚Äî</div>
<div class="small" id="mainProblemHint">‚Äî</div>
</div>
<div class="stat clickable" data-detail="modules" id="kModules">
<div class="label">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</div>
<div class="value" id="recModules">‚Äî</div>
<div class="small">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ –ø–æ—Ä–æ–≥–∞–º —Ä–∏—Å–∫–∞.</div>
</div>
<div class="stat clickable" data-detail="demo" id="kDemo">
<div class="label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–µ–º–æ</div>
<div class="value" id="demoFocus">‚Äî</div>
<div class="small" id="demoFocusHint">‚Äî</div>
</div>
</div>
</div>
</header>
<div class="grid">
<div class="card" id="riskHeatmapCard">
<h2>Heatmap –ø–æ –∑–æ–Ω–∞–º —Ä–∏—Å–∫–∞ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)</h2>
<div class="small">–§–æ—Ä–º—É–ª–∞ –ø–æ –∑–æ–Ω–µ: Œ£(–í–µ—Å√ó–û—Ç–≤–µ—Ç) / Œ£(–í–µ—Å –∑–æ–Ω—ã). –û—Ç–≤–µ—Ç: –î–∞=0, –ß–∞—Å—Ç–∏—á–Ω–æ=0.5, –ù–µ—Ç=1.</div>
<div class="hr"></div>
<div class="row">
<div>
<div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
<b>–°–µ—Ä—ã–µ –∑–æ–Ω—ã (–æ—Ö–≤–∞—Ç / –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)</b>
<span class="mono" id="riskGreyPct">‚Äî%</span>
</div>
<div class="bar"><span id="riskGreyBar"></span></div>
</div>
<div>
<div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
<b>–õ–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π —Ä–∏—Å–∫</b>
<span class="mono" id="riskLicPct">‚Äî%</span>
</div>
<div class="bar"><span id="riskLicBar"></span></div>
</div>
</div>
<div class="row" style="margin-top:10px">
<div>
<div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
<b>–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å / —Ä—É—á–Ω–æ–π —Ç—Ä—É–¥</b>
<span class="mono" id="riskOpsPct">‚Äî%</span>
</div>
<div class="bar"><span id="riskOpsBar"></span></div>
</div>
<div>
<div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
<b>–£–ø—Ä–∞–≤–ª—è–µ–º–æ—Å—Ç—å / –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏—Å—Ç–æ—Ä–∏–∏</b>
<span class="mono" id="riskGovPct">‚Äî%</span>
</div>
<div class="bar"><span id="riskGovBar"></span></div>
</div>
</div>
<div class="hr"></div>
<h3>–°—Ç–æ–∏–º–æ—Å—Ç—å –±–µ–∑–¥–µ–π—Å—Ç–≤–∏—è (‚ÇΩ/–≥–æ–¥)</h3>
<div class="row">
<div class="stat" style="box-shadow:none">
<div class="label">–õ–∏—Ü–µ–Ω–∑–∏–∏ (–ü–û)</div>
<div class="value mono" id="coiLic">‚Äî</div>
<div class="small">–ë—é–¥–∂–µ—Ç –ª–∏—Ü–µ–Ω–∑–∏–π √ó % –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ –ü–û</div>
</div>
<div class="stat" style="box-shadow:none">
<div class="label">–ü—Ä–æ—Å—Ç–æ–∏</div>
<div class="value mono" id="coiDown">‚Äî</div>
<div class="small">–ß–∞—Å—ã –ø—Ä–æ—Å—Ç–æ—è √ó –°—Ç–æ–∏–º–æ—Å—Ç—å —á–∞—Å–∞</div>
</div>
</div>
<div class="row" style="margin-top:10px">
<div class="stat" style="box-shadow:none">
<div class="label">–†—É—á–Ω–æ–π —Ç—Ä—É–¥</div>
<div class="value mono" id="coiManual">‚Äî</div>
<div class="small">–ö–æ–ª-–≤–æ –ò–¢ √ó –∑–∞—Ä–ø–ª–∞—Ç–∞ √ó % —Ä—É—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π</div>
</div>
<div class="stat" style="box-shadow:none">
<div class="label">–ò—Ç–æ–≥–æ</div>
<div class="value mono" id="coiTotal">‚Äî</div>
<div class="small">–°—É–º–º–∞ 3 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤</div>
</div>
</div>
</div>
<div class="card" id="cLevelBlock" style="display:none">
<h2>C-level –≤—ã–≤–æ–¥ (–∞–≤—Ç–æ)</h2>
<div class="small">–°—Ñ–æ—Ä–º–∏—Ä—É–π—Ç–µ –∫—Ä–∞—Ç–∫–∏–π –≤—ã–≤–æ–¥ –¥–ª—è CEO/CFO/CIO: ¬´–≥–¥–µ –ø—Ä–æ—Å–µ–¥–∞–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ä—ã–Ω–∫–∞¬ª, ¬´—Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —ç—Ñ—Ñ–µ–∫—Ç¬ª, ¬´—Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥¬ª.</div>
<div class="row" style="margin-top:10px">
<div style="grid-column:1 / -1;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
<span class="pill" id="dataAccuracyPill">–¢–æ—á–Ω–æ—Å—Ç—å –æ—Ç—á—ë—Ç–∞: ‚Äî%</span>
<span class="pill" id="dataSourcesPill">–ò—Å—Ç–æ—á–Ω–∏–∫–∏: ‚Äî</span>
</div>
</div>
<div class="small" style="margin-top:6px">–ß—Ç–æ–±—ã –ø–æ–≤—ã—Å–∏—Ç—å —Ç–æ—á–Ω–æ—Å—Ç—å, –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ 3‚Äì5 –≤–æ–ø—Ä–æ—Å–æ–≤ –Ω–∏–∂–µ (–ø–æ–¥–±–∏—Ä–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ –≤–ª–∏—è–Ω–∏—é –Ω–∞ PSI).</div>
<div class="card" style="margin-top:10px;background:rgba(255,255,255,.04)">
<h3 style="margin:0 0 8px">–¢–æ–ø‚Äë–≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è —Ç–æ—á–Ω–æ—Å—Ç–∏</h3>
<ol class="small" id="topQuestions" style="margin:0;padding-left:18px;line-height:1.45"></ol>
</div>
<div class="card" id="benchTransparencyCard" style="margin-top:10px;background:rgba(255,255,255,.04)">
<details id="benchDetails" style="cursor:pointer">
<summary style="font-weight:900">–ü–æ–∫–∞–∑–∞—Ç—å, –∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –ø–æ –±–µ–Ω—á–º–∞—Ä–∫–∞–º</summary>
<div class="small" id="benchDetailsMeta" style="margin-top:10px;opacity:.9"></div>
<div style="overflow:auto;margin-top:10px">
<table class="table" style="min-width:760px">
<thead>
<tr>
<th>–ü–∞—Ä–∞–º–µ—Ç—Ä</th>
<th>–ó–Ω–∞—á–µ–Ω–∏–µ</th>
<th>P25‚ÄìP75</th>
<th>–ò—Å—Ç–æ—á–Ω–∏–∫</th>
</tr>
</thead>
<tbody id="benchDetailsTbody"></tbody>
</table>
</div>
</details>
</div>
<div class="row" style="margin-top:10px">
<label style="grid-column:1 / -1">–¢–µ–∫—Å—Ç –≤—ã–≤–æ–¥–∞
        <textarea id="cLevelText" placeholder="–ù–∞–∂–º–∏—Ç–µ ¬´C-level –≤—ã–≤–æ–¥¬ª –≤–≤–µ—Ä—Ö—É ‚Äî —Å—é–¥–∞ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—Å—è —Ç–µ–∫—Å—Ç."></textarea>
</label>
</div>
<div class="btns" style="margin-top:10px">
<button class="btn ghost" id="btnCopyCLevel">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
<button class="btn ghost" id="btnHideCLevel">–°–∫—Ä—ã—Ç—å</button>
</div>
</div>
<div class="card" id="cardPassport">
<h2>1) –ü–∞—Å–ø–æ—Ä—Ç –ø—Ä–æ–µ–∫—Ç–∞</h2>
<div class="row">
<label>–ö–æ–º–ø–∞–Ω–∏—è
          <input id="company" placeholder="–û–û–û ¬´–ü—Ä–æ–º—Ä–µ—Å—É—Ä—Å¬ª"/>
</label>
<label>–û—Ç—Ä–∞—Å–ª—å
          <select id="industry">
<option value="">‚Äî –≤—ã–±—Ä–∞—Ç—å ‚Äî</option>
<option>–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å</option><option>–¢–µ–ª–µ–∫–æ–º</option><option>–†–∏—Ç–µ–π–ª</option>
<option>–§–∏–Ω–∞–Ω—Å—ã</option><option>–ì–æ—Å—Å–µ–∫—Ç–æ—Ä</option><option>–ò–¢/–∏–Ω—Ç–µ–≥—Ä–∞—Ç–æ—Ä</option><option>–î—Ä—É–≥–æ–µ</option>
</select>
</label>
</div>
<div class="row" style="margin-top:6px">
<div class="hint" id="companyMeta" style="flex:1;color:#6b7280;font-size:12px">‚Äî</div>
<button class="btn ghost" id="btnCompanyAll" style="display:none">–í—Å–µ –∑–∞–ø–∏—Å–∏</button>
</div>
</div>

<!-- Passport extended fields (hidden on focused pages) -->
<div id="passportExtra">
<div class="row" style="margin-top:10px">
<label>Sales –º–µ–Ω–µ–¥–∂–µ—Ä (–§–ò–û)
          <input id="sales_manager" placeholder="–ò–º—è –§–∞–º–∏–ª–∏—è"/>
</label>
<label>Pre-Sale –º–µ–Ω–µ–¥–∂–µ—Ä (–§–ò–û)
          <input id="presale_manager" placeholder="–ò–º—è –§–∞–º–∏–ª–∏—è"/>
</label>
</div>
<div class="row" style="margin-top:10px">
<label>–õ–ü–† / –∫–æ–Ω—Ç–∞–∫—Ç
          <input id="lpr" placeholder="–§–ò–û, –¥–æ–ª–∂–Ω–æ—Å—Ç—å, –∫–æ–Ω—Ç–∞–∫—Ç—ã"/>
</label>
<!-- removed status block as requested -->
<label>–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö (—Å–≤–æ–±–æ–¥–Ω—ã–π –≤–≤–æ–¥)
          <input id="sources" placeholder="AD, SCCM, VMware, SNMP, IPMI, MS SQL, API‚Ä¶"/>
</label>
</div>
<div class="row" style="margin-top:10px">
<label>–ö–æ–ª-–≤–æ —Ä–∞–±–æ—á–∏—Ö –º–µ—Å—Ç
          <input id="workplaces" min="0" step="1" type="number" value="0"/>
</label>
<label>–ö–æ–ª-–≤–æ —Å–µ—Ä–≤–µ—Ä–æ–≤
          <input id="servers" min="0" step="1" type="number" value="0"/>
</label>
</div>
<div class="row" style="margin-top:10px">
<label>–ö–æ–ª-–≤–æ —Ñ–∏–ª–∏–∞–ª–æ–≤
          <input id="branches" min="0" step="1" type="number" value="0"/>
</label>
</div>
<div class="row" style="margin-top:10px">
<label>–ó–∞–∫—Ä—ã—Ç—ã–π –∫–æ–Ω—Ç—É—Ä
          <select id="closed"><option value="">‚Äî</option><option>–î–∞</option><option>–ù–µ—Ç</option></select>
</label>
<label>–ü—Ä–∏–º–µ—á–∞–Ω–∏—è –ø–æ —Å—Ä–µ–¥–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
          <input id="envNote" placeholder="–ù–∞–ø—Ä.: —Ñ–∏–ª–∏–∞–ª—å–Ω–∞—è —Å–µ—Ç—å, VDI, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –ò–ë"/>
</label>
</div>
  <!-- always-visible extra infra questions (was deep-only) -->
<h3 style="margin:14px 0 6px">–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (–¥–æ–ø. –≤–æ–ø—Ä–æ—Å—ã)</h3>
<div class="small">–ù–∞—Ç–∏–≤–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –æ—Ü–µ–Ω–∫–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö.</div>
<div class="row" style="margin-top:10px">
<label>–í–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è
          
<input id="virt" type="hidden" value=""/>
<div class="virt-wrapper">
<label class="virt-item"><input type="checkbox" value="VMware"/> VMware</label>
<label class="virt-item"><input type="checkbox" value="Hyper-V"/> Hyper‚ÄëV</label>
<label class="virt-item"><input type="checkbox" value="KVM/Proxmox"/> KVM / Proxmox</label>
<label class="virt-item"><input type="checkbox" value="–î—Ä—É–≥–∞—è"/> –î—Ä—É–≥–∞—è</label>
<label class="virt-item"><input type="checkbox" value="–ù–µ—Ç"/> –ù–µ—Ç</label>
</div>
<div class="virt-hint">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤.</div>
</label>
<label>–ú–æ–¥–µ–ª—å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
          <select id="hostingModel">
<option value="">‚Äî</option>
<option>On‚Äëprem</option>
<option>–ì–∏–±—Ä–∏–¥</option>
<option>–ü—É–±–ª–∏—á–Ω–æ–µ –æ–±–ª–∞–∫–æ</option>
</select>
</label>
</div>
<div class="row" style="margin-top:10px">
<label>–î–æ–º–µ–Ω—ã AD / –∫–∞—Ç–∞–ª–æ–≥–æ–≤ (–∫–æ–ª-–≤–æ)
          <input id="adDomains" min="0" step="1" type="number" value="0"/>
</label>
<label>–°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è —Å–µ—Ç–∏
          <select id="netSeg">
<option value="">‚Äî</option>
<option>Prod/Test/Dev –†–∞–∑–¥–µ–ª–µ–Ω—ã</option>
<option>–ï—Å—Ç—å —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è (—á–∞—Å—Ç–∏—á–Ω–æ)</option>
<option>–ù–µ—Ç</option>
</select>
</label>
</div>
<div class="row" style="margin-top:10px">
<label>–¢–µ—Ä–º–∏–Ω–∞–ª—å–Ω—ã–µ —Ñ–µ—Ä–º—ã / RDS / VDI farms
          <select id="terminalFarms">
<option value="">‚Äî</option>
<option>–î–∞</option>
<option>–ù–µ—Ç</option>
</select>
</label>
<label>–í–æ–∑—Ä–∞—Å—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∂–µ–ª–µ–∑–∞
          <select id="hwAge">
<option value="">‚Äî</option>
<option>–¥–æ 3 –ª–µ—Ç</option>
<option>3‚Äì5 –ª–µ—Ç</option>
<option>5+ –ª–µ—Ç</option>
</select>
</label>
</div>
<div class="row" style="margin-top:10px">
<label>–†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤
          <select id="redundancy">
<option value="">‚Äî</option>
<option>–ï—Å—Ç—å</option>
<option>–ß–∞—Å—Ç–∏—á–Ω–æ</option>
<option>–ù–µ—Ç</option>
</select>
</label>
</div>
<div class="hr"></div>
</div>
<!-- /passportExtra -->
</div>

<div class="card" id="cardMaturity">
<h2>2) –ó—Ä–µ–ª–æ—Å—Ç—å –∏ —Ä–∏—Å–∫–∏ (–¥–ª—è –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏)</h2>
<div class="small">–ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ –∏–Ω—Ç–µ—Ä–≤—å—é. –ò–Ω–¥–µ–∫—Å—ã —Å—á–∏—Ç–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–≤ —à–∞–ø–∫–µ).</div>
<h3>2.1 –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∑—Ä–µ–ª–æ—Å—Ç—å</h3>
<div class="table-wrap">
<table>
<thead><tr><th>–ö—Ä–∏—Ç–µ—Ä–∏–π</th><th style="width:170px">–ë–∞–ª–ª (0‚Äì2)</th><th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th></tr></thead>
<tbody id="techTbody"></tbody>
</table>
</div>
<h3>2.2 –ü—Ä–æ—Ü–µ—Å—Å–Ω–∞—è –∑—Ä–µ–ª–æ—Å—Ç—å</h3>
<div class="table-wrap">
<table>
<thead><tr><th>–ö—Ä–∏—Ç–µ—Ä–∏–π</th><th style="width:170px">–ë–∞–ª–ª (0‚Äì2)</th><th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th></tr></thead>
<tbody id="procTbody"></tbody>
</table>
</div>
<h3>2.3 –†–∏—Å–∫-–ø—Ä–æ—Ñ–∏–ª—å</h3>
<div class="table-wrap">
<table>
<thead><tr><th>–§–∞–∫—Ç–æ—Ä</th><th style="width:170px">–ï—Å—Ç—å? (0/1)</th><th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th></tr></thead>
<tbody id="riskTbody"></tbody>
</table>
</div>
<div class="hr"></div>
</div>
<div class="card" id="cardFinance">
<h2>3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞ (–¥–ª—è ROI / Cost of Inaction)</h2>
<div class="small">–í–∫–ª—é—á–∞–µ—Ç –ª–∏—Ü–µ–Ω–∑–∏–∏, —Ä—É—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, –ø—Ä–æ—Å—Ç–æ–∏ –∏ –≤–ª–∏—è–Ω–∏–µ –∂–µ–ª–µ–∑–∞.</div>
<div class="small">–≠—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã–π –±–ª–æ–∫ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ ROI –∏ –≤ —Ä–∞—Å—á–µ—Ç–∞—Ö –ø–æ—Ç–µ—Ä—å.</div>
<div class="row" style="margin-top:10px">
<label>–°—Ä–µ–¥–Ω—è—è –∑–∞—Ä–ø–ª–∞—Ç–∞ IT (‚ÇΩ/–º–µ—Å) GROSS
          <input id="salary" min="0" step="1000" type="number" value="0"/>
</label>
<label>–ö–æ–ª-–≤–æ IT —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
          <input id="itCount" min="0" step="1" type="number" value="0"/>
</label>
</div>
<div class="row" style="margin-top:10px">
<label>% —Ä—É—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
          <input id="manualPct" max="100" min="0" step="1" type="number" value="0"/>
</label>
<label>–ë—é–¥–∂–µ—Ç –Ω–∞ –ª–∏—Ü–µ–Ω–∑–∏–∏ (‚ÇΩ/–≥–æ–¥)
          <input id="licBudget" min="0" step="10000" type="number" value="0"/>
</label>
</div>
<div class="row" style="margin-top:10px">
<label>% –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ –ü–û (–æ—Ü–µ–Ω–∫–∞)
          <input id="unusedPct" max="100" min="0" step="1" type="number" value="0"/>
</label>
<label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Ä–∞—Å—á–µ—Ç—É
          <input id="finNote" placeholder="–û—Ç–∫—É–¥–∞ —Ü–∏—Ñ—Ä—ã / –∫—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª"/>
</label>
<div data-mode="deep">
<div class="row" style="margin-top:10px">
<label>% –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö VM / –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ (–æ—Ü–µ–Ω–∫–∞)
          <input id="vmUnusedPct" max="100" min="0" step="1" type="number" value="0"/>
</label>
<label>–ù–µ–∑–∞–º–µ–Ω–∏–º—ã–µ –ò–¢-—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ (bus-factor ‚â§2)
          <select id="keyPeopleRisk">
<option value="">‚Äî</option>
<option>–î–∞</option>
<option>–ù–µ—Ç</option>
</select>
</label>
</div>
<div class="row" style="margin-top:10px">
<label>–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ –∑–Ω–∞–Ω–∏–π (0‚Äì2)
          <select id="docScore">
<option value="0">0 ‚Äî –Ω–µ—Ç</option>
<option value="1">1 ‚Äî —á–∞—Å—Ç–∏—á–Ω–æ</option>
<option value="2">2 ‚Äî –µ—Å—Ç—å</option>
</select>
</label>
<label>% —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –û–°/–ü–û (–æ—Ü–µ–Ω–∫–∞)
          <input id="obsoletePct" max="100" min="0" step="1" type="number" value="0"/>
</label>
</div>
</div>
</div>
<div data-mode="deep">
<h3 style="margin:14px 0 6px">–ñ–µ–ª–µ–∑–æ –∏ –ø—Ä–æ—Å—Ç–æ–∏ (–¥–ª—è CoI)</h3>
<div class="small">–î–æ–ø–æ–ª–Ω—è–µ—Ç Cost of Inaction: –ø—Ä–æ—Å—Ç–æ–∏ –∏ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∂–µ–ª–µ–∑–∞.</div>
<div class="row" style="margin-top:6px">
<div class="hint" id="companyMeta" style="flex:1;color:#6b7280;font-size:12px">‚Äî</div>
<button class="btn ghost" id="btnCompanyAll" style="display:none">–í—Å–µ –∑–∞–ø–∏—Å–∏</button>
</div>
</div>
<div class="row" style="margin-top:10px">
<label>–ë—é–¥–∂–µ—Ç –Ω–∞ –∂–µ–ª–µ–∑–æ (‚ÇΩ/–≥–æ–¥) <span class="small" style="opacity:.8">(–æ—Ü–µ–Ω–æ—á–Ω–æ)</span>
<input id="hwBudget" min="0" step="10000" type="number" value="0"/>
</label>
<label>–ê–º–æ—Ä—Ç–∏–∑–∞—Ü–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∂–µ–ª–µ–∑–∞ (–ø–ª–∞–Ω –µ—Å—Ç—å?)
          <select id="hwPlan">
<option value="">‚Äî</option>
<option>–î–∞</option>
<option>–ß–∞—Å—Ç–∏—á–Ω–æ</option>
<option>–ù–µ—Ç</option>
</select>
</label>
</div>
<div class="row" style="margin-top:10px">
<label>–ü—Ä–æ—Å—Ç–æ–∏/–∏–Ω—Ü–∏–¥–µ–Ω—Ç—ã: —á–∞—Å–æ–≤ –ø—Ä–æ—Å—Ç–æ—è –≤ –≥–æ–¥ <span class="small" style="opacity:.8">(–æ—Ü–µ–Ω–æ—á–Ω–æ)</span>
<input id="downtimeHours" min="0" step="1" type="number" value="0"/>
</label>
<label>–°—Ç–æ–∏–º–æ—Å—Ç—å —á–∞—Å–∞ –ø—Ä–æ—Å—Ç–æ—è (‚ÇΩ/—á–∞—Å) <span class="small" style="opacity:.8">(–¥–ª—è –±–∏–∑–Ω–µ—Å–∞)</span>
<input id="downtimeCost" min="0" step="1000" type="number" value="0"/>
</label>
</div>
<div class="row" style="margin-top:10px">
<label>–ò–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤ –≤ –º–µ—Å—è—Ü (–≤ —Å—Ä–µ–¥–Ω–µ–º) <span class="small" style="opacity:.8">(–æ—Ü–µ–Ω–æ—á–Ω–æ)</span>
<input id="incidentsPerMonth" min="0" step="1" type="number" value="0"/>
</label>
<label>–°–µ—Ä–≤–∏—Å-–¥–µ—Å–∫ –µ—Å—Ç—å?
          <select id="serviceDesk">
<option value="">‚Äî</option>
<option>–î–∞</option>
<option>–ù–µ—Ç</option>
</select>
</label>
</div>
</div>
<div class="hr"></div>
<div class="hr"></div>
</div>
<div class="card" id="cardReq">
<h2>4) –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø–∏–ª–æ—Ç—É ‚Äî —Ä–µ–µ—Å—Ç—Ä</h2>
<div class="small">–ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –∏–Ω—Ç–µ—Ä–≤—å—é/–¥–µ–º–æ. –≠—Ç–æ –æ—Å–Ω–æ–≤–∞ –¥–ª—è –ü–°–ò –∏ –ø—Ä–∏–µ–º–∫–∏. <b>–°—Ç–∞—Ç—É—Å —É–±—Ä–∞–Ω</b> ‚Äî –¥–æ–∫—É–º–µ–Ω—Ç —Å—Ç–∞—Ç–∏—á–Ω—ã–π.</div>
<div class="btns" style="margin:10px 0 6px">
<button class="btn ghost" id="btnAddReq">+ –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ</button>
<button class="btn ghost" id="btnClearReq">–û—á–∏—Å—Ç–∏—Ç—å</button>
</div>
<div class="table-wrap">
<table>
<thead>
<tr>
<th style="width:54px">‚Ññ</th>
<th style="min-width:220px">–ë–∏–∑–Ω–µ—Å –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å</th>
<th style="min-width:340px">–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞</th>
<th style="width:160px">–¢–∏–ø</th>
<th style="width:140px">–û–±—è–∑–∞—Ç.</th>
<th style="width:220px">–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å</th>
<th style="min-width:240px">–ú–µ—Ç—Ä–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏</th>
</tr>
</thead>
<tbody id="reqTbody"></tbody>
</table>
</div>
<div class="hr"></div>
<div class="hr"></div>
</div>
<div class="card" id="cardPSI">
<h2>5) –ü–°–ò ‚Äî —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø—Ä–∏–µ–º–∫–∞</h2>
<div class="small">–ü–æ –∏—Ç–æ–≥–∞–º –ø–∏–ª–æ—Ç–∞: —Ñ–∏–∫—Å–∏—Ä—É–µ–º ¬´–æ–∂–∏–¥–∞–Ω–∏–µ ‚Üí —Ñ–∞–∫—Ç ‚Üí —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ¬ª –∏ —Ä–µ—à–µ–Ω–∏–µ ¬´–ø—Ä–∏–Ω—è–ª–∏/–Ω–µ –ø—Ä–∏–Ω—è–ª–∏¬ª.</div>
<div class="btns" style="margin:10px 0 6px">
<button class="btn ghost" id="btnAddPsi">+ –î–æ–±–∞–≤–∏—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π</button>
<button class="btn ghost" id="btnClearPsi">–û—á–∏—Å—Ç–∏—Ç—å</button>
</div>
<div class="table-wrap">
<table id="psiTable">
<thead>
<tr>
<th style="width:54px">‚Ññ</th>
<th style="min-width:260px">–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è</th>
<th style="min-width:260px">–°—Ü–µ–Ω–∞—Ä–∏–π –ø—Ä–æ–≤–µ—Ä–∫–∏</th>
<th style="min-width:260px">–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</th>
<th style="min-width:260px">–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</th>
<th style="width:170px">–°–æ–æ—Ç–≤. (–î–∞/–ù–µ—Ç)</th>
<th style="width:190px">–ü—Ä–∏–Ω—è–ª–∏? (–î–∞/–ù–µ—Ç)</th>
<th style="min-width:260px">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
</tr>
</thead>
<tbody id="psiTbody"></tbody>
</table>
</div>
<div class="hr"></div>
<div class="card pad" id="prodReqCard" style="margin-top:12px">
<h2>6) –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø—Ä–æ–¥—É–∫—Ç—É</h2>
<div class="small">–§–∏–∫—Å–∏—Ä—É–µ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø—Ä–æ–¥—É–∫—Ç—É (–¥–ª—è roadmap/–æ—Ü–µ–Ω–∫–∏). –ò–Ω–¥–µ–∫—Å ‚Äî –ø–æ ¬´–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏¬ª.</div>
<div class="btns" style="margin:10px 0 6px">
<button class="btn ghost" id="btnAddProdReq">+ –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ</button>
<button class="btn ghost" id="btnClearProdReq">–û—á–∏—Å—Ç–∏—Ç—å</button>
</div>
<div class="table-wrap">
<table>
<thead>
<tr>
<th style="width:54px">‚Ññ</th>
<th style="min-width:260px">–ë–∏–∑–Ω–µ—Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ</th>
<th style="min-width:340px">–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ</th>
<th style="width:160px">–¢–∏–ø</th>
<th style="width:140px">–û–±—è–∑–∞—Ç.</th>
<th style="width:220px">–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å</th>
</tr>
</thead>
<tbody id="prodReqTbody"></tbody>
</table>
</div>
</div>
<div id="projectRisksWrap">
<h2>5.1) –†–∏—Å–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ (–∫–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞)</h2>
<div class="small">–†–∞–∑–¥–µ–ª –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è. –í –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π –≤–µ—Ä—Å–∏–∏ PDF —Å–∫—Ä—ã—Ç.</div>
<div class="table-wrap" style="margin-top:10px">
<table>
<thead>
<tr>
<th style="width:220px">–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä</th>
<th>–£—Å–ª–æ–≤–∏–µ</th>
<th style="width:180px">–°—Ç–∞—Ç—É—Å</th>
<th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
</tr>
</thead>
<tbody id="projectRisks"></tbody>
</table>
</div>
<div class="row" style="margin-top:10px">
<label>–£—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ (–∏—Ç–æ–≥)
            <input id="riskLevelText" readonly=""/>
</label>
<label>–ß—Ç–æ –º–æ–∂–µ—Ç –ø–æ–π—Ç–∏ –Ω–µ —Ç–∞–∫ (–∫—Ä–∞—Ç–∫–æ)
            <input id="riskNotes" placeholder="–ù–∞–ø—Ä.: –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º, –Ω–µ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞, —Ä–∞–∑–º—ã—Ç—ã–π –ø–µ—Ä–∏–º–µ—Ç—Ä..."/>
</label>
</div>
<div class="hr"></div>
</div>
<div class="hr"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
const TECH = [
  {label:"T1. –ï—Å—Ç—å –ª–∏ –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–º –ü–û?", mode:"both"},
  {label:"T2. –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω –ª–∏ —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –æ–± –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–µ (–±–µ–∑ —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞)?", mode:"both"},
  {label:"T3. –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ –ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –¥—É–±–ª–µ–π —É—Å—Ç—Ä–æ–π—Å—Ç–≤?", mode:"both"},
  {label:"T4. –ï—Å—Ç—å –ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –≤ —Å–µ—Ç–∏?", mode:"both"},
  {label:"T5. –û–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ª–∏ –¥–∞–Ω–Ω—ã–µ –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –∏ –ü–û –±–µ–∑ —Ä—É—á–Ω–æ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞?", mode:"both"},
  {label:"T6. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ª–∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –ü–û?", mode:"deep"},
  {label:"T7. –ï—Å—Ç—å –ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—è–≤–ª–µ–Ω–∏–µ –Ω–µ—Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–æ–≥–æ –∏–ª–∏ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω–æ–≥–æ –ü–û?", mode:"deep"},
  {label:"T8. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏ –¥–∞–Ω–Ω—ã–µ –æ–± –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏ –≤ –¥—Ä—É–≥–∏—Ö —Å–∏—Å—Ç–µ–º–∞—Ö (ITSM, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –ª–∏—Ü–µ–Ω–∑–∏—Ä–æ–≤–∞–Ω–∏–µ)?", mode:"deep"},
  {label:"T9. –û—Ö–≤–∞—á–µ–Ω—ã –ª–∏ —Å–±–æ—Ä–æ–º –¥–∞–Ω–Ω—ã—Ö –≤—Å–µ —Å–µ–≥–º–µ–Ω—Ç—ã –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (VDI, —Ñ–∏–ª–∏–∞–ª—ã, –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç—É—Ä—ã)?", mode:"deep"},
  {label:"T10. –í–æ–∑–º–æ–∂–Ω–æ –ª–∏ —Ä–∞—Å—à–∏—Ä—è—Ç—å –º–æ–¥–µ–ª—å —Å–æ–±–∏—Ä–∞–µ–º—ã—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –±–µ–∑ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏?", mode:"deep"}
];

const PROC = [
  {label:"P1. –§–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å —É—á–µ—Ç–∞ –ò–¢-–∞–∫—Ç–∏–≤–æ–≤?", mode:"both"},
  {label:"P2. –ù–∞–∑–Ω–∞—á–µ–Ω –ª–∏ –≤–ª–∞–¥–µ–ª–µ—Ü –ø—Ä–æ—Ü–µ—Å—Å–∞ —É—á–µ—Ç–∞ –∞–∫—Ç–∏–≤–æ–≤?", mode:"both"},
  {label:"P3. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏ –¥–∞–Ω–Ω—ã–µ –æ–± –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏?", mode:"both"},
  {label:"P4. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏ –¥–∞–Ω–Ω—ã–µ –æ–± –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞–º–∏?", mode:"both"},
  {label:"P5. –ï—Å—Ç—å –ª–∏ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç –∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –∏ –ü–û?", mode:"both"},
  {label:"P6. –ü—Ä–æ–≤–æ–¥–∏—Ç—Å—è –ª–∏ —Ä–µ–≥—É–ª—è—Ä–Ω–∞—è —Å–≤–µ—Ä–∫–∞ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å —É—á–µ—Ç–Ω–æ–π?", mode:"deep"},
  {label:"P7. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏ –¥–∞–Ω–Ω—ã–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–∫—É–ø–æ–∫ –ü–û?", mode:"deep"},
  {label:"P8. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã—Ö —Ä–∏—Å–∫–æ–≤?", mode:"deep"},
  {label:"P9. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–µ—â–µ–Ω–Ω–æ–≥–æ –ü–û?", mode:"deep"},
  {label:"P10. –ï—Å—Ç—å –ª–∏ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç —Ä–µ–∞–∫—Ü–∏–∏ –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ/–Ω–µ—É—á—Ç–µ–Ω–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞?", mode:"deep"}
];

const RISK = [
  {label:"–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–∞—è (–º–Ω–æ–≥–æ —Ñ–∏–ª–∏–∞–ª–æ–≤/–ø–ª–æ—â–∞–¥–æ–∫)", mode:"both"},
  {label:"–ü–∞—Ä–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –±—ã—Å—Ç—Ä–æ —Ä–∞—Å—Ç–µ—Ç/–º–µ–Ω—è–µ—Ç—Å—è", mode:"both"},
  {label:"–ú–Ω–æ–≥–æ —Ä—É—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —É—á–µ—Ç–µ –∞–∫—Ç–∏–≤–æ–≤", mode:"both"},
  {label:"–ï—Å—Ç—å —Ä–∏—Å–∫ –Ω–µ—É—á—Ç–µ–Ω–Ω—ã—Ö —É—Å—Ç–∞–Ω–æ–≤–æ–∫ –ü–û", mode:"both"},
  {label:"–ï—Å—Ç—å —á–∞—Å—Ç—ã–µ –∏–Ω—Ü–∏–¥–µ–Ω—Ç—ã/–ø—Ä–æ—Å—Ç–æ–∏ (–ø–æ –æ—â—É—â–µ–Ω–∏—è–º –±–∏–∑–Ω–µ—Å–∞)", mode:"both"},
  {label:"–ë—ã–ª–∏ –≤–Ω–µ—à–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –≥–æ–¥–∞", mode:"deep"},
  {label:"–ü–ª–∞–Ω–∏—Ä—É—é—Ç—Å—è –∫—Ä—É–ø–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≤ 12 –º–µ—Å—è—Ü–µ–≤ (–º–∏–≥—Ä–∞—Ü–∏–∏/—Å–ª–∏—è–Ω–∏—è)", mode:"deep"},
  {label:"–í—ã—Å–æ–∫–∞—è —Ç–µ–∫—É—á–µ—Å—Ç—å –ò–¢-–ø–µ—Ä—Å–æ–Ω–∞–ª–∞/—Å–º–µ–Ω–∞ –ø–æ–¥—Ä—è–¥—á–∏–∫–æ–≤", mode:"deep"}
];

const FEAS_OPTIONS = [
  { label: "‚Äî", score: null },
  { label: "–ü–æ–ª–Ω–æ—Å—Ç—å—é", score: 1.00 },
  { label: "–ß–∞—Å—Ç–∏—á–Ω–æ", score: 0.60 },
  // Backward-compat: older sheets stored just "–ù–µ—Ç"
  { label: "–ù–µ—Ç", score: 0.00 },
  { label: "–ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏", score: 0.00 },
  { label: "–ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏", score: 0.00 },
  // Backward-compat casing variants
  { label: "–•–∞—Ä–¥ –∫–æ–¥ (—Å–∫–æ—Ä–æ)", score: 0.70 },
  { label: "–•–∞—Ä–¥ –∫–æ–¥ (–°–∫–æ—Ä–æ)", score: 0.70 },
  { label: "–•–∞—Ä–¥ –∫–æ–¥ (–Ω–µ —Å–∫–æ—Ä–æ)", score: 0.30 },
  { label: "–¢—Ä–µ–±—É–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç", score: 0.50 },
];

function fmtMoney(n){ if(!isFinite(n)) return "‚Äî"; return Math.round(n).toLocaleString("ru-RU")+" ‚ÇΩ"; }
function clampInt(v,min,max){ v=parseInt(v,10); if(isNaN(v)) v=min; return Math.min(max,Math.max(min,v)); }
function clamp(v,min,max){ v=+v; if(!isFinite(v)) return min; return Math.min(max, Math.max(min, v)); }
function debounce(fn,ms){ let t; return (...a)=>{clearTimeout(t); t=setTimeout(()=>fn(...a),ms)}; }
const avg = arr => arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0;


/* ===================== Benchmark engine (Iteration 1 + 2) ===================== */

// Benchmarks are *synthetic but realistic* ranges (P25‚ÄìP75) by Industry + Size bucket.
// NOTE: All values are percentages unless stated otherwise.
const BENCH = {
  "–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å": {
    "1-2k":   { manualPct:{m:34,p25:26,p75:44}, unusedPct:{m:18,p25:12,p75:27}, vmUnusedPct:{m:22,p25:15,p75:32},
              incidentsPerMonth:{m:14,p25:8,p75:22}, downtimeHours:{m:26,p25:14,p75:40}, downtimeCost:{m:350000,p25:120000,p75:650000},
              obsoletePct:{m:32,p25:22,p75:44}, keyPeopleRisk:{m:1,p25:1,p75:2}, docScore:{m:0.8,p25:0,p75:1} },
    "2-10k":  { manualPct:{m:38,p25:30,p75:50}, unusedPct:{m:20,p25:13,p75:30}, vmUnusedPct:{m:26,p25:18,p75:36},
              incidentsPerMonth:{m:22,p25:14,p75:35}, downtimeHours:{m:42,p25:24,p75:70}, downtimeCost:{m:550000,p25:220000,p75:1000000},
              obsoletePct:{m:35,p25:25,p75:48}, keyPeopleRisk:{m:1,p25:1,p75:2}, docScore:{m:0.7,p25:0,p75:1} },
    "10k+":   { manualPct:{m:42,p25:34,p75:54}, unusedPct:{m:22,p25:15,p75:34}, vmUnusedPct:{m:28,p25:20,p75:38},
              incidentsPerMonth:{m:30,p25:18,p75:45}, downtimeHours:{m:60,p25:36,p75:95}, downtimeCost:{m:900000,p25:350000,p75:1700000},
              obsoletePct:{m:30,p25:20,p75:42}, keyPeopleRisk:{m:1,p25:1,p75:2}, docScore:{m:0.9,p25:0,p75:2} }
  },
  "–§–∏–Ω–∞–Ω—Å—ã": {
    "1-2k":   { manualPct:{m:28,p25:20,p75:38}, unusedPct:{m:16,p25:10,p75:24}, vmUnusedPct:{m:20,p25:12,p75:30},
              incidentsPerMonth:{m:10,p25:6,p75:16}, downtimeHours:{m:18,p25:10,p75:28}, downtimeCost:{m:650000,p25:250000,p75:1300000},
              obsoletePct:{m:22,p25:14,p75:32}, keyPeopleRisk:{m:1,p25:1,p75:2}, docScore:{m:1.2,p25:1,p75:2} },
    "2-10k":  { manualPct:{m:32,p25:24,p75:42}, unusedPct:{m:18,p25:12,p75:27}, vmUnusedPct:{m:22,p25:14,p75:32},
              incidentsPerMonth:{m:16,p25:10,p75:26}, downtimeHours:{m:30,p25:18,p75:48}, downtimeCost:{m:1100000,p25:450000,p75:2200000},
              obsoletePct:{m:24,p25:16,p75:36}, keyPeopleRisk:{m:1,p25:1,p75:2}, docScore:{m:1.3,p25:1,p75:2} },
    "10k+":   { manualPct:{m:34,p25:26,p75:44}, unusedPct:{m:20,p25:13,p75:30}, vmUnusedPct:{m:24,p25:16,p75:34},
              incidentsPerMonth:{m:22,p25:14,p75:34}, downtimeHours:{m:44,p25:28,p75:70}, downtimeCost:{m:1800000,p25:800000,p75:3500000},
              obsoletePct:{m:20,p25:12,p75:30}, keyPeopleRisk:{m:1,p25:1,p75:2}, docScore:{m:1.5,p25:1,p75:2} }
  },
  "–¢–µ–ª–µ–∫–æ–º": {
    "1-2k":   { manualPct:{m:32,p25:24,p75:42}, unusedPct:{m:17,p25:11,p75:26}, vmUnusedPct:{m:24,p25:16,p75:34},
              incidentsPerMonth:{m:18,p25:10,p75:28}, downtimeHours:{m:34,p25:20,p75:52}, downtimeCost:{m:500000,p25:200000,p75:950000},
              obsoletePct:{m:28,p25:18,p75:40}, keyPeopleRisk:{m:1,p25:1,p75:2}, docScore:{m:0.9,p25:0,p75:2} },
    "2-10k":  { manualPct:{m:36,p25:28,p75:48}, unusedPct:{m:19,p25:12,p75:29}, vmUnusedPct:{m:28,p25:20,p75:38},
              incidentsPerMonth:{m:28,p25:16,p75:42}, downtimeHours:{m:55,p25:34,p75:85}, downtimeCost:{m:850000,p25:350000,p75:1600000},
              obsoletePct:{m:30,p25:20,p75:42}, keyPeopleRisk:{m:1,p25:1,p75:2}, docScore:{m:0.8,p25:0,p75:1} },
    "10k+":   { manualPct:{m:38,p25:30,p75:50}, unusedPct:{m:20,p25:13,p75:31}, vmUnusedPct:{m:30,p25:22,p75:40},
              incidentsPerMonth:{m:36,p25:22,p75:55}, downtimeHours:{m:80,p25:50,p75:120}, downtimeCost:{m:1400000,p25:650000,p75:2600000},
              obsoletePct:{m:26,p25:16,p75:38}, keyPeopleRisk:{m:1,p25:1,p75:2}, docScore:{m:1.0,p25:0,p75:2} }
  },
  "–†–∏—Ç–µ–π–ª": {
    "1-2k":   { manualPct:{m:36,p25:28,p75:46}, unusedPct:{m:19,p25:12,p75:28}, vmUnusedPct:{m:20,p25:12,p75:30},
              incidentsPerMonth:{m:16,p25:10,p75:26}, downtimeHours:{m:28,p25:16,p75:44}, downtimeCost:{m:250000,p25:90000,p75:500000},
              obsoletePct:{m:34,p25:24,p75:46}, keyPeopleRisk:{m:2,p25:1,p75:2}, docScore:{m:0.6,p25:0,p75:1} },
    "2-10k":  { manualPct:{m:40,p25:32,p75:52}, unusedPct:{m:22,p25:14,p75:34}, vmUnusedPct:{m:24,p25:16,p75:34},
              incidentsPerMonth:{m:24,p25:14,p75:38}, downtimeHours:{m:46,p25:28,p75:72}, downtimeCost:{m:420000,p25:160000,p75:850000},
              obsoletePct:{m:36,p25:26,p75:50}, keyPeopleRisk:{m:2,p25:1,p75:2}, docScore:{m:0.6,p25:0,p75:1} },
    "10k+":   { manualPct:{m:42,p25:34,p75:54}, unusedPct:{m:24,p25:16,p75:36}, vmUnusedPct:{m:26,p25:18,p75:36},
              incidentsPerMonth:{m:32,p25:20,p75:50}, downtimeHours:{m:70,p25:44,p75:110}, downtimeCost:{m:650000,p25:260000,p75:1300000},
              obsoletePct:{m:32,p25:22,p75:46}, keyPeopleRisk:{m:2,p25:1,p75:2}, docScore:{m:0.7,p25:0,p75:2} }
  },
  "–ì–æ—Å—Å–µ–∫—Ç–æ—Ä": {
    "1-2k":   { manualPct:{m:40,p25:32,p75:52}, unusedPct:{m:14,p25:9,p75:22}, vmUnusedPct:{m:18,p25:10,p75:28},
              incidentsPerMonth:{m:12,p25:7,p75:20}, downtimeHours:{m:22,p25:12,p75:36}, downtimeCost:{m:120000,p25:50000,p75:260000},
              obsoletePct:{m:42,p25:32,p75:55}, keyPeopleRisk:{m:2,p25:1,p75:2}, docScore:{m:0.7,p25:0,p75:1} },
    "2-10k":  { manualPct:{m:44,p25:36,p75:56}, unusedPct:{m:16,p25:10,p75:25}, vmUnusedPct:{m:20,p25:12,p75:30},
              incidentsPerMonth:{m:18,p25:10,p75:30}, downtimeHours:{m:36,p25:20,p75:60}, downtimeCost:{m:180000,p25:80000,p75:400000},
              obsoletePct:{m:45,p25:35,p75:60}, keyPeopleRisk:{m:2,p25:1,p75:2}, docScore:{m:0.7,p25:0,p75:1} },
    "10k+":   { manualPct:{m:46,p25:38,p75:58}, unusedPct:{m:18,p25:12,p75:28}, vmUnusedPct:{m:22,p25:14,p75:32},
              incidentsPerMonth:{m:24,p25:14,p75:40}, downtimeHours:{m:55,p25:34,p75:90}, downtimeCost:{m:260000,p25:120000,p75:550000},
              obsoletePct:{m:40,p25:30,p75:55}, keyPeopleRisk:{m:2,p25:1,p75:2}, docScore:{m:0.8,p25:0,p75:2} }
  },
  "–ò–¢/–∏–Ω—Ç–µ–≥—Ä–∞—Ç–æ—Ä": {
    "1-2k":   { manualPct:{m:30,p25:22,p75:40}, unusedPct:{m:21,p25:13,p75:32}, vmUnusedPct:{m:26,p25:18,p75:36},
              incidentsPerMonth:{m:14,p25:8,p75:22}, downtimeHours:{m:20,p25:12,p75:32}, downtimeCost:{m:220000,p25:90000,p75:500000},
              obsoletePct:{m:24,p25:16,p75:34}, keyPeopleRisk:{m:1,p25:1,p75:2}, docScore:{m:0.9,p25:0,p75:2} },
    "2-10k":  { manualPct:{m:34,p25:26,p75:46}, unusedPct:{m:24,p25:16,p75:36}, vmUnusedPct:{m:30,p25:22,p75:40},
              incidentsPerMonth:{m:20,p25:12,p75:32}, downtimeHours:{m:32,p25:20,p75:50}, downtimeCost:{m:350000,p25:150000,p75:800000},
              obsoletePct:{m:26,p25:18,p75:38}, keyPeopleRisk:{m:1,p25:1,p75:2}, docScore:{m:1.0,p25:0,p75:2} },
    "10k+":   { manualPct:{m:36,p25:28,p75:48}, unusedPct:{m:26,p25:18,p75:38}, vmUnusedPct:{m:32,p25:24,p75:42},
              incidentsPerMonth:{m:26,p25:16,p75:40}, downtimeHours:{m:44,p25:28,p75:70}, downtimeCost:{m:600000,p25:250000,p75:1300000},
              obsoletePct:{m:22,p25:14,p75:34}, keyPeopleRisk:{m:1,p25:1,p75:2}, docScore:{m:1.1,p25:0,p75:2} }
  }
};

function sizeBucket(totalEndpoints){
  const n = +totalEndpoints || 0;
  if(n <= 2000) return "1-2k";
  if(n <= 10000) return "2-10k";
  return "10k+";
}

function getProfile(){
  const industry = (document.getElementById("industry")?.value || "").trim() || "–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å";
  const workplaces = (+document.getElementById("workplaces")?.value || 0);
  const servers = (+document.getElementById("servers")?.value || 0);
  const total = workplaces + servers;
  const bucket = sizeBucket(total);
  const vdi = (document.getElementById("vdi")?.value || "").trim();
  const closed = (document.getElementById("closed")?.value || "").trim();
  const branches = (+document.getElementById("branches")?.value || 0);
  return {industry, bucket, total, workplaces, servers, vdi, closed, branches};
}


const BENCH_MATURITY = {
  "–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å": {"1-2k":{techMaturityPct:{m:52,p25:40,p75:64}, procMaturityPct:{m:46,p25:34,p75:58}, riskProb:{m:0.32,p25:0.22,p75:0.44}, feasibilityPct:{m:62,p25:50,p75:74}, changeMaturityPct:{m:42,p25:30,p75:55}, scalabilityPct:{m:50,p25:38,p75:62}, aiReadinessPct:{m:44,p25:32,p75:58}},
                     "2-10k":{techMaturityPct:{m:56,p25:44,p75:68}, procMaturityPct:{m:50,p25:38,p75:62}, riskProb:{m:0.36,p25:0.25,p75:0.48}, feasibilityPct:{m:60,p25:48,p75:72}, changeMaturityPct:{m:46,p25:34,p75:58}, scalabilityPct:{m:54,p25:42,p75:66}, aiReadinessPct:{m:46,p25:34,p75:60}},
                     "10k+":{techMaturityPct:{m:60,p25:48,p75:72}, procMaturityPct:{m:54,p25:42,p75:66}, riskProb:{m:0.34,p25:0.24,p75:0.46}, feasibilityPct:{m:58,p25:46,p75:70}, changeMaturityPct:{m:50,p25:38,p75:62}, scalabilityPct:{m:58,p25:46,p75:70}, aiReadinessPct:{m:50,p25:38,p75:64}} },
  "–§–∏–Ω–∞–Ω—Å—ã": {"1-2k":{techMaturityPct:{m:58,p25:46,p75:70}, procMaturityPct:{m:56,p25:44,p75:68}, riskProb:{m:0.38,p25:0.28,p75:0.52}, feasibilityPct:{m:64,p25:52,p75:76}, changeMaturityPct:{m:52,p25:40,p75:64}, scalabilityPct:{m:56,p25:44,p75:68}, aiReadinessPct:{m:52,p25:40,p75:66}},
             "2-10k":{techMaturityPct:{m:62,p25:50,p75:74}, procMaturityPct:{m:60,p25:48,p75:72}, riskProb:{m:0.40,p25:0.30,p75:0.54}, feasibilityPct:{m:62,p25:50,p75:74}, changeMaturityPct:{m:56,p25:44,p75:68}, scalabilityPct:{m:60,p25:48,p75:72}, aiReadinessPct:{m:56,p25:44,p75:70}},
             "10k+":{techMaturityPct:{m:66,p25:54,p75:78}, procMaturityPct:{m:64,p25:52,p75:76}, riskProb:{m:0.36,p25:0.26,p75:0.50}, feasibilityPct:{m:60,p25:48,p75:72}, changeMaturityPct:{m:60,p25:48,p75:72}, scalabilityPct:{m:62,p25:50,p75:74}, aiReadinessPct:{m:60,p25:48,p75:74}} },
  "–¢–µ–ª–µ–∫–æ–º": {"1-2k":{techMaturityPct:{m:56,p25:44,p75:68}, procMaturityPct:{m:50,p25:38,p75:62}, riskProb:{m:0.34,p25:0.24,p75:0.48}, feasibilityPct:{m:60,p25:48,p75:72}, changeMaturityPct:{m:48,p25:36,p75:60}, scalabilityPct:{m:56,p25:44,p75:68}, aiReadinessPct:{m:54,p25:42,p75:68}},
             "2-10k":{techMaturityPct:{m:60,p25:48,p75:72}, procMaturityPct:{m:54,p25:42,p75:66}, riskProb:{m:0.36,p25:0.26,p75:0.50}, feasibilityPct:{m:58,p25:46,p75:70}, changeMaturityPct:{m:52,p25:40,p75:64}, scalabilityPct:{m:60,p25:48,p75:72}, aiReadinessPct:{m:58,p25:46,p75:72}},
             "10k+":{techMaturityPct:{m:64,p25:52,p75:76}, procMaturityPct:{m:58,p25:46,p75:70}, riskProb:{m:0.34,p25:0.24,p75:0.48}, feasibilityPct:{m:56,p25:44,p75:68}, changeMaturityPct:{m:56,p25:44,p75:68}, scalabilityPct:{m:64,p25:52,p75:76}, aiReadinessPct:{m:62,p25:50,p75:76}} },
  "–†–∏—Ç–µ–π–ª": {"1-2k":{techMaturityPct:{m:50,p25:38,p75:62}, procMaturityPct:{m:44,p25:32,p75:56}, riskProb:{m:0.30,p25:0.20,p75:0.42}, feasibilityPct:{m:64,p25:52,p75:76}, changeMaturityPct:{m:40,p25:28,p75:52}, scalabilityPct:{m:52,p25:40,p75:64}, aiReadinessPct:{m:46,p25:34,p75:60}},
           "2-10k":{techMaturityPct:{m:54,p25:42,p75:66}, procMaturityPct:{m:48,p25:36,p75:60}, riskProb:{m:0.32,p25:0.22,p75:0.44}, feasibilityPct:{m:62,p25:50,p75:74}, changeMaturityPct:{m:44,p25:32,p75:56}, scalabilityPct:{m:56,p25:44,p75:68}, aiReadinessPct:{m:50,p25:38,p75:64}},
           "10k+":{techMaturityPct:{m:58,p25:46,p75:70}, procMaturityPct:{m:52,p25:40,p75:64}, riskProb:{m:0.30,p25:0.20,p75:0.42}, feasibilityPct:{m:60,p25:48,p75:72}, changeMaturityPct:{m:48,p25:36,p75:60}, scalabilityPct:{m:60,p25:48,p75:72}, aiReadinessPct:{m:54,p25:42,p75:68}} },
  "–ì–æ—Å—Å–µ–∫—Ç–æ—Ä": {"1-2k":{techMaturityPct:{m:48,p25:36,p75:60}, procMaturityPct:{m:46,p25:34,p75:58}, riskProb:{m:0.42,p25:0.32,p75:0.56}, feasibilityPct:{m:58,p25:46,p75:70}, changeMaturityPct:{m:44,p25:32,p75:56}, scalabilityPct:{m:46,p25:34,p75:58}, aiReadinessPct:{m:38,p25:28,p75:52}},
             "2-10k":{techMaturityPct:{m:52,p25:40,p75:64}, procMaturityPct:{m:50,p25:38,p75:62}, riskProb:{m:0.44,p25:0.34,p75:0.58}, feasibilityPct:{m:56,p25:44,p75:68}, changeMaturityPct:{m:48,p25:36,p75:60}, scalabilityPct:{m:50,p25:38,p75:62}, aiReadinessPct:{m:40,p25:30,p75:54}},
             "10k+":{techMaturityPct:{m:56,p25:44,p75:68}, procMaturityPct:{m:54,p25:42,p75:66}, riskProb:{m:0.40,p25:0.30,p75:0.54}, feasibilityPct:{m:54,p25:42,p75:66}, changeMaturityPct:{m:52,p25:40,p75:64}, scalabilityPct:{m:52,p25:40,p75:64}, aiReadinessPct:{m:44,p25:32,p75:58}} },
  "–ò–¢/–ò–Ω—Ç–µ–≥—Ä–∞—Ç–æ—Ä—ã": {"1-2k":{techMaturityPct:{m:62,p25:50,p75:74}, procMaturityPct:{m:54,p25:42,p75:66}, riskProb:{m:0.28,p25:0.18,p75:0.40}, feasibilityPct:{m:66,p25:54,p75:78}, changeMaturityPct:{m:54,p25:42,p75:66}, scalabilityPct:{m:62,p25:50,p75:74}, aiReadinessPct:{m:60,p25:48,p75:74}},
                   "2-10k":{techMaturityPct:{m:66,p25:54,p75:78}, procMaturityPct:{m:58,p25:46,p75:70}, riskProb:{m:0.30,p25:0.20,p75:0.42}, feasibilityPct:{m:64,p25:52,p75:76}, changeMaturityPct:{m:58,p25:46,p75:70}, scalabilityPct:{m:66,p25:54,p75:78}, aiReadinessPct:{m:64,p25:52,p75:78}},
                   "10k+":{techMaturityPct:{m:70,p25:58,p75:82}, procMaturityPct:{m:62,p25:50,p75:74}, riskProb:{m:0.28,p25:0.18,p75:0.40}, feasibilityPct:{m:62,p25:50,p75:74}, changeMaturityPct:{m:62,p25:50,p75:74}, scalabilityPct:{m:70,p25:58,p75:82}, aiReadinessPct:{m:68,p25:56,p75:82}} }
};

const DEFAULT_BENCH = {
  techMaturityPct:{m:56,p25:44,p75:68},
  procMaturityPct:{m:52,p25:40,p75:64},
  riskProb:{m:0.34,p25:0.24,p75:0.48},
  feasibilityPct:{m:60,p25:48,p75:72},
  changeMaturityPct:{m:50,p25:38,p75:62},
  scalabilityPct:{m:56,p25:44,p75:68},
  aiReadinessPct:{m:50,p25:38,p75:64}
};

// Small deterministic jitter (so the same profile gives stable output inside range).
function stableJitter(seedStr, p25, p75){
  const s = seedStr.split("").reduce((a,c)=>a + c.charCodeAt(0), 0);
  const t = (Math.sin(s*999) + 1) / 2; // 0..1
  return p25 + (p75 - p25) * t;
}

// Estimate parameter value using: client input -> (optional) interview mapping -> benchmark.
function estimateParam(key, opts={}){
  const mode = (opts && opts.forceBenchHint) ? "bench" : (document.getElementById("benchMode")?.value || "mixed"); // mixed|client|bench
  const prof = getProfile();
  const bench = (BENCH_MATURITY[prof.industry] && BENCH_MATURITY[prof.industry][prof.bucket] && BENCH_MATURITY[prof.industry][prof.bucket][key])
    || (BENCH[prof.industry] && BENCH[prof.industry][prof.bucket] && BENCH[prof.industry][prof.bucket][key])
    || (BENCH_MATURITY["–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å"] && BENCH_MATURITY["–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å"][prof.bucket] && BENCH_MATURITY["–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å"][prof.bucket][key])
    || (BENCH["–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å"] && BENCH["–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å"][prof.bucket] && BENCH["–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å"][prof.bucket][key])
    || DEFAULT_BENCH[key];

  const el = document.getElementById(opts.elId || key);
  const raw = (el && ("value" in el)) ? String(el.value).trim() : "";
  const hasClient = raw !== "" && isFinite(+raw);

  // Benchmark base with stable jitter inside P25‚ÄìP75
  const benchVal = stableJitter(`${prof.industry}|${prof.bucket}|${prof.total}|${key}`, bench.p25, bench.p75);

  // Adjustments (lightweight, to avoid "one number for all")
  let adj = 0;
  if(key === "manualPct"){
    if(prof.branches >= 10) adj += 4;
    if(prof.vdi === "–î–∞") adj -= 2;
    if(prof.closed === "–î–∞") adj += 2;
  }
  if(key === "incidentsPerMonth"){
    if(prof.branches >= 10) adj += 3;
    if(prof.closed === "–î–∞") adj += 2;
  }
  if(key === "unusedPct"){
    if(prof.vdi === "–î–∞") adj += 2;
  }
  if(key === "obsoletePct"){
    if(prof.closed === "–î–∞") adj += 3;
  }
  const benchAdj = benchVal + adj;

  if(mode === "bench"){
    return {v:benchAdj, src:"bench", range:[bench.p25+adj, bench.p75+adj], prof};
  }

  if(mode === "client"){
    if(hasClient) return {v:+raw, src:"client", range:null, prof};
    return {v:NaN, src:"missing", range:null, prof};
  }

  // mixed
  if(hasClient) return {v:+raw, src:"client", range:bench ? [bench.p25+adj, bench.p75+adj] : null, prof};
  return {v:benchAdj, src:"bench", range:[bench.p25+adj, bench.p75+adj], prof};
}

// Confidence scoring: client=1.0, interview=0.6 (reserved), bench=0.35, missing=0
function srcWeight(src){
  if(src==="client") return 1.0;
  if(src==="interview") return 0.6;
  if(src==="bench") return 0.35;
  return 0.0;
}

let LAST_EST = {params:{}, confidence:{}, accuracy:0};

function formatRange(r){
  if(!r || !isFinite(r[0]) || !isFinite(r[1])) return "‚Äî";
  const a = Math.round(r[0]);
  const b = Math.round(r[1]);
  return `${a}‚Äì${b}`;
}

function updateDataAccuracyUI(){
  const pill = document.getElementById("dataAccuracyPill");
  const pill2 = document.getElementById("dataSourcesPill");
  if(pill){
    const a = Math.round(LAST_EST.accuracy || 0);
    pill.textContent = `–¢–æ—á–Ω–æ—Å—Ç—å –æ—Ç—á—ë—Ç–∞: ${isFinite(a)?a:0}%`;
  }
  if(pill2){
    const c = Object.values(LAST_EST.params||{}).filter(p=>p.src==="client").length;
    const b = Object.values(LAST_EST.params||{}).filter(p=>p.src==="bench").length;
    pill2.textContent = `–ò—Å—Ç–æ—á–Ω–∏–∫–∏: üü¢${c} / üîµ${b}`;
  }
}

function updateTopQuestions(){
  const ol = document.getElementById("topQuestions");
  if(!ol) return;

  // Information gain approximated by how much a missing param influences weighted PSI.
  const impact = [
    {key:"manualPct", label:"% —Ä—É—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –ò–¢ (–æ—Ü–µ–Ω–∫–∞)", gain:0.20+0.08},
    {key:"unusedPct", label:"% –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ –ü–û/–ª–∏—Ü–µ–Ω–∑–∏–π (–æ—Ü–µ–Ω–∫–∞)", gain:0.15},
    {key:"vmUnusedPct", label:"% –ø—Ä–æ—Å—Ç–∞–∏–≤–∞—é—â–∏—Ö VM/–≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ (–æ—Ü–µ–Ω–∫–∞)", gain:0.15},
    {key:"incidentsPerMonth", label:"–ò–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤ –≤ –º–µ—Å—è—Ü (—Å—Ä–µ–¥–Ω–µ–µ)", gain:0.20+0.08},
    {key:"downtimeHours", label:"–ß–∞—Å–æ–≤ –ø—Ä–æ—Å—Ç–æ—è –≤ –≥–æ–¥ (–æ—Ü–µ–Ω–∫–∞)", gain:0.20},
    {key:"downtimeCost", label:"–°—Ç–æ–∏–º–æ—Å—Ç—å —á–∞—Å–∞ –ø—Ä–æ—Å—Ç–æ—è (‚ÇΩ/—á–∞—Å)", gain:0.20},
    {key:"obsoletePct", label:"–î–æ–ª—è —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –û–°/–ü–û (%)", gain:0.10},
    {key:"keyPeopleRisk", label:"–ï—Å—Ç—å –ª–∏ ¬´–Ω–µ–∑–∞–º–µ–Ω–∏–º—ã–µ¬ª —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã? (–î–∞/–ù–µ—Ç)", gain:0.10},
    {key:"docScore", label:"–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (–ù–µ—Ç/–ß–∞—Å—Ç–∏—á–Ω–æ/–î–∞)", gain:0.10}
  ];

  const missing = impact
    .map(x=>({ ...x, src: LAST_EST.params?.[x.key]?.src || "missing" }))
    .filter(x=>x.src==="missing")
    .sort((a,b)=>b.gain-a.gain)
    .slice(0,5);

  ol.innerHTML = "";
  if(missing.length===0){
    const li=document.createElement("li");
    li.textContent="–í—Å–µ –∫–ª—é—á–µ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã —É–∂–µ –¥–∞–Ω—ã ‚Äî —Ç–æ—á–Ω–æ—Å—Ç—å –±–ª–∏–∑–∫–∞ –∫ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π.";
    ol.appendChild(li);
    return;
  }
  missing.forEach(x=>{
    const li=document.createElement("li");
    li.innerHTML = `<b>${x.label}</b> ‚Äî –ø–æ–≤—ã—Å–∏—Ç —Ç–æ—á–Ω–æ—Å—Ç—å –∏ –∫–∞—á–µ—Å—Ç–≤–æ –≤—ã–≤–æ–¥–∞ –ø–æ PSI (–≤–ª–∏—è–Ω–∏–µ: ~${Math.round(x.gain*100)}%).`;
    ol.appendChild(li);
  });
}

function paintStat(elId, pct, higherBetter=true){
  const el=document.getElementById(elId);
  el.classList.remove("good","warn","bad");
  if(!isFinite(pct)) return;
  if(higherBetter){
    if(pct>=75) el.classList.add("good");
    else if(pct>=45) el.classList.add("warn");
    else el.classList.add("bad");
  } else {
    if(pct<=25) el.classList.add("good");
    else if(pct<=55) el.classList.add("warn");
    else el.classList.add("bad");
  }
}
function paintRisk(score){
  const el=document.getElementById("kRisk");
  if(!el) return;
  el.classList.remove("good","warn","bad");
  if(!isFinite(score)) return;
  if(score<=1) el.classList.add("good");
  else if(score<=3) el.classList.add("warn");
  else el.classList.add("bad");
}

function createScoreRow(tbody,item,type){
  const label = (typeof item==="string") ? item : (item?.label||"");
  const mode = (typeof item==="string") ? "both" : (item?.mode||"both");
  const tr=document.createElement("tr");
  tr.dataset.mode = mode;

  tr.innerHTML = `
    <td>
      <span class="statusDot dotRed maturityDot" style="margin-right:10px" title="–ü–æ–ª–µ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ"></span>
      ${label}
    </td>
    <td>
      <select class="${type}-score" data-origin="">
        ${type==="risk"
          ? `<option value="">‚Äî</option><option value="0">–ù–µ—Ç</option><option value="1">–î–∞</option>`
          : `<option value="">‚Äî</option><option value="0">–ù–µ—Ç</option><option value="1">–ß–∞—Å—Ç–∏—á–Ω–æ</option><option value="2">–î–∞</option>`
        }
      </select>
    </td>
    <td><input class="${type}-note" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–ø–æ –∂–µ–ª–∞–Ω–∏—é)"></td>
  `;
  tbody.appendChild(tr);

  // dot behavior: red(empty) / green(user) / blue(synthetic)
  const dot = tr.querySelector(".maturityDot");
  const sel = tr.querySelector("select");
  const updateDot = ()=>{
    if(!dot || !sel) return;
    const v = (sel.value ?? "").toString().trim();
    if(!v){
      dot.classList.remove("dotBlue","dotGreen");
      dot.classList.add("dotRed");
      dot.title = "–ü–æ–ª–µ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ";
      return;
    }
    const synthetic = (sel.dataset.synthetic === "1") || (sel.dataset.origin === "synthetic");
    dot.classList.remove("dotRed","dotBlue","dotGreen");
    dot.classList.add(synthetic ? "dotBlue" : "dotGreen");
    dot.title = synthetic ? "–°–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ (–º–æ–∂–Ω–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å)" : "–ó–∞–ø–æ–ª–Ω–µ–Ω–æ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º";
  };

  // user edit -> user origin, clear synthetic
  sel.addEventListener("change", ()=>{
    sel.dataset.origin = "user";
    if(sel.dataset.synthetic === "1") delete sel.dataset.synthetic;
    updateDot();
  }, {passive:true});

  updateDot();
}


function _normKey(s){
  // Normalize question label to match keys in question_bank.js
  // Bank keys do NOT contain numbering like "T1." / "P3." etc.
  let x = String(s||"").replace(/\s+/g," ").trim();
  // strip leading numbering markers: "T1.", "P10.", "1)", "1.", "2.1" etc.
  x = x.replace(/^(?:[TP–ê-–ØA-Z]{0,2}\s*)?\d+(?:[\.:]\d+)*[\.)\.:\-\s]+/i, "");
  // strip leading "T"/"P" with digits if still present
  x = x.replace(/^[TP]\s*\d+\s*[\.)\.:\-\s]+/i, "");
  return x.toLowerCase().replace(/—ë/g,"–µ")
    .replace(/[‚Äú‚Äù"'`]/g,"")
    .replace(/\s+/g," ")
    .replace(/[^0-9a-z–∞-—è .\-_/():,?]+/g,"")
    .trim();
}

function _normZone(z){
  const v = String(z||"").trim().toLowerCase();
  if(!v) return "";
  if(v.includes("–ª–∏—Ü–µ–Ω")) return "–õ–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π —Ä–∏—Å–∫";
  if(v.includes("—Ä—É—á") || v.includes("–æ–ø–µ—Ä–∞—Ü")) return "–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å / —Ä—É—á–Ω–æ–π —Ç—Ä—É–¥";
  if(v.includes("–∏—Å—Ç–æ—Ä") || v.includes("—É–ø—Ä–∞–≤")) return "–£–ø—Ä–∞–≤–ª—è–µ–º–æ—Å—Ç—å / –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏—Å—Ç–æ—Ä–∏–∏";
  // default -> grey
  return "–°–µ—Ä—ã–µ –∑–æ–Ω—ã (–æ—Ö–≤–∞—Ç / –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)";
}

function _getBank(){
  // Return expanded bank with multiple key forms to avoid mismatches
  // between question text in UI (often without numbering) and keys in the bank.
  if(window.__ITMEN_BANK_EXPANDED) return window.__ITMEN_BANK_EXPANDED;
  const base = (window.ITMEN_QUESTION_BANK)||{};
  const exp = {};
  try{
    Object.entries(base).forEach(([k,v])=>{
      // keep original key
      exp[String(k)] = v;
      // add normalized-without-numbering key
      const nk = _normKey(k);
      if(nk) exp[nk] = v;
      // add extra variant: strip only leading "t1."/"p1." from already normalized strings
      const nk2 = nk.replace(/^[tp]\s*\d+\s*[\.)\-:\s]+/i, "").trim();
      if(nk2) exp[nk2] = v;
    });
  }catch(_e){}
  window.__ITMEN_BANK_EXPANDED = exp;
  return exp;
}

function computeHeatmapFromMaturity(){
  const bank=_getBank();
  const zones = {
    "–°–µ—Ä—ã–µ –∑–æ–Ω—ã (–æ—Ö–≤–∞—Ç / –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)": {w:0, s:0},
    "–õ–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π —Ä–∏—Å–∫": {w:0, s:0},
    "–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å / —Ä—É—á–Ω–æ–π —Ç—Ä—É–¥": {w:0, s:0},
    "–£–ø—Ä–∞–≤–ª—è–µ–º–æ—Å—Ç—å / –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏—Å—Ç–æ—Ä–∏–∏": {w:0, s:0},
  };
  const contribs = [];

  function handleRows(rows){
    rows.forEach(tr=>{
      const labelCell = tr.children?.[0];
      const labelText = labelCell ? labelCell.textContent.replace(/\s+/g," ").trim() : "";
      // Prefer stable code keys like T1/P3 (text may differ slightly between bank and UI)
      const mCode = labelText.match(/^\s*([TP])\s*(\d+)\s*[\.)]/i);
      const codeKey = mCode ? (mCode[1].toLowerCase()+mCode[2]) : null;
      const key=_normKey(labelText);
      const meta = (codeKey && bank[codeKey]) ? bank[codeKey] : bank[key];
      if(!meta) return;

      const sel=tr.querySelector("select");
      const v = (sel && sel.value!=="") ? Number(sel.value) : null;
      if(v===null || Number.isNaN(v)) return;

      // v: 0 –ù–µ—Ç, 1 –ß–∞—Å—Ç–∏—á–Ω–æ, 2 –î–∞
      const answerRisk = (v===2)?0 : (v===1)?0.5 : 1;
      const w = Number(meta.w)||1;
      const zone = _normZone(meta.zone);
      if(!zones[zone]) zones[zone] = {w:0,s:0};
      zones[zone].w += w;
      zones[zone].s += w*answerRisk;

      // contribution for demo plan
      contribs.push({
        zone,
        w,
        a: answerRisk,
        c: w*answerRisk,
        prio: Number(meta.prio)||99,
        func: meta.func || "",
        module: meta.module||"",
        q: meta.q||labelText
      });
    });
  }

  handleRows([ ...document.querySelectorAll("#techTbody tr") ]);
  handleRows([ ...document.querySelectorAll("#procTbody tr") ]);

  const out = {};
  let totW=0, totS=0;
  Object.keys(zones).forEach(z=>{
    const Zw=zones[z].w;
    const Zs=zones[z].s;
    const risk = (Zw>0) ? (Zs/Zw) : null;
    out[z] = risk; // 0..1
    if(risk!==null){
      totW += Zw;
      totS += Zs;
    }
  });
  out.__overall = (totW>0) ? (totS/totW) : null;

  // main problem = max risk
  let maxZ=null, maxV=-1;
  Object.entries(out).forEach(([z,v])=>{
    if(z==="__overall" || v===null) return;
    if(v>maxV){maxV=v; maxZ=z;}
  });
  out.__mainZone = maxZ;
  out.__mainRisk = (maxV>=0)?maxV:null;
  out.__contribs = contribs;

  return out;
}

function decideModules(r){
  // thresholds are in percent
  const grey = r["–°–µ—Ä—ã–µ –∑–æ–Ω—ã (–æ—Ö–≤–∞—Ç / –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)"];
  const lic  = r["–õ–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π —Ä–∏—Å–∫"];
  const ops  = r["–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å / —Ä—É—á–Ω–æ–π —Ç—Ä—É–¥"];
  const gov  = r["–£–ø—Ä–∞–≤–ª—è–µ–º–æ—Å—Ç—å / –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏—Å—Ç–æ—Ä–∏–∏"];

  const mods=[];
  if(grey!==null && grey*100 >= 40) mods.push("–ë–∞–∑–æ–≤—ã–π");
  if(lic!==null  && lic*100  >= 30) mods.push("–ü—Ä–∏–∑–º–∞");
  if(gov!==null  && gov*100  >= 40) mods.push("–ì–∏–±–∫–∞—è –º–æ–¥–µ–ª—å");
  if(ops!==null  && ops*100  >= 50) mods.push("–û–±–æ–≥–∞—â–µ–Ω–∏–µ");
  return mods.length ? mods : ["‚Äî"];
}

function decideDemo(mainZone){
  switch(mainZone){
    case "–°–µ—Ä—ã–µ –∑–æ–Ω—ã (–æ—Ö–≤–∞—Ç / –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)":
      return {title:"–ê–≥—Ä–µ–≥–∞—Ü–∏—è/–æ—Ö–≤–∞—Ç", hint:"–ù–∞—á–∞—Ç—å —Å –µ–¥–∏–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –ø—Ä–∞–≤–¥—ã –∏ –ø–æ–∫—Ä—ã—Ç–∏—è —Å–µ–≥–º–µ–Ω—Ç–æ–≤."};
    case "–õ–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π —Ä–∏—Å–∫":
      return {title:"–ü—Ä–∏–∑–º–∞ (–ª–∏—Ü–µ–Ω–∑–∏–∏)", hint:"–ù–∞—á–∞—Ç—å —Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –ü–û –∏ –∫–æ–Ω—Ç—Ä–æ–ª—è –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã—Ö —Ä–∏—Å–∫–æ–≤."};
    case "–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å / —Ä—É—á–Ω–æ–π —Ç—Ä—É–¥":
      return {title:"–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è", hint:"–ù–∞—á–∞—Ç—å —Å–æ —Å–Ω–∏–∂–µ–Ω–∏—è —Ä—É—á–Ω–æ–≥–æ —Ç—Ä—É–¥–∞ –∏ —É—Å–∫–æ—Ä–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö."};
    case "–£–ø—Ä–∞–≤–ª—è–µ–º–æ—Å—Ç—å / –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏—Å—Ç–æ—Ä–∏–∏":
      return {title:"–ò—Å—Ç–æ—Ä–∏—è/—É–ø—Ä–∞–≤–ª—è–µ–º–æ—Å—Ç—å", hint:"–ù–∞—á–∞—Ç—å —Å –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏ —É–ø—Ä–∞–≤–ª—è–µ–º–æ—Å—Ç–∏ (–∞—É–¥–∏—Ç/–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å)."};
    default:
      return {title:"‚Äî", hint:"–ó–∞–ø–æ–ª–Ω–∏ –æ—Ç–≤–µ—Ç—ã –≤ 2.1/2.2 ‚Äî –ø–æ—è–≤–∏—Ç—Å—è —Å—Ü–µ–Ω–∞—Ä–∏–π."};
  }
}

function _escHtml(s){
  return (s||"").replace(/[&<>\"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c]));
}

function buildDemoPlan(hm){
  const contribs = (hm && hm.__contribs) ? hm.__contribs.slice() : [];
  if(!contribs.length){
    return {title:"‚Äî", html:"<div class='small'>–ó–∞–ø–æ–ª–Ω–∏ –æ—Ç–≤–µ—Ç—ã –≤ 2.1/2.2 ‚Äî –ø–æ—è–≤–∏—Ç—Å—è –ø–ª–∞–Ω –¥–µ–º–æ.</div>"};
  }

  // Sort by impact (w√óanswer) then by explicit priority (lower=more important)
  contribs.sort((x,y)=> (y.c - x.c) || ((x.prio||99) - (y.prio||99)));

  const mainZone = hm.__mainZone || null;
  const base = decideDemo(mainZone);

  function cleanQ(q){
    return (q||"")
      .replace(/^\s*[TP]\s*\d+\s*[\.)]\s*/i, "")
      .replace(/^\s*\d+\s*[\.)]\s*/, "")
      .trim();
  }
  function pickFunc(x){
    const f = (x.func && String(x.func).trim()) ? String(x.func).trim() : cleanQ(x.q||"");
    // Normalize: collapse whitespace, remove trailing dots
    return f.replace(/\s+/g," ").replace(/[.„ÄÇ]\s*$/,"").trim();
  }

  // Deduplicate by functional description (same function may map to multiple questions)
  function uniqueByFunc(list){
    const seen=new Set();
    const out=[];
    for(const x of list){
      const f=pickFunc(x);
      if(!f) continue;
      const key=f.toLowerCase();
      if(seen.has(key)) continue;
      seen.add(key);
      out.push({...x, __func:f});
    }
    return out;
  }

  const inMainZone = mainZone ? contribs.filter(x=>x.zone===mainZone && x.c>0) : [];
  const allPositive = contribs.filter(x=>x.c>0);

  const topMainUnique = uniqueByFunc(inMainZone);
  const topAllUnique  = uniqueByFunc(allPositive);

  // Remove items already shown in main list from "also show"
  const mainKeys = new Set(topMainUnique.map(x=>x.__func.toLowerCase()));
  const alsoUnique = topAllUnique.filter(x=>!mainKeys.has(x.__func.toLowerCase()));

  function li(x, idx){
    const pr = (idx!==undefined && idx!==null) ? (idx+1) : "";
    return `<li><span class="prio">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç ${pr}</span><span class="func">${_escHtml(x.__func || pickFunc(x))}</span></li>`;
  }

  // UI: show only TOP by main zone. Everything else is under one "–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë".
const mainTop = topMainUnique.slice(0,3);
const mainMore = topMainUnique.slice(3,10); // cap
const alsoMore = alsoUnique.slice(0,10);    // cap

let html = `<div class="demoIntro">${_escHtml(base.hint)}</div>`;

if(mainTop.length){
  html += `<div class="demoSectionTitle">–¢–æ–ø –¥–µ–º–æ –ø–æ –æ—Å–Ω–æ–≤–Ω–æ–π –∑–æ–Ω–µ</div>
    <ul class="demoList">${mainTop.map((x,i)=>li(x,i)).join("")}</ul>`;
}

const extraCount = (mainMore.length + alsoMore.length);
if(extraCount){
  html += `<details class="demoDetails"><summary class="demoSummary">–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë (${extraCount})</summary>
    <div class="demoExtra">`;
  if(mainMore.length){
    html += `<div class="demoSectionTitle" style="margin-top:8px">–ï—â—ë –ø–æ –æ—Å–Ω–æ–≤–Ω–æ–π –∑–æ–Ω–µ</div>
      <ul class="demoList">${mainMore.map((x,i)=>li(x,i+mainTop.length)).join("")}</ul>`;
  }
  if(alsoMore.length){
    html += `<div class="demoSectionTitle" style="margin-top:10px">–¢–∞–∫–∂–µ —Å—Ç–æ–∏—Ç –ø–æ–∫–∞–∑–∞—Ç—å</div>
      <ul class="demoList">${alsoMore.map((x,i)=>li(x,i+mainTop.length+mainMore.length)).join("")}</ul>`;
  }
  html += `</div></details>`;
}

return {title: base.title, html};
}

function _fmtRub(n){
  if(n===null || n===undefined || Number.isNaN(n)) return "‚Äî";
  try{
    return Math.round(n).toLocaleString("ru-RU");
  }catch(e){
    return String(Math.round(n));
  }
}

// Safe numeric reader (value/text -> number)
function _num(id){
  const el=document.getElementById(id);
  if(!el) return NaN;
  const raw=("value" in el) ? (el.value??"") : (el.textContent??"");
  const s=_numFromText(raw);
  const n=parseFloat(String(s).replace(",","."));
  return Number.isFinite(n)?n:NaN;
}

function computeCOIBreakdown(){
  const licBudget = _num("licBudget") || 0;
  const unusedPct = _num("unusedPct") || 0;
  const downtimeHours = _num("downtimeHours") || 0;
  // In UI input is "downtimeCost". Keep backward-compat with "costPerHour".
  const costPerHour = _num("downtimeCost") || _num("costPerHour") || 0;
  const itCount = _num("itCount") || 0;
  const salary = _num("salary") || 0;
  const manualPct = _num("manualPct") || 0;

  const licLoss = licBudget * (unusedPct/100);
  const downLoss = downtimeHours * costPerHour;
  const manualLoss = itCount * salary * 12 * (manualPct/100);

  const total = licLoss + downLoss + manualLoss;
  return {licLoss, downLoss, manualLoss, total};
}


function ensureBaseTables(){
  const techTb=document.getElementById("techTbody");
  const procTb=document.getElementById("procTbody");
  const riskTb=document.getElementById("riskTbody");
  techTb.innerHTML=""; procTb.innerHTML=""; riskTb.innerHTML="";
  TECH.forEach(x=>createScoreRow(techTb,x,"tech"));
  PROC.forEach(x=>createScoreRow(procTb,x,"proc"));
  RISK.forEach(x=>createScoreRow(riskTb,x,"risk"));

  // IMPORTANT: these maturity selects feed Heatmap/Pilot Readiness.
  // Rows are created dynamically, so we must bind recalc after creation.
  try{
    [...techTb.querySelectorAll('select,input,textarea'),
     ...procTb.querySelectorAll('select,input,textarea'),
     ...riskTb.querySelectorAll('select,input,textarea')]
      .forEach(el=>{
        el.addEventListener('change', recalc, {passive:true});
        el.addEventListener('input', debounce(recalc, 120), {passive:true});
      });
  }catch(_e){}
}

function addReqRow(data){
  const tb=document.getElementById("reqTbody");
  const idx=tb.children.length+1;
  const feasOptions = FEAS_OPTIONS.map(o=>`<option value="${o.label}">${o.label}</option>`).join("");
  const tr=document.createElement("tr");
  tr.innerHTML = `
    <td class="right mono">${idx}</td>
    <td><textarea class="req-owner" placeholder="–ë–∏–∑–Ω–µ—Å –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å / –∑–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ?"></textarea></td>
    <td><textarea class="req-text" placeholder="–ß—Ç–æ –∏–º–µ–Ω–Ω–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–æ/–ø–æ–∫–∞–∑–∞–Ω–æ –Ω–∞ –ø–∏–ª–æ—Ç–µ?"></textarea></td>
    <td>
      <select class="req-type">
        <option>–¢–µ—Ö</option><option>–ò–ë</option><option>–ë–∏–∑–Ω–µ—Å</option><option>–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</option><option>–û—Ç—á–µ—Ç—ã</option>
      </select>
    </td>
    <td>
      <select class="req-must"><option value="–î–∞">–î–∞</option><option value="–ù–µ—Ç">–ù–µ—Ç</option></select>
    </td>
    <td><select class="req-feas">${feasOptions}</select></td>
    <td><textarea class="req-metric" placeholder="–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä—è–µ–º? (–º–µ—Ç—Ä–∏–∫–∞/–æ—Ç—á–µ—Ç/—Å–∫—Ä–∏–Ω)"></textarea></td>
  `;
  tb.appendChild(tr);

  if(data){
    tr.querySelector(".req-text").value = data.text || "";
    setSelectSmart_(tr.querySelector(".req-type"), data.type, "–¢–µ—Ö");
    setSelectSmart_(tr.querySelector(".req-must"), data.must, "–î–∞");
    setSelectSmart_(tr.querySelector(".req-feas"), data.feas, "‚Äî");
    tr.querySelector(".req-metric").value = data.metric || "";
    tr.querySelector(".req-owner").value = data.owner || "";
  }

  tr.querySelectorAll("input,select,textarea").forEach(el=>{
    el.addEventListener("input", debounce(recalc,120));
    el.addEventListener("change", recalc);
  });
  recalc();
}

// --- Helpers: robustly set <select> values coming from Google Sheets (case/aliases)
function setSelectSmart_(sel, raw, fallback){
  if(!sel) return;
  const v0 = (raw===undefined || raw===null) ? "" : String(raw);
  const v = v0.trim();
  if(!v){
    if(fallback!==undefined) sel.value = String(fallback);
    return;
  }

  // 1) exact
  const opts = Array.from(sel.options||[]);
  if(opts.some(o=>String(o.value)===v)) { sel.value = v; return; }
  if(opts.some(o=>String(o.text)===v)) { sel.value = (opts.find(o=>String(o.text)===v)||{}).value || v; return; }

  // 2) case-insensitive match
  const vl = v.toLowerCase();
  const optCI = opts.find(o=>String(o.value).toLowerCase()===vl) || opts.find(o=>String(o.text).toLowerCase()===vl);
  if(optCI){ sel.value = optCI.value; return; }

  // 3) common aliases (–î–∞/–ù–µ—Ç, numbers, booleans)
  const yes = ["1","–¥–∞","yes","true","y","ok","–∞–≥–∞"].includes(vl);
  const no  = ["0","–Ω–µ—Ç","no","false","n"].includes(vl);
  if(yes){
    const o = opts.find(o=>o.value==="–î–∞" || o.text==="–î–∞");
    if(o){ sel.value=o.value; return; }
  }
  if(no){
    const o = opts.find(o=>o.value==="–ù–µ—Ç" || o.text==="–ù–µ—Ç");
    if(o){ sel.value=o.value; return; }
  }

  // 4) type aliases
  const map = {
    "—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ":"–¢–µ—Ö",
    "—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π":"–¢–µ—Ö",
    "—Ç–µ—Ö–Ω–∏—á":"–¢–µ—Ö",
    "–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è":"–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏",
    "–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏":"–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏",
    "–æ—Ç—á–µ—Ç—ã":"–û—Ç—á–µ—Ç—ã",
    "–æ—Ç—á—ë—Ç—ã":"–û—Ç—á–µ—Ç—ã",
  };
  for(const k in map){
    if(vl.includes(k)){
      const want = map[k];
      const o = opts.find(o=>o.value===want || o.text===want);
      if(o){ sel.value=o.value; return; }
    }
  }

  // 5) fallback
  if(fallback!==undefined) sel.value = String(fallback);
}


const PROD_FEAS_OPTIONS = [
  { label: "‚Äî", score: null },
  { label: "–ü–æ–ª–Ω–æ—Å—Ç—å—é", score: 1.00 },
  { label: "–ß–∞—Å—Ç–∏—á–Ω–æ", score: 0.60 },
  { label: "–ù–µ—Ç", score: 0.00 },
  { label: "–ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏", score: 0.00 },
  // Accept both casing variants
  { label: "–•–∞—Ä–¥ –∫–æ–¥ (–°–∫–æ—Ä–æ)", score: 0.70 },
  { label: "–•–∞—Ä–¥ –∫–æ–¥ (—Å–∫–æ—Ä–æ)", score: 0.70 },
  { label: "–•–∞—Ä–¥ –∫–æ–¥ (–Ω–µ —Å–∫–æ—Ä–æ)", score: 0.30 },
  { label: "–¢—Ä–µ–±—É–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç", score: 0.50 },
];

function addProdReqRow(data){
  const tb=document.getElementById("prodReqTbody");
  if(!tb) return;
  const idx=tb.children.length+1;
  const feasOptions = PROD_FEAS_OPTIONS.map(o=>`<option value="${o.label}">${o.label}</option>`).join("");
  const tr=document.createElement("tr");
  tr.innerHTML = `
    <td class="right mono">${idx}</td>
    <td><textarea class="prod-biz" placeholder="–ó–∞—á–µ–º –±–∏–∑–Ω–µ—Å—É? –∫–∞–∫—É—é —Ü–µ–Ω–Ω–æ—Å—Ç—å –¥–∞—ë—Ç?"></textarea></td>
    <td><textarea class="prod-func" placeholder="–ß—Ç–æ –∏–º–µ–Ω–Ω–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ –ø—Ä–æ–¥—É–∫—Ç–µ?"></textarea></td>
    <td>
      <select class="prod-type">
        <option>–¢–µ—Ö</option><option>–ò–ë</option><option>–ë–∏–∑–Ω–µ—Å</option><option>–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</option><option>–û—Ç—á–µ—Ç—ã</option>
      </select>
    </td>
    <td>
      <select class="prod-must"><option value="–î–∞">–î–∞</option><option value="–ù–µ—Ç">–ù–µ—Ç</option></select>
    </td>
    <td><select class="prod-feas">${feasOptions}</select></td>
  `;
  tb.appendChild(tr);

  if(data){
    tr.querySelector(".prod-biz").value = data.biz || data.owner || "";
    tr.querySelector(".prod-func").value = data.func || data.text || "";
    setSelectSmart_(tr.querySelector(".prod-type"), data.type, "–¢–µ—Ö");
    setSelectSmart_(tr.querySelector(".prod-must"), data.must, "–î–∞");
    setSelectSmart_(tr.querySelector(".prod-feas"), data.feas, "‚Äî");
  }

  tr.querySelectorAll("input,select,textarea").forEach(el=>{
    el.addEventListener("input", debounce(recalc,120));
    el.addEventListener("change", recalc);
  });
  recalc();
}

function addPsiRow(data){
  const tb=document.getElementById("psiTbody");
  const idx=tb.children.length+1;
  const tr=document.createElement("tr");
  tr.innerHTML = `
    <td class="right mono">${idx}</td>
    <td><textarea class="psi-req" placeholder="–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ / —á—Ç–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º?"></textarea></td>
    <td><textarea class="psi-scn" placeholder="–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º? (—Ñ—É–Ω–∫—Ü–∏—è/—Å—Ü–µ–Ω–∞—Ä–∏–π)"></textarea></td>
    <td><textarea class="psi-exp" placeholder="–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç"></textarea></td>
    <td><textarea class="psi-act" placeholder="–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç"></textarea></td>
    <td>
      <select class="psi-ok"><option value="">‚Äî</option><option value="–î–∞">–î–∞</option><option value="–ù–µ—Ç">–ù–µ—Ç</option></select>
    </td>
    <td>
      <select class="psi-acc"><option value="">‚Äî</option><option value="–î–∞">–î–∞</option><option value="–ù–µ—Ç">–ù–µ—Ç</option></select>
    </td>
    <td><textarea class="psi-note" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π/–∑–∞–º–µ—á–∞–Ω–∏—è"></textarea></td>
  `;
  tb.appendChild(tr);

  if(data){
    tr.querySelector(".psi-req").value = data.req || "";
    tr.querySelector(".psi-scn").value = data.scn || "";
    tr.querySelector(".psi-exp").value = data.exp || "";
    tr.querySelector(".psi-act").value = data.act || "";
    setSelectSmart_(tr.querySelector(".psi-ok"),  data.ok,  "");
    setSelectSmart_(tr.querySelector(".psi-acc"), data.acc, "");
    tr.querySelector(".psi-note").value = data.note || "";
  }
  tr.querySelectorAll("input,select,textarea").forEach(el=>{
    el.addEventListener("input", debounce(recalc,120));
    el.addEventListener("change", recalc);
  });
  recalc();
}


function painLevelLabel(pct){
  if(!isFinite(pct)) return "‚Äî";
  if(pct >= 75) return "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ";
  if(pct >= 50) return "–í—ã—Å–æ–∫–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ";
  if(pct >= 25) return "–°—Ä–µ–¥–Ω–µ–µ –¥–∞–≤–ª–µ–Ω–∏–µ";
  return "–ù–∏–∑–∫–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ";
}
function readinessLabel(pct){
  if(!isFinite(pct)) return "‚Äî";
  if(pct >= 90) return "–ì–æ—Ç–æ–≤ –∫ –ü–°–ò";
  if(pct >= 70) return "–ì–æ—Ç–æ–≤";
  if(pct >= 40) return "–£—Å–ª–æ–≤–Ω–æ –≥–æ—Ç–æ–≤";
  return "–ù–µ –≥–æ—Ç–æ–≤";
}
function probabilityLabel(pct){
  if(!isFinite(pct)) return "‚Äî";
  if(pct >= 80) return "–ü–æ—á—Ç–∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ";
  if(pct >= 60) return "–í—ã—Å–æ–∫–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å";
  if(pct >= 30) return "–°—Ä–µ–¥–Ω—è—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å";
  return "–ù–∏–∑–∫–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å";
}


function computePSIFromDom(){
  // Robust PSI fallback: compute from already-rendered KPI values so PSI never stays "‚Äî%"
  const numFromEl = (id)=>{
    const el=document.getElementById(id);
    if(!el) return NaN;
    const t=(el.textContent||"").replace("%","").replace(/\s+/g," ").trim();
    const n=parseFloat(t.replace(",","."));
    return Number.isFinite(n)?n:NaN;
  };
  const tech=numFromEl("techIndex");
  const proc=numFromEl("procIndex");
  const recover=numFromEl("recoverIndex");
  const bus=numFromEl("busIndex");
  const obsol=numFromEl("obsolIndex");
  const ai=numFromEl("aiIndex");

  // If we have at least tech/proc, compute; otherwise leave as ‚Äî
  const parts=[
    {v:tech, w:0.30},   // proxy for "control" and tech maturity
    {v:proc, w:0.20},   // process maturity
    {v:recover, w:0.15},
    {v:bus, w:0.10},
    {v:obsol, w:0.10},
    {v:ai, w:0.15},
  ];
  const valid=parts.filter(p=>Number.isFinite(p.v) && p.w>0);
  if(!valid.length){ return NaN; }
  const sumW=valid.reduce((a,p)=>a+p.w,0);
  let psi=valid.reduce((a,p)=>a+p.v*p.w,0)/sumW;
  psi=Math.round(clamp(psi,0,100));
  const scoreEl=document.getElementById("psi2Score");
  const labelEl=document.getElementById("psi2Label");
  if(scoreEl) scoreEl.textContent = `${psi}%`;
  if(labelEl) labelEl.textContent = (psi>=75 ? "–ó–µ–ª—ë–Ω–∞—è –∑–æ–Ω–∞" : (psi>=45 ? "–ñ—ë–ª—Ç–∞—è –∑–æ–Ω–∞" : "–ö—Ä–∞—Å–Ω–∞—è –∑–æ–Ω–∞"));
  try{ paintIf("kPSI", psi, true); }catch(_e){}
  return psi;
}


/* ===== Quick interview: synthetic defaults for hidden (deep) fields ===== */
function applyQuickSynthetics(){
  const mode = document.getElementById("interviewMode")?.value || "quick";
  const isQuick = (mode === "quick");

  // Helpers for maturity tables
  const setRowScoreByLabel = (tbodyId, labelStartsWith, val)=>{
    const tb = document.getElementById(tbodyId);
    if(!tb) return;
    const rows = [...tb.querySelectorAll("tr")];
    const tr = rows.find(r=>{
      const td = r.querySelector("td");
      const txt = (td?.innerText || "").replace(/\s+/g," ").trim();
      return txt.startsWith(labelStartsWith);
    });
    if(!tr) return;
    const sel = tr.querySelector("select");
    if(!sel) return;
    const cur = (sel.value ?? "").trim();
    if(cur !== "" && cur !== "0" && sel.dataset.synthetic !== "1") return;
    sel.value = String(val);
    sel.dataset.synthetic = "1";
    sel.dataset.origin = "synthetic";
  };

  // In QUICK mode: default all hidden deep maturity rows to 0 unless user filled
  if(isQuick){
    ["techTbody","procTbody","riskTbody"].forEach(tbid=>{
      const tb=document.getElementById(tbid);
      if(!tb) return;
      tb.querySelectorAll("tr").forEach(tr=>{
        if(tr.dataset.mode !== "deep") return;
        const sel = tr.querySelector("select");
        if(!sel) return;
        const cur = (sel.value ?? "").trim();
        if(cur !== "" && cur !== "0" && sel.dataset.synthetic !== "1") return;
        sel.value = "0";
        sel.dataset.synthetic = "1";
        sel.dataset.origin = "synthetic";
      });
    });
  }

  // Read passport values for synthetic logic
  const workplaces = Number(document.getElementById("workplaces")?.value || 0);
  const servers = Number(document.getElementById("servers")?.value || 0);
  const endpoints = Math.max(0, workplaces + servers);
  const branches = Number(document.getElementById("branches")?.value || 0);

  // Infrastructure synthetic defaults
  const setSynthSelect = (id, v)=>{
    const el = document.getElementById(id);
    if(!el) return;
    const cur = (el.value ?? "").toString().trim();
    if(cur !== "" && el.dataset.synthetic !== "1") return;
    el.value = v;
    el.dataset.synthetic = "1";
    el.dataset.origin = "synthetic";
  };
  setSynthSelect("hostingModel", "On‚Äëprem");
  setSynthSelect("netSeg", "Prod/Test/Dev –†–∞–∑–¥–µ–ª–µ–Ω—ã");

  // Risk synthetics (as requested)
  setRowScoreByLabel("riskTbody", "–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–∞—è", branches > 1 ? 1 : 0);
  setRowScoreByLabel("riskTbody", "–ü–∞—Ä–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –±—ã—Å—Ç—Ä–æ —Ä–∞—Å—Ç–µ—Ç/–º–µ–Ω—è–µ—Ç—Å—è", 0);
  setRowScoreByLabel("riskTbody", "–ü–ª–∞–Ω–∏—Ä—É—é—Ç—Å—è –∫—Ä—É–ø–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã", endpoints > 5000 ? 1 : 0);
  setRowScoreByLabel("riskTbody", "–í—ã—Å–æ–∫–∞—è —Ç–µ–∫—É—á–µ—Å—Ç—å –ò–¢-–ø–µ—Ä—Å–æ–Ω–∞–ª–∞", 0);

  // Finance synthetic defaults
  const setSynthField = (id, v)=>{
    const el = document.getElementById(id);
    if(!el) return;
    const cur = (el.value ?? "").toString().trim();
    if(cur !== "" && cur !== "0" && el.dataset.synthetic !== "1") return;
    el.value = String(v);
    el.dataset.synthetic = "1";
    el.dataset.origin = "synthetic";
  };
  setSynthField("salary", 300000);
  setSynthField("manualPct", 20);
  setSynthField("unusedPct", 10);
  setSynthField("vmUnusedPct", 10);
  setSynthField("downtimeHours", 120);
  setSynthField("downtimeCost", 150000);
  setSynthField("incidentsPerMonth", 4);
  setSynthField("obsoletePct", 15);

  setSynthSelect("serviceDesk", "–î–∞");
  setSynthSelect("keyPeopleRisk", "–î–∞");

  // Endpoint budgets synthetic mapping (SW/HW) using provided table
  const virtStr = (document.getElementById("virt")?.value || "").toString();
  const hasVirt = virtStr && !virtStr.includes("–ù–µ—Ç");
  const band = (n)=>{
    if(n>=20000) return "20000+";
    if(n>=5000) return "5000-20000";
    if(n>=1000) return "1000-5000";
    return "100-1000";
  };
  const COSTS = {
    "100-1000":   { noVirt:{sw:17000, hw:37000}, virt:{sw:19040, hw:31450} },
    "1000-5000":  { noVirt:{sw:15300, hw:33300}, virt:{sw:17136, hw:28305} },
    "5000-20000": { noVirt:{sw:13600, hw:29600}, virt:{sw:15232, hw:25160} },
    "20000+":     { noVirt:{sw:11900, hw:25900}, virt:{sw:13328, hw:22015} }
  };
  const b = band(endpoints);
  const c = (COSTS[b] || COSTS["100-1000"])[hasVirt ? "virt" : "noVirt"];
  setSynthField("licBudget", Math.round(endpoints * c.sw));
  setSynthField("hwBudget", Math.round(endpoints * c.hw));
}

/* ===== Synthetic marker UX: blue dot + auto-clear on manual edits ===== */
function applySyntheticTitles(){
  document.querySelectorAll('input[data-synthetic="1"], select[data-synthetic="1"], textarea[data-synthetic="1"]').forEach(el=>{
    if(!el.title) el.title = "–°–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ (–±—ã—Å—Ç—Ä–æ–µ –∏–Ω—Ç–µ—Ä–≤—å—é). –ò–∑–º–µ–Ω–∏—Ç–µ –≤—Ä—É—á–Ω—É—é ‚Äî –º–µ—Ç–∫–∞ –∏—Å—á–µ–∑–Ω–µ—Ç.";
  });
}

// Clear marker once user changes value manually
function installSyntheticAutoClear(){
  const clear = (el)=>{
    if(!el || !el.dataset) return;
    if(el.dataset.synthetic === "1"){
      delete el.dataset.synthetic;
      el.title = "";
    }
  };
  document.addEventListener("input", (e)=>clear(e.target), true);
  document.addEventListener("change", (e)=>clear(e.target), true);
}
installSyntheticAutoClear();

// Ensure titles are applied after quick synthetics
try{
  const __origApplyQuickSynthetics = applyQuickSynthetics;
  applyQuickSynthetics = function(){
    __origApplyQuickSynthetics();
    applySyntheticTitles();
  };
}catch(_e){}


// If user edits a field we previously filled synthetically ‚Äî stop treating it as synthetic.
document.addEventListener("input",(e)=>{
  const t = e.target;
  if(t && t.dataset && t.dataset.synthetic === "1"){
    t.dataset.synthetic = "0";
  }
},{capture:true});
/* ====================================================================== */


function setText(id, val){
  const el=document.getElementById(id);
  if(el) el.textContent = val;
}
function paintIf(id, pct, isPct){
  const el=document.getElementById(id);
  if(!el) return;
  paintStat(id, pct, isPct);
}

// ===== v60 FIX: missing helpers used by recalc/export/sync =====
function clamp(n, a, b){ n=Number(n); if(!isFinite(n)) return a; return Math.max(a, Math.min(b, n)); }
function maturityLevel(avg){
  avg = Number(avg); if(!isFinite(avg)) return "‚Äî";
  if(avg < 40) return "–ù–∏–∑–∫–∞—è";
  if(avg < 70) return "–°—Ä–µ–¥–Ω—è—è";
  return "–í—ã—Å–æ–∫–∞—è";
}
function computeCriticality(lossTotal, riskIndex, maturityAvg){
  // lossTotal may be in money; convert to a 0-100 signal using log scaling.
  const loss = Number(lossTotal);
  const lossScore = isFinite(loss) && loss>0 ? clamp((Math.log10(loss+1)/7)*100, 0, 100) : 0; // ~ up to 10^7
  const r = clamp(riskIndex, 0, 100);
  const m = clamp(maturityAvg, 0, 100);
  // higher risk + higher loss + lower maturity => higher criticality
  const crit = 0.45*lossScore + 0.35*r + 0.20*(100-m);
  return Math.round(clamp(crit, 0, 100));
}
function criticalityLabel(crit){
  crit = Number(crit); if(!isFinite(crit)) return "‚Äî";
  if(crit < 30) return "–ù–∏–∑–∫–∞—è";
  if(crit < 60) return "–°—Ä–µ–¥–Ω—è—è";
  if(crit < 80) return "–í—ã—Å–æ–∫–∞—è";
  return "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è";
}

// --- v61: required-fields UI refresh (was missing and broke Excel/save) ---
function updateRequiredUI(){
  try{
    const companyEl = document.getElementById('company');
    if(companyEl){
      const missing = !(companyEl.value || '').trim();
      companyEl.classList.toggle('req-miss', missing);
      // If there is a required-dot element, toggle it too
      const dot = document.querySelector('[data-required-dot="company"]') || document.getElementById('reqDotCompany');
      if(dot) dot.style.opacity = missing ? '1' : '0.25';
    }
  }catch(_e){}
}

function recalc(){
  let recover = NaN; // prevent TDZ (used before computed)

  // During reverse-sync (loading from Google Sheets) we dispatch many change/input
  // events. Recalc must stay safe and MUST NOT trigger any automatic save.
  window.__ITMEN_IS_LOADING = window.__ITMEN_IS_LOADING === true;

  console.log("recalc() clicked", new Date().toISOString());
  try{ applyQuickSynthetics(); }catch(e){}


// maturity indices (with benchmark fallback)
const techSel=[...document.querySelectorAll(".tech-score")];
const procSel=[...document.querySelectorAll(".proc-score")];
const riskSel=[...document.querySelectorAll(".risk-score")];

const techAnswered=techSel.filter(s=>String(s.value).trim()!=="").map(s=>clampInt(s.value,0,2));
const procAnswered=procSel.filter(s=>String(s.value).trim()!=="").map(s=>clampInt(s.value,0,2));
const riskAnswered=riskSel.filter(s=>String(s.value).trim()!=="").map(s=>clampInt(s.value,0,1));
const riskScores = riskAnswered;

const modeTop = (document.getElementById("benchMode")?.value || "mixed"); // mixed|client|bench

// benchmark-based fallbacks for maturity/risk (segment-aware)
const estM = {};
estM.techMaturityPct = estimateParam("techMaturityPct", {elId:"__none__"});
estM.procMaturityPct = estimateParam("procMaturityPct", {elId:"__none__"});
estM.riskProb = estimateParam("riskProb", {elId:"__none__"});

const techIndex = (techAnswered.length>0)
  ? Math.round((avg(techAnswered)/2)*100)
  : (modeTop==="client" ? NaN : Math.round(estM.techMaturityPct.v));

const procIndex = (procAnswered.length>0)
  ? Math.round((avg(procAnswered)/2)*100)
  : (modeTop==="client" ? NaN : Math.round(estM.procMaturityPct.v));

const riskIndex = (riskAnswered.length>0)
  ? riskAnswered.reduce((a,b)=>a+b,0)
  : (modeTop==="client" ? NaN : Math.round(clamp(estM.riskProb.v,0,1)*riskSel.length));

  setText("techIndex", isFinite(techIndex)? `${techIndex}%` : "‚Äî%");
  setText("procIndex", isFinite(procIndex)? `${procIndex}%` : "‚Äî%");
  setText("riskIndex", isFinite(riskIndex)? `${riskIndex}` : "‚Äî");

  paintIf("kTech", techIndex, true);
  paintIf("kProc", procIndex, true);
  paintRisk(riskIndex);

  // ===== Data estimation (client + benchmark) =====
  const est = {};
  est.manualPct = estimateParam("manualPct", {elId:"manualPct"});
  est.unusedPct = estimateParam("unusedPct", {elId:"unusedPct"});
  est.vmUnusedPct = estimateParam("vmUnusedPct", {elId:"vmUnusedPct"});
  est.downtimeHours = estimateParam("downtimeHours", {elId:"downtimeHours"});
  est.downtimeCost = estimateParam("downtimeCost", {elId:"downtimeCost"});
  est.incidentsPerMonth = estimateParam("incidentsPerMonth", {elId:"incidentsPerMonth"});
  est.obsoletePct = estimateParam("obsoletePct", {elId:"obsoletePct"});
  est.keyPeopleRisk = estimateParam("keyPeopleRisk", {elId:"keyPeopleRisk"});
  est.docScore = estimateParam("docScore", {elId:"docScore"});

  // store last estimates for UI + modal
  LAST_EST.params = est;

  // overall accuracy proxy (0..100)
  const accKeys = ["manualPct","unusedPct","vmUnusedPct","downtimeHours","downtimeCost","incidentsPerMonth","obsoletePct","keyPeopleRisk","docScore"];
  const acc = accKeys.reduce((a,k)=>a + srcWeight(est[k]?.src||"missing"),0) / accKeys.length;
  LAST_EST.accuracy = Math.round(acc*100);

  updateDataAccuracyUI();
  updateTopQuestions();

  // Cost of inaction
  const salary=+document.getElementById("salary").value||0;
  const itCount=+document.getElementById("itCount").value||0;
  const manualPct=(isFinite(est.manualPct.v)?est.manualPct.v:0)/100;
  const licBudget=+document.getElementById("licBudget").value||0;
  const unusedPct=(isFinite(est.unusedPct.v)?est.unusedPct.v:0)/100;
  const downtimeHours=isFinite(est.downtimeHours.v)?est.downtimeHours.v:0;
  const downtimeCost=isFinite(est.downtimeCost.v)?est.downtimeCost.v:0;

  const lossManual=salary*12*itCount*manualPct;
  const lossUnused=licBudget*unusedPct;
  const lossDowntime=downtimeHours*downtimeCost;
  const lossTotal=lossManual+lossUnused+lossDowntime;

  setText("coiRub", fmtMoney(lossTotal));
  setText("coiBreakdown", `–†—É—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏: ${fmtMoney(lossManual)} ¬∑ –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–µ –ü–û: ${fmtMoney(lossUnused)} ¬∑ –ü—Ä–æ—Å—Ç–æ–∏: ${fmtMoney(lossDowntime)}`);
  paintIf("kCoI", lossTotal>0 ? 10 : NaN, false); // just adds outline if filled

  // Feasibility from requirements
  const reqRows=[...document.querySelectorAll("#reqTbody tr")];
  const feasVals=[];
  let totalReq=0, mustReq=0;
  reqRows.forEach(r=>{
    const text=(r.querySelector(".req-text")?.value||"").trim();
    if(!text) return;
    totalReq += 1;
    const must = r.querySelector(".req-must")?.value || "–î–∞";
    if(must==="–î–∞") mustReq += 1;
    const feas = r.querySelector(".req-feas")?.value || "‚Äî";
    const opt = FEAS_OPTIONS.find(o=>o.label===feas);
    if(opt && typeof opt.score === "number") feasVals.push(opt.score);
  });
  const estFeas = estimateParam("feasibilityPct", {elId:"__none__"});
  const feasPct = feasVals.length ? Math.round(avg(feasVals)*100) : ((modeTop==="client")?NaN:Math.round(estFeas.v));
  setText("feasScore", isFinite(feasPct) ? `${feasPct}%` : "‚Äî%");
  paintIf("kFeas", isFinite(feasPct)?feasPct:NaN, true);

  // Product requirements feasibility (section 6)
  const prodReqRows=[...document.querySelectorAll("#prodReqTbody tr")];
  const prodFeasVals=[];
  prodReqRows.forEach(r=>{
    const func=(r.querySelector(".prod-func")?.value||"").trim();
    const biz=(r.querySelector(".prod-biz")?.value||"").trim();
    if(!func && !biz) return;
    const feas = r.querySelector(".prod-feas")?.value || "‚Äî";
    const opt = PROD_FEAS_OPTIONS.find(o=>o.label===feas);
    if(opt && typeof opt.score === "number") prodFeasVals.push(opt.score);
  });
  const prodFeasPct = prodFeasVals.length ? Math.round(avg(prodFeasVals)*100) : NaN;
  const prodEl=document.getElementById("prodFeasScore");
  if(prodEl) prodEl.textContent = isFinite(prodFeasPct) ? `${prodFeasPct}%` : "‚Äî%";
  if(document.getElementById("kProdFeas")) paintIf("kProdFeas", isFinite(prodFeasPct)?prodFeasPct:NaN, true);

  // ----- Criticality & client summary -----
  const maturityAvg = Math.round((techIndex + procIndex) / 2);
  const crit = computeCriticality(lossTotal, riskIndex, maturityAvg);
  const critLbl = criticalityLabel(crit);

  const critScoreEl=document.getElementById("critScore"); if(critScoreEl) critScoreEl.textContent = isFinite(crit) ? (crit + "%") : "‚Äî%";
  const critLabelEl=document.getElementById("critLabel"); if(critLabelEl) critLabelEl.textContent = critLbl;

  const mLvl = maturityLevel(maturityAvg);
  const coiText = fmtMoney(lossTotal);
  const maturityLevelTextEl=document.getElementById("maturityLevelText"); if(maturityLevelTextEl) maturityLevelTextEl.value = mLvl;
  const critLabelClientEl=document.getElementById("critLabelClient"); if(critLabelClientEl) critLabelClientEl.value = critLbl;
  const coiClientEl=document.getElementById("coiClient"); if(coiClientEl) coiClientEl.value = coiText;
  const clientOneLinerEl=document.getElementById("clientOneLiner"); if(clientOneLinerEl) clientOneLinerEl.value = `–ó—Ä–µ–ª–æ—Å—Ç—å: ${mLvl}. –ü–æ—Ç–µ—Ä–∏: ${coiText}/–≥–æ–¥. –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${critLbl}.`;

  try{
// ----- Project risks table (internal control) -----
  const risks = [];
  risks.push({name:"–ó—Ä–µ–ª–æ—Å—Ç—å", cond:"–°—Ä–µ–¥–Ω—è—è –∑—Ä–µ–ª–æ—Å—Ç—å < 40%", hit: maturityAvg < 40, note:`–°–µ–π—á–∞—Å: ${maturityAvg}%`});
  risks.push({name:"–†–∏—Å–∫-–ø—Ä–æ—Ñ–∏–ª—å", cond:"–ò–Ω–¥–µ–∫—Å —Ä–∏—Å–∫–∞ ‚â• 3", hit: riskIndex >= 3, note:`–°–µ–π—á–∞—Å: ${riskIndex}`});
  risks.push({name:"–†–µ–∞–ª–∏–∑—É–µ–º–æ—Å—Ç—å", cond:"–ò–Ω–¥–µ–∫—Å —Ä–µ–∞–ª–∏–∑—É–µ–º–æ—Å—Ç–∏ < 60%", hit: isFinite(feasPct) ? (feasPct < 60) : true, note:`–°–µ–π—á–∞—Å: ${isFinite(feasPct)?feasPct:"‚Äî"}%`});
  const reqFilled = [...document.querySelectorAll("#reqTbody tr")].some(r=> (r.querySelector(".req-text")?.value||"").trim());
  risks.push({name:"–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è", cond:"–ù–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π", hit: !reqFilled, note: reqFilled ? "OK" : "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ä–µ–µ—Å—Ç—Ä —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π"});
  const hasLpr = ((document.getElementById("lpr")?.value||"").trim().length > 0);
  risks.push({name:"–õ–ü–†", cond:"–ù–µ —É–∫–∞–∑–∞–Ω –õ–ü–†/–∫–æ–Ω—Ç–∞–∫—Ç", hit: !hasLpr, note: hasLpr ? "OK" : "–£–∫–∞–∂–∏—Ç–µ –õ–ü–†"});

  const hitCount = risks.filter(r=>r.hit).length;
  const riskLevel = hitCount >= 3 ? "–í—ã—Å–æ–∫–∏–π" : (hitCount === 2 ? "–°—Ä–µ–¥–Ω–∏–π" : "–ù–∏–∑–∫–∏–π");
  const riskLevelEl = document.getElementById("riskLevelText");
  if(riskLevelEl) riskLevelEl.value = `${riskLevel} (—Ç—Ä–∏–≥–≥–µ—Ä–æ–≤: ${hitCount})`;

  const tb = document.getElementById("projectRisks");
  if(tb){
    tb.innerHTML = "";
    risks.forEach(r=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `<td><b>${r.name}</b></td><td>${r.cond}</td><td>${r.hit ? "‚ö†Ô∏è –ï—Å—Ç—å —Ä–∏—Å–∫" : "‚úÖ –û–ö"}</td><td>${r.note||""}</td>`;
      tb.appendChild(tr);
    });
  }


  // ----- Indices: Pain / Readiness / Deal probability -----
  const projCostBase = ( (+document.getElementById("workplaces")?.value||0) + (+document.getElementById("servers")?.value||0) ) * 1300;
  const capPain = projCostBase > 0 ? projCostBase : 5_000_000;
  const painScore = ((lossTotal/capPain)*0.6) + (manualPct*0.2) + ((lossDowntime/capPain)*0.2);
  const painPct = Math.round(clamp(painScore, 0, 2) * 50); // 0..100
  setText("painIndex", isFinite(painPct) ? `${painPct}%` : "‚Äî%");
  setText("painLabel", painLevelLabel(painPct));
  paintIf("kPain", isFinite(painPct)?painPct:NaN, true);

  const missingNow = validateRequired();
  const hasCompany = !missingNow.includes("–ö–æ–º–ø–∞–Ω–∏—è");
  const hasSources = ((document.getElementById("sources")?.value||"").trim().length > 0);
  const hasReq = reqFilled;
  const hasPsi2 = !missingNow.some(x=>x.startsWith("–ü–°–ò:"));
  const feasOk = isFinite(feasPct) ? (feasPct >= 50) : false;
  const riskOk = riskIndex <= 3;
  const readinessParts = [hasCompany, hasSources, hasReq, hasPsi2, feasOk, riskOk];
  const readyPct = Math.round(100 * (readinessParts.filter(Boolean).length / readinessParts.length));
  setText("readyIndex", isFinite(readyPct) ? `${readyPct}%` : "‚Äî%");
  setText("readyLabel", readinessLabel(readyPct));
  paintIf("kReady", isFinite(readyPct)?readyPct:NaN, true);

  const riskNorm = clamp(riskIndex/5, 0, 1);
  // Updated win probability: considers PSI + maturity + feasibility (pilot/product) + finance pressure/return
  const psi2Num = (function(){
    const t=(document.getElementById("psi2Score")?.textContent||"").replace("%","").trim();
    const n=parseFloat(t.replace(",","."));
    return Number.isFinite(n)?n:NaN;
  })();
  const psi2Norm = isFinite(psi2Num) ? clamp(psi2Num/100,0,1) : 0;
  const feasPilotNorm = isFinite(feasPct) ? clamp(feasPct/100,0,1) : 0;
  const feasProdNorm = isFinite(prodFeasPct) ? clamp(prodFeasPct/100,0,1) : 0;
  const techNorm = isFinite(techIndex) ? clamp(techIndex/100,0,1) : 0;
  const procNorm = isFinite(procIndex) ? clamp(procIndex/100,0,1) : 0;
  const returnNorm = (typeof recover==="number" && isFinite(recover)) ? clamp(recover/100,0,1) : 0;
  const pressureNorm = isFinite(painPct) ? clamp(painPct/100,0,1) : 0;
  const prob = (psi2Norm*0.25) + (feasPilotNorm*0.20) + (feasProdNorm*0.12) + (techNorm*0.15) + (procNorm*0.12) + (returnNorm*0.08) + (pressureNorm*0.08);
  const probPct = Math.round(clamp(prob, 0, 1) * 100);
  setText("probIndex", isFinite(probPct) ? `${probPct}%` : "‚Äî%");
  setText("probLabel", probabilityLabel(probPct));
  paintIf("kProb", isFinite(probPct)?probPct:NaN, true);

  // ===== Additional indices (PSI 2.0) =====
  const vmUnusedPct = (+document.getElementById("vmUnusedPct")?.value || 0);
  const keyPeopleRiskStr = (document.getElementById("keyPeopleRisk")?.value || "");
  let keyPeopleRisk = keyPeopleRiskStr === "–î–∞" ? 1 : (keyPeopleRiskStr === "–ù–µ—Ç" ? 0 : NaN);
  if(!isFinite(keyPeopleRisk) && isFinite(est.keyPeopleRisk.v)) keyPeopleRisk = est.keyPeopleRisk.v >= 0.5 ? 1 : 0;
  const docScoreRaw = (document.getElementById("docScore")?.value || "").trim();
  let docScore = docScoreRaw==="" ? NaN : clampInt(docScoreRaw, 0, 2);
  if(!isFinite(docScore) && isFinite(est.docScore.v)) docScore = clampInt(String(Math.round(est.docScore.v)), 0, 2);
  const obsoletePct = isFinite(est.obsoletePct.v)?est.obsoletePct.v:(+document.getElementById("obsoletePct")?.value || 0);

  // Recoverable Budget Index (licenses + VM) ‚Äî higher is better
  const L = clamp((isFinite(est.unusedPct.v)?est.unusedPct.v:(+document.getElementById("unusedPct").value || 0))/100, 0, 1);
  const V = clamp((isFinite(est.vmUnusedPct.v)?est.vmUnusedPct.v:vmUnusedPct)/100, 0, 1);
  const L_norm = clamp(L/0.25, 0, 1);
  const V_norm = clamp(V/0.30, 0, 1);
  recover = 100 * (1 - (0.6*L_norm + 0.4*V_norm));
  recover = Math.round(clamp(recover, 0, 100));
  setText("recoverIndex", isFinite(recover) ? `${recover}%` : "‚Äî%");
  setText("recoverLabel", recover>=75 ? "–í—ã—Å–æ–∫–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª" : (recover>=45 ? "–°—Ä–µ–¥–Ω–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª" : "–ù–∏–∑–∫–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª"));
  paintIf("kRecover", isFinite(recover)?recover:NaN, true);

  // Bus-factor Index ‚Äî higher is better
  let bus = NaN;
  if(isFinite(keyPeopleRisk)) {
    bus = 100 - (keyPeopleRisk*40 + (2 - docScore)*20);
    bus = Math.round(clamp(bus, 0, 100));
  }
  setText("busIndex", isFinite(bus) ? `${bus}%` : "‚Äî%");
  setText("busLabel", isFinite(bus) ? (bus>=75 ? "–ù–∏–∑–∫–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å" : (bus>=45 ? "–°—Ä–µ–¥–Ω—è—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å" : "–í—ã—Å–æ–∫–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å")) : "‚Äî");
  paintIf("kBus", isFinite(bus)?bus:NaN, true);

  // Tech Obsolescence Index ‚Äî higher is better
  const ageSel = (document.getElementById("hwAge")?.value || "");
  const ageFactor = (ageSel==="–¥–æ 3 –ª–µ—Ç") ? 10 : (ageSel==="3‚Äì5 –ª–µ—Ç" ? 25 : (ageSel==="5+ –ª–µ—Ç" ? 45 : 0));
  let obsol = 100 - (clamp(obsoletePct,0,100)*1.2 + ageFactor);
  obsol = Math.round(clamp(obsol, 0, 100));
  setText("obsolIndex", isFinite(obsol) ? `${obsol}%` : "‚Äî%");
  setText("obsolLabel", obsol>=75 ? "–û–ö" : (obsol>=45 ? "–ù—É–∂–Ω–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è" : "–í—ã—Å–æ–∫–∏–π —Ç–µ—Ö–¥–æ–ª–≥"));
  paintIf("kObsol", isFinite(obsol)?obsol:NaN, true);

  // AI Readiness Index ‚Äî higher is better (tech+proc+richness of sources)
  const sourcesStr = (document.getElementById("sources")?.value || "");
  const srcCount = sourcesStr.split(",").map(s=>s.trim()).filter(Boolean).length;
  const srcNorm = clamp(srcCount/6, 0, 1);
  let ai = ( (isFinite(techIndex)?techIndex:0) * 0.50 ) + ( (isFinite(procIndex)?procIndex:0) * 0.30 ) + (srcNorm * 100 * 0.20);
  ai = Math.round(clamp(ai, 0, 100));
  setText("aiIndex", isFinite(ai) ? `${ai}%` : "‚Äî%");
  setText("aiLabel", ai>=75 ? "–ì–æ—Ç–æ–≤–æ" : (ai>=45 ? "–ß–∞—Å—Ç–∏—á–Ω–æ –≥–æ—Ç–æ–≤–æ" : "–ù—É–∂–Ω–æ –Ω–∞–≤–µ—Å—Ç–∏ –ø–æ—Ä—è–¥–æ–∫ –≤ –¥–∞–Ω–Ω—ã—Ö"));
  paintIf("kAI", isFinite(ai)?ai:NaN, true);

  // Cost of Inaction score for PSI (normalize by baseline spend, 0‚Äì4% = ok)
  const hwBudget = (+document.getElementById("hwBudget")?.value || 0);
  const baseline = (salary*12*itCount) + licBudget + hwBudget;
  let coiScore = NaN;
  if(baseline>0){
    const share = clamp(lossTotal / baseline, 0, 1);
    coiScore = 100 * (1 - clamp(share/0.04, 0, 1)); // 4% = 0 score, 0% = 100
    coiScore = Math.round(clamp(coiScore, 0, 100));
  }

  // Regulatory readiness proxy (based on risk flags: audits + unaccounted software)
  const auditIdx = RISK.findIndex(x=>x.label && x.label.toLowerCase().includes("–ø—Ä–æ–≤–µ—Ä"));
  const unlicensedIdx = RISK.findIndex(x=>x.label && x.label.toLowerCase().includes("–Ω–µ—É—á—Ç–µ–Ω–Ω—ã—Ö —É—Å—Ç–∞–Ω–æ–≤–æ–∫"));
  const auditFlag = auditIdx>=0 ? (riskScores[auditIdx]||0) : 0;
  const unlicensedFlag = unlicensedIdx>=0 ? (riskScores[unlicensedIdx]||0) : 0;
  const reg = Math.round(clamp(100 - (auditFlag*40 + unlicensedFlag*60), 0, 100));

  // IT Reactivity proxy (incidents + manual ops)
  const incidentsPerMonth = isFinite(est.incidentsPerMonth.v)?est.incidentsPerMonth.v:(+document.getElementById("incidentsPerMonth")?.value || 0);
  const incNorm = clamp(incidentsPerMonth/30, 0, 1);
  const manNorm = clamp((isFinite(est.manualPct.v)?est.manualPct.v:(+document.getElementById("manualPct").value||0))/60, 0, 1);
  const reactivity = Math.round(100 * (1 - clamp(0.6*incNorm + 0.4*manNorm, 0, 1)));

  // Change maturity proxy (use process maturity)
  const change = Math.round(clamp(procIndex,0,100));

  // Scalability proxy (branches + growth risk flag)
  const branches = (+document.getElementById("branches")?.value || 0);
  const growthIdx = RISK.findIndex(x=>x.label && x.label.toLowerCase().includes("—Ä–∞—Å—Ç–µ—Ç/–º–µ–Ω—è–µ—Ç—Å—è"));
  const growthFlag = growthIdx>=0 ? (riskScores[growthIdx]||0) : 0;
  const brNorm = clamp(branches/20, 0, 1);
  const scalability = Math.round(clamp( (techIndex*0.5 + procIndex*0.3 + (1 - (0.6*brNorm + 0.4*growthFlag))*100*0.2), 0, 100));

  // PSI 2.0 weighted score (0‚Äì100)
  const w = {
    coi:0.20, recover:0.15, control:0.15, bus:0.10, reg:0.10,
    obsol:0.10, react:0.08, change:0.05, scale:0.04, ai:0.03
  };
  const control = Math.round(clamp(techIndex,0,100));
  const parts = [
    {v:coiScore, w:w.coi},
    {v:recover, w:w.recover},
    {v:control, w:w.control},
    {v:bus, w:w.bus},
    {v:reg, w:w.reg},
    {v:obsol, w:w.obsol},
    {v:reactivity, w:w.react},
    {v:change, w:w.change},
    {v:scalability, w:w.scale},
    {v:ai, w:w.ai},
  ];
  const normalizedParts = parts.map(p=>({v:Number(p.v), w:Number(p.w)}));
  const valid = normalizedParts.filter(p=>Number.isFinite(p.v) && Number.isFinite(p.w) && p.w>0);
  const sumW = valid.reduce((a,p)=>a+p.w,0);
  let psi2 = NaN;
  if(sumW>0){
    psi2 = valid.reduce((a,p)=>a + p.v*p.w,0) / sumW;
    psi2 = Math.round(clamp(psi2, 0, 100));

    // NOTE: legacy variable `core` was undefined and broke recalc, which prevented
    // Heatmap/Pilot Readiness from updating.
  }
  setText("psi2Score", isFinite(psi2) ? `${psi2}%` : "‚Äî%");
  setText("psi2Label", isFinite(psi2) ? (psi2>=75 ? "–ó–µ–ª—ë–Ω–∞—è –∑–æ–Ω–∞" : (psi2>=45 ? "–ñ—ë–ª—Ç–∞—è –∑–æ–Ω–∞" : "–ö—Ä–∞—Å–Ω–∞—è –∑–æ–Ω–∞")) : "‚Äî");
  try{ paintIf("kPSI", Number.isFinite(psi2)?psi2:NaN, true); }catch(_e){}
  try{ renderBenchHints(); }catch(_e){}


  // ==== Heatmap / Pilot Readiness / Modules / Demo / COI breakdown ====
  try{
    const hm = computeHeatmapFromMaturity();
    const g = hm["–°–µ—Ä—ã–µ –∑–æ–Ω—ã (–æ—Ö–≤–∞—Ç / –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)"];
    const l = hm["–õ–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π —Ä–∏—Å–∫"];
    const o = hm["–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å / —Ä—É—á–Ω–æ–π —Ç—Ä—É–¥"];
    const v = hm["–£–ø—Ä–∞–≤–ª—è–µ–º–æ—Å—Ç—å / –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏—Å—Ç–æ—Ä–∏–∏"];
    const overall = hm.__overall;

    function setBar(pctId, barId, val){
      const el=document.getElementById(pctId);
      const bar=document.getElementById(barId);
      if(!el || !bar) return;
      if(val===null){ el.textContent="‚Äî%"; bar.style.width="0%"; return; }
      const p=Math.max(0, Math.min(100, Math.round(val*100)));
      el.textContent=p+"%";
      bar.style.width=p+"%";
    }
    setBar("riskGreyPct","riskGreyBar",g);
    setBar("riskLicPct","riskLicBar",l);
    setBar("riskOpsPct","riskOpsBar",o);
    setBar("riskGovPct","riskGovBar",v);

    // Pilot readiness
    const prEl=document.getElementById("pilotReady");
    const prLab=document.getElementById("pilotReadyLabel");
    if(prEl){
      if(overall===null){ prEl.textContent="‚Äî%"; prLab && (prLab.textContent="–ó–∞–ø–æ–ª–Ω–∏ –∑—Ä–µ–ª–æ—Å—Ç—å (2.1/2.2)"); }
      else{
        const pr = Math.max(0, Math.min(100, Math.round((1-overall)*100)));
        prEl.textContent = pr+"%";
        if(prLab){
          prLab.textContent = (pr<50) ? "–ü–∏–ª–æ—Ç —Å–ª–æ–∂–Ω—ã–π" : (pr<70) ? "–ü–∏–ª–æ—Ç —Å—Ä–µ–¥–Ω–∏–π" : "–ë—ã—Å—Ç—Ä—ã–π –ø–∏–ª–æ—Ç";
        }
      }
    }

    // Main problem
    const mp=document.getElementById("mainProblem");
    const mph=document.getElementById("mainProblemHint");
    if(mp){
      mp.textContent = hm.__mainZone || "‚Äî";
      if(mph){
        mph.textContent = (hm.__mainZone && hm.__mainRisk!==null) ? ("–†–∏—Å–∫: "+Math.round(hm.__mainRisk*100)+"%") : "–ó–∞–ø–æ–ª–Ω–∏ –∑—Ä–µ–ª–æ—Å—Ç—å (2.1/2.2)";
      }
    }

    // Modules
    const mods=decideModules(hm);
    const rm=document.getElementById("recModules");
    if(rm) rm.textContent = mods.join(" + ");

    // Demo focus (top functions)
    const dp=buildDemoPlan(hm);
    const dfe=document.getElementById("demoFocus");
    const dff=document.getElementById("demoFocusHint");
    if(dfe) dfe.textContent=dp.title;
    if(dff) dff.innerHTML=dp.html;

    // COI breakdown
    const coi = computeCOIBreakdown();
    const coiLic=document.getElementById("coiLic");
    const coiDown=document.getElementById("coiDown");
    const coiManual=document.getElementById("coiManual");
    const coiTotal=document.getElementById("coiTotal");
    coiLic && (coiLic.textContent=_fmtRub(coi.licLoss));
    coiDown && (coiDown.textContent=_fmtRub(coi.downLoss));
    coiManual && (coiManual.textContent=_fmtRub(coi.manualLoss));
    coiTotal && (coiTotal.textContent=_fmtRub(coi.total));
  }catch(e){ console.warn("heatmap/calc failed", e); }


}catch(e){ console.error('recalc tail error', e); }
// Required fields gate (PDF)

  // Always recompute PSI from DOM as a final fallback
  try{ if(!isFinite(parseFloat((document.getElementById('psi2Score')?.textContent||'').replace('%','')))) computePSIFromDom(); }catch(_e){}
  updateRequiredUI();
}

function collect(){
  const get=id=>document.getElementById(id)?.value ?? "";
  return {
    meta:{
      company:get("company"), industry:get("industry"), sales_manager:get("sales_manager"), presale_manager:get("presale_manager"), lpr:get("lpr"),
      workplaces:+get("workplaces")||0, servers:+get("servers")||0, branches:+get("branches")||0,
      vdi:get("vdi"), closed:get("closed"), sources:get("sources"), envNote:get("envNote"), benchMode:get("benchMode"), interviewMode:get("interviewMode"), pdfMode:get("pdfMode"),
      virt:get("virt"), hostingModel:get("hostingModel"), adDomains:get("adDomains"), netSeg:get("netSeg"), terminalFarms:get("terminalFarms"), hwAge:get("hwAge"), hwAccounting:get("hwAccounting"), redundancy:get("redundancy")
    },
    maturity:{
      tech: TECH.map((k,i)=>({key:k, score: clampInt(document.querySelectorAll(".tech-score")[i].value,0,2), note: document.querySelectorAll(".tech-note")[i].value||""})),
      proc: PROC.map((k,i)=>({key:k, score: clampInt(document.querySelectorAll(".proc-score")[i].value,0,2), note: document.querySelectorAll(".proc-note")[i].value||""})),
      risk: RISK.map((k,i)=>({key:k, score: clampInt(document.querySelectorAll(".risk-score")[i].value,0,1), note: document.querySelectorAll(".risk-note")[i].value||""})),
    },
    finance:{
      salary:+get("salary")||0, itCount:+get("itCount")||0, manualPct:+get("manualPct")||0,
      licBudget:+get("licBudget")||0, unusedPct:+get("unusedPct")||0, vmUnusedPct:+get("vmUnusedPct")||0,
      hwBudget:+get("hwBudget")||0, hwPlan:get("hwPlan"),
      downtimeHours:+get("downtimeHours")||0, downtimeCost:+get("downtimeCost")||0,
      incidentsPerMonth:+get("incidentsPerMonth")||0, serviceDesk:get("serviceDesk"),
      keyPeopleRisk:get("keyPeopleRisk"), docScore:clampInt(get("docScore"),0,2), obsoletePct:+get("obsoletePct")||0,
      note:get("finNote")
    },
    requirements:[...document.querySelectorAll("#reqTbody tr")].map(r=>({
      text:r.querySelector(".req-text")?.value||"",
      type:r.querySelector(".req-type")?.value||"–¢–µ—Ö",
      must:r.querySelector(".req-must")?.value||"–î–∞",
      feas:r.querySelector(".req-feas")?.value||"‚Äî",
      metric:r.querySelector(".req-metric")?.value||"",
      owner:r.querySelector(".req-owner")?.value||"",
    })),
    productRequirements:[...document.querySelectorAll("#prodReqTbody tr")].map(r=>({
      biz:r.querySelector(".prod-biz")?.value||"",
      func:r.querySelector(".prod-func")?.value||"",
      type:r.querySelector(".prod-type")?.value||"–¢–µ—Ö",
      must:r.querySelector(".prod-must")?.value||"–î–∞",
      feas:r.querySelector(".prod-feas")?.value||"‚Äî",
    })),
    psi:[...document.querySelectorAll("#psiTbody tr")].map(r=>({
      req:r.querySelector(".psi-req")?.value||"",
      scn:r.querySelector(".psi-scn")?.value||"",
      exp:r.querySelector(".psi-exp")?.value||"",
      act:r.querySelector(".psi-act")?.value||"",
      ok:r.querySelector(".psi-ok")?.value||"",
      acc:r.querySelector(".psi-acc")?.value||"",
      note:r.querySelector(".psi-note")?.value||"",
    })),
    pilot:{
      goal:get("pilotGoal"), tasks:get("pilotTasks_removed"), kpi:get("pilotKpi_removed"), scope:get("pilotScope"),
      summary:get("pilotSummary"), decision:get("pilotDecision"), recommendedConfig:get("recommendedConfig")
    },
    projectRisks:{
      level:(document.getElementById("riskLevelText")?.value||""),
      notes:(document.getElementById("riskNotes")?.value||""),
      table:[...document.querySelectorAll("#projectRisks tr")].map(r=>({
        indicator:(r.querySelector("td:nth-child(1)")?.innerText||"").trim(),
        condition:(r.querySelector("td:nth-child(2)")?.innerText||"").trim(),
        status:(r.querySelector("td:nth-child(3)")?.innerText||"").trim(),
        comment:(r.querySelector("td:nth-child(4)")?.innerText||"").trim(),
      }))
    },
    kpi:{
      psi2:(document.getElementById("psi2Score")?.textContent||"").trim(),
      psi2Zone:(document.getElementById("psi2Label")?.textContent||"").trim(),
      tech:(document.getElementById("techIndex")?.textContent||"").trim(),
      proc:(document.getElementById("procIndex")?.textContent||"").trim(),
      risk:(document.getElementById("riskIndex")?.textContent||"").trim(),
      coi:(document.getElementById("coiTotal")?.textContent||"").trim(),
      feas:(document.getElementById("feasScore")?.textContent||"").trim(),
      prodFeas:(document.getElementById("prodFeasScore")?.textContent||"").trim(),
      pain:(document.getElementById("painIndex")?.textContent||"").trim(),
      ready:(document.getElementById("readyIndex")?.textContent||"").trim(),
      prob:(document.getElementById("probIndex")?.textContent||"").trim(),
      recover:(document.getElementById("recoverIndex")?.textContent||"").trim(),
      bus:(document.getElementById("busIndex")?.textContent||"").trim(),
      obsol:(document.getElementById("obsolIndex")?.textContent||"").trim(),
      ai:(document.getElementById("aiIndex")?.textContent||"").trim(),
      crit:(document.getElementById("critScore")?.textContent||"").trim(),
      critLabel:(document.getElementById("critLabel")?.textContent||"").trim(),
    },
    audit:{
      savedAt:new Date().toISOString(),
      version:"v7.0 (excel+gsync)"
    }
  };
}


function flattenForSheets(raw){
  // –î–µ–ª–∞–µ—Ç –ø–ª–æ—Å–∫–∏–π –æ–±—ä–µ–∫—Ç –¥–ª—è Google Sheets: –∫–ª—é—á–∏ –∏–∑ —à–∞–ø–∫–∏ (1-—è —Å—Ç—Ä–æ–∫–∞) –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞—Å—Ç—å.
  // 1) meta.* –ø–æ–¥–Ω–∏–º–∞–µ–º –Ω–∞ –≤–µ—Ä—Ö–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å (company, industry, ...).
  // 2) –¢–∞–∫–∂–µ –∫–ª–∞–¥–µ–º –≤—Å–µ –ø—É—Ç–∏ –≤–∏–¥–∞ a.b.c (–µ—Å–ª–∏ –≤ —à–∏—Ç–µ —Ç–∞–∫ –Ω–∞–∑–≤–∞–ª–∏ –∫–æ–ª–æ–Ω–∫—É).
  // 3) –ü–æ–ª–Ω—ã–π –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π payload –¥—É–±–ª–∏—Ä—É–µ–º –≤ –ø–æ–ª–µ 'payload' (–µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å –≤ —à–∞–ø–∫–µ).
  const out = {};
  const seenLeaf = new Map(); // leafKey -> count

  function walk(cur, prefix){
    if(cur === null || cur === undefined) return;
    if(Array.isArray(cur)){
      out[prefix] = JSON.stringify(cur);
      return;
    }
    if(typeof cur === "object"){
      for(const k in cur){
        const key = prefix ? (prefix + "." + k) : k;
        walk(cur[k], key);
      }
      return;
    }
    out[prefix] = cur;
    const leaf = String(prefix).split(".").pop();
    seenLeaf.set(leaf, (seenLeaf.get(leaf)||0) + 1);
  }

  if(raw && typeof raw === "object"){
    walk(raw, "");
    // lift meta.*
    if(raw.meta && typeof raw.meta === "object"){
      for(const k in raw.meta){ out[k] = raw.meta[k]; }
    }
    // optional: lift KPI to simple names too
    if(raw.kpi && typeof raw.kpi === "object"){
      for(const k in raw.kpi){
        out[k] = out[k] ?? raw.kpi[k];         // if sheet uses 'psi2Score' etc
        out["kpi."+k] = raw.kpi[k];            // if sheet uses dot notation
      }
    }
    // include full payload
    out.payload = raw;
  }
  // Remove accidental empty key if any
  if(out[""] !== undefined) delete out[""];
  return out;
}




function apply(data){
  if(!data) return;
  const set=(id,v)=>{const el=document.getElementById(id); if(el) el.value = v ?? "";};

  const m=data.meta||{};
  set("company",m.company); set("industry",m.industry); set("lpr",m.lpr); set("sources",m.sources); set("envNote",m.envNote);
  set("workplaces",m.workplaces); set("servers",m.servers); set("branches",m.branches); set("vdi",m.vdi); set("closed",m.closed);
  set("benchMode",m.benchMode); set("interviewMode",m.interviewMode); set("pdfMode",m.pdfMode);

  const mat=data.maturity||{};
  if(mat.tech) mat.tech.forEach((x,i)=>{const s=document.querySelectorAll(".tech-score")[i]; const n=document.querySelectorAll(".tech-note")[i]; if(s) s.value=String(x.score??0); if(n) n.value=x.note??"";});
  if(mat.proc) mat.proc.forEach((x,i)=>{const s=document.querySelectorAll(".proc-score")[i]; const n=document.querySelectorAll(".proc-note")[i]; if(s) s.value=String(x.score??0); if(n) n.value=x.note??"";});
  if(mat.risk) mat.risk.forEach((x,i)=>{const s=document.querySelectorAll(".risk-score")[i]; const n=document.querySelectorAll(".risk-note")[i]; if(s) s.value=String(x.score??0); if(n) n.value=x.note??"";});

  const f=data.finance||{};
  set("salary",f.salary); set("itCount",f.itCount); set("manualPct",f.manualPct);
  set("licBudget",f.licBudget); set("unusedPct",f.unusedPct); set("vmUnusedPct",f.vmUnusedPct);
  set("hwBudget",f.hwBudget); set("hwPlan",f.hwPlan);
  set("downtimeHours",f.downtimeHours); set("downtimeCost",f.downtimeCost);
  set("incidentsPerMonth",f.incidentsPerMonth); set("serviceDesk",f.serviceDesk);
  set("keyPeopleRisk",f.keyPeopleRisk); set("docScore",f.docScore); set("obsoletePct",f.obsoletePct);
  set("finNote",f.note);

  // requirements
  const __reqTb=document.getElementById("reqTbody");
  if(__reqTb) __reqTb.innerHTML="";
  (data.requirements||[]).forEach(r=>addReqRow(r));
  // product requirements
  const prTb=document.getElementById("prodReqTbody");
  if(prTb){ prTb.innerHTML=""; (data.productRequirements||[]).forEach(r=>addProdReqRow(r)); }
  // psi
  const __psiTb=document.getElementById("psiTbody");
  if(__psiTb) __psiTb.innerHTML="";
  (data.psi||[]).forEach(r=>addPsiRow(r));
  const p=data.pilot||{};
  set("pilotGoal",p.goal); set("pilotTasks_removed",p.tasks); set("pilotKpi_removed",p.kpi); set("pilotScope",p.scope);
  set("pilotSummary",p.summary); set("pilotDecision",p.decision); set("recommendedConfig",p.recommendedConfig);

  const pr=(data.projectRisks||{});
  set("riskLevelText", pr.level);
  set("riskNotes", pr.notes);

  recalc();
}

function seedReq(){
  const presets=[
    {text:"–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ Active Directory / FreeIPA –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤", type:"–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏", must:"–î–∞", feas:"–ü–æ–ª–Ω–æ—Å—Ç—å—é", metric:"–û—Ç—á–µ—Ç/—Å–∫—Ä–∏–Ω –ø–æ –Ω–∞–π–¥–µ–Ω–Ω—ã–º –æ–±—ä–µ–∫—Ç–∞–º", owner:"–ö–ª–∏–µ–Ω—Ç+–ü—Ä–µ—Å–µ–π–ª"},
    {text:"–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è –ø–∏–ª–æ—Ç–Ω–æ–π –∑–æ–Ω—ã (‚â•95% —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –≤ –ø–µ—Ä–∏–º–µ—Ç—Ä–µ)", type:"–¢–µ—Ö", must:"–î–∞", feas:"–ü–æ–ª–Ω–æ—Å—Ç—å—é", metric:"–û—Ç—á–µ—Ç –ø–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º + —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å —ç—Ç–∞–ª–æ–Ω–æ–º", owner:"–ü—Ä–µ—Å–µ–π–ª"},
    {text:"–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –ü–û (–¥–æ–ª—è –Ω–µ—Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–æ–≥–æ ‚â§5%)", type:"–¢–µ—Ö", must:"–î–∞", feas:"–ß–∞—Å—Ç–∏—á–Ω–æ", metric:"–û—Ç—á–µ—Ç –ø–æ –ü–û", owner:"–ü—Ä–µ—Å–µ–π–ª"},
    {text:"–û—Ç—á–µ—Ç –ø–æ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω–æ–º—É/–Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ–º—É –ü–û", type:"–ò–ë", must:"–ù–µ—Ç", feas:"–¢—Ä–µ–±—É–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç", metric:"–°–ø–∏—Å–æ–∫/–æ—Ç—á–µ—Ç", owner:"–ü—Ä–µ—Å–µ–π–ª"},
  ];
  presets.forEach(p=>addReqRow(p));
}
function seedPsi(){
  const presets=[
    {req:"", scn:"–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –≤ –ø–∏–ª–æ—Ç–Ω–æ–π –∑–æ–Ω–µ", exp:"–°–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–µ—Ä–∏–º–µ—Ç—Ä—É, ‚â•95% –ø–æ–∫—Ä—ã—Ç–∏–µ", act:"", ok:"", acc:"", note:""},
    {req:"", scn:"–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –ü–û", exp:"–ù–µ—Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–æ–µ –ü–û ‚â§5% –∏ –≤—ã–¥–µ–ª–µ–Ω–æ –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–ø–∏—Å–∫–æ–º", act:"", ok:"", acc:"", note:""},
    {req:"", scn:"–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç—á–µ—Ç–∞ –ø–æ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω–æ–º—É –ü–û", exp:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω –æ—Ç—á–µ—Ç/—Å–ø–∏—Å–æ–∫ –ø–æ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º", act:"", ok:"", acc:"", note:""},
  ];
  presets.forEach(p=>addPsiRow(p));
}

function safeRecalc(){
  try { return recalc(); }
  catch(err){
    console.error("recalc() failed", err);
    return null;
  }
}

document.getElementById("btnRecalc").addEventListener("click", ()=>{ try{ recalc(); }catch(e){ console.warn("recalc failed",e);} try{ syncToGoogleSheets("recalc"); }catch(e){ console.warn("sync failed",e);} });
// ===== v7: Excel export + Google Sheets sync =====
const GOOGLE_SHEETS_WEBAPP_URL = (window.GS_WEBAPP_URL || "").trim();
console.log("‚úÖ Using Google Sheets WebApp URL:", GOOGLE_SHEETS_WEBAPP_URL);

function showLoader(title, sub){
  try{
    const el = document.getElementById("globalLoader");
    if(!el) return;
    const t = document.getElementById("globalLoaderTitle");
    const s = document.getElementById("globalLoaderSub");
    if(t) t.textContent = title || "–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶";
    if(s) s.textContent = sub || "Google Sheets –æ—Ç–≤–µ—á–∞–µ—Ç, —ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.";
    el.style.display = "flex";
    el.setAttribute("aria-hidden","false");
  }catch(_e){}
}
function hideLoader(){
  try{
    const el = document.getElementById("globalLoader");
    if(!el) return;
    el.style.display = "none";
    el.setAttribute("aria-hidden","true");
  }catch(_e){}
}

// –ï—Å–ª–∏ —É —Ç–µ–±—è –¥—Ä—É–≥–æ–π URL ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–º–µ–Ω—è–π —Å—Ç—Ä–æ–∫—É –≤—ã—à–µ.

function safeNum(v){
  const n = Number(String(v).replace(/[‚ÇΩ\s]/g,'').replace(',', '.').replace('%',''));
  return Number.isFinite(n) ? n : null;
}
function aoaSheet(rows){ return (window.XLSX ? XLSX.utils.aoa_to_sheet(rows) : null); }

function buildExcelWorkbook(payload){
  if(!window.XLSX) throw new Error("SheetJS (XLSX) –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è. –ü—Ä–æ–≤–µ—Ä—å –¥–æ—Å—Ç—É–ø –∫ CDN.");
  const wb = XLSX.utils.book_new();

  // Sheet: –ü–∞—Å–ø–æ—Ä—Ç + –§–∏–Ω–∞–Ω—Å—ã + KPI
  const m = payload.meta||{};
  const f = payload.finance||{};
  const k = payload.kpi||{};
  const s1 = [
    ["–†–∞–∑–¥–µ–ª","–ü–∞—Ä–∞–º–µ—Ç—Ä","–ó–Ω–∞—á–µ–Ω–∏–µ"],
    ["1) –ü–∞—Å–ø–æ—Ä—Ç","–ö–æ–º–ø–∞–Ω–∏—è", m.company||""],
    ["1) –ü–∞—Å–ø–æ—Ä—Ç","–û—Ç—Ä–∞—Å–ª—å", m.industry||""],
    ["1) –ü–∞—Å–ø–æ—Ä—Ç","–õ–ü–† / –∫–æ–Ω—Ç–∞–∫—Ç", m.lpr||""],
    ["1) –ü–∞—Å–ø–æ—Ä—Ç","–ò—Å—Ç–æ—á–Ω–∏–∫–∏", m.sources||""],
    ["1) –ü–∞—Å–ø–æ—Ä—Ç","–ü—Ä–∏–º–µ—á–∞–Ω–∏—è –ø–æ —Å—Ä–µ–¥–µ", m.envNote||""],
    ["1) –ü–∞—Å–ø–æ—Ä—Ç","–ö–æ–ª-–≤–æ —Ä–∞–±–æ—á–∏—Ö –º–µ—Å—Ç", m.workplaces??""],
    ["1) –ü–∞—Å–ø–æ—Ä—Ç","–ö–æ–ª-–≤–æ —Å–µ—Ä–≤–µ—Ä–æ–≤", m.servers??""],
    ["1) –ü–∞—Å–ø–æ—Ä—Ç","–ö–æ–ª-–≤–æ —Ñ–∏–ª–∏–∞–ª–æ–≤", m.branches??""],
    ["1) –ü–∞—Å–ø–æ—Ä—Ç","VDI", m.vdi||""],
    ["1) –ü–∞—Å–ø–æ—Ä—Ç","–ó–∞–∫—Ä—ã—Ç—ã–π –∫–æ–Ω—Ç—É—Ä", m.closed||""],
["1) –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞","–í–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è", m.virt||""],
    ["1) –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞","–ú–æ–¥–µ–ª—å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è", m.hostingModel||""],
    ["1) –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞","–î–æ–º–µ–Ω—ã AD / –∫–∞—Ç–∞–ª–æ–≥–æ–≤ (–∫–æ–ª-–≤–æ)", m.adDomains??""],
    ["1) –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞","–°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è —Å–µ—Ç–∏", m.netSeg||""],
    ["1) –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞","–¢–µ—Ä–º–∏–Ω–∞–ª—å–Ω—ã–µ —Ñ–µ—Ä–º—ã / RDS / VDI farms", m.terminalFarms||""],
    ["1) –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞","–í–æ–∑—Ä–∞—Å—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∂–µ–ª–µ–∑–∞", m.hwAge||""],
    ["1) –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞","–£—á–µ—Ç –∂–µ–ª–µ–∑–∞ (–∫–∞–∫ —Å–µ–π—á–∞—Å)", m.hwAccounting||""],
    ["1) –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞","–†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤", m.redundancy||""],
    ["","", ""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","–°—Ä–µ–¥–Ω—è—è –∑–∞—Ä–ø–ª–∞—Ç–∞ IT (‚ÇΩ/–º–µ—Å) GROSS", f.salary??""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","–ö–æ–ª-–≤–æ IT —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤", f.itCount??""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","% —Ä—É—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π", f.manualPct??""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","–ë—é–¥–∂–µ—Ç –Ω–∞ –ª–∏—Ü–µ–Ω–∑–∏–∏ (‚ÇΩ/–≥–æ–¥)", f.licBudget??""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","% –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ –ü–û", f.unusedPct??""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","% –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö VM", f.vmUnusedPct??""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","–ë—é–¥–∂–µ—Ç –Ω–∞ –∂–µ–ª–µ–∑–æ (‚ÇΩ/–≥–æ–¥)", f.hwBudget??""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","–ü–ª–∞–Ω –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∂–µ–ª–µ–∑–∞", f.hwPlan||""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","–ß–∞—Å–æ–≤ –ø—Ä–æ—Å—Ç–æ—è –≤ –≥–æ–¥", f.downtimeHours??""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","–°—Ç–æ–∏–º–æ—Å—Ç—å —á–∞—Å–∞ –ø—Ä–æ—Å—Ç–æ—è (‚ÇΩ/—á–∞—Å)", f.downtimeCost??""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","–ò–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤ –≤ –º–µ—Å—è—Ü", f.incidentsPerMonth??""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","–°–µ—Ä–≤–∏—Å-–¥–µ—Å–∫", f.serviceDesk||""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","Bus-factor ‚â§2 (–µ—Å—Ç—å?)", f.keyPeopleRisk||""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å (0‚Äì2)", f.docScore??""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","% —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –û–°/–ü–û", f.obsoletePct??""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π", f.note||""],
    ["","", ""],
    ["KPI (—à–∞–ø–∫–∞)","PSI 2.0", k.psi2||""],
    ["KPI (—à–∞–ø–∫–∞)","–ó–æ–Ω–∞ PSI", k.psi2Zone||""],
    ["KPI (—à–∞–ø–∫–∞)","–ò–Ω–¥–µ–∫—Å —Ç–µ—Ö. –∑—Ä–µ–ª–æ—Å—Ç–∏", k.tech||""],
    ["KPI (—à–∞–ø–∫–∞)","–ò–Ω–¥–µ–∫—Å –ø—Ä–æ—Ü. –∑—Ä–µ–ª–æ—Å—Ç–∏", k.proc||""],
    ["KPI (—à–∞–ø–∫–∞)","–ò–Ω–¥–µ–∫—Å —Ä–∏—Å–∫–∞", k.risk||""],
    ["KPI (—à–∞–ø–∫–∞)","Cost of Inaction (‚ÇΩ/–≥–æ–¥)", k.coi||""],
    ["KPI (—à–∞–ø–∫–∞)","–†–µ–∞–ª–∏–∑—É–µ–º–æ—Å—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π", k.feas||""],
    ["KPI (—à–∞–ø–∫–∞)","–≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ", k.pain||""],
    ["KPI (—à–∞–ø–∫–∞)","–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø–∏–ª–æ—Ç—É", k.ready||""],
    ["KPI (—à–∞–ø–∫–∞)","–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Å–¥–µ–ª–∫–∏", k.prob||""],
    ["KPI (—à–∞–ø–∫–∞)","–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –≤–æ–∑–≤—Ä–∞—Ç–∞ –±—é–¥–∂–µ—Ç–∞", k.recover||""],
    ["KPI (—à–∞–ø–∫–∞)","–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –ª—é–¥–µ–π", k.bus||""],
    ["KPI (—à–∞–ø–∫–∞)","–¢–µ—Ö. —Å—Ç–∞—Ä–µ–Ω–∏–µ", k.obsol||""],
    ["KPI (—à–∞–ø–∫–∞)","–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ò–ò", k.ai||""],
    ["KPI (—à–∞–ø–∫–∞)","–ö–∞—Ç–µ–≥–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞", k.crit||""],
    ["KPI (—à–∞–ø–∫–∞)","–ö–∞—Ç–µ–≥–æ—Ä–∏—è (–ª–µ–π–±–ª)", k.critLabel||""],
  ];
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(s1), "01_–ü–∞—Å–ø–æ—Ä—Ç+KPI");

  // Sheet: 2.1
  const tech = (payload.maturity?.tech||[]).map(x=>[x.key?.label||"", x.score, x.note||""]);
  tech.unshift(["–ö—Ä–∏—Ç–µ—Ä–∏–π","–ë–∞–ª–ª (0‚Äì2)","–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"]);
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(tech), "02_–¢–µ—Ö_2.1");

  // Sheet: 2.2
  const proc = (payload.maturity?.proc||[]).map(x=>[x.key?.label||"", x.score, x.note||""]);
  proc.unshift(["–ö—Ä–∏—Ç–µ—Ä–∏–π","–ë–∞–ª–ª (0‚Äì2)","–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"]);
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(proc), "03_–ü—Ä–æ—Ü_2.2");

  // Sheet: 2.3
  const risk = (payload.maturity?.risk||[]).map(x=>[x.key?.label||"", x.score, x.note||""]);
  risk.unshift(["–§–∞–∫—Ç–æ—Ä","–ï—Å—Ç—å? (0/1)","–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"]);
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(risk), "04_–†–∏—Å–∫–∏_2.3");

  // Sheet: 4 –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
  const req = (payload.requirements||[]).map((r,i)=>[i+1, r.text||"", r.type||"", r.must||"", r.feas||"", r.metric||"", r.owner||""]);
  req.unshift(["‚Ññ","–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞","–¢–∏–ø","–û–±—è–∑–∞—Ç.","–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å","–ú–µ—Ç—Ä–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏","–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π"]);
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(req), "05_–¢—Ä–µ–±_4");

  // Sheet: 5 –ü–°–ò
  const psi = (payload.psi||[]).map((r,i)=>[i+1, r.scn||"", r.exp||"", r.act||"", r.ok||"", r.acc||"", r.note||""]);
  psi.unshift(["‚Ññ","–°—Ü–µ–Ω–∞—Ä–∏–π","–û–∂–∏–¥–∞–Ω–∏–µ","–§–∞–∫—Ç","–°–æ–æ—Ç–≤.","–ü—Ä–∏–Ω—è–ª–∏?","–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"]);
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(psi), "06_–ü–°–ò_5");

  // Sheet: 6 –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø—Ä–æ–¥—É–∫—Ç—É
  const prodreq = (payload.productRequirements||payload.prodRequirements||payload.prodreq||[]).map((r,i)=>[i+1, r.biz||"", r.func||"", r.type||"", r.must||"", r.feas||""]);
  prodreq.unshift(["‚Ññ","–ë–∏–∑–Ω–µ—Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ","–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ","–¢–∏–ø","–û–±—è–∑–∞—Ç.","–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å"]);
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(prodreq), "07_–ü—Ä–æ–¥–¢—Ä–µ–±_6");


  // Sheet: 5.1 –†–∏—Å–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞
  const pr = payload.projectRisks||{};
  const prHead = [
    ["–ü–∞—Ä–∞–º–µ—Ç—Ä","–ó–Ω–∞—á–µ–Ω–∏–µ"],
    ["–£—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ (–∏—Ç–æ–≥)", pr.level||""],
    ["–ß—Ç–æ –º–æ–∂–µ—Ç –ø–æ–π—Ç–∏ –Ω–µ —Ç–∞–∫ (–∫—Ä–∞—Ç–∫–æ)", pr.notes||""],
    ["",""],
    ["–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä","–£—Å–ª–æ–≤–∏–µ","–°—Ç–∞—Ç—É—Å","–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"],
  ];
  const prRows = (pr.table||[]).map(x=>[x.indicator||"", x.condition||"", x.status||"", x.comment||""]);
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(prHead.concat(prRows)), "07_–†–∏—Å–∫–∏_5.1");

  return wb;
}

function exportExcel(){
  try{
    recalc();
    try{ const vboxes=document.querySelectorAll(".virt-wrapper input[type=checkbox]"); if(vboxes && vboxes.length){ const sel=[...vboxes].filter(b=>b.checked).map(b=>b.value).join("; "); const hv=document.getElementById("virt"); if(hv) hv.value=sel; } }catch(e){} // —á—Ç–æ–±—ã KPI –∏ —Ä–∏—Å–∫–∏ —Ç–æ—á–Ω–æ –æ–±–Ω–æ–≤–∏–ª–∏—Å—å
    const payload = collect();
    const wb = buildExcelWorkbook(payload);
    const nameBase = (payload.meta?.company||"ITMen_PSI").replace(/[^\p{L}\p{N}_\- ]/gu,"").trim().slice(0,60) || "ITMen_PSI";
    const fname = `${nameBase}_PSI_v7.xlsx`;
    XLSX.writeFile(wb, fname);
  }catch(e){
    console.error(e);
    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–≥—Ä—É–∑–∏—Ç—å Excel: " + (e?.message||e));
  }
}

let _gsyncTimer = null;
async function syncToGoogleSheets(reason){
  // CSP-safe saving for GitHub Pages: use fetch(no-cors) and allow connect-src via CSP meta in <head>.
  clearTimeout(window.__gsyncTimer);
  window.__gsyncTimer = setTimeout(async ()=>{
    const st = document.getElementById("gsyncStatus");
    try{
      // Always try to compute indices before saving (but don't block save if UI paint fails)
      try{ recalc(); }catch(_e){}

      const url = (typeof window.GS_WEBAPP_URL === "string" && window.GS_WEBAPP_URL) ? window.GS_WEBAPP_URL :
                  ((typeof window.GOOGLE_SHEETS_WEBAPP_URL === "string" && window.GOOGLE_SHEETS_WEBAPP_URL) ? window.GOOGLE_SHEETS_WEBAPP_URL : "");
      if(!url) throw new Error("Google Sheets URL is not set");

      const payloadRaw = collect();
      payloadRaw.audit = payloadRaw.audit || {};
      payloadRaw.audit.syncReason = reason || "manual";
      payloadRaw.audit.syncedAt = new Date().toISOString();

      const payload = flattenForSheets(payloadRaw);

      if(st){
        st.style.display="block";
        st.style.color="#0ea5e9";
        st.textContent="‚è´ –û—Ç–ø—Ä–∞–≤–ª—è—é –≤ Google Sheets‚Ä¶";
      }

      await fetch(url + (url.includes("?") ? "&" : "?") + "action=save", {
        method: "POST",
        mode: "no-cors",
        headers: {"Content-Type":"text/plain;charset=utf-8"},
        body: JSON.stringify(payload)
      });

      if(st){
        st.style.color="#16a34a";
        st.textContent="‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Google Sheets.";
        setTimeout(()=>{ try{ st.style.display='none'; }catch(_){} }, 2500);
      }
      console.log("‚úÖ Sheets sync sent (fetch no-cors)");
    }catch(err){
      console.error("gsync error", err);
      if(st){
        st.style.display="block";
        st.style.color="#b91c1c";
        st.textContent="‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: " + ((err && err.message) ? err.message : err);
        setTimeout(()=>{ try{ st.style.display='none'; }catch(_){} }, 6500);
      }
    }
  }, 200);
}

document.getElementById("btnExportXlsx")?.addEventListener("click", exportExcel);

// –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å = —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å (–ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
document.getElementById("btnRecalc").addEventListener("click", ()=>{
  try{ recalc(); }catch(e){ console.warn("recalc() failed", e); }
});

// –ü–µ—á–∞—Ç—å / –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ PDF = —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≤ Google Sheets (–∫–∞–∫ –≤ –≤–∞—à–µ–π –ª–æ–≥–∏–∫–µ)
document.getElementById("btnPrint").addEventListener("click", ()=>{
  try{ syncToGoogleSheets("pdf"); }catch(e){ console.warn("syncToGoogleSheets failed", e); }
  window.print();
});

document.getElementById("btnCLevel").addEventListener("click", ()=>{
  try{
    recalc(); // ensure latest
    const company = (document.getElementById("company").value || "–ö–æ–º–ø–∞–Ω–∏—è").trim();
    const psi2 = document.getElementById("psi2Score").textContent.replace("%","").trim();
    const psi2n = parseInt(psi2,10);
    const zone = document.getElementById("psi2Label").textContent;

    const coi = document.getElementById("coiTotal").textContent;
    const rec = document.getElementById("recoverIndex").textContent;
    const bus = document.getElementById("busIndex").textContent;
    const ob = document.getElementById("obsolIndex").textContent;
    const ai = document.getElementById("aiIndex").textContent;

    const topGaps = [];
    const pushGap = (name, val, hint)=>{
      const n = parseInt(String(val).replace("%","").trim(),10);
      if(isFinite(n) && n < 45) topGaps.push({name, n, hint});
    };
    pushGap("–£–ø—Ä–∞–≤–ª—è–µ–º–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö (—Ç–µ—Ö. –∑—Ä–µ–ª–æ—Å—Ç—å)", document.getElementById("techIndex").textContent, "–ù—É–∂–µ–Ω –µ–¥–∏–Ω—ã–π —Ä–µ–µ—Å—Ç—Ä –∞–∫—Ç–∏–≤–æ–≤ –∏ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π —Å–±–æ—Ä.");
    pushGap("–ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å –≤–Ω–µ–¥—Ä–µ–Ω–∏—è (–ø—Ä–æ—Ü. –∑—Ä–µ–ª–æ—Å—Ç—å)", document.getElementById("procIndex").textContent, "–ù—É–∂–Ω—ã —Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã –∏ —Ä–æ–ª–∏: –∫—Ç–æ –≤–ª–∞–¥–µ–ª–µ—Ü –¥–∞–Ω–Ω—ã—Ö/–ø—Ä–æ—Ü–µ—Å—Å–æ–≤.");
    pushGap("–í–æ–∑–≤—Ä–∞—Ç –±—é–¥–∂–µ—Ç–∞", rec, "–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ª–∏—Ü–µ–Ω–∑–∏–π/VM –¥–∞—ë—Ç –±—ã—Å—Ç—Ä—ã–π —ç—Ñ—Ñ–µ–∫—Ç.");
    pushGap("–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –ª—é–¥–µ–π", bus, "–°–Ω–∏–∑–∏—Ç—å bus-factor: –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è, —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã, –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∞–∫—Ç–∏–≤–æ–≤.");
    pushGap("–¢–µ—Ö–¥–æ–ª–≥", ob, "–ü–ª–∞–Ω –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –û–°/–ü–û –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –≤–µ—Ä—Å–∏–π/–ø–æ–¥–¥–µ—Ä–∂–∫–∏.");
    pushGap("–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏/–ò–ò", ai, "–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏ –µ–¥–∏–Ω—ã–π —Å–ª–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π.");

    topGaps.sort((a,b)=>a.n-b.n);
    const gapsText = topGaps.slice(0,4).map(g=>`‚Ä¢ ${g.name}: ${g.n}% ‚Äî ${g.hint}`).join("\n");

    const nextStep = "–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –ø–∏–ª–æ—Ç 4‚Äì6 –Ω–µ–¥–µ–ª—å –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –ø–µ—Ä–∏–º–µ—Ç—Ä–µ (–æ—Ñ–∏—Å/—Ñ–∏–ª–∏–∞–ª/VDI) —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞ –∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º –µ–¥–∏–Ω–æ–≥–æ —Ä–µ–µ—Å—Ç—Ä–∞ –∞–∫—Ç–∏–≤–æ–≤.";
    const text =
`C-level summary ‚Äî ${company}

PSI 2.0: ${isFinite(psi2n)?psi2n+"%":"‚Äî"} (${zone})

–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —ç—Ñ—Ñ–µ–∫—Ç (–æ—Ü–µ–Ω–∫–∞):
‚Ä¢ Cost of Inaction: ${coi} –≤ –≥–æ–¥ (—Ä—É—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ + –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–µ –ü–û + –ø—Ä–æ—Å—Ç–æ–∏)
‚Ä¢ –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –≤–æ–∑–≤—Ä–∞—Ç–∞ –±—é–¥–∂–µ—Ç–∞: ${rec}

–ö–ª—é—á–µ–≤—ã–µ –∑–æ–Ω—ã –ø—Ä–æ—Å–∞–¥–∫–∏ (—Ö—É–∂–µ ¬´–∑–¥–æ—Ä–æ–≤–æ–≥–æ —Ä—ã–Ω–∫–∞¬ª):
${gapsText || "‚Ä¢ –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –∫–ª—é—á–µ–≤—ã—Ö —Ä–∞–∑—Ä—ã–≤–æ–≤ ‚Äî –∑–∞–ø–æ–ª–Ω–∏—Ç–µ 3‚Äì5 –ø–æ–ª–µ–π (–ª–∏—Ü–µ–Ω–∑–∏–∏/VM/—Ç–µ—Ö–¥–æ–ª–≥/bus-factor)."}

–ß—Ç–æ –¥–∞—Å—Ç –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ:
‚Ä¢ –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ–± –ò–¢-–∞–∫—Ç–∏–≤–∞—Ö –∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
‚Ä¢ –°–Ω–∏–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–ø–ª–∞—Ç—ã –∑–∞ –ª–∏—Ü–µ–Ω–∑–∏–∏/—Ä–µ—Å—É—Ä—Å—ã –∏ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ —Ä—É—á–Ω—ã—Ö —Ç—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç
‚Ä¢ –°–Ω–∏–∂–µ–Ω–∏–µ —Ä–∏—Å–∫–æ–≤ –ø—Ä–æ–≤–µ—Ä–æ–∫ –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤

${nextStep}
`;
    const block = document.getElementById("cLevelBlock");
    const ta = document.getElementById("cLevelText");
    if(block && ta){
      ta.value = text;
      block.style.display = "block";
      block.scrollIntoView({behavior:"smooth", block:"start"});
    }
  }catch(e){
    console.error(e);
    alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –≤—ã–≤–æ–¥: " + e);
  }
});

document.getElementById("btnCopyCLevel").addEventListener("click", async ()=>{
  const ta=document.getElementById("cLevelText");
  if(!ta) return;
  try{ await navigator.clipboard.writeText(ta.value||""); }
  catch(e){ ta.select(); document.execCommand("copy"); }
});

document.getElementById("btnHideCLevel").addEventListener("click", ()=>{
  const block=document.getElementById("cLevelBlock");
  if(block) block.style.display="none";
});

document.getElementById("btnAddReq").addEventListener("click", ()=>addReqRow());
if(document.getElementById("btnAddProdReq")) document.getElementById("btnAddProdReq").addEventListener("click", ()=>addProdReqRow());
document.getElementById("btnClearReq").addEventListener("click", ()=>{
  if(confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è?")){ const __reqTb=document.getElementById("reqTbody");
  if(__reqTb) __reqTb.innerHTML=""; recalc(); }
});
if(document.getElementById("btnClearProdReq")) document.getElementById("btnClearProdReq").addEventListener("click", ()=>{
  if(confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø—Ä–æ–¥—É–∫—Ç—É?")){ const __prodTb=document.getElementById("prodReqTbody");
  if(__prodTb) __prodTb.innerHTML=""; recalc(); }
});
document.getElementById("btnAddPsi").addEventListener("click", ()=>addPsiRow());
document.getElementById("btnClearPsi").addEventListener("click", ()=>{
  if(confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –ü–°–ò?")){ const __psiTb=document.getElementById("psiTbody");
  if(__psiTb) __psiTb.innerHTML=""; recalc(); }
});

ensureBaseTables();
recalc();

const pdfModeEl = document.getElementById("pdfMode");
if(pdfModeEl){
  pdfModeEl.addEventListener("change", (e)=>{ setMode(e.target.value); recalc(); });
  setMode(pdfModeEl.value || "internal");
} else {
  setMode("internal");
}
updateRequiredUI();

const interviewModeEl = document.getElementById("interviewMode");
if(interviewModeEl){
  // show/hide extended passport + infra questions depending on interview mode
  function applyPassportVisibility(mode){
    const m = mode || (document.getElementById('interviewMode')?.value || 'fast');
    const show = (m === 'deep');
    const extra = document.getElementById('passportExtra');
    if (extra) extra.style.display = show ? '' : 'none';
    const infra = document.getElementById('infraSection');
    if (infra) infra.style.display = show ? '' : 'none';
  }
  interviewModeEl.addEventListener("change",(e)=>{ setInterviewMode(e.target.value); recalc(); applyPassportVisibility(e.target.value); });
  setInterviewMode(interviewModeEl.value || "quick");
} else {
  setInterviewMode("quick");
}

const benchModeEl = document.getElementById("benchMode");
if(benchModeEl){
  benchModeEl.addEventListener("change",()=>{ recalc(); });
  if(!benchModeEl.value) benchModeEl.value = "mixed";
}

/* ===== KPI Explain Modal logic (safe, no impact on calculations) ===== *

/* Helpers for showing data sources + uncertainty */
function kpiParamKeys(kpiId){
  switch(kpiId){
    case "kCOI": return ["manualPct","unusedPct","downtimeHours","downtimeCost"];
    case "kRecover": return ["unusedPct","vmUnusedPct"];
    case "kBus": return ["keyPeopleRisk","docScore"];
    case "kObsol": return ["obsoletePct"];
    case "kReady": return ["manualPct","incidentsPerMonth"];
    case "kPSI": return ["manualPct","unusedPct","vmUnusedPct","downtimeHours","downtimeCost","incidentsPerMonth","obsoletePct","keyPeopleRisk","docScore"];
    default: return [];
  }
}
function kpiConfidencePct(kpiId){
  const keys = kpiParamKeys(kpiId);
  if(!keys.length) return NaN;
  const sum = keys.reduce((a,k)=>a + srcWeight(LAST_EST.params?.[k]?.src||"missing"),0);
  return Math.round(100*sum/keys.length);
}
function srcBadge(src){
  if(src==="client") return "üü¢ –∫–ª–∏–µ–Ω—Ç";
  if(src==="bench") return "üîµ –±–µ–Ω—á–º–∞—Ä–∫";
  if(src==="interview") return "üü° –∏–Ω—Ç–µ—Ä–≤—å—é";
  return "‚Äî";
}
function kpiBuildDataHtml(kpiId){
  const keys = kpiParamKeys(kpiId);
  if(!keys.length) return `<span class="small">–î–ª—è —ç—Ç–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ –Ω–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Å–∏–Ω—Ç–µ—Ç–∏–∫–∏.</span>`;
  const rows = keys.map(k=>{
    const p = LAST_EST.params?.[k];
    const v = p && isFinite(p.v) ? p.v : NaN;
    const labelMap = {
      manualPct:"–†—É—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, %",
      unusedPct:"–ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–µ –ü–û/–ª–∏—Ü–µ–Ω–∑–∏–∏, %",
      vmUnusedPct:"–ü—Ä–æ—Å—Ç–∞–∏–≤–∞—é—â–∏–µ VM, %",
      downtimeHours:"–ü—Ä–æ—Å—Ç–æ–∏, —á–∞—Å–æ–≤/–≥–æ–¥",
      downtimeCost:"–°—Ç–æ–∏–º–æ—Å—Ç—å —á–∞—Å–∞ –ø—Ä–æ—Å—Ç–æ—è, ‚ÇΩ/—á–∞—Å",
      incidentsPerMonth:"–ò–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤/–º–µ—Å",
      obsoletePct:"–£—Å—Ç–∞—Ä–µ–≤—à–µ–µ –û–°/–ü–û, %",
      keyPeopleRisk:"–ù–µ–∑–∞–º–µ–Ω–∏–º—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ (0/1)",
      docScore:"–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å (0‚Äì2)"
    };
    const lab = labelMap[k] || k;
    const range = p?.range ? formatRange(p.range) : "‚Äî";
    const vTxt = isFinite(v) ? (k.includes("Cost") ? fmtMoney(v) : Math.round(v).toString()) : "‚Äî";
    const src = srcBadge(p?.src);
    return `<tr><td>${lab}</td><td class="mono" style="text-align:right">${vTxt}</td><td class="mono" style="text-align:right">${range}</td><td style="text-align:right">${src}</td></tr>`;
  }).join("");
  const conf = kpiConfidencePct(kpiId);
  return `
    <div class="small" style="margin-bottom:8px">–î–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç—å –∏–Ω–¥–µ–∫—Å–∞: <b>${isFinite(conf)?conf:0}%</b> (—á–µ–º –±–æ–ª—å—à–µ üü¢, —Ç–µ–º —Ç–æ—á–Ω–µ–µ).</div>
    <table style="width:100%;border-collapse:collapse;font-size:13px">
      <thead>
        <tr style="opacity:.75">
          <th style="text-align:left;padding:6px 0;border-bottom:1px solid var(--border)">–ü–∞—Ä–∞–º–µ—Ç—Ä</th>
          <th style="text-align:right;padding:6px 0;border-bottom:1px solid var(--border)">–û—Ü–µ–Ω–∫–∞</th>
          <th style="text-align:right;padding:6px 0;border-bottom:1px solid var(--border)">P25‚ÄìP75</th>
          <th style="text-align:right;padding:6px 0;border-bottom:1px solid var(--border)">–ò—Å—Ç–æ—á–Ω–∏–∫</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

// Uncertainty range for Recover index (computed from benchmark ranges if present)
function recoverRange(){
  const pL = LAST_EST.params?.unusedPct;
  const pV = LAST_EST.params?.vmUnusedPct;
  if(!pL?.range || !pV?.range) return null;
  const calc = (L,V)=>{
    const Lr = clamp((L/100)/0.25, 0, 1);
    const Vr = clamp((V/100)/0.30, 0, 1);
    return Math.round(clamp(100*(1-(0.6*Lr+0.4*Vr)),0,100));
  };
  const lo = calc(pL.range[1], pV.range[1]); // worse case (higher waste)
  const hi = calc(pL.range[0], pV.range[0]); // best case
  return [Math.min(lo,hi), Math.max(lo,hi)];
}
const KPI_META = {
  kPSI: {
    title: "PSI 2.0 (–∏—Ç–æ–≥)",
    sub: "–°–≤–æ–¥–Ω—ã–π –∏–Ω–¥–µ–∫—Å –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏/—Ä–∏—Å–∫–æ–≤/—ç–∫–æ–Ω–æ–º–∏–∫–∏ –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏—è –æ –ø–∏–ª–æ—Ç–µ.",
    what: "–≠—Ç–æ ¬´–æ–±—â–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞¬ª –ø—Ä–æ–µ–∫—Ç–∞: –Ω–∞—Å–∫–æ–ª—å–∫–æ –≤—Å—ë –≥–æ—Ç–æ–≤–æ –¥–ª—è –ø–∏–ª–æ—Ç–∞ –∏ –≥–¥–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–≤–∞–ª—ã (–¥–∞–Ω–Ω—ã–µ, –ø—Ä–æ—Ü–µ—Å—Å—ã, —Ä–∏—Å–∫–∏, —ç–∫–æ–Ω–æ–º–∏–∫–∞).",
    how: "–°—á–∏—Ç–∞–µ—Ç—Å—è –∫–∞–∫ –≤–∑–≤–µ—à–µ–Ω–Ω–∞—è —Å—É–º–º–∞ –∏–Ω–¥–µ–∫—Å–æ–≤: —Ç–µ—Ö. –∑—Ä–µ–ª–æ—Å—Ç—å, –ø—Ä–æ—Ü–µ—Å—Å–Ω–∞—è –∑—Ä–µ–ª–æ—Å—Ç—å, —Ä–∏—Å–∫, —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ, —Ä–µ–∞–ª–∏–∑—É–µ–º–æ—Å—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π, –≤–æ–∑–≤—Ä–∞—Ç –±—é–¥–∂–µ—Ç–∞, –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –ª—é–¥–µ–π, —Ç–µ—Ö. —Å—Ç–∞—Ä–µ–Ω–∏–µ, AI –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å. –í–µ—Å–∞–º–∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç –º–æ–¥–µ–ª—å (–≤—à–∏—Ç–∞ –≤ –∫–æ–¥).",
    impact: "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è: ¬´–∏–¥—ë–º –≤ –ø–∏–ª–æ—Ç / —á—Ç–æ —Ñ–∏–∫—Å–∏—Ä—É–µ–º –¥–æ –ø–∏–ª–æ—Ç–∞ / –∫–∞–∫–æ–π —Å–æ—Å—Ç–∞–≤ –ø–∏–ª–æ—Ç–∞¬ª. –¢–∞–∫–∂–µ –≤–ª–∏—è–µ—Ç –Ω–∞ ¬´–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Å–¥–µ–ª–∫–∏¬ª (—á–µ—Ä–µ–∑ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å/—Ä–∏—Å–∫–∏).",
    doHtml: `
      <ul>
        <li><b>0‚Äì39%</b>: –ø–∏–ª–æ—Ç —Ä–∏—Å–∫–æ–≤–∞–Ω ‚Äî —Å–Ω–∞—á–∞–ª–∞ –∑–∞–∫—Ä—ã—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏/–ø—Ä–æ—Ü–µ—Å—Å—ã (—Å–ø–∏—Å–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π –Ω–∏–∂–µ –ø–æ –ø—Ä–æ–≤–∞–ª—å–Ω—ã–º –∏–Ω–¥–µ–∫—Å–∞–º), –∑–∞—Ç–µ–º –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è –∫ –ø–∏–ª–æ—Ç—É.</li>
        <li><b>40‚Äì69%</b>: –ø–∏–ª–æ—Ç –≤–æ–∑–º–æ–∂–µ–Ω ‚Äî –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–∏–ª–æ—Ç —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –æ–±—ä—ë–º–∞ –∏ —á—ë—Ç–∫–∏–º–∏ –∫—Ä–∏—Ç–µ—Ä–∏—è–º–∏ —É—Å–ø–µ—Ö–∞.</li>
        <li><b>70‚Äì100%</b>: –º–æ–∂–Ω–æ –∏–¥—Ç–∏ –≤ –ø–∏–ª–æ—Ç —É–≤–µ—Ä–µ–Ω–Ω–æ ‚Äî —Ä–∞—Å—à–∏—Ä—è—Ç—å –æ—Ö–≤–∞—Ç, –¥–æ–±–∞–≤–ª—è—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∏ KPI.</li>
      </ul>`
  },
  kTech: {
    title: "–ò–Ω–¥–µ–∫—Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –∑—Ä–µ–ª–æ—Å—Ç–∏",
    sub: "–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –ø–æ –¥–∞–Ω–Ω—ã–º –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º (AD/SCCM/VMware/SNMP –∏ —Ç.–¥.).",
    what: "–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω–æ —Å–æ–±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–∏–ª–æ—Ç–∞ –±—ã—Å—Ç—Ä–æ –∏ –±–µ–∑ –±–æ–ª–∏: –µ—Å—Ç—å –ª–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∏, –¥–æ—Å—Ç—É–ø—ã, —Å–ø–æ—Å–æ–±—ã —Å–±–æ—Ä–∞.",
    how: "–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞ –ø–æ —Å–ø–∏—Å–∫—É –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ —Ä–∞–∑–¥–µ–ª–∞ 2.1 (0=–Ω–µ—Ç, 1=—á–∞—Å—Ç–∏—á–Ω–æ, 2=–µ—Å—Ç—å), –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–Ω–∞—è –≤ –ø—Ä–æ—Ü–µ–Ω—Ç—ã.",
    impact: "–í–ª–∏—è–µ—Ç –Ω–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø–∏–ª–æ—Ç—É, —Å—Ä–æ–∫–∏ –∏ –æ–±—ä—ë–º —Ä–∞–±–æ—Ç –ø–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤. –ö–æ—Å–≤–µ–Ω–Ω–æ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ç–æ—á–Ω–æ—Å—Ç—å —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏—Ö —Ä–∞—Å—á—ë—Ç–æ–≤.",
    doHtml: `
      <ul>
        <li><b>0‚Äì39%</b>: –Ω–∞—á–∏–Ω–∞—Ç—å —Å ¬´–º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç—É—Ä–∞¬ª (AD + 1 –∏—Å—Ç–æ—á–Ω–∏–∫ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏), —Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø—ã/–æ–∫–Ω–∞, –≤—ã–±—Ä–∞—Ç—å –ø–∏–ª–æ—Ç–Ω—É—é –∑–æ–Ω—É.</li>
        <li><b>40‚Äì69%</b>: –ø–æ–¥–∫–ª—é—á–∞—Ç—å 2‚Äì4 –∫–ª—é—á–µ–≤—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–∞, –≤–∫–ª—é—á–∏—Ç—å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é/–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é, —Å–æ–±—Ä–∞—Ç—å –ø–µ—Ä–≤—É—é ¬´–µ–¥–∏–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É¬ª.</li>
        <li><b>70‚Äì100%</b>: —Ä–∞—Å—à–∏—Ä—è—Ç—å –æ—Ö–≤–∞—Ç (—Ñ–∏–ª–∏–∞–ª—ã/VDI/—Å–µ—Ç–µ–≤–æ–µ), –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏ –æ—Ç—á—ë—Ç—ã.</li>
      </ul>`
  },
  kProc: {
    title: "–ò–Ω–¥–µ–∫—Å –ø—Ä–æ—Ü–µ—Å—Å–Ω–æ–π –∑—Ä–µ–ª–æ—Å—Ç–∏",
    sub: "–ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å –≤–Ω–µ–¥—Ä–µ–Ω–∏—è (—Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã, —Ä–æ–ª–∏, –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞).",
    what: "–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –±—É–¥–µ—Ç —É–ø—Ä–∞–≤–ª—è–µ–º—ã–º: –µ—Å—Ç—å –ª–∏ –≤–ª–∞–¥–µ–ª—å—Ü—ã, –ø—Ä–∞–≤–∏–ª–∞ —É—á—ë—Ç–∞, –∑–∞–∫—É–ø–æ–∫, –∏–∑–º–µ–Ω–µ–Ω–∏–π.",
    how: "–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞ –ø–æ —Ä–∞–∑–¥–µ–ª—É 2.2 (0/1/2), –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–Ω–∞—è –≤ –ø—Ä–æ—Ü–µ–Ω—Ç—ã.",
    impact: "–í–ª–∏—è–µ—Ç –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π, –∫–∞—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö (–∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å), —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∞ (—ç–∫–æ–Ω–æ–º–∏—è –Ω–µ ¬´—Å—ä–µ–¥–∞–µ—Ç—Å—è¬ª –æ–±—Ä–∞—Ç–Ω–æ).",
    doHtml: `
      <ul>
        <li><b>0‚Äì39%</b>: —Ñ–∏–∫—Å–∏—Ä—É–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ (–≤–ª–∞–¥–µ–ª–µ—Ü —É—á—ë—Ç–∞, —Ä–µ–≥–ª–∞–º–µ–Ω—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ) ‚Äî –∏–Ω–∞—á–µ –ø–∏–ª–æ—Ç –¥–∞—Å—Ç ¬´–∫—Ä–∞—Å–∏–≤—ã–µ —Ü–∏—Ñ—Ä—ã¬ª, –Ω–æ –Ω–µ –∑–∞–∫—Ä–µ–ø–∏—Ç—Å—è.</li>
        <li><b>40‚Äì69%</b>: –æ–ø–∏—Å—ã–≤–∞–µ–º 2‚Äì3 –ø—Ä–æ—Ü–µ—Å—Å–∞ (—É—á—ë—Ç, –∑–∞–∫—É–ø–∫–∞, –≤—ã–≤–æ–¥), –≤–≤–æ–¥–∏–º —Ä–µ–≥—É–ª—è—Ä–Ω—É—é —Å–≤–µ—Ä–∫—É/–∞—É–¥–∏—Ç.</li>
        <li><b>70‚Äì100%</b>: –¥–æ–±–∞–≤–ª—è–µ–º KPI, –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ–º –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –∞–∫—Ç–∏–≤–æ–≤ –∏ –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç—å.</li>
      </ul>`
  },
  kRisk: {
    title: "–ò–Ω–¥–µ–∫—Å —Ä–∏—Å–∫–∞",
    sub: "–°—É–º–º–∞ —Ä–∏—Å–∫‚Äë—Ñ–∞–∫—Ç–æ—Ä–æ–≤ (0‚Äì5): 0‚Äì1 –Ω–∏–∑–∫–∏–π, 2‚Äì3 —Å—Ä–µ–¥–Ω–∏–π, 4‚Äì5 –≤—ã—Å–æ–∫–∏–π.",
    what: "–≠—Ç–æ –±—ã—Å—Ç—Ä—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä, –Ω–∞—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–µ–∫—Ç —Å–ª–æ–∂–Ω—ã–π/–æ–ø–∞—Å–Ω—ã–π –∏–∑‚Äë–∑–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç—å, –∏–∑–º–µ–Ω–µ–Ω–∏—è, —Ä—É—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —Ç.–¥.",
    how: "–°—á–∏—Ç–∞–µ—Ç—Å—è –∫–∞–∫ —Å—É–º–º–∞ –æ—Ç–º–µ—á–µ–Ω–Ω—ã—Ö —Ä–∏—Å–∫‚Äë—Ñ–∞–∫—Ç–æ—Ä–æ–≤ –≤ —Ä–∞–∑–¥–µ–ª–µ 2.3 (0/1).",
    impact: "–í–ª–∏—è–µ—Ç –Ω–∞ –ø–ª–∞–Ω –ø–∏–ª–æ—Ç–∞ (–æ–±—ä—ë–º, —Å—Ä–æ–∫–∏, –±—É—Ñ–µ—Ä—ã), —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –¥–æ–ø. –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è.",
    doHtml: `
      <ul>
        <li><b>0‚Äì1</b>: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–∏–ª–æ—Ç.</li>
        <li><b>2‚Äì3</b>: –ø–∏–ª–æ—Ç —Å –±—É—Ñ–µ—Ä–æ–º –ø–æ —Å—Ä–æ–∫–∞–º + —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Ä–∏—Å–∫–∏ –≤ –ø–ª–∞–Ω–µ (–¥–æ—Å—Ç—É–ø—ã, —Ñ–∏–ª–∏–∞–ª—ã, –ò–ë).</li>
        <li><b>4‚Äì5</b>: —Å–Ω–∞—á–∞–ª–∞ ¬´–ø–∏–ª–æ—Ç –ø–∏–ª–æ—Ç–∞¬ª (—É–∑–∫–∞—è –∑–æ–Ω–∞), –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º –∫—Ä–∏—Ç–∏—á–Ω—ã–µ —Ä–∏—Å–∫–∏ (–ò–ë, –¥–æ—Å—Ç—É–ø—ã, –∏—Å—Ç–æ—á–Ω–∏–∫–∏, —Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã).</li>
      </ul>`
  },
  kCoI: {
    title: "Cost of Inaction (‚ÇΩ/–≥–æ–¥)",
    sub: "–û—Ü–µ–Ω–∫–∞ –ø–æ—Ç–µ—Ä—å –æ—Ç –±–µ–∑–¥–µ–π—Å—Ç–≤–∏—è: —Ä—É—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ + –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–µ –ü–û + –ø—Ä–æ—Å—Ç–æ–∏.",
    what: "–°–∫–æ–ª—å–∫–æ –¥–µ–Ω–µ–≥ –≤ –≥–æ–¥ ¬´—É—Ç–µ–∫–∞–µ—Ç¬ª –∏–∑‚Äë–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—è (–¥–∞–∂–µ –±–µ–∑ –ø–æ–∫—É–ø–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–∞).",
    how: "–†—É—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ = –ó–ü√ó–ò–¢‚Äë—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏√ó%—Ä—É—á–Ω√ó12; –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–µ –ü–û = –±—é–¥–∂–µ—Ç –ª–∏—Ü–µ–Ω–∑–∏–π√ó%–Ω–µ–∏—Å–ø; –ü—Ä–æ—Å—Ç–æ–∏ = —á–∞—Å—ã –ø—Ä–æ—Å—Ç–æ—è√ó—Å—Ç–æ–∏–º–æ—Å—Ç—å —á–∞—Å–∞. –í—Å—ë —Å—É–º–º–∏—Ä—É–µ—Ç—Å—è.",
    impact: "–°–∏–ª—å–Ω—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç –¥–ª—è CFO/CEO: –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞ –Ω–∞ –ø–∏–ª–æ—Ç/–≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞.",
    doHtml: `
      <ul>
        <li><b>0‚Äì5 –º–ª–Ω</b>: —Ñ–æ–∫—É—Å –Ω–∞ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É –¥–∞–Ω–Ω—ã—Ö –∏ ¬´–±—ã—Å—Ç—Ä—ã–µ –ø–æ–±–µ–¥—ã¬ª (—É—á—ë—Ç, –±–∞–∑–æ–≤—ã–µ –æ—Ç—á—ë—Ç—ã).</li>
        <li><b>5‚Äì20 –º–ª–Ω</b>: –ø–∏–ª–æ—Ç –Ω–∞ —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π —ç—Ñ—Ñ–µ–∫—Ç (–ª–∏—Ü–µ–Ω–∑–∏–∏ + –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è + –∫–æ–Ω—Ç—Ä–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∏–π).</li>
        <li><b>20+ –º–ª–Ω</b>: –±—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç, —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –æ—Ö–≤–∞—Ç–∞, –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–æ–ª—è.</li>
      </ul>`
  },
  kCrit: {
    title: "–ö–∞—Ç–µ–≥–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞",
    sub: "–û—Ü–µ–Ω–∫–∞ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏/–º–∞—Å—à—Ç–∞–±–∞ –ø—Ä–æ–µ–∫—Ç–∞ (–ø—Ä–æ—Ü–µ–Ω—Ç + –º–µ—Ç–∫–∞).",
    what: "–ù–∞—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–µ–∫—Ç ¬´–±–æ–ª—å—à–æ–π¬ª –ø–æ –º–∞—Å—à—Ç–∞–±—É/—Å–ª–æ–∂–Ω–æ—Å—Ç–∏ ‚Äî —á—Ç–æ–±—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤—ã–±—Ä–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç –ø–∏–ª–æ—Ç–∞ –∏ —Ä–µ—Å—É—Ä—Å—ã.",
    how: "–°—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –ø–∞—Å–ø–æ—Ä—Ç–∞ (–æ–±—ä—ë–º—ã, —Ñ–∏–ª–∏–∞–ª—ã, VDI/–∑–∞–∫—Ä—ã—Ç—ã–π –∫–æ–Ω—Ç—É—Ä/–≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è –∏ –¥—Ä.) –∏ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é.",
    impact: "–í–ª–∏—è–µ—Ç –Ω–∞ –æ–±—ä—ë–º –ø–∏–ª–æ—Ç–∞, –ø–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è, –Ω—É–∂–Ω—ã–µ —Ä–æ–ª–∏ –∏ —Å—Ä–æ–∫–∏.",
    doHtml: `
      <ul>
        <li><b>0‚Äì33%</b>: –ª—ë–≥–∫–∏–π –ø–∏–ª–æ—Ç (1 –ø–ª–æ—â–∞–¥–∫–∞/–ø–æ–¥—Å–µ—Ç—å, 1‚Äì2 –∏—Å—Ç–æ—á–Ω–∏–∫–∞).</li>
        <li><b>34‚Äì66%</b>: —Å—Ä–µ–¥–Ω–∏–π –ø–∏–ª–æ—Ç (–Ω–µ—Å–∫–æ–ª—å–∫–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤, —á–∞—Å—Ç—å —Ñ–∏–ª–∏–∞–ª–æ–≤/VDI –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏).</li>
        <li><b>67‚Äì100%</b>: –∫—Ä—É–ø–Ω—ã–π –ø–∏–ª–æ—Ç (—Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è, –ò–ë, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏, –ø–æ—ç—Ç–∞–ø–Ω–æ—Å—Ç—å).</li>
      </ul>`
  },
  kFeas: {
    title: "–ò–Ω–¥–µ–∫—Å —Ä–µ–∞–ª–∏–∑—É–µ–º–æ—Å—Ç–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π",
    sub: "–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª ¬´–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏¬ª –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π.",
    what: "–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –ø–∏–ª–æ—Ç–∞ –≤—ã–ø–æ–ª–Ω–∏–º—ã –≤ —Ç–µ–∫—É—â–µ–º –∫–æ–Ω—Ç—É—Ä–µ (–∏—Å—Ç–æ—á–Ω–∏–∫–∏, –¥–æ—Å—Ç—É–ø—ã, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ò–ë).",
    how: "–ë–µ—Ä—ë—Ç—Å—è —Å—Ä–µ–¥–Ω–∏–π score –ø–æ –ø–æ–ª—é ¬´–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å¬ª (—Ä–∞–∑–¥–µ–ª —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π) –∏ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è –≤ –ø—Ä–æ—Ü–µ–Ω—Ç—ã.",
    impact: "–í–ª–∏—è–µ—Ç –Ω–∞ –ø–ª–∞–Ω –ø–∏–ª–æ—Ç–∞: –∫–∞–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –±–µ—Ä—ë–º –≤ –ø–∏–ª–æ—Ç, –∫–∞–∫–∏–µ ‚Äî –≤ —ç—Ç–∞–ø 2.",
    doHtml: `
      <ul>
        <li><b>0‚Äì49%</b>: —Å—É–∑–∏—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –ø–∏–ª–æ—Ç–∞ –¥–æ –±–∞–∑–æ–≤–æ–≥–æ –∫–æ–Ω—Ç—É—Ä–∞, —Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–æ—Å—Ç—É–ø—ã.</li>
        <li><b>50‚Äì79%</b>: –ø–∏–ª–æ—Ç –ø–æ –æ—Å–Ω–æ–≤–Ω—ã–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º + 1‚Äì2 ¬´–ø—Ä–µ–º–∏—É–º¬ª –∫–µ–π—Å–∞.</li>
        <li><b>80‚Äì100%</b>: –º–æ–∂–Ω–æ –±—Ä–∞—Ç—å —à–∏—Ä–æ–∫–∏–π —Å–ø–∏—Å–æ–∫ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∏ –¥–µ–ª–∞—Ç—å –¥–µ–º–æ‚Äë–æ—Ç—á—ë—Ç—ã.</li>
      </ul>`
  },
      kProdFeas: {
        title:"–ò–Ω–¥–µ–∫—Å —Ä–µ–∞–ª–∏–∑—É–µ–º–æ—Å—Ç–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ –ø—Ä–æ–¥—É–∫—Ç—É",
        what:"–û—Ü–µ–Ω–∫–∞ —Ç–æ–≥–æ, –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø—Ä–æ–¥—É–∫—Ç—É —Ä–µ–∞–ª–∏–∑—É–µ–º—ã –≤ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏/–ø–ª–∞–Ω–∞—Ö.",
        how:"–°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ –∫–æ–ª–æ–Ω–∫–µ ¬´–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å¬ª –≤ —Ä–∞–∑–¥–µ–ª–µ 6, –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö.",
        data:"–û—Å–Ω–æ–≤–∞–Ω–æ –Ω–∞ —Ä–µ–µ—Å—Ç—Ä–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ –ø—Ä–æ–¥—É–∫—Ç—É (—Ä–∞–∑–¥–µ–ª 6).",
        impact:"–í–ª–∏—è–µ—Ç –Ω–∞ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç—å –æ–∂–∏–¥–∞–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–∞ –∏ –Ω–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ roadmap.",
        do:"–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ä–∞–∑–¥–µ–ª 6. –ï—Å–ª–∏ –∏–Ω–¥–µ–∫—Å –Ω–∏–∑–∫–∏–π ‚Äî —Ñ–∏–∫—Å–∏—Ä—É–π—Ç–µ –æ–∂–∏–¥–∞–Ω–∏—è, –ø–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∏ roadmap, –∏–ª–∏ —É—Ç–æ—á–Ω—è–π—Ç–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è."
      },
  kPain: {
    title: "–ò–Ω–¥–µ–∫—Å —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–≥–æ –¥–∞–≤–ª–µ–Ω–∏—è",
    sub: "–ù–∞—Å–∫–æ–ª—å–∫–æ –æ—Å—Ç—Ä–æ –±–∏–∑–Ω–µ—Å—É –Ω—É–∂–Ω–æ —Å–Ω–∏–∑–∏—Ç—å –∑–∞—Ç—Ä–∞—Ç—ã/—Ä–∏—Å–∫–∏ —Å–µ–π—á–∞—Å.",
    what: "–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç ¬´–Ω–∞—Å–∫–æ–ª—å–∫–æ –±–æ–ª–∏—Ç¬ª —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏: –±—é–¥–∂–µ—Ç—ã, —Ä—É—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, –ø—Ä–æ—Å—Ç–æ–∏ –∏ —Ç.–ø.",
    how: "–°—á–∏—Ç–∞–µ—Ç—Å—è –∏–∑ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –±–ª–æ–∫–∞ (—Ä—É—á–Ω–æ–π —Ç—Ä—É–¥, –±—é–¥–∂–µ—Ç –ª–∏—Ü–µ–Ω–∑–∏–π, –Ω–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ, –ø—Ä–æ—Å—Ç–æ–∏) –ø–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π —à–∫–∞–ª–µ.",
    impact: "–í–ª–∏—è–µ—Ç –Ω–∞ –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—é: –µ—Å–ª–∏ –¥–∞–≤–ª–µ–Ω–∏–µ –≤—ã—Å–æ–∫–æ–µ ‚Äî –¥–µ–ª–∞–µ–º –ø–∏–ª–æ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ ¬´–¥–µ–Ω–µ–∂–Ω—ã–º¬ª.",
    doHtml: `
      <ul>
        <li><b>0‚Äì33%</b>: –ø–∏–ª–æ—Ç –±–æ–ª—å—à–µ –ø—Ä–æ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å/–∫–æ–Ω—Ç—Ä–æ–ª—å.</li>
        <li><b>34‚Äì66%</b>: –ø–∏–ª–æ—Ç –ø—Ä–æ —ç–∫–æ–Ω–æ–º–∏—é (–ª–∏—Ü–µ–Ω–∑–∏–∏ + –∞–∫—Ç–∏–≤—ã) –∏ –±—ã—Å—Ç—Ä—ã–µ –æ—Ç—á—ë—Ç—ã.</li>
        <li><b>67‚Äì100%</b>: –ø–∏–ª–æ—Ç –∫–∞–∫ –∞–Ω—Ç–∏–∫—Ä–∏–∑–∏—Å–Ω—ã–π –ø—Ä–æ–µ–∫—Ç: –±—ã—Å—Ç—Ä—ã–µ –¥–µ–Ω—å–≥–∏ + –∫–æ–Ω—Ç—Ä–æ–ª—å —Ä–∏—Å–∫–æ–≤.</li>
      </ul>`
  },
  kReady: {
    title: "–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø–∏–ª–æ—Ç—É",
    sub: "–ò–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å –ø–∏–ª–æ—Ç.",
    what: "–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –º–æ–∂–Ω–æ –ª–∏ –Ω–∞—á–∏–Ω–∞—Ç—å –ø–∏–ª–æ—Ç –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å –∏–ª–∏ —Å–Ω–∞—á–∞–ª–∞ –Ω–∞–¥–æ –∑–∞–∫—Ä—ã—Ç—å –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É–Ω–∫—Ç—ã.",
    how: "–ö–æ–º–±–∏–Ω–∞—Ü–∏—è —Ç–µ—Ö. –∑—Ä–µ–ª–æ—Å—Ç–∏, –ø—Ä–æ—Ü–µ—Å—Å–Ω–æ–π –∑—Ä–µ–ª–æ—Å—Ç–∏, —Ä–µ–∞–ª–∏–∑—É–µ–º–æ—Å—Ç–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∏ —Ä–∏—Å–∫‚Äë—Ñ–∞–∫—Ç–æ—Ä–æ–≤ (–≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞).",
    impact: "–í–ª–∏—è–µ—Ç –Ω–∞ —Ä–µ—à–µ–Ω–∏–µ ¬´—Å—Ç–∞—Ä—Ç—É–µ–º/–≥–æ—Ç–æ–≤–∏–º¬ª –∏ –Ω–∞ –æ–±—ä—ë–º –ø–∏–ª–æ—Ç–∞.",
    doHtml: `
      <ul>
        <li><b>0‚Äì49%</b>: –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (–¥–æ—Å—Ç—É–ø—ã, –∏—Å—Ç–æ—á–Ω–∏–∫–∏, —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è), –∑–∞—Ç–µ–º —Å—Ç–∞—Ä—Ç.</li>
        <li><b>50‚Äì79%</b>: –º–æ–∂–Ω–æ —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å –ø–∏–ª–æ—Ç –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –∑–æ–Ω–µ.</li>
        <li><b>80‚Äì100%</b>: –º–æ–∂–Ω–æ —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å –ø–∏–ª–æ—Ç —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è–º–∏.</li>
      </ul>`
  },
  kProb: {
    title: "–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Å–¥–µ–ª–∫–∏",
    sub: "–û—Ü–µ–Ω–∫–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–Ω–¥–µ–∫—Å–æ–≤ (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π KPI –ø—Ä–µ—Å–µ–π–ª–∞).",
    what: "–≠—Ç–æ –Ω–µ ¬´–º–∞–≥–∏—è¬ª, –∞ —É–¥–æ–±–Ω—ã–π –æ—Ä–∏–µ–Ω—Ç–∏—Ä: –Ω–∞—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–µ–∫—Ç –≤—ã–≥–ª—è–¥–∏—Ç ¬´–∂–∏–≤—ã–º¬ª –ø–æ –¥–∞–Ω–Ω—ã–º, –ø—Ä–æ—Ü–µ—Å—Å–∞–º –∏ —ç–∫–æ–Ω–æ–º–∏–∫–µ.",
    how: "–ö–æ–º–±–∏–Ω–∏—Ä—É–µ—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø–∏–ª–æ—Ç—É, —Ä–∏—Å–∫‚Äë–ø—Ä–æ—Ñ–∏–ª—å –∏ —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ (–≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞).",
    impact: "–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è –ø—Ä–æ–¥–∞–∂: –≥–¥–µ —É—Å–∏–ª–∏–≤–∞—Ç—å –ø—Ä–µ—Å–µ–π–ª, –≥–¥–µ –ø—Ä–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ, –≥–¥–µ –∑–∞–∫—Ä—ã–≤–∞—Ç—å —Ä–∏—Å–∫–∏.",
    doHtml: `
      <ul>
        <li><b>0‚Äì39%</b>: —É—Å–∏–ª–∏–≤–∞–µ–º –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—é, —É—Ç–æ—á–Ω—è–µ–º –õ–ü–†/–±–æ–ª—å/–¥–∞–Ω–Ω—ã–µ, —Ñ–∏–∫—Å–∏—Ä—É–µ–º next step.</li>
        <li><b>40‚Äì69%</b>: –≥–æ—Ç–æ–≤–∏–º –ø–∏–ª–æ—Ç–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º —ç–∫–æ–Ω–æ–º–∏–∫—É –∏ –¥–æ—Å—Ç—É–ø—ã.</li>
        <li><b>70‚Äì100%</b>: —É—Å–∫–æ—Ä—è–µ–º—Å—è: —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –ø–∏–ª–æ—Ç–∞/–ö–ü, –∫–∞–ª–µ–Ω–¥–∞—Ä—å —Ä–∞–±–æ—Ç, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ.</li>
      </ul>`
  },
  kRecover: {
    title: "–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –≤–æ–∑–≤—Ä–∞—Ç–∞ –±—é–¥–∂–µ—Ç–∞",
    sub: "–≠–∫–æ–Ω–æ–º–∏—è –Ω–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ª–∏—Ü–µ–Ω–∑–∏—è—Ö –∏ –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–∞—Ö.",
    what: "–°–∫–æ–ª—å–∫–æ –±—é–¥–∂–µ—Ç–∞ –º–æ–∂–Ω–æ ¬´–≤–µ—Ä–Ω—É—Ç—å¬ª –∑–∞ —Å—á—ë—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ª–∏—Ü–µ–Ω–∑–∏–π –∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã.",
    how: "–ë–µ—Ä—ë—Ç—Å—è % –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ –ü–û (–∏ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ ‚Äî –∏–∑–±—ã—Ç–æ—á–Ω–æ—Å—Ç—å VM) –∏ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è –≤ –∏–Ω–¥–µ–∫—Å: —á–µ–º –±–æ–ª—å—à–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ, —Ç–µ–º –Ω–∏–∂–µ —Ç–µ–∫—É—â–∞—è –∑—Ä–µ–ª–æ—Å—Ç—å –∏ —Ç–µ–º –≤—ã—à–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª —ç–∫–æ–Ω–æ–º–∏–∏.",
    impact: "–ü—Ä—è–º–∞—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–∏–ª–æ—Ç–∞: –Ω–∞ —ç—Ç–æ–º –∏–Ω–¥–µ–∫—Å–µ –ø—Ä–æ—â–µ –≤—Å–µ–≥–æ –ø–æ–∫–∞–∑–∞—Ç—å –±—ã—Å—Ç—Ä—ã–π —ç—Ñ—Ñ–µ–∫—Ç.",
    doHtml: `
      <ul>
        <li><b>0‚Äì39%</b>: –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª —ç–∫–æ–Ω–æ–º–∏–∏ –Ω–∏–∑–∫–∏–π ‚Äî —Ñ–æ–∫—É—Å –Ω–∞ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å, –Ω–µ –æ–±–µ—â–∞–µ–º ¬´–º–Ω–æ–≥–æ –¥–µ–Ω–µ–≥¬ª.</li>
        <li><b>40‚Äì69%</b>: –µ—Å—Ç—å –æ—â—É—Ç–∏–º–∞—è —ç–∫–æ–Ω–æ–º–∏—è ‚Äî –ø–∏–ª–æ—Ç –Ω–∞ –ª–∏—Ü–µ–Ω–∑–∏–∏ + –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é + –æ—Ç—á—ë—Ç—ã.</li>
        <li><b>70‚Äì100%</b>: –≤—ã—Å–æ–∫–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª ‚Äî –Ω–∞—á–∏–Ω–∞–µ–º —Å SAM/usage –∏ –±—ã—Å—Ç—Ä—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π (–ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ/—Å–Ω—è—Ç–∏–µ).</li>
      </ul>`
  },
  kBus: {
    title: "–ò–Ω–¥–µ–∫—Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ª—é–¥–µ–π (Bus‚Äëfactor)",
    sub: "–†–∏—Å–∫ ¬´–¥–µ—Ä–∂–∏—Ç—Å—è –Ω–∞ 1‚Äì2 –ª—é–¥—è—Ö¬ª + –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.",
    what: "–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ –∑–Ω–∞–Ω–∏—è –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –∞–∫—Ç–∏–≤–∞–º–∏ –∑–∞–≤—è–∑–∞–Ω—ã –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞—Ö/–ø–æ–¥—Ä—è–¥—á–∏–∫–∞—Ö.",
    how: "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –æ—Ç–≤–µ—Ç—ã –ø—Ä–æ ¬´–Ω–µ–∑–∞–º–µ–Ω–∏–º—ã—Ö¬ª –∏ —É—Ä–æ–≤–µ–Ω—å –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏/—Ä–µ–≥–ª–∞–º–µ–Ω—Ç–æ–≤ (–¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –ø–æ–ª—è) + –ø—Ä–æ—Ü–µ—Å—Å–Ω—É—é –∑—Ä–µ–ª–æ—Å—Ç—å.",
    impact: "–í–ª–∏—è–µ—Ç –Ω–∞ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å: –±–µ–∑ —Å–Ω–∏–∂–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —ç—Ñ—Ñ–µ–∫—Ç –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –±—É–¥–µ—Ç –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–º.",
    doHtml: `
      <ul>
        <li><b>0‚Äì39%</b>: –≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ ‚Äî —Ñ–æ—Ä–º–∞–ª–∏–∑—É–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, –æ–ø–∏—Å—ã–≤–∞–µ–º –º–∏–Ω–∏–º—É–º –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, —Ñ–∏–∫—Å–∏—Ä—É–µ–º –∑–Ω–∞–Ω–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ.</li>
        <li><b>40‚Äì69%</b>: —Å—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫ ‚Äî –≤–≤–æ–¥–∏–º —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –æ—Ç—á—ë—Ç—ã/–∞—É–¥–∏—Ç, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–æ–ª–∏.</li>
        <li><b>70‚Äì100%</b>: –Ω–∏–∑–∫–∏–π —Ä–∏—Å–∫ ‚Äî –º–æ–∂–Ω–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –±–µ–∑ —Å—Ç—Ä–∞—Ö–∞ ¬´–ø–æ—Ç–µ—Ä—è—Ç—å –∫–ª—é—á–µ–≤–æ–≥–æ¬ª.</li>
      </ul>`
  },
  kObsol: {
    title: "–ò–Ω–¥–µ–∫—Å —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ —Å—Ç–∞—Ä–µ–Ω–∏—è",
    sub: "–£—Å—Ç–∞—Ä–µ–≤—à–∏–µ –û–°/–ü–û + –≤–æ–∑—Ä–∞—Å—Ç –ø–∞—Ä–∫–∞.",
    what: "–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥: —Å–∫–æ–ª—å–∫–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —É—Å—Ç–∞—Ä–µ–ª–æ –∏ –ø–æ–≤—ã—à–∞–µ—Ç —Ä–∏—Å–∫–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏/–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.",
    how: "–ë–µ—Ä—ë—Ç—Å—è % —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –û–°/–ü–û (–µ—Å–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ) + —Ñ–∞–∫—Ç–æ—Ä –≤–æ–∑—Ä–∞—Å—Ç–∞ –∂–µ–ª–µ–∑–∞ (–ø–æ–ª–µ ¬´–í–æ–∑—Ä–∞—Å—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∂–µ–ª–µ–∑–∞¬ª).",
    impact: "–í–ª–∏—è–µ—Ç –Ω–∞ —Ä–∏—Å–∫–∏ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤, —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏.",
    doHtml: `
      <ul>
        <li><b>0‚Äì39%</b>: –∫—Ä–∏—Ç–∏—á–Ω–æ ‚Äî –ø–ª–∞–Ω –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö —Å–µ–≥–º–µ–Ω—Ç–æ–≤, –∫–æ–Ω—Ç—Ä–æ–ª—å –≤–µ—Ä—Å–∏–π –∏ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω–æ–≥–æ –ü–û.</li>
        <li><b>40‚Äì69%</b>: —É–º–µ—Ä–µ–Ω–Ω–æ ‚Äî —Å–æ—Å—Ç–∞–≤–ª—è–µ–º roadmap –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏ –≤–≤–æ–¥–∏–º –∫–æ–Ω—Ç—Ä–æ–ª—å –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞.</li>
        <li><b>70‚Äì100%</b>: —Ö–æ—Ä–æ—à–æ ‚Äî –º–æ–∂–Ω–æ —Å–º–µ—â–∞—Ç—å —Ñ–æ–∫—É—Å –Ω–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é.</li>
      </ul>`
  },
  kAI: {
    title: "–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ò–ò / –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏",
    sub: "–ù–∞—Å–∫–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ –∏ –∫–æ–Ω—Ç—É—Ä –≥–æ—Ç–æ–≤—ã –∫ –≤–Ω–µ–¥—Ä–µ–Ω–∏—é –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏/–∞–Ω–∞–ª–∏—Ç–∏–∫–∏.",
    what: "–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –º–æ–∂–Ω–æ –ª–∏ —Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é/–∞–Ω–∞–ª–∏—Ç–∏–∫—É/–ò–ò –ø–æ–≤–µ—Ä—Ö –¥–∞–Ω–Ω—ã—Ö ‚Äî –∏–ª–∏ —Å–Ω–∞—á–∞–ª–∞ –Ω—É–∂–µ–Ω –ø–æ—Ä—è–¥–æ–∫ –≤ –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è.",
    how: "–ö–æ–º–±–∏–Ω–∞—Ü–∏—è —Ç–µ—Ö. –∑—Ä–µ–ª–æ—Å—Ç–∏ –∏ –ø—Ä–æ—Ü–µ—Å—Å–Ω–æ–π –∑—Ä–µ–ª–æ—Å—Ç–∏ + –Ω–∞–ª–∏—á–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤/—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö (–≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞).",
    impact: "–í–ª–∏—è–µ—Ç –Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–µ–ª–∞—Ç—å –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É (heatmap –ü–û, –ø—Ä–æ–≥–Ω–æ–∑—ã, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∏).",
    doHtml: `
      <ul>
        <li><b>0‚Äì39%</b>: —Å–Ω–∞—á–∞–ª–∞ –ø–æ—Ä—è–¥–æ–∫ –≤ –¥–∞–Ω–Ω—ã—Ö (–∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è, –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è, –µ–¥–∏–Ω—ã–π —Ä–µ–µ—Å—Ç—Ä).</li>
        <li><b>40‚Äì69%</b>: –º–æ–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å —Å –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–æ–≤/–ø—Ä–∞–≤–∏–ª –∏ –ø—Ä–æ—Å—Ç—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.</li>
        <li><b>70‚Äì100%</b>: –º–æ–∂–Ω–æ —Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ (–ø—Ä–µ–¥–∏–∫—Ç–∏–≤–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, –∞–≤—Ç–æ–ø–æ–ª–∏—Ç–∏–∫–∏).</li>
      </ul>`
  }
  ,

  // --- Risk & Readiness (auto) ---
  kPilotReady: {
    title: "Pilot Readiness Index",
    sub: "–ò–Ω–¥–µ–∫—Å –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –ø–∏–ª–æ—Ç—É (1 ‚àí —Å—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫ –ø–æ –∑–æ–Ω–∞–º) √ó 100",
    what: "–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ ¬´–ª–µ–≥–∫–æ¬ª –ø—Ä–æ–π—Ç–∏ –ø–∏–ª–æ—Ç: —á–µ–º –Ω–∏–∂–µ —Ä–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º –∑–æ–Ω–∞–º (–¥–∞–Ω–Ω—ã–µ/–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞, –ª–∏—Ü–µ–Ω–∑–∏–∏, —Ä—É—á–Ω–æ–π —Ç—Ä—É–¥, —É–ø—Ä–∞–≤–ª—è–µ–º–æ—Å—Ç—å), —Ç–µ–º –≤—ã—à–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å.",
    how: "–°–Ω–∞—á–∞–ª–∞ —Å—á–∏—Ç–∞–µ–º —Ä–∏—Å–∫ –ø–æ 4 –∑–æ–Ω–∞–º: Œ£(–í–µ—Å√ó–û—Ç–≤–µ—Ç) / Œ£(–í–µ—Å –∑–æ–Ω—ã), –≥–¥–µ –û—Ç–≤–µ—Ç: –î–∞=0, –ß–∞—Å—Ç–∏—á–Ω–æ=0.5, –ù–µ—Ç=1. –î–∞–ª–µ–µ –±–µ—Ä—ë–º —Å—Ä–µ–¥–Ω–µ–µ –ø–æ –∑–æ–Ω–∞–º –∏ —Å—á–∏—Ç–∞–µ–º Ready = (1 ‚àí RiskAvg) √ó 100.",
    impact: "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, —á—Ç–æ–±—ã –±—ã—Å—Ç—Ä–æ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ø–∏–ª–æ—Ç: <50 ‚Äî —Å–ª–æ–∂–Ω—ã–π (–Ω—É–∂–Ω—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã), 50‚Äì70 ‚Äî —Å—Ä–µ–¥–Ω–∏–π, 70+ ‚Äî –±—ã—Å—Ç—Ä—ã–π.",
    doHtml: `
      <ul>
        <li><b>&lt;50%</b>: —Å–Ω–∞—á–∞–ª–∞ –∑–∞–∫—Ä—ã–≤–∞–µ–º 1‚Äì2 —Å–∞–º—ã–µ –∫—Ä–∞—Å–Ω—ã–µ –∑–æ–Ω—ã (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç—É—Ä –¥–∞–Ω–Ω—ã—Ö/–¥–æ—Å—Ç—É–ø–æ–≤), –∑–∞—Ç–µ–º –ø–∏–ª–æ—Ç.</li>
        <li><b>50‚Äì70%</b>: –ø–∏–ª–æ—Ç –≤–æ–∑–º–æ–∂–µ–Ω, –Ω–æ —Ñ–∏–∫—Å–∏—Ä—É–µ–º –≥—Ä–∞–Ω–∏—Ü—ã (–æ—Ö–≤–∞—Ç, —Å—Ä–æ–∫–∏) –∏ –∫—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞.</li>
        <li><b>70%+</b>: –º–æ–∂–Ω–æ –∏–¥—Ç–∏ –≤ –ø–∏–ª–æ—Ç —É–≤–µ—Ä–µ–Ω–Ω–æ –∏ —Ä–∞—Å—à–∏—Ä—è—Ç—å –æ—Ö–≤–∞—Ç.</li>
      </ul>`
  },
  kMainProblem: {
    title: "–û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞",
    sub: "–ó–æ–Ω–∞ —Ä–∏—Å–∫–∞ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –≤–∫–ª–∞–¥–æ–º",
    what: "–≠—Ç–æ ¬´–≥–ª–∞–≤–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞ –±–æ–ª–∏¬ª –ø–æ –º–æ–¥–µ–ª–∏: –≥–¥–µ —Ä–∏—Å–∫ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π ‚Äî —Ç—É–¥–∞ –∏ –±—å—ë–º –¥–µ–º–æ/–ø–∏–ª–æ—Ç –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å.",
    how: "–ë–µ—Ä—ë–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –∏–∑ 4 –∑–æ–Ω —Ä–∏—Å–∫–∞ (—Å–µ—Ä—ã–µ –∑–æ–Ω—ã / –ª–∏—Ü–µ–Ω–∑–∏–∏ / —Ä—É—á–Ω–æ–π —Ç—Ä—É–¥ / —É–ø—Ä–∞–≤–ª—è–µ–º–æ—Å—Ç—å).",
    impact: "–ü–æ–∑–≤–æ–ª—è–µ—Ç –Ω–µ —Ä–∞—Å–ø—ã–ª—è—Ç—å—Å—è: –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å 1 –≥–ª–∞–≤–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –¥–µ–º–æ –∏ —Å–æ–±—Ä–∞—Ç—å –ø–∏–ª–æ—Ç –≤–æ–∫—Ä—É–≥ –Ω–µ–≥–æ.",
    doHtml: `
      <div class="small">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –∑–æ–Ω–∞ —Ä–∏—Å–∫–∞ = Œ£(–í–µ—Å√ó–û—Ç–≤–µ—Ç) / Œ£(–í–µ—Å –∑–æ–Ω—ã). –ß–µ–º –±–ª–∏–∂–µ –∫ 100%, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ –±–æ–ª—å.</div>
      <ul style="margin-top:8px">
        <li><b>–°–µ—Ä—ã–µ –∑–æ–Ω—ã</b> ‚Üí –Ω–∞—á–∞—Ç—å —Å –∞–≥—Ä–µ–≥–∞—Ü–∏–∏/–æ—Ö–≤–∞—Ç–∞ –∏ –µ–¥–∏–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω—ã.</li>
        <li><b>–õ–∏—Ü–µ–Ω–∑–∏–∏</b> ‚Üí –Ω–∞—á–∞—Ç—å —Å –ü—Ä–∏–∑–º—ã (–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ü–û, –∫–æ–Ω—Ç—Ä–æ–ª—å –ª–∏—Ü–µ–Ω–∑–∏–π).</li>
        <li><b>–†—É—á–Ω–æ–π —Ç—Ä—É–¥</b> ‚Üí –Ω–∞—á–∞—Ç—å —Å –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –∏ —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è —Ä—É—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.</li>
        <li><b>–£–ø—Ä–∞–≤–ª—è–µ–º–æ—Å—Ç—å</b> ‚Üí –Ω–∞—á–∞—Ç—å —Å –∏—Å—Ç–æ—Ä–∏–∏/–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏–π.</li>
      </ul>`
  },
  kModules: {
    title: "–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è",
    sub: "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ –ø–æ—Ä–æ–≥–∞–º —Ä–∏—Å–∫–∞",
    what: "–ü–æ–¥–±–∏—Ä–∞–µ—Ç –Ω–∞–±–æ—Ä –º–æ–¥—É–ª–µ–π –ò–¢–ú–µ–Ω –ø–æ–¥ –ø—Ä–æ—Ñ–∏–ª—å –±–æ–ª–∏ –∫–ª–∏–µ–Ω—Ç–∞, —á—Ç–æ–±—ã –ø–∏–ª–æ—Ç –∏ –¥–µ–º–æ –±—ã–ª–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã.",
    how: "–°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ä–∏—Å–∫ –ø–æ –∑–æ–Ω–∞–º —Å –ø–æ—Ä–æ–≥–∞–º–∏ (–≤—à–∏—Ç—ã): –°–µ—Ä—ã–µ –∑–æ–Ω—ã‚â•40% ‚Üí –ë–∞–∑–æ–≤—ã–π; –õ–∏—Ü–µ–Ω–∑–∏–∏‚â•30% ‚Üí –ü—Ä–∏–∑–º–∞; –£–ø—Ä–∞–≤–ª—è–µ–º–æ—Å—Ç—å‚â•40% ‚Üí –ì–∏–±–∫–∞—è –º–æ–¥–µ–ª—å; –†—É—á–Ω–æ–π —Ç—Ä—É–¥‚â•50% ‚Üí –û–±–æ–≥–∞—â–µ–Ω–∏–µ.",
    impact: "–°–Ω–∏–∂–∞–µ—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å ¬´–ø–æ–∫–∞–∑–∞–ª–∏ –Ω–µ —Ç–æ¬ª –∏ —É—Å–∫–æ—Ä—è–µ—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –ø–∏–ª–æ—Ç–∞.",
    doHtml: `<div class="small">–≠—Ç–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–ª—è —Å—Ç–∞—Ä—Ç–∞. –î–∞–ª—å—à–µ –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø–æ –º–µ—Ä–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏ —É—Ç–æ—á–Ω–µ–Ω–∏—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π.</div>`
  },
  kDemo: {
    title: "–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–µ–º–æ",
    sub: "–°—Ç–∞—Ä—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –¥–µ–º–æ –ø–æ –≥–ª–∞–≤–Ω–æ–π –∑–æ–Ω–µ —Ä–∏—Å–∫–∞",
    what: "–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —Å –∫–∞–∫–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è –¥–µ–º–æ –Ω–∞—á–∞—Ç—å, —á—Ç–æ–±—ã –±—ã—Å—Ç—Ä–æ ¬´–ø–æ–ø–∞—Å—Ç—å –≤ –±–æ–ª—å¬ª –∏ –∑–∞–∫—Ä–µ–ø–∏—Ç—å —Ü–µ–Ω–Ω–æ—Å—Ç—å.",
    how: "–°—Ü–µ–Ω–∞—Ä–∏–π –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –ø–æ –∑–æ–Ω–µ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º —Ä–∏—Å–∫–æ–º (—Å–º. ¬´–û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞¬ª).",
    impact: "–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∫–æ–Ω–≤–µ—Ä—Å–∏—é –¥–µ–º–æ ‚Üí –ø–∏–ª–æ—Ç, –ø–æ—Ç–æ–º—É —á—Ç–æ –ø–µ—Ä–≤—ã–µ 5‚Äì10 –º–∏–Ω—É—Ç –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –∏–º–µ–Ω–Ω–æ —Ç–æ, –∑–∞ —á—Ç–æ –∫–ª–∏–µ–Ω—Ç –≥–æ—Ç–æ–≤ –ø–ª–∞—Ç–∏—Ç—å.",
    doHtml: `
      <ul>
        <li><b>–°–µ—Ä—ã–µ –∑–æ–Ω—ã</b>: –ø–æ–∫–∞–∑–∞—Ç—å –∞–≥—Ä–µ–≥–∞—Ü–∏—é –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ ‚Üí –µ–¥–∏–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ ‚Üí coverage/freshness.</li>
        <li><b>–õ–∏—Ü–µ–Ω–∑–∏–∏</b>: –ø–æ–∫–∞–∑–∞—Ç—å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é –ü–û ‚Üí —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ ‚Üí —ç–∫–æ–Ω–æ–º–∏—è –Ω–∞ –ª–∏—Ü–µ–Ω–∑–∏—è—Ö.</li>
        <li><b>–†—É—á–Ω–æ–π —Ç—Ä—É–¥</b>: –ø–æ–∫–∞–∑–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é –æ—Ç—á—ë—Ç–æ–≤/—Å–≤–µ—Ä–æ–∫ ‚Üí —Å–Ω–∏–∂–µ–Ω–∏–µ —Ä—É—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.</li>
        <li><b>–£–ø—Ä–∞–≤–ª—è–µ–º–æ—Å—Ç—å</b>: –ø–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π ‚Üí –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å ‚Üí –∫–æ–Ω—Ç—Ä–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∏–π.</li>
      </ul>`
  }
};

function kpiModalOpen(kpiId){
  const meta = KPI_META[kpiId];
  if(!meta) return;
  const m = document.getElementById("kpiModal");
  if(!m) return;
  // Defensive: modal markup may vary across pages
  const tEl = document.getElementById("kpiModalTitle");
  if(tEl) tEl.textContent = meta.title || "–ò–Ω–¥–µ–∫—Å";
  const sEl = document.getElementById("kpiModalSub");
  if(sEl) sEl.textContent = meta.sub || "";
  const wEl = document.getElementById("kpiModalWhat");
  if(wEl) wEl.textContent = meta.what || "‚Äî";
  const hEl = document.getElementById("kpiModalHow");
  if(hEl) hEl.textContent = meta.how || "‚Äî";
  const iEl = document.getElementById("kpiModalImpact");
  if(iEl) iEl.textContent = meta.impact || "‚Äî";
  const dEl = document.getElementById("kpiModalDo");
  if(dEl) dEl.innerHTML = meta.doHtml || "‚Äî";
  // Data + confidence (synthetic benchmarks)
  const dataEl = document.getElementById("kpiModalData");
  if(dataEl) dataEl.innerHTML = kpiBuildDataHtml(kpiId);

  const unc = document.getElementById("kpiModalUnc");
  const rngEl = document.getElementById("kpiModalRange");
  const barEl = document.getElementById("kpiModalRangeBar");
  if(unc && rngEl && barEl){
    let r = null;
    if(kpiId === "kRecover") r = recoverRange();
    if(r){
      unc.style.display = "block";
      rngEl.textContent = `${r[0]}‚Äì${r[1]}%`;
      // visualize as 0..100
      const w = Math.max(2, Math.min(100, r[1]-r[0]));
      barEl.style.width = `${w}%`;
      barEl.style.marginLeft = `${Math.max(0, Math.min(98, r[0]))}%`;
      barEl.style.background = "rgba(59,130,246,.65)";
    } else {
      unc.style.display = "none";
    }
  }

  const nEl = document.getElementById("kpiModalNote");
  if(nEl) nEl.textContent = meta.note || "";
  m.setAttribute("aria-hidden","false");
  // focus close for accessibility
  const closeBtn = document.getElementById("kpiModalClose");
  closeBtn && closeBtn.focus && closeBtn.focus();
}

function kpiModalClose(){
  const m = document.getElementById("kpiModal");
  if(!m) return;
  m.setAttribute("aria-hidden","true");
}

function setupKpiExplain(){
  const bars = document.querySelectorAll(".kpiBar");
  if(!bars || !bars.length) return;

  bars.forEach(bar=>{
    // make KPI cards clearly clickable
    bar.querySelectorAll(".stat[id]").forEach(el=>{
      el.classList.add("kpi-clickable");
      el.setAttribute("role","button");
      el.setAttribute("tabindex","0");
      el.setAttribute("aria-label","–û—Ç–∫—Ä—ã—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ" );
    });

    // robust click/tap delegation
    bar.addEventListener("click",(e)=>{
      // Prevent KPI modal from opening when user interacts with expandable lists / controls inside cards
      if(e?.target?.tagName==="SUMMARY" || e?.target?.closest?.("details.demoDetails")) return;
      const stat = e.target.closest(".stat[id]");
      if(!stat) return;
      kpiModalOpen(stat.id);
    });

    // keyboard open (Enter/Space)
    bar.addEventListener("keydown",(e)=>{
      if(e.key !== "Enter" && e.key !== " ") return;
      const stat = e.target.closest?.(".stat[id]");
      if(!stat) return;
      e.preventDefault();
      kpiModalOpen(stat.id);
    });
  });

  // hover open (only on devices that support hover)
  const canHover = window.matchMedia && window.matchMedia("(hover:hover)").matches;
  if(canHover){
    let t=null, lastId=null;
    bar.addEventListener("pointerover",(e)=>{
      const stat = e.target.closest(".stat[id]");
      if(!stat) return;
      lastId = stat.id;
      clearTimeout(t);
      t = setTimeout(()=>{ if(lastId) kpiModalOpen(lastId); }, 550);
    });
    bar.addEventListener("pointerout",()=>{ clearTimeout(t); lastId=null; });
  }

  // modal close handlers
  const closeBtn = document.getElementById("kpiModalClose");
  closeBtn && closeBtn.addEventListener("click", kpiModalClose);
  const modal = document.getElementById("kpiModal");
  modal && modal.addEventListener("click",(e)=>{
    if(e.target && e.target.getAttribute && e.target.getAttribute("data-kpi-close")==="1") kpiModalClose();
  });
  document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") kpiModalClose(); });
}

document.addEventListener("DOMContentLoaded", ()=>{ try{ setupKpiExplain(); }catch(e){ console.error("KPI modal init error", e); } });

document.addEventListener("DOMContentLoaded", ()=>{ try{ recalc(); }catch(e){ console.error(e); } });

/* ===== Benchmark transparency (manager visibility) ===== */
function fmtRange(r){
  if(!r || !isFinite(r[0]) || !isFinite(r[1])) return "‚Äî";
  const a = Math.round(r[0]); const b = Math.round(r[1]);
  return `${a}‚Äì${b}`;
}
function fmtVal(v, key){
  if(!isFinite(v)) return "‚Äî";
  const vv = (key.endsWith("Pct") ? Math.round(v) : (Number.isInteger(v) ? v : Math.round(v*10)/10));
  return key.endsWith("Pct") ? `${vv}%` : `${vv}`;
}
function benchKeyLabel(key){
  const map = {
    manualPct:"–î–æ–ª—è —Ä—É—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –ò–¢",
    unusedPct:"–ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ª–∏—Ü–µ–Ω–∑–∏–∏ (–æ—Ü–µ–Ω–∫–∞)",
    vmUnusedPct:"–ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ VM/—Ä–µ—Å—É—Ä—Å—ã",
    incidentsPerMonth:"–ò–Ω—Ü–∏–¥–µ–Ω—Ç—ã –≤ –º–µ—Å—è—Ü (–æ—Ü–µ–Ω–∫–∞)",
    downtimeHours:"–ü—Ä–æ—Å—Ç–æ–∏ (—á/–≥–æ–¥, –æ—Ü–µ–Ω–∫–∞)",
    downtimeCost:"–°—Ç–æ–∏–º–æ—Å—Ç—å —á–∞—Å–∞ –ø—Ä–æ—Å—Ç–æ—è (‚ÇΩ)",
    obsoletePct:"–£—Å—Ç–∞—Ä–µ–≤—à–∏–µ –û–°/–ü–û (–æ—Ü–µ–Ω–∫–∞)",
    keyPeopleRisk:"–ù–µ–∑–∞–º–µ–Ω–∏–º—ã–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã (0/1)",
    docScore:"–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (0‚Äì2)",
    techMaturityPct:"–¢–µ—Ö. –∑—Ä–µ–ª–æ—Å—Ç—å (–±–µ–Ω—á–º–∞—Ä–∫, %)",
    procMaturityPct:"–ü—Ä–æ—Ü. –∑—Ä–µ–ª–æ—Å—Ç—å (–±–µ–Ω—á–º–∞—Ä–∫, %)",
    riskProb:"–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ä–∏—Å–∫–æ–≤ (–±–µ–Ω—á–º–∞—Ä–∫, –¥–æ–ª—è)",
    feasibilityPct:"–†–µ–∞–ª–∏–∑—É–µ–º–æ—Å—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π (–±–µ–Ω—á–º–∞—Ä–∫, %)",
    changeMaturityPct:"–ó—Ä–µ–ª–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–π (–±–µ–Ω—á–º–∞—Ä–∫, %)",
    scalabilityPct:"–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å (–±–µ–Ω—á–º–∞—Ä–∫, %)",
    aiReadinessPct:"AI –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å (–±–µ–Ω—á–º–∞—Ä–∫, %)"
  };
  return map[key] || key;
}
function updateBenchTransparency(){
  try{
    const prof = getProfile();
    const keys = [
      {key:"manualPct", elId:"manualPct"},
      {key:"unusedPct", elId:"unusedPct"},
      {key:"vmUnusedPct", elId:"vmUnusedPct"},
      {key:"incidentsPerMonth", elId:"incidentsPerMonth"},
      {key:"downtimeHours", elId:"downtimeHours"},
      {key:"downtimeCost", elId:"downtimeCost"},
      {key:"obsoletePct", elId:"obsoletePct"},
      {key:"keyPeopleRisk", elId:"keyPeopleRisk"},
      {key:"docScore", elId:"docScore"},
      {key:"techMaturityPct", elId:"__none__"},
      {key:"procMaturityPct", elId:"__none__"},
      {key:"riskProb", elId:"__none__"},
      {key:"feasibilityPct", elId:"__none__"},
      {key:"changeMaturityPct", elId:"__none__"},
      {key:"scalabilityPct", elId:"__none__"},
      {key:"aiReadinessPct", elId:"__none__"},
    ];

    const rows = [];
    let benchCount = 0;
    let totalCount = 0;

    for(const k of keys){
      const est = estimateParam(k.key, {elId:k.elId});
      const src = est.src;
      const v = est.v;
      const range = est.range;
      // count only when value used and sourced from bench
      totalCount++;
      if(src==="bench") benchCount++;

      rows.push({
        key:k.key,
        label: benchKeyLabel(k.key),
        value: fmtVal(v, k.key),
        range: fmtRange(range),
        src: src==="bench" ? "üîµ –±–µ–Ω—á–º–∞—Ä–∫" : (src==="client" ? "üü¢ –∫–ª–∏–µ–Ω—Ç" : "‚Äî")
      });
    }

    // badge
    const countEl = document.getElementById("benchCount");
    if(countEl) countEl.textContent = String(benchCount);
    const profEl = document.getElementById("benchProfileLabel");
    if(profEl){
      const bucket = prof.bucket || "‚Äî";
      profEl.textContent = `(${prof.industry || "‚Äî"}, ${bucket})`;
    }

    // details table
    const meta = document.getElementById("benchDetailsMeta");
    if(meta){
      meta.textContent = `–ü—Ä–æ—Ñ–∏–ª—å –±–µ–Ω—á–º–∞—Ä–∫–∞: ${prof.industry || "‚Äî"} / ${prof.bucket || "‚Äî"}; –º–∞—Å—à—Ç–∞–±: ${prof.total || "‚Äî"}; —Ñ–∏–ª–∏–∞–ª—ã: ${prof.branches || "‚Äî"}. –°–∏–Ω—Ç–µ—Ç–∏–∫–∞ –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω–∞ –¥–ª—è ${benchCount} –∏–∑ ${totalCount} –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.`;
    }
    const tbody = document.getElementById("benchDetailsTbody");
    if(tbody){
      tbody.innerHTML = rows.map(r=>`
        <tr>
          <td>${r.label}</td>
          <td class="mono">${r.value}</td>
          <td class="mono">${r.range}</td>
          <td>${r.src}</td>
        </tr>
      `).join("");
    }
  }catch(e){
    console.warn("updateBenchTransparency failed", e);
  }
}

// hook into existing recalc safely
try{
  const __recalc = recalc;
  recalc = function(){
    const out = __recalc();
    updateBenchTransparency();
    return out;
  };
  // update on mode change
  const bm = document.getElementById("benchMode");
  if(bm) bm.addEventListener("change", ()=>{ try{recalc();}catch(e){} });
  // initial
  updateBenchTransparency();
}catch(e){
  console.warn("bench transparency hook failed", e);
}

function renderBenchHints(){
  const mode = document.getElementById("benchMode")?.value || "mixed";
  const hintMap = [
    // key, elementId, unit
    ["manualPct","manualPct","%"],
    ["unusedPct","unusedPct","%"],
    ["vmUnusedPct","vmUnusedPct","%"],
    ["obsoletePct","obsoletePct","%"],
    ["incidentsPerMonth","incidentsPerMonth","/–º–µ—Å"],
    ["downtimeHours","downtimeHours","—á/–≥–æ–¥"],
    ["downtimeCost","downtimeCost","‚ÇΩ/—á"],
    ["docScore","docScore","/2"],
    ["keyPeopleRisk","keyPeopleRisk",""],
    ["techMaturityPct","techMaturityPct","%"],
    ["procMaturityPct","procMaturityPct","%"],
    ["riskProb","riskProb",""],
    ["feasibilityPct","feasibilityPct","%"],
    ["changeMaturityPct","changeMaturityPct","%"],
    ["scalabilityPct","scalabilityPct","%"],
    ["aiReadinessPct","aiReadinessPct","%"]
  ];

  function fmtRange(key, est){
    const v = est?.v;
    const p25 = est?.p25;
    const p75 = est?.p75;
    if(!Number.isFinite(v)) return "";
    const unit = (key==="incidentsPerMonth") ? "/–º–µ—Å" : (key==="downtimeHours" ? "—á/–≥–æ–¥" : (key==="downtimeCost" ? "‚ÇΩ/—á" : (key.endsWith("Pct") ? "%" : "")));
    const vv = key.endsWith("Pct") ? Math.round(v) : Math.round(v);
    const r25 = Number.isFinite(p25) ? (key.endsWith("Pct") ? Math.round(p25) : Math.round(p25)) : null;
    const r75 = Number.isFinite(p75) ? (key.endsWith("Pct") ? Math.round(p75) : Math.round(p75)) : null;
    const range = (r25!==null && r75!==null) ? ` (${r25}‚Äì${r75}${unit})` : "";
    return `${vv}${unit}${range}`;
  }

  for(const [key, elId] of hintMap){
    const el = document.getElementById(elId);
    if(!el) continue;

    // determine if "empty" from UI perspective
    let isEmpty = false;
    if(el.tagName==="INPUT" || el.tagName==="TEXTAREA"){
      isEmpty = (String(el.value||"").trim()==="");
    } else if(el.tagName==="SELECT"){
      const v = String(el.value||"").trim();
      isEmpty = (v==="" || v==="na" || v==="unknown");
    }

    // compute benchmark estimate regardless of mode (so it's a hint even in "only client")
    const est = (typeof estimateParam==="function") ? estimateParam(key, /*forceBenchHint*/ true) : null;

    // Create or find hint node
    let hint = el.parentElement?.querySelector(`.bench-hint[data-for="${elId}"]`);
    if(!hint){
      hint = document.createElement("div");
      hint.className = "bench-hint";
      hint.dataset.for = elId;
      hint.style.marginTop = "6px";
      hint.style.fontSize = "12px";
      hint.style.opacity = "0.85";
      hint.style.color = "#6b7280";
      // try to place after element within same cell
      if(el.parentElement) el.parentElement.appendChild(hint);
    }

    // Decide what to show
    if(!isEmpty){
      // if user filled, still show "—Ä—ã–Ω–æ–∫ –æ–±—ã—á–Ω–æ ..." lightly
      if(est && Number.isFinite(est.v)){
        hint.textContent = `‚ÑπÔ∏è –†—ã–Ω–æ–∫: ${fmtRange(key, est)}`;
        hint.style.color = "#6b7280";
      } else {
        hint.textContent = "";
      }
      continue;
    }

    if(!est || !Number.isFinite(est.v)){
      hint.textContent = "";
      continue;
    }

    const used = (mode!=="client"); // in mixed/bench we actually use it
    hint.textContent = used ? `üîµ –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ–Ω—á–º–∞—Ä–∫: ${fmtRange(key, est)}` : `üîµ –ü–æ–¥—Å–∫–∞–∑–∫–∞ –±–µ–Ω—á–º–∞—Ä–∫–∞: ${fmtRange(key, est)}`;
    hint.style.color = used ? "#2563eb" : "#6b7280";
  }
}


/* ===== v7.6 PATCH: exact Google Sheets header mapping ===== */
var SHEET_KEYS = (`run_id	timestamp	pdfMode	interviewMode	benchMode	cLevelText	company	industry	lpr	sources	workplaces	servers	branches	vdi	closed	envNote	virt	hostingModel	adDomains	netSeg	terminalFarms	hwAge	hwAccounting	redundancy	salary	itCount	manualPct	licBudget	unusedPct	finNote	vmUnusedPct	keyPeopleRisk	docScore	obsoletePct	hwBudget	hwPlan	downtimeHours	downtimeCost	incidentsPerMonth	serviceDesk	riskLevelText	riskNotes	psi2Score	psi2Label	techIndex	procIndex	riskIndex	coiTotal	recoverIndex	busIndex	obsolIndex	aiIndex	painIndex	feasScore	readyIndex	readyLabel	probIndex	probLabel	benchCount	benchProfileLabel	req_count	psi_count	project_risks_count	project_risk_level	project_risk_notes	tech_count	proc_count	risk_count	tech_01_label	tech_01_score	tech_01_note	tech_02_label	tech_02_score	tech_02_note	tech_03_label	tech_03_score	tech_03_note	tech_04_label	tech_04_score	tech_04_note	tech_05_label	tech_05_score	tech_05_note	tech_06_label	tech_06_score	tech_06_note	tech_07_label	tech_07_score	tech_07_note	tech_08_label	tech_08_score	tech_08_note	tech_09_label	tech_09_score	tech_09_note	tech_10_label	tech_10_score	tech_10_note	proc_01_label	proc_01_score	proc_01_note	proc_02_label	proc_02_score	proc_02_note	proc_03_label	proc_03_score	proc_03_note	proc_04_label	proc_04_score	proc_04_note	proc_05_label	proc_05_score	proc_05_note	proc_06_label	proc_06_score	proc_06_note	proc_07_label	proc_07_score	proc_07_note	proc_08_label	proc_08_score	proc_08_note	proc_09_label	proc_09_score	proc_09_note	proc_10_label	proc_10_score	proc_10_note	risk_01_label	risk_01_val	risk_01_note	risk_02_label	risk_02_val	risk_02_note	risk_03_label	risk_03_val	risk_03_note	risk_04_label	risk_04_val	risk_04_note	risk_05_label	risk_05_val	risk_05_note	risk_06_label	risk_06_val	risk_06_note	risk_07_label	risk_07_val	risk_07_note	risk_08_label	risk_08_val	risk_08_note	req_01_text	req_01_type	req_01_must	req_01_feas	req_01_metric	req_01_owner	req_02_text	req_02_type	req_02_must	req_02_feas	req_02_metric	req_02_owner	req_03_text	req_03_type	req_03_must	req_03_feas	req_03_metric	req_03_owner	req_04_text	req_04_type	req_04_must	req_04_feas	req_04_metric	req_04_owner	req_05_text	req_05_type	req_05_must	req_05_feas	req_05_metric	req_05_owner	req_06_text	req_06_type	req_06_must	req_06_feas	req_06_metric	req_06_owner	req_07_text	req_07_type	req_07_must	req_07_feas	req_07_metric	req_07_owner	req_08_text	req_08_type	req_08_must	req_08_feas	req_08_metric	req_08_owner	req_09_text	req_09_type	req_09_must	req_09_feas	req_09_metric	req_09_owner	req_10_text	req_10_type	req_10_must	req_10_feas	req_10_metric	req_10_owner	req_11_text	req_11_type	req_11_must	req_11_feas	req_11_metric	req_11_owner	req_12_text	req_12_type	req_12_must	req_12_feas	req_12_metric	req_12_owner	req_13_text	req_13_type	req_13_must	req_13_feas	req_13_metric	req_13_owner	req_14_text	req_14_type	req_14_must	req_14_feas	req_14_metric	req_14_owner	req_15_text	req_15_type	req_15_must	req_15_feas	req_15_metric	req_15_owner	req_16_text	req_16_type	req_16_must	req_16_feas	req_16_metric	req_16_owner	req_17_text	req_17_type	req_17_must	req_17_feas	req_17_metric	req_17_owner	req_18_text	req_18_type	req_18_must	req_18_feas	req_18_metric	req_18_owner	req_19_text	req_19_type	req_19_must	req_19_feas	req_19_metric	req_19_owner	req_20_text	req_20_type	req_20_must	req_20_feas	req_20_metric	req_20_owner	psi_01_scn	psi_01_exp	psi_01_act	psi_01_ok	psi_01_acc	psi_01_note	psi_02_scn	psi_02_exp	psi_02_act	psi_02_ok	psi_02_acc	psi_02_note	psi_03_scn	psi_03_exp	psi_03_act	psi_03_ok	psi_03_acc	psi_03_note	psi_04_scn	psi_04_exp	psi_04_act	psi_04_ok	psi_04_acc	psi_04_note	psi_05_scn	psi_05_exp	psi_05_act	psi_05_ok	psi_05_acc	psi_05_note	psi_06_scn	psi_06_exp	psi_06_act	psi_06_ok	psi_06_acc	psi_06_note	psi_07_scn	psi_07_exp	psi_07_act	psi_07_ok	psi_07_acc	psi_07_note	psi_08_scn	psi_08_exp	psi_08_act	psi_08_ok	psi_08_acc	psi_08_note	psi_09_scn	psi_09_exp	psi_09_act	psi_09_ok	psi_09_acc	psi_09_note	psi_10_scn	psi_10_exp	psi_10_act	psi_10_ok	psi_10_acc	psi_10_note	psi_11_scn	psi_11_exp	psi_11_act	psi_11_ok	psi_11_acc	psi_11_note	psi_12_scn	psi_12_exp	psi_12_act	psi_12_ok	psi_12_acc	psi_12_note	psi_13_scn	psi_13_exp	psi_13_act	psi_13_ok	psi_13_acc	psi_13_note	psi_14_scn	psi_14_exp	psi_14_act	psi_14_ok	psi_14_acc	psi_14_note	psi_15_scn	psi_15_exp	psi_15_act	psi_15_ok	psi_15_acc	psi_15_note	psi_16_scn	psi_16_exp	psi_16_act	psi_16_ok	psi_16_acc	psi_16_note	psi_17_scn	psi_17_exp	psi_17_act	psi_17_ok	psi_17_acc	psi_17_note	psi_18_scn	psi_18_exp	psi_18_act	psi_18_ok	psi_18_acc	psi_18_note	psi_19_scn	psi_19_exp	psi_19_act	psi_19_ok	psi_19_acc	psi_19_note	psi_20_scn	psi_20_exp	psi_20_act	psi_20_ok	psi_20_acc	psi_20_note	project_risk_01_name	project_risk_01_condition	project_risk_01_status	project_risk_01_note	project_risk_02_name	project_risk_02_condition	project_risk_02_status	project_risk_02_note	project_risk_03_name	project_risk_03_condition	project_risk_03_status	project_risk_03_note	project_risk_04_name	project_risk_04_condition	project_risk_04_status	project_risk_04_note	project_risk_05_name	project_risk_05_condition	project_risk_05_status	project_risk_05_note	project_risk_06_name	project_risk_06_condition	project_risk_06_status	project_risk_06_note	project_risk_07_name	project_risk_07_condition	project_risk_07_status	project_risk_07_note	project_risk_08_name	project_risk_08_condition	project_risk_08_status	project_risk_08_note	project_risk_09_name	project_risk_09_condition	project_risk_09_status	project_risk_09_note	project_risk_10_name	project_risk_10_condition	project_risk_10_status	project_risk_10_note	project_risk_11_name	project_risk_11_condition	project_risk_11_status	project_risk_11_note	project_risk_12_name	project_risk_12_condition	project_risk_12_status	project_risk_12_note	project_risk_13_name	project_risk_13_condition	project_risk_13_status	project_risk_13_note	project_risk_14_name	project_risk_14_condition	project_risk_14_status	project_risk_14_note	project_risk_15_name	project_risk_15_condition	project_risk_15_status	project_risk_15_note	project_risk_16_name	project_risk_16_condition	project_risk_16_status	project_risk_16_note	project_risk_17_name	project_risk_17_condition	project_risk_17_status	project_risk_17_note	project_risk_18_name	project_risk_18_condition	project_risk_18_status	project_risk_18_note	project_risk_19_name	project_risk_19_condition	project_risk_19_status	project_risk_19_note	project_risk_20_name	project_risk_20_condition	project_risk_20_status	project_risk_20_note	sales_manager	presale_manager	pilotGoal	pilotScope	pilotSummary	pilotDecision	recommendedConfig	pilotTasks_removed	pilotKpi_removed	psi_01_req	psi_02_req	psi_03_req	psi_04_req	psi_05_req	psi_06_req	psi_07_req	psi_08_req	psi_09_req	psi_10_req	psi_11_req	psi_12_req	psi_13_req	psi_14_req	psi_15_req	psi_16_req	psi_17_req	psi_18_req	psi_19_req	psi_20_req	prod_01_biz	prod_01_func	prod_01_type	prod_01_must	prod_01_feas	prod_02_biz	prod_02_func	prod_02_type	prod_02_must	prod_02_feas	prod_03_biz	prod_03_func	prod_03_type	prod_03_must	prod_03_feas	prod_04_biz	prod_04_func	prod_04_type	prod_04_must	prod_04_feas	prod_05_biz	prod_05_func	prod_05_type	prod_05_must	prod_05_feas	prod_06_biz	prod_06_func	prod_06_type	prod_06_must	prod_06_feas	prod_07_biz	prod_07_func	prod_07_type	prod_07_must	prod_07_feas	prod_08_biz	prod_08_func	prod_08_type	prod_08_must	prod_08_feas	prod_09_biz	prod_09_func	prod_09_type	prod_09_must	prod_09_feas	prod_10_biz	prod_10_func	prod_10_type	prod_10_must	prod_10_feas	prod_11_biz	prod_11_func	prod_11_type	prod_11_must	prod_11_feas	prod_12_biz	prod_12_func	prod_12_type	prod_12_must	prod_12_feas	prod_13_biz	prod_13_func	prod_13_type	prod_13_must	prod_13_feas	prod_14_biz	prod_14_func	prod_14_type	prod_14_must	prod_14_feas	prod_15_biz	prod_15_func	prod_15_type	prod_15_must	prod_15_feas	prod_16_biz	prod_16_func	prod_16_type	prod_16_must	prod_16_feas	prod_17_biz	prod_17_func	prod_17_type	prod_17_must	prod_17_feas	prod_18_biz	prod_18_func	prod_18_type	prod_18_must	prod_18_feas	prod_19_biz	prod_19_func	prod_19_type	prod_19_must	prod_19_feas	prod_20_biz	prod_20_func	prod_20_type	prod_20_must	prod_20_feas	prod_21_biz	prod_21_func	prod_21_type	prod_21_must	prod_21_feas	prod_22_biz	prod_22_func	prod_22_type	prod_22_must	prod_22_feas	prod_23_biz	prod_23_func	prod_23_type	prod_23_must	prod_23_feas	prod_24_biz	prod_24_func	prod_24_type	prod_24_must	prod_24_feas	prod_25_biz	prod_25_func	prod_25_type	prod_25_must	prod_25_feas	prod_26_biz	prod_26_func	prod_26_type	prod_26_must	prod_26_feas	prod_27_biz	prod_27_func	prod_27_type	prod_27_must	prod_27_feas	prod_28_biz	prod_28_func	prod_28_type	prod_28_must	prod_28_feas	prod_29_biz	prod_29_func	prod_29_type	prod_29_must	prod_29_feas	prod_30_biz	prod_30_func	prod_30_type	prod_30_must	prod_30_feas	payload`).split(/\t/);

// Ensure required columns exist in mapping
try{
  if(Array.isArray(SHEET_KEYS)){
    if(!SHEET_KEYS.includes('run_id')) SHEET_KEYS.unshift('run_id');
    if(!SHEET_KEYS.includes('timestamp')) SHEET_KEYS.splice(1,0,'timestamp');
  }
}catch(_e){}
window.SHEET_KEYS = SHEET_KEYS;


// Compat layer: the Sheet template uses prodreq_* columns for product requirements.
// If we trim payload by SHEET_KEYS and prodreq_* aren't present, they get dropped on save.
(function ensureSheetKeysCompat(){
  try{
    const need = [];
    const has = (k)=>SHEET_KEYS.indexOf(k)>=0;
    if(!has("prodreq_count")) need.push("prodreq_count");
    for(let i=1;i<=30;i++){
      const n = String(i).padStart(2,"0");
      ["biz","func","type","must","feas"].forEach(sfx=>{
        const k = `prodreq_${n}_${sfx}`;
        if(!has(k)) need.push(k);
      });
    }
    if(need.length) SHEET_KEYS.push(...need);
  }catch(e){ console.warn("ensureSheetKeysCompat failed", e); }
})();

function _el(id){ return document.getElementById(id); }
function _val(id){
  const el=_el(id);
  if(!el) return "";
  const tag=(el.tagName||"").toLowerCase();
  if(tag==="input" || tag==="select" || tag==="textarea") return (el.value ?? "");
  return (el.textContent ?? "").trim();
}
function _cellVal(cell){
  if(!cell) return "";
  const inp = cell.querySelector("textarea,input,select");
  if(inp) return (inp.value ?? "");
  return (cell.textContent ?? "").trim();
}
function _numFromText(t){
  if(t===null || t===undefined) return "";
  const s=String(t).replace(/\s/g,"").replace(/‚ÇΩ/g,"").replace(/%/g,"").replace(/,/g,".");
  const m=s.match(/-?\d+(\.\d+)?/);
  return m ? m[0] : "";
}

function buildSheetPayloadExact(){
  // Ensure KPI up to date
  try{ if(typeof recalc==="function") recalc(); }catch(_){}
  const out = {};

  // Basic scalar ids (match your headers 1:1)
  const scalarIds = ["pdfMode", "interviewMode", "benchMode", "cLevelText", "company", "industry", "lpr", "sources", "sales_manager", "presale_manager", "workplaces", "servers", "branches", "vdi", "closed", "envNote", "pilotGoal", "pilotScope", "pilotSummary", "pilotDecision", "recommendedConfig", "pilotTasks_removed", "pilotKpi_removed", "virt", "hostingModel", "adDomains", "netSeg", "terminalFarms", "hwAge", "hwAccounting", "redundancy", "salary", "itCount", "manualPct", "licBudget", "unusedPct", "finNote", "vmUnusedPct", "keyPeopleRisk", "docScore", "obsoletePct", "hwBudget", "hwPlan", "downtimeHours", "downtimeCost", "incidentsPerMonth", "serviceDesk", "riskLevelText", "riskNotes"];
  scalarIds.forEach(id=> out[id]=_val(id));

  // virt (supports native checkboxes UI)
  try{
    const vboxes = document.querySelectorAll(".virt-wrapper input[type=checkbox]");
    if(vboxes && vboxes.length){
      const selected = Array.from(vboxes).filter(b=>b.checked).map(b=>b.value);
      out.virt = selected.join("; ");
      const hiddenVirt = document.getElementById("virt");
      if(hiddenVirt) hiddenVirt.value = out.virt;
    }
  }catch(e){}


  // KPI values (as numbers where appropriate)
  const kpiIds = ["psi2Score","psi2Label","techIndex","procIndex","riskIndex","coiTotal","recoverIndex","busIndex",
    "obsolIndex","aiIndex","painIndex","feasScore","readyIndex","readyLabel","probIndex","probLabel","benchCount","benchProfileLabel"
  ];
  kpiIds.forEach(id=>{
    const raw=_val(id);
    out[id] = (id.endsWith("Label") || id==="psi2Label" || id==="readyLabel" || id==="probLabel" || id==="benchProfileLabel" || id==="mainProblem" || id==="recModules" || id==="demoFocus")
      ? raw
      : _numFromText(raw);
  });

  // Counts
  const techRows=[...document.querySelectorAll("#techTbody tr")];
  const procRows=[...document.querySelectorAll("#procTbody tr")];
  const riskRows=[...document.querySelectorAll("#riskTbody tr")];
  const reqRows=[...document.querySelectorAll("#reqTbody tr")];
  const psiRows=[...document.querySelectorAll("#psiTbody tr")];
  const prRows=[...document.querySelectorAll("#projectRisks tr")];

  out.tech_count = techRows.length;
  out.proc_count = procRows.length;
  out.risk_count = riskRows.length;
  out.req_count = reqRows.length;
  out.psi_count = psiRows.length;
  out.project_risks_count = prRows.length;

  // Project risks summary fields (match your headers)
  out.project_risk_level = out.riskLevelText || "";
  out.project_risk_notes = out.riskNotes || "";

  // TECH/PROC/RISK detailed
  function fillMaturity(prefix, rows, labelsArr, scoreKey, noteKey){
    for(let i=0;i<10;i++){
      const idx=i+1;
      const keyL = `${prefix}_${String(idx).padStart(2,"0")}_label`;
      const keyS = `${prefix}_${String(idx).padStart(2,"0")}_${scoreKey}`;
      const keyN = `${prefix}_${String(idx).padStart(2,"0")}_${noteKey}`;
      const r = rows[i];
      out[keyL] = (labelsArr && labelsArr[i] && labelsArr[i].label) ? labelsArr[i].label : (r?.cells?.[0]?.textContent||"").trim();
      out[keyS] = r ? (r.querySelector("select")?.value ?? "") : "";
      out[keyN] = r ? (r.querySelector("input,textarea")?.value ?? "") : "";
    }
  }
  fillMaturity("tech", techRows, (typeof TECH!=="undefined"?TECH:null), "score", "note");
  fillMaturity("proc", procRows, (typeof PROC!=="undefined"?PROC:null), "score", "note");

  // Risk has val 0/1
  for(let i=0;i<8;i++){
    const idx=i+1;
    const keyL = `risk_${String(idx).padStart(2,"0")}_label`;
    const keyV = `risk_${String(idx).padStart(2,"0")}_val`;
    const keyN = `risk_${String(idx).padStart(2,"0")}_note`;
    const r = riskRows[i];
    out[keyL] = (typeof RISK!=="undefined" && RISK[i] && RISK[i].label) ? RISK[i].label : (r?.cells?.[0]?.textContent||"").trim();
    out[keyV] = r ? (r.querySelector("select")?.value ?? "") : "";
    out[keyN] = r ? (r.querySelector("input,textarea")?.value ?? "") : "";
  }

  // Requirements (up to 20)
  for(let i=0;i<20;i++){
    const idx=i+1;
    const r=reqRows[i];
    // Table columns: 0 ‚Ññ, 1 owner(business need), 2 text(req), 3 type, 4 must, 5 feas, 6 metric
    out[`req_${String(idx).padStart(2,"0")}_owner`]  = r ? _cellVal(r.cells[1]) : "";
    out[`req_${String(idx).padStart(2,"0")}_text`]   = r ? _cellVal(r.cells[2]) : "";
    out[`req_${String(idx).padStart(2,"0")}_type`]   = r ? _cellVal(r.cells[3]) : "";
    out[`req_${String(idx).padStart(2,"0")}_must`]   = r ? _cellVal(r.cells[4]) : "";
    out[`req_${String(idx).padStart(2,"0")}_feas`]   = r ? _cellVal(r.cells[5]) : "";
    out[`req_${String(idx).padStart(2,"0")}_metric`] = r ? _cellVal(r.cells[6]) : "";
  }

  // PSI (up to 20)
  for(let i=0;i<20;i++){
    const idx=i+1;
    const r=psiRows[i];
    const n = String(idx).padStart(2,"0");
    // Table columns: 0 ‚Ññ, 1 req, 2 scn, 3 exp, 4 act, 5 ok, 6 acc, 7 note
    out["psi_"+n+"_req"]  = r ? _cellVal(r.cells[1]) : "";
    out["psi_"+n+"_scn"]  = r ? _cellVal(r.cells[2]) : "";
    out["psi_"+n+"_exp"]  = r ? _cellVal(r.cells[3]) : "";
    out["psi_"+n+"_act"]  = r ? _cellVal(r.cells[4]) : "";
    out["psi_"+n+"_ok"]   = r ? _cellVal(r.cells[5]) : "";
    out["psi_"+n+"_acc"]  = r ? _cellVal(r.cells[6]) : "";
    out["psi_"+n+"_note"] = r ? _cellVal(r.cells[7]) : "";
  }

  // Product requirements (up to 30)
  const prodRows = Array.from(document.querySelectorAll("#prodReqTbody tr"));
  out.prodreq_count = prodRows.length;
  for(let i=0;i<30;i++){
    const idx=i+1;
    const r=prodRows[i];
    const n = String(idx).padStart(2,"0");
    out["prodreq_"+n+"_biz"]  = r ? _cellVal(r.cells[1]) : "";
    out["prod_"+n+"_biz"]  = r ? _cellVal(r.cells[1]) : "";
    out["prodreq_"+n+"_func"] = r ? _cellVal(r.cells[2]) : "";
    out["prod_"+n+"_func"] = r ? _cellVal(r.cells[2]) : "";
    out["prodreq_"+n+"_type"] = r ? _cellVal(r.cells[3]) : "";
    out["prod_"+n+"_type"] = r ? _cellVal(r.cells[3]) : "";
    out["prodreq_"+n+"_must"] = r ? _cellVal(r.cells[4]) : "";
    out["prod_"+n+"_must"] = r ? _cellVal(r.cells[4]) : "";
    out["prodreq_"+n+"_feas"] = r ? _cellVal(r.cells[5]) : "";
    out["prod_"+n+"_feas"] = r ? _cellVal(r.cells[5]) : "";
  }

  // Project risk table (up to 20)
  for(let i=0;i<20;i++){
    const idx=i+1;
    const r=prRows[i];
    out[`project_risk_${String(idx).padStart(2,"0")}_name`]      = r ? _cellVal(r.cells[0]) : "";
    out[`project_risk_${String(idx).padStart(2,"0")}_condition`] = r ? _cellVal(r.cells[1]) : "";
    out[`project_risk_${String(idx).padStart(2,"0")}_status`]    = r ? _cellVal(r.cells[2]) : "";
    out[`project_risk_${String(idx).padStart(2,"0")}_note`]      = r ? _cellVal(r.cells[3]) : "";
  }

  // Ensure run_id and timestamp
  if(!out.run_id) out.run_id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now());
  if(!out.timestamp) out.timestamp = new Date().toISOString();

  // Also include full JSON snapshot if someone adds "payload" column later
  out.payload = JSON.stringify(out);

  // === Dashboard aliases (so analytics can read consistent keys) ===
  // Some dashboard widgets expect psi/ready/probability fields.
  const psi2Num = parseFloat(String(out.psi2Score||"").replace("%","").trim());
  const readyNum = parseFloat(String(out.readyIndex||"").replace("%","").trim());
  const probNum = parseFloat(String(out.probIndex||"").replace("%","").trim());
  if(isFinite(psi2Num)) out.psi = psi2Num;
  if(isFinite(readyNum)) out.ready = readyNum;
  if(isFinite(probNum)) { out.probability = probNum; out.prob = probNum; }
  // Synthetic analytics aliases
  const benchNum = parseInt(String(out.benchCount||"0"),10);
  if(isFinite(benchNum)) out.synthetic_count = benchNum;

  // Ensure run identifiers for Sheets
  if(!out.run_id){ out.run_id = (window.crypto && crypto.randomUUID) ? crypto.randomUUID() : ('run_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8)); }
  out.timestamp = new Date().toISOString();
  out.total_fields = SHEET_KEYS.length;

  // Return only keys the sheet expects (safe)
  const trimmed = {};
  SHEET_KEYS.forEach(k=>{ trimmed[k]= (out[k]===undefined? "": out[k]); });
  return trimmed;
}

// Override sync to Sheets to use exact payload
async function syncToGoogleSheets(){
  // IMPORTANT: Apps Script routes actions by query parameter.
  // If we POST raw JSON to /exec without ?action=save, server will default to stats.
  const base = (typeof GOOGLE_SHEETS_WEBAPP_URL!=="undefined" && GOOGLE_SHEETS_WEBAPP_URL) ? String(GOOGLE_SHEETS_WEBAPP_URL).trim() : "";
  if(!base){
    console.warn("Google Sheets URL is not set");
    return;
  }
  const url = base + (base.includes("?") ? "&" : "?") + "action=save";
  const payload = buildSheetPayloadExact();
  const body = "action=save&payload=" + encodeURIComponent(JSON.stringify(payload));

  // 1) Beacon (no CORS / no preflight)
  try{
    if(navigator.sendBeacon){
      const ok = navigator.sendBeacon(url, new Blob([body], {type:"text/plain;charset=utf-8"}));
      if(ok){ console.log("‚úÖ Sheets sync sent (beacon)"); return; }
    }
  }catch(e){ console.warn("Beacon failed", e); }

  // 2) Fetch no-cors fallback
  try{
    await fetch(url, {method:"POST", mode:"no-cors", body, keepalive:true, headers: {"Content-Type":"text/plain;charset=utf-8"}});
    console.log("‚úÖ Sheets sync sent (fetch no-cors)");
  }catch(e){
    console.error("‚ùå Sheets sync failed", e);
  }
}
/* ===== end patch ===== */

</script>
<script id="gs-reverse-sync-js">
/* =========================================================
   Reverse sync with Google Sheets (PSI_Log)
   - Search by company name while typing
   - Pick ‚Üí load last saved payload and fill the form
   Works with existing GOOGLE_SHEETS_WEBAPP_URL constant.
========================================================= */
(function(){
  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function formatMsk(iso){
    const raw = String(iso || "").trim();
    if(!raw) return "";
    try{
      const d = new Date(raw);
      if(isNaN(d.getTime())) return "–û–±–Ω–æ–≤–ª–µ–Ω–æ: " + esc(raw);
      const date = new Intl.DateTimeFormat("ru-RU",{timeZone:"Europe/Moscow",day:"2-digit",month:"2-digit",year:"numeric"}).format(d);
      const time = new Intl.DateTimeFormat("ru-RU",{timeZone:"Europe/Moscow",hour:"2-digit",minute:"2-digit"}).format(d);
      return `–û–±–Ω–æ–≤–ª–µ–Ω–æ: <span class="dt-date">${date}</span> <span class="dt-time">${time}</span> <span class="dt-tz">–ú–°–ö</span>`;
    }catch(e){
      return "–û–±–Ω–æ–≤–ª–µ–Ω–æ: " + esc(raw);
    }
  }

  function debounce(fn, ms){
    let t = null;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(()=>fn(...args), ms);
    };
  }

  
  // ===== JSONP helper (Apps Script cannot set CORS headers) =====
  // ===== JSONP helper (Apps Script cannot set CORS headers) =====
function jsonp(url, timeoutMs=15000){
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Math.random().toString(36).slice(2) + "_" + Date.now();
    const sep = url.includes("?") ? "&" : "?";
    const full = url + sep + "callback=" + encodeURIComponent(cb);

    const script = document.createElement("script");
    script.src = full;
    script.async = true;

    let done = false;
    const cleanup = () => {
      if(done) return;
      done = true;
      try { delete window[cb]; } catch(e) { window[cb] = undefined; }
      try { script.remove(); } catch(e) {}
    };

    const timer = setTimeout(() => {
      cleanup();
      reject(new Error("JSONP timeout"));
    }, timeoutMs);

    window[cb] = (data) => { clearTimeout(timer); cleanup(); resolve(data); };
    script.onerror = () => { clearTimeout(timer); cleanup(); reject(new Error("JSONP request failed")); };

    document.body.appendChild(script);
  });
}

async function gsSearch(q){
    const base = (typeof GOOGLE_SHEETS_WEBAPP_URL === "string" && GOOGLE_SHEETS_WEBAPP_URL) ? GOOGLE_SHEETS_WEBAPP_URL : "";
    if(!base) throw new Error("GOOGLE_SHEETS_WEBAPP_URL is not set");
    const url = `${base}?action=search&q=${encodeURIComponent(q)}&limit=10`;
    return await jsonp(url); // JSONP to bypass CORS for local HTML
  }

  async function gsGetByCompany(company){
    const base = (typeof GOOGLE_SHEETS_WEBAPP_URL === "string" && GOOGLE_SHEETS_WEBAPP_URL) ? GOOGLE_SHEETS_WEBAPP_URL : "";
    if(!base) throw new Error("GOOGLE_SHEETS_WEBAPP_URL is not set");
    const url = `${base}?action=get&company=${encodeURIComponent(company)}`;
    return await jsonp(url); // JSONP to bypass CORS for local HTML
  }


  // Build a fast lookup: normalizedId -> real element id
  function normalizeKey(k){
    return String(k||"").trim().toLowerCase().replace(/[^a-z0-9–∞-—è—ë]+/gi,"");
  }
  const __EL_ID_MAP = (() => {
    const m = new Map();
    document.querySelectorAll("[id]").forEach(el=>{
      const id = el.id;
      if(!id) return;
      m.set(normalizeKey(id), id);
    });
    return m;
  })();

  function findElementByKey(key){
    if(!key) return null;
    // 1) exact
    let el = document.getElementById(key);
    if(el) return el;
    const k1 = String(key).trim();
    const k2 = k1.toLowerCase();
    // 2) lower
    el = document.getElementById(k2);
    if(el) return el;
    // 3) normalized match (strip spaces/underscores/etc)
    const norm = normalizeKey(k1);
    const realId = __EL_ID_MAP.get(norm);
    if(realId) return document.getElementById(realId);
    return null;
  }

  // Rebuild table sections from flat sheet columns when loading a company.
  // Sheets rows are flat (req_01_text, psi_01_scn, prod_01_biz, ...), while the UI expects arrays.
  function rebuildTablesFromFlat_(data){
    if(!data || typeof data !== "object") return;
    const pick = (k) => {
      if (data[k] !== undefined) return data[k];
      const lk = String(k).toLowerCase();
      if (data[lk] !== undefined) return data[lk];
      return "";
    };

    // --- Fallback: if Apps Script stored full arrays as JSON strings in columns (requirements/productRequirements/psi)
    // Some older/newer sheets may store these as JSON (e.g., "[{...}]" ). Prefer them when present.
    function tryParseJsonArray(v){
      if(typeof v!=="string") return null;
      const s=v.trim();
      if(!s) return null;
      if(!(s.startsWith("[") && s.endsWith("]"))) return null;
      try{
        const arr = JSON.parse(s);
        return Array.isArray(arr) ? arr : null;
      }catch(e){ return null; }
    }

    const reqTbody = document.getElementById("reqTbody");
    if(reqTbody){
      // Prefer JSON array snapshot when available
      const __arr = tryParseJsonArray(data.requirements || data.Requirements);
      if(__arr){
        reqTbody.innerHTML = "";
        (__arr.length?__arr:[{}]).forEach(r=>addReqRow(r));
      } else {
      reqTbody.innerHTML = "";
      const rows = [];
      for(let i=1;i<=20;i++){
        const n = String(i).padStart(2,"0");
        const row = {
          owner: pick(`req_${n}_owner`),
          text: pick(`req_${n}_text`),
          type: pick(`req_${n}_type`),
          must: pick(`req_${n}_must`),
          feas: pick(`req_${n}_feas`),
          metric: pick(`req_${n}_metric`),
        };
        const hasAny = Object.values(row).some(v=>String(v??"").trim()!=="");
        if(hasAny) rows.push(row);
      }
      if(rows.length===0) rows.push({});
      rows.forEach(r=>addReqRow(r));      }

    }

    const psiTbody = document.getElementById("psiTbody");
    if(psiTbody){
      // Prefer JSON array snapshot when available
      const __arr = tryParseJsonArray(data.psi || data.PSI);
      if(__arr){
        psiTbody.innerHTML = "";
        (__arr.length?__arr:[{}]).forEach(r=>addPsiRow(r));
      } else {
      psiTbody.innerHTML = "";
      const rows = [];
      for(let i=1;i<=20;i++){
        const n = String(i).padStart(2,"0");
        const row = {
          req: pick(`psi_${n}_req`),
          scn: pick(`psi_${n}_scn`),
          exp: pick(`psi_${n}_exp`),
          act: pick(`psi_${n}_act`),
          ok: pick(`psi_${n}_ok`),
          acc: pick(`psi_${n}_acc`),
          note: pick(`psi_${n}_note`),
        };
        const hasAny = Object.values(row).some(v=>String(v??"").trim()!=="");
        if(hasAny) rows.push(row);
      }
      if(rows.length===0) rows.push({});
      rows.forEach(r=>addPsiRow(r));      }

    }

    const prodTbody = document.getElementById("prodReqTbody");
    if(prodTbody){
      // Prefer JSON array snapshot when available
      const __arr = tryParseJsonArray(data.productRequirements || data.ProductRequirements || data.prodRequirements || data.ProdRequirements);
      if(__arr){
        prodTbody.innerHTML = "";
        (__arr.length?__arr:[{}]).forEach(r=>addProdReqRow(r));
      } else {
      prodTbody.innerHTML = "";
      const rows = [];
      for(let i=1;i<=30;i++){
        const n = String(i).padStart(2,"0");
        // Some sheets used different prefixes for product requirements.
        // Support: prod_XX_*, prodreq_XX_*, product_XX_*.
        const pickProd = (suffix) => (
          pick(`prod_${n}_${suffix}`) ||
          pick(`prodreq_${n}_${suffix}`) ||
          pick(`product_${n}_${suffix}`)
        );
        const row = {
          biz: pickProd("biz"),
          func: pickProd("func"),
          type: pickProd("type"),
          must: pickProd("must"),
          feas: pickProd("feas"),
        };
        const hasAny = Object.values(row).some(v=>String(v??"").trim()!=="");
        if(hasAny) rows.push(row);
      }
      if(rows.length===0) rows.push({});
      rows.forEach(r=>addProdReqRow(r));      }

    }
  }

  function applyPayload(payload){
    if(!payload || typeof payload !== "object") return;

    // Guard: while we are applying data from Sheets, we must avoid any
    // auto-save triggers and reduce noisy intermediate recalcs.
    window.__ITMEN_IS_LOADING = true;
    // normalize legacy/alt keys coming from Sheets / Apps Script
    try{
      const p = payload;
      if(p.sales_manager==null && p.salesManager!=null) p.sales_manager = p.salesManager;
      if(p.sales_manager==null && p.sales!=null) p.sales_manager = p.sales;
      if(p.presale_manager==null && p.preSaleManager!=null) p.presale_manager = p.preSaleManager;
      if(p.presale_manager==null && p.presaleManager!=null) p.presale_manager = p.presaleManager;
      if(p.presale_manager==null && p.presale!=null) p.presale_manager = p.presale;
      if(p.timestamp==null && p.Timestamp!=null) p.timestamp = p.Timestamp;
      if(p.run_id==null && p.runId!=null) p.run_id = p.runId;
      if(p.sources==null && p.data_sources!=null) p.sources = p.data_sources;
      if(p.sources==null && p["–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö"]!=null) p.sources = p["–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö"];
      // pilot dot-notation (from flattenForSheets or Apps Script)
      if(p.pilotGoal==null && p["pilot.goal"]!=null) p.pilotGoal = p["pilot.goal"];
      if(p.pilotScope==null && p["pilot.scope"]!=null) p.pilotScope = p["pilot.scope"];
      if(p.pilotSummary==null && p["pilot.summary"]!=null) p.pilotSummary = p["pilot.summary"];
      if(p.pilotDecision==null && p["pilot.decision"]!=null) p.pilotDecision = p["pilot.decision"];
      if(p.recommendedConfig==null && p["pilot.recommendedConfig"]!=null) p.recommendedConfig = p["pilot.recommendedConfig"];
      if(p.pilotTasks_removed==null && p["pilot.tasks"]!=null) p.pilotTasks_removed = p["pilot.tasks"];
      if(p.pilotKpi_removed==null && p["pilot.kpi"]!=null) p.pilotKpi_removed = p["pilot.kpi"];
    }catch(e){}


    // 0) If the sheet row contains a full JSON snapshot in 'payload' column ‚Äî parse it.
    // It may be either:
    //  - a flat object (same keys as columns), or
    //  - a structured payload (meta/maturity/requirements/psi/pilot...).
    try{
      const raw = payload.payload;
      let full = null;
      if(typeof raw === "string"){
        let s = raw.trim();
        // sometimes payload is double-encoded JSON string
        for(let i=0;i<2;i++){
          if(s.startsWith('"') && s.endsWith('"')){ try{ s = JSON.parse(s); }catch(_e){} }
        }
        if(s && (s.startsWith("{") || s.startsWith("["))){
          try{ full = JSON.parse(s); }catch(_e){}
        }
      } else if(raw && typeof raw === "object"){
        full = raw;
      }

      if(full && typeof full === "object"){
        if(full.meta || full.maturity || full.requirements || full.productRequirements || full.psi || full.pilot){
          try{ if(typeof apply==="function") apply(full); }catch(e){ console.warn("apply(structured) failed", e); }
        } else {
          payload = Object.assign({}, full, payload);
        }
      }
    }catch(e){}


    // 1) basic fields by id
    Object.entries(payload).forEach(([id, val]) => {
      const el = findElementByKey(id);
      if(!el) return;

      // skip if element is file input
      if (el.type === "file") return;

      // checkbox
      if (el.type === "checkbox") {
        el.checked = !!val;
        el.dispatchEvent(new Event("change", { bubbles:true }));
        return;
      }

      // select/input/textarea
      if (val === null || val === undefined) return;
      if (typeof val === "object") {
        // try stringify for unknown objects
        try { el.value = JSON.stringify(val); } catch(e) { el.value = String(val); }
      } else {
        el.value = String(val);
      }
      el.dispatchEvent(new Event("input", { bubbles:true }));
      el.dispatchEvent(new Event("change", { bubbles:true }));
    });

    // 2) virt multiselect special handling (if payload.virt is array or comma string)
    try{
      const virtArr = Array.isArray(payload.virt)
        ? payload.virt
        : (typeof payload.virt === "string" ? payload.virt.split(",").map(s=>s.trim()).filter(Boolean) : null);

      if(virtArr){
        const wrap = document.querySelector(".virt-wrapper");
        if(wrap){
          wrap.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.checked = virtArr.includes(cb.value);
          });
        }
        const hidden = document.getElementById("virt");
        if(hidden) hidden.value = virtArr.join(",");
      }
    }catch(e){}

    // 3) rebuild tables from flat sheet columns (requirements/PSI/product requirements)
    try{ rebuildTablesFromFlat_(payload); }catch(e){ console.warn("rebuildTablesFromFlat_ failed", e); }

    // 4) kick recalculation (if button exists)
    const btn = document.getElementById("btnRecalc");
    if(btn) btn.click();
    // 3) maturity tables (tech/proc) and risk table are stored in Sheets as tech_01_score etc.
    try{
      function pad2(n){ return String(n).padStart(2,"0"); }

      function fillMaturityFromPayload(prefix, tbodyId, max){
        const rows = Array.from(document.querySelectorAll(`#${tbodyId} tr`));
        for(let i=1;i<=max;i++){
          const keyS = `${prefix}_${pad2(i)}_score`;
          const keyN = `${prefix}_${pad2(i)}_note`;
          const row = rows[i-1];
          if(!row) continue;

          if(payload[keyS] !== undefined && payload[keyS] !== null){
            const sel = row.querySelector("select");
            if(sel){
              sel.value = String(payload[keyS]);
              sel.dispatchEvent(new Event("change", { bubbles:true }));
            }
          }
          if(payload[keyN] !== undefined && payload[keyN] !== null){
            const field = row.querySelector("input,textarea");
            if(field){
              field.value = String(payload[keyN]);
              field.dispatchEvent(new Event("input", { bubbles:true }));
            }
          }
        }
      }

      function fillRiskFromPayload(tbodyId, max){
        const rows = Array.from(document.querySelectorAll(`#${tbodyId} tr`));
        for(let i=1;i<=max;i++){
          const keyV = `risk_${pad2(i)}_val`;
          const keyN = `risk_${pad2(i)}_note`;
          const row = rows[i-1];
          if(!row) continue;

          if(payload[keyV] !== undefined && payload[keyV] !== null){
            const sel = row.querySelector("select");
            if(sel){
              sel.value = String(payload[keyV]);
              sel.dispatchEvent(new Event("change", { bubbles:true }));
            }
          }
          if(payload[keyN] !== undefined && payload[keyN] !== null){
            const field = row.querySelector("input,textarea");
            if(field){
              field.value = String(payload[keyN]);
              field.dispatchEvent(new Event("input", { bubbles:true }));
            }
          }
        }
      }

      fillMaturityFromPayload("tech", "techTbody", 10);
      fillMaturityFromPayload("proc", "procTbody", 10);
      fillRiskFromPayload("riskTbody", 8);
    }catch(e){
      console.warn("applyPayload maturity/risk fill failed", e);
    }

    // done
    window.__ITMEN_IS_LOADING = false;

  }

  function init(){
    const input = document.getElementById("company");
    if(!input) return;

    

    // ensure meta + 'all records' button exist on all pages
    let meta = document.getElementById("companyMeta");
    if(!meta){
      meta = document.createElement("div");
      meta.id = "companyMeta";
      meta.className = "hint";
      meta.style.cssText = "margin-top:6px;color:#6b7280;font-size:12px";
      (input.closest(".row") || input.parentElement || document.body).appendChild(meta);
    }
    let btnAll = document.getElementById("btnCompanyAll");
    if(!btnAll){
      btnAll = document.createElement("button");
      btnAll.id = "btnCompanyAll";
      btnAll.className = "btn ghost";
      btnAll.textContent = "–í—Å–µ –∑–∞–ø–∏—Å–∏";
      btnAll.style.display = "none";
      (meta.parentElement || input.parentElement || document.body).appendChild(btnAll);
    }

// wrap for positioning
    const label = input.closest("label");
    if(label && !label.classList.contains("companySuggestWrap")) {
      label.classList.add("companySuggestWrap");
    }

    // dropdown node
    let dd = document.getElementById("companySuggestDropdown");
    if(!dd){
      dd = document.createElement("div");
      dd.id = "companySuggestDropdown";
      dd.className = "companySuggestDropdown";
      document.body.appendChild(dd);
      dd.style.position = "fixed";
      dd.style.zIndex = "999999";
    }

    function positionDropdown(){
      try{
        const r = input.getBoundingClientRect();
        dd.style.left = (r.left) + "px";
        dd.style.top  = (r.bottom + 6) + "px";
        dd.style.width = (r.width) + "px";
      }catch(e){}
    }

    function hide(){ dd.style.display="none"; dd.innerHTML=""; }
    function show(){ positionDropdown(); dd.style.display="block"; }

    const __memCache = new Map();
const LS_KEY = "itmen_gs_search_cache_v1";
// Keep TTL small so new companies appear quickly in suggestions.
const LS_TTL_MS = 5 * 60 * 1000; // 5 min

function lsLoad(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return {};
    const obj = JSON.parse(raw);
    return (obj && typeof obj === "object") ? obj : {};
  }catch(e){ return {}; }
}
function lsSave(obj){
  try{ localStorage.setItem(LS_KEY, JSON.stringify(obj)); }catch(e){}
}

let __lsCache = lsLoad();

function cacheGet(q){
  const key = String(q||"").trim().toLowerCase();
  if(!key) return null;
  if(__memCache.has(key)) return __memCache.get(key);
  const hit = __lsCache[key];
  if(hit && hit.t && (Date.now()-hit.t) < LS_TTL_MS && hit.data){
    __memCache.set(key, hit.data);
    return hit.data;
  }
  return null;
}
function cacheSet(q, data){
  const key = String(q||"").trim().toLowerCase();
  if(!key) return;
  __memCache.set(key, data);
  __lsCache[key] = {t: Date.now(), data};
  // keep cache small
  const keys = Object.keys(__lsCache);
  if(keys.length > 80){
    keys.sort((a,b)=>(__lsCache[a]?.t||0)-(__lsCache[b]?.t||0));
    for(const k of keys.slice(0, keys.length-80)) delete __lsCache[k];
  }
  lsSave(__lsCache);
}

// Expose cache reset (used after SAVE)
function cacheClear(){
  try{ __memCache.clear(); }catch(_e){}
  try{ __lsCache = {}; localStorage.removeItem(LS_KEY); }catch(_e){}
}
try{ window.__itmenCompanyCacheClear = cacheClear; }catch(_e){}

const run = debounce(async ()=>{
  const qRaw = String(input.value || "").trim();
  if(qRaw.length < 2){ hide(); return; }
  const q = qRaw.toLowerCase();

  // inline feedback right away
  dd.innerHTML = `<div class="companySuggestItem"><div class="companySuggestTitle">–ò—â—É –∫–æ–º–ø–∞–Ω–∏—é‚Ä¶</div><div class="companySuggestMeta">–ó–∞–ø—Ä–æ—Å –∫ –±–∞–∑–µ –≤ Google Sheets</div></div>`;
  show();

  // global loader ‚Äî only if request is slow (no flicker)
  let slowTimer = setTimeout(()=>showLoader("–ò—â—É –∫–æ–º–ø–∞–Ω–∏—é‚Ä¶", "–ó–∞–ø—Ä–æ—Å –∫ Google Sheets"), 450);

  try{
    let data = cacheGet(q);
    if(!data){
      data = await gsSearch(q);
      cacheSet(q, data);
    }
    clearTimeout(slowTimer);
    hideLoader();

    if(!data || !data.ok){
      dd.innerHTML = `<div class="companySuggestItem"><div class="companySuggestTitle">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</div><div class="companySuggestMeta">–ü–æ–ø—Ä–æ–±—É–π —É—Ç–æ—á–Ω–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ</div></div>`;
      show();
      return;
    }
    const items = Array.isArray(data.items) ? data.items : [];
    if(items.length === 0){
      dd.innerHTML = `<div class="companySuggestItem"><div class="companySuggestTitle">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</div><div class="companySuggestMeta">–ü–æ–ø—Ä–æ–±—É–π —É—Ç–æ—á–Ω–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ</div></div>`;
      show();
      return;
    }

    dd.innerHTML = "";

    // Simple suggestions (company list). When selected ‚Üí load last saved snapshot by company.
    items.forEach(it=>{
      const name = String(it.company || "").trim();
      if(!name) return;
      const row = document.createElement("div");
      row.className = "companySuggestItem";
      row.innerHTML = `<div class="companySuggestTitle">${esc(name)}</div>`;
      row.addEventListener("mousedown", async (ev)=>{
        ev.preventDefault();
        hide();
        input.value = name;
        try{
          showLoader("–ó–∞–≥—Ä—É–∂–∞—é –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞–ø–∏—Å—å‚Ä¶", "–ü–æ–ª—É—á–∞—é –¥–∞–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏ –∏–∑ Google Sheets");
          const got = await gsGetByCompany(name);
          if(got && got.ok && got.item){
            showLoader("–ü—Ä–∏–º–µ–Ω—è—é –¥–∞–Ω–Ω—ã–µ‚Ä¶", "–ó–∞–ø–æ–ª–Ω—è—é —Ñ–æ—Ä–º—É –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –∏–∑ –±–∞–∑—ã");
            applyPayload(got.item);
            showLoader("–ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é –∏–Ω–¥–µ–∫—Å—ã‚Ä¶", "–û–±–Ω–æ–≤–ª—è—é KPI –∏ –∏–Ω–¥–µ–∫—Å—ã —Ä–µ–∞–ª–∏–∑—É–µ–º–æ—Å—Ç–∏");
            try{ recalc(); }catch(_e){}
          }
          hideLoader();
        }catch(e){
          console.error("Reverse sync load failed:", e);
          showLoader("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏", "–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.");
          setTimeout(hideLoader, 1500);
        }
      });
      dd.appendChild(row);
    });

    show();

  }catch(e){
    clearTimeout(slowTimer);
    hideLoader();
    dd.innerHTML = `<div class="companySuggestItem"><div class="companySuggestTitle">–û—à–∏–±–∫–∞</div><div class="companySuggestMeta">–ë–∞–∑–∞ –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª–∞. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.</div></div>`;
    show();
  }
}, 520);

    input.addEventListener("input", run);
    input.addEventListener("focus", run);
    input.addEventListener("blur", ()=> setTimeout(hide, 180));

    
    window.addEventListener("scroll", () => { if(dd.style.display==="block") positionDropdown(); }, true);
    window.addEventListener("resize", () => { if(dd.style.display==="block") positionDropdown(); });
// optional: keyboard escape to close
    input.addEventListener("keydown", (e)=>{
      if(e.key === "Escape"){ hide(); }
    });
  }

  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }
})();
</script>
<!-- KPI Explain Modal -->
<div aria-hidden="true" class="kpiModal" id="kpiModal">
<div class="backdrop" data-kpi-close="1" onclick="kpiModalClose()"></div>
<div aria-labelledby="kpiModalTitle" aria-modal="true" class="dialog" role="dialog">
<div class="head">
<div>
<div class="title" id="kpiModalTitle">–ò–Ω–¥–µ–∫—Å</div>
<div class="sub" id="kpiModalSub"></div>
</div>
<button aria-label="–ó–∞–∫—Ä—ã—Ç—å" class="closeBtn" id="kpiModalClose" onclick="kpiModalClose()">‚úï</button>
</div>
<div class="body">
<div class="sect">
<h3>1) –ß—Ç–æ —ç—Ç–æ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏</h3>
<p id="kpiModalWhat">‚Äî</p>
</div>
<div class="sect">
<h3>2) –õ–æ–≥–∏–∫–∞ —Ä–∞—Å—á—ë—Ç–∞</h3>
<p id="kpiModalHow">‚Äî</p>
</div>
<div class="sect">
<h3>2.5) –î–∞–Ω–Ω—ã–µ –∏ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç—å</h3>
<p id="kpiModalData">‚Äî</p>
<div class="small" id="kpiModalUnc" style="margin-top:8px;display:none">
<div style="display:flex;justify-content:space-between;gap:12px;margin-bottom:6px">
<span>–î–∏–∞–ø–∞–∑–æ–Ω (P25‚ÄìP75) –ø–æ –±–µ–Ω—á–º–∞—Ä–∫—É</span><span class="mono" id="kpiModalRange">‚Äî</span>
</div>
<div style="height:10px;border-radius:999px;border:1px solid var(--border);background:rgba(0,0,0,.06);overflow:hidden">
<div id="kpiModalRangeBar" style="height:100%;width:0%"></div>
</div>
</div>
</div>
<div class="sect">
<h3>3) –ù–∞ —á—Ç–æ –≤–ª–∏—è–µ—Ç</h3>
<p id="kpiModalImpact">‚Äî</p>
</div>
<div class="sect">
<h3>4) –ß—Ç–æ –¥–µ–ª–∞—Ç—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º</h3>
<div id="kpiModalDo">‚Äî</div>
</div>
<div class="note" id="kpiModalNote"></div>
</div>
</div>
</div>
<script id="field-status-dots">
(function(){
  const REQUIRED = new Set(["company"]);
  const DOT_STYLE = `
    .statusDot{display:inline-block;width:8px;height:8px;border-radius:999px;margin-left:8px;vertical-align:middle;box-shadow:0 0 0 2px rgba(15,23,42,.08) inset}
    .dotRed{background:#ef4444}
    .dotBlue{background:#2563eb}
    .dotGreen{background:#22c55e}
  `;
  try{
    const st = document.createElement("style");
    st.textContent = DOT_STYLE;
    document.head.appendChild(st);
  }catch(e){}

  function ensureDot(el){
    const id = el && el.id;
    if(!id || REQUIRED.has(id)) return null;
    const label = el.closest("label") || el.parentElement;
    if(!label) return null;
    let dot = label.querySelector(`.statusDot[data-for="${id}"]`);
    if(dot) return dot;
    dot = document.createElement("span");
    dot.className = "statusDot dotRed";
    dot.setAttribute("data-for", id);
    // place dot near the label title if possible; otherwise at end
    const firstText = label.childNodes && label.childNodes[0];
    label.appendChild(dot);
    return dot;
  }

  function setDot(dot, state){
    if(!dot) return;
    dot.classList.remove("dotRed","dotBlue","dotGreen");
    dot.classList.add(state==="blue" ? "dotBlue" : (state==="green" ? "dotGreen" : "dotRed"));
  }

  function updateOne(el){
    const id = el.id;
    if(!id || REQUIRED.has(id)) return;
    const dot = ensureDot(el);
    const v = (el.value ?? "").toString().trim();
    if(!v){ setDot(dot,"red"); return; }
    const src = el.dataset.origin || "user";
    setDot(dot, src==="synthetic" ? "blue" : "green");
  }

  function clearOptionalDefaults(){
    document.querySelectorAll("input,select,textarea").forEach(el=>{
      if(!el.id || REQUIRED.has(el.id)) return;
      if(el.tagName==="SELECT") return;
      const v = (el.value ?? "").toString().trim();
      if(v==="0") el.value="";
    });
  }

  function bind(){
    document.querySelectorAll("input,select,textarea").forEach(el=>{
      if(!el.id || REQUIRED.has(el.id)) return;
      ensureDot(el);
      el.addEventListener("input", ()=>{ el.dataset.origin="user"; updateOne(el); }, {passive:true});
      el.addEventListener("change", ()=>{ el.dataset.origin="user"; updateOne(el); }, {passive:true});
    });
  }

  function updateMaturityOne(tr){
    if(!tr) return;
    const dot = tr.querySelector(".maturityDot");
    const sel = tr.querySelector("select");
    if(!dot || !sel) return;
    const v = (sel.value ?? "").toString().trim();
    if(!v){
      dot.classList.remove("dotBlue","dotGreen");
      dot.classList.add("dotRed");
      dot.title = "–ü–æ–ª–µ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ";
      return;
    }
    const synthetic = (sel.dataset.synthetic === "1") || (sel.dataset.origin === "synthetic");
    dot.classList.remove("dotRed","dotBlue","dotGreen");
    dot.classList.add(synthetic ? "dotBlue" : "dotGreen");
    dot.title = synthetic ? "–°–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ (–º–æ–∂–Ω–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å)" : "–ó–∞–ø–æ–ª–Ω–µ–Ω–æ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º";
  }

  function updateAll(){
    document.querySelectorAll("input,select,textarea").forEach(updateOne);
    document.querySelectorAll("#techTbody tr, #procTbody tr, #riskTbody tr").forEach(updateMaturityOne);
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    clearOptionalDefaults();
    bind();
    // Update on recalcs as well
    const recalcBtn = document.getElementById("btnRecalc");
    if(recalcBtn) recalcBtn.addEventListener("click", ()=>setTimeout(updateAll, 50));
    updateAll();
  });
})();
</script>
<!-- Hidden form/iframe for cross-origin POST (bypasses fetch/beacon CSP on GitHub Pages) -->
<iframe id="gsyncFrame" name="gsyncFrame" style="display:none"></iframe>
<form id="gsyncForm" method="POST" style="display:none" target="gsyncFrame">
<input name="action" type="hidden" value="save"/>
<input name="payload" type="hidden" value=""/>
</form>
<script>

/* === ITMEN CSP-SAFE SAVE OVERRIDE (FORM POST) === */
function syncToGoogleSheets(){
  const base = (typeof window!=="undefined" && (window.GS_WEBAPP_URL || window.GOOGLE_SHEETS_WEBAPP_URL)) ? String(window.GS_WEBAPP_URL || window.GOOGLE_SHEETS_WEBAPP_URL).trim() : "";
  if(!base){ console.warn("Google Sheets URL is not set"); return; }
  const actionUrl = base + (base.includes("?") ? "&" : "?") + "action=save";
  const payload = (typeof buildSheetPayloadExact==="function") ? buildSheetPayloadExact() : {};
  try{ if(!payload.company){ const c=document.getElementById("company")?.value || document.getElementById("dockCompany")?.value || ""; payload.company = String(c||"").trim(); } }catch(_e){}
  // create hidden iframe + form
  let ifr = document.getElementById("gsHiddenFrame");
  if(!ifr){
    ifr = document.createElement("iframe");
    ifr.id = "gsHiddenFrame";
    ifr.name = "gsHiddenFrame";
    ifr.style.display = "none";
    document.body.appendChild(ifr);
  }
  let form = document.getElementById("gsHiddenForm");
  if(!form){
    form = document.createElement("form");
    form.id = "gsHiddenForm";
    form.method = "POST";
    form.target = "gsHiddenFrame";
    form.style.display = "none";
    document.body.appendChild(form);
  }
  form.action = actionUrl;
  let inp = form.querySelector('input[name="payload"]');
  if(!inp){
    inp = document.createElement("input");
    inp.type = "hidden";
    inp.name = "payload";
    form.appendChild(inp);
  }
  inp.value = JSON.stringify(payload);
  try{ 
    form.submit();
    // After SAVE, clear company suggestions cache so new names appear immediately.
    try{ window.__itmenCompanyCacheClear && window.__itmenCompanyCacheClear(); }catch(_e){}
    console.log("‚úÖ Sheets sync sent (form-post)"); 
  }
  catch(e){ console.error("‚ùå Sheets sync failed (form-post)", e); }
}
/* === end override === */


  function openCompanyVersionsModal(company, items){
    try{
      const modal = document.getElementById('kpiModal');
      const body = document.getElementById('kpiModalBody');
      const title = document.getElementById('kpiModalTitle');
      if(!modal || !body || !title){
        const msg = items.map((it,i)=>`${i+1}) ${(it.timestamp||it.Timestamp||'')}`).join('\n');
        alert(`–í—Å–µ –∑–∞–ø–∏—Å–∏ –¥–ª—è ${company}:\n`+msg);
        return;
      }
      title.textContent = `–í—Å–µ –∑–∞–ø–∏—Å–∏ ‚Äî ${company}`;
      const rows = items.slice().sort((a,b)=> String(b.timestamp||b.Timestamp||'').localeCompare(String(a.timestamp||a.Timestamp||'')));
      body.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:8px">
          ${rows.map((it,idx)=>{
            const ts = it.timestamp||it.Timestamp||'';
            const tsTxt = ts ? new Date(ts).toLocaleString('ru-RU') : '‚Äî';
            const rid = it.run_id || it.runId || '';
            return `<button class="btn ghost" data-idx="${idx}" style="text-align:left">
              <div style="font-weight:600">${tsTxt}</div>
              <div style="font-size:12px;color:#6b7280">run_id: ${rid || '‚Äî'}</div>
            </button>`;
          }).join('')}
        </div>`;
      body.querySelectorAll('button[data-idx]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const it = rows[Number(btn.getAttribute('data-idx'))];
          applyPayload(it);
          const metaEl = document.getElementById('companyMeta');
          if(metaEl){
            const ts = it.timestamp||it.Timestamp||'';
            metaEl.textContent = `–ü–æ—Å–ª–µ–¥–Ω–µ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ: ${ts ? new Date(ts).toLocaleString('ru-RU') : '‚Äî'} ¬∑ –≤–µ—Ä—Å–∏–π: ${rows.length}`;
          }
          closeKpiModal();
        });
      });
      openKpiModal();
    }catch(e){
      console.warn('openCompanyVersionsModal failed', e);
    }
  }
</script>
<script>
  // QuickDock (search + link company param)
  (function(){
    const WEBAPP_URL = (window.GS_WEBAPP_URL || window.GOOGLE_SHEETS_WEBAPP_URL || "").trim();
    const dockCompany = document.getElementById('dockCompany');
    const dockSuggest = document.getElementById('dockSuggest');
    if(!dockCompany) return;

    function jsonp(url, timeoutMs=15000){
      return new Promise((resolve, reject)=>{
        const cb = 'cb_' + Math.random().toString(36).slice(2);
        const s = document.createElement('script');
        const t = setTimeout(()=>{ cleanup(); reject(new Error('JSONP timeout')); }, timeoutMs);
        function cleanup(){
          clearTimeout(t);
          try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
          if(s.parentNode) s.parentNode.removeChild(s);
        }
        window[cb] = (data)=>{ cleanup(); resolve(data); };
        const sep = url.includes('?') ? '&' : '?';
        s.src = url + sep + 'callback=' + encodeURIComponent(cb);
        s.onerror = ()=>{ cleanup(); reject(new Error('JSONP error')); };
        document.body.appendChild(s);
      });
    }

    function getCompanyFromUrl(){
      try{ return (new URL(location.href)).searchParams.get('company') || ''; }catch(e){ return ''; }
    }
    function setCompanyInLinks(company){
      const qs = company ? ('?company='+encodeURIComponent(company)) : '';
      document.querySelectorAll('.quickDock a.tool').forEach(a=>{
        const href = a.getAttribute('href') || '';
        if(!href || href.startsWith('http')) return;
        const clean = href.split('?')[0];
        a.setAttribute('href', clean + qs);
      });
    }

    const initial = getCompanyFromUrl();
    dockCompany.value = initial;
    try{ const cEl=document.getElementById('company'); if(cEl && !cEl.value) cEl.value = initial; }catch(_e){}
    setCompanyInLinks(initial);

    let timer=null;
    dockCompany.addEventListener('input', ()=>{
      clearTimeout(timer);
      const q = dockCompany.value.trim();
      setCompanyInLinks(q);
      try{ const cEl=document.getElementById('company'); if(cEl) cEl.value = q; }catch(_e){}
      if(q.length < 3){ dockSuggest.style.display='none'; dockSuggest.innerHTML=''; return; }
      timer = setTimeout(()=>runSearch(q), 250);
    });

    dockCompany.addEventListener('keydown', (ev)=>{
      if(ev.key === 'Enter'){
        try{ const cEl=document.getElementById('company'); if(cEl) cEl.value = dockCompany.value.trim(); }catch(_e){}
        const c = dockCompany.value.trim();
        const u = new URL(location.href);
        if(c) u.searchParams.set('company', c); else u.searchParams.delete('company');
        location.href = u.toString();
      }
    });
    const dockLoadBtn = document.getElementById('dockLoadBtn');
    if(dockLoadBtn){ dockLoadBtn.addEventListener('click', ()=>{ const ev = new KeyboardEvent('keydown',{key:'Enter'}); dockCompany.dispatchEvent(ev); }); }

    async function runSearch(q){
      if(!WEBAPP_URL) return;
      try{
        const data = await jsonp(WEBAPP_URL + '?action=search&q=' + encodeURIComponent(q) + '&limit=10');
        const items = (data && data.ok && Array.isArray(data.items)) ? data.items : [];
        if(!items.length){ dockSuggest.style.display='none'; dockSuggest.innerHTML=''; return; }
        dockSuggest.innerHTML = items.map(it=>{
          const name = (it.company||'').replaceAll('"','&quot;');
          const meta = it.timestamp ? ('<span style="color:#6b7280;font-size:12px">–æ–±–Ω–æ–≤–ª–µ–Ω–æ: '+String(it.timestamp).replaceAll('<','&lt;')+'</span>') : '';
          return '<div class="dockItem" data-company="'+name+'"><b>'+name+'</b>'+meta+'</div>';
        }).join('');
        dockSuggest.style.display='block';
        dockSuggest.querySelectorAll('.dockItem').forEach(el=>{
          el.addEventListener('click', ()=>{
            const c = el.getAttribute('data-company')||'';
            dockSuggest.style.display='none';
            dockCompany.value = c;
            setCompanyInLinks(c);
            const u = new URL(location.href);
            u.searchParams.set('company', c);
            location.href = u.toString();
          });
        });
      }catch(e){
        dockSuggest.style.display='none';
      }
    }
  })();
</script>
<div aria-hidden="true" id="globalLoader">
<div aria-live="polite" class="box" role="status">
<div class="spinner"></div>
<div>
<p class="title" id="globalLoaderTitle">–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶</p>
<p class="sub" id="globalLoaderSub">Google Sheets –æ—Ç–≤–µ—á–∞–µ—Ç, —ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.</p>
</div>
</div>
</div>

<script>
(function(){
  const KEEP = new Set([]);
  // 1) remove passport extra fields on focused pages
  const mode = 'interview';
  const extra = document.getElementById('passportExtra');
    if (extra && ['indices','pilot','product','psi'].includes(mode)) { extra.remove(); }
  // 3) hide cards not in KEEP (only when KEEP provided)
  if(KEEP.size){
    document.querySelectorAll('.card[id]').forEach(card=>{
      if(!KEEP.has(card.id)) card.style.display='none';
    });
  }
  // 4) for pages that should not show KPI bars / top indices, hide them unless mode=indices/full/interview
  if(['pilot','product','psi'].includes(mode)){
    document.querySelectorAll('.kpiBar, #riskHeatmapCard').forEach(el=>el.style.display='none');
    // also hide any "risk & readiness" blocks if present
    document.querySelectorAll('[data-section="risk"], .riskGrid, .riskRow').forEach(el=>el.style.display='none');
  }
  if(mode==='product'){
    // ensure product requirements card visible if exists
    const pr=document.getElementById('prodReqCard');
    if(pr) pr.style.display='';
  }
})();
</script>

<!-- Dock collapse/expand (shared for all pages) -->
<script>
(function(){
  function initDockToggle(){
    const btn = document.getElementById("dockToggle");
    const dock = document.getElementById("quickDock");
    if(!btn || !dock) return;
    const KEY = "itmenDockCollapsed";
    const body = document.body;
    function apply(collapsed){
      body.classList.toggle("dockCollapsed", !!collapsed);
      btn.setAttribute("aria-expanded", String(!collapsed));
      btn.textContent = collapsed ? "‚ñ∂" : "‚óÄ";
      btn.title = collapsed ? "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –ø–∞–Ω–µ–ª—å" : "–°–≤–µ—Ä–Ω—É—Ç—å –ø–∞–Ω–µ–ª—å";
    }
    let collapsed = false;
    try{ collapsed = localStorage.getItem(KEY) === "1"; }catch(e){}
    apply(collapsed);
    btn.addEventListener("click", function(e){
      e.preventDefault();
      collapsed = !collapsed;
      apply(collapsed);
      try{ localStorage.setItem(KEY, collapsed ? "1" : "0"); }catch(e){}
    });
  }
  if(document.readyState === "loading") document.addEventListener("DOMContentLoaded", initDockToggle);
  else initDockToggle();
})();
</script>


<script>
(function(){
  try{
    window.BUILD_VERSION = "v62";
    // Update any build badges if present
    const badge = document.querySelector('#buildBadge, .buildBadge, [data-build-badge]');
    if(badge) badge.textContent = "BUILD v62";
    console.log("‚úÖ BUILD v62 loaded");
  }catch(_){}
  const _id = (x)=>document.getElementById(x);

  // Required validation: ONLY company is required
  window.validateRequired = window.validateRequired || function(){
    const c = _id('company') || _id('dockCompany');
    return !!(c && String(c.value||'').trim());
  };

  // Some pages call setMode(); keep it as a safe no-op (mode toggles handled elsewhere)
  window.setMode = window.setMode || function(){};

  // Fallback payload builder: collect all fields by id (unknown keys are ignored by Sheets writer)
  function fallbackPayload(){
    const obj = {};
    document.querySelectorAll('input,select,textarea').forEach(el=>{
      if(!el || !el.id) return;
      if(el.disabled) return;
      const t = (el.type||'').toLowerCase();
      if(t === 'radio'){
        if(!el.checked) return;
        obj[el.name || el.id] = el.value;
        return;
      }
      if(t === 'checkbox'){
        obj[el.id] = el.checked ? '–¥–∞' : '–Ω–µ—Ç';
        return;
      }
      obj[el.id] = el.value;
    });
    // ensure company key exists
    if(!obj.company){
      const c = _id('company') || _id('dockCompany');
      if(c && String(c.value||'').trim()) obj.company = String(c.value||'').trim();
    }
    return obj;
  }

  // Make buildSheetPayloadExact safe
  if(typeof window.buildSheetPayloadExact === 'function'){
    const _orig = window.buildSheetPayloadExact;
    window.buildSheetPayloadExact = function(){
      try{
        return _orig();
      }catch(e){
        console.warn("buildSheetPayloadExact failed ‚Üí using fallback payload", e);
        return fallbackPayload();
      }
    };
  } else {
    window.buildSheetPayloadExact = fallbackPayload;
  }

  // Make recalc safe (must not block save/excel)
  if(typeof window.recalc === 'function' && typeof window.safeRecalc !== 'function'){
    window.safeRecalc = function(){
      try{ return window.recalc(); }
      catch(e){ console.warn("recalc failed (ignored)", e); return null; }
    };
  }

  // Patch recalc button handlers (if any) to use safeRecalc then sync
  if(typeof window.handleRecalcClick === 'function'){
    const _h = window.handleRecalcClick;
    window.handleRecalcClick = function(ev){
      try{
        if(typeof window.safeRecalc === 'function') window.safeRecalc();
        return _h(ev);
      }catch(e){
        console.warn("handleRecalcClick failed", e);
      }
    };
  }

  // Ensure Excel export doesn't crash due to recalc
  if(typeof window.exportExcel === 'function'){
    const _ex = window.exportExcel;
    window.exportExcel = function(){
      try{ if(typeof window.safeRecalc === 'function') window.safeRecalc(); }catch(_){}
      return _ex.apply(this, arguments);
    };
  }
})();
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https: data:; connect-src 'self' https://script.google.com https://script.googleusercontent.com; img-src 'self' data: https:; frame-src https://script.google.com https://script.googleusercontent.com;">
<script src="config.js"></script>
<script src="question_bank.js"></script>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ö–∞—Ä—Ç–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è + –ü–°–ò ‚Äî –ò–Ω—Ñ–µ—Ä–∏—Ç –ò–¢–ú–µ–Ω</title>
<style>
:root{
  --brand-red:#ff0000;
  --brand-red-2:#e21d35;
  --bg:#ffffff;
  --surface:#ffffff;
  --text:#111827;
  --muted:#6b7280;
  --border:#D1D1D1;
  --field:#E4E4E4;
  --field-focus:#ffffff;
  --shadow: 0 10px 30px rgba(0,0,0,.08);
  font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,#f7f7f8 0%,#ffffff 60%);color:var(--text)}
.container{max-width:1480px;margin:22px auto;padding:0 14px} /* fixed too-wide */

/* ===== QuickDock (left, on all pages) ===== */
.quickDock{position:fixed;left:16px;top:16px;width:320px;z-index:50}
.quickDock .card{box-shadow:0 18px 50px rgba(15,23,42,.12)}
.dockTitle{font-weight:950;font-size:14px;margin:0 0 10px}
.dockSearchWrap{position:relative}
.dockIcon{position:absolute;left:12px;top:50%;transform:translateY(-50%);opacity:.7}
.dockSearch{width:100%;border:1px solid rgba(15,23,42,.12);background:#f2f4f8;padding:11px 12px 11px 38px;border-radius:12px;outline:none;font-size:14px}
.dockSuggest{margin-top:8px;border:1px solid rgba(15,23,42,.12);border-radius:12px;overflow:hidden;display:none;background:#fff}
.dockItem{padding:10px 12px;border-top:1px solid rgba(15,23,42,.06);cursor:pointer}
.dockItem:first-child{border-top:none}
.dockItem b{display:block}
.toolGrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:10px}
.tool{padding:12px;border:1px solid rgba(15,23,42,.12);border-radius:14px;background:#fff;display:flex;gap:10px;align-items:flex-start;text-decoration:none;color:inherit}
.tIcon{width:28px;height:28px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.18)}
.tName{font-weight:900;font-size:13px;line-height:1.15}
.tDesc{font-size:12px;color:var(--muted);margin-top:3px}
@media (max-width:1480px){.quickDock{position:static;width:auto;margin:0 14px 12px}}
@media (min-width:1101px){.container{padding-left:360px}}
header{display:flex;gap:14px;align-items:flex-start;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap}
h1{font-size:20px;margin:0}
.sub{color:var(--muted);font-size:13px;margin-top:6px;line-height:1.35;max-width:920px}
.grid{display:grid;grid-template-columns:1fr;gap:14px} /* no right sidebar now */

.card{background:var(--surface);border:1px solid #e5e7eb;border-radius:16px;padding:16px;box-shadow:var(--shadow)}
h2{font-size:15px;margin:0 0 10px}
h3{font-size:13px;margin:12px 0 8px;color:#334155}
.hr{height:1px;background:#e5e7eb;margin:12px -16px}

label{display:grid;gap:6px;font-size:13px}
input,select,textarea{
  width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);
  background:var(--field);color:var(--text);
}
input:focus,select:focus,textarea:focus{
  outline:none;background:var(--field-focus);
  border-color: rgba(255,0,0,.55);box-shadow:0 0 0 3px rgba(255,0,0,.12);
}
textarea{min-height:120px;resize:vertical}
/* ===== Synthetic marker (quick-mode auto-filled) ===== */
input[data-synthetic="1"], select[data-synthetic="1"], textarea[data-synthetic="1"]{
  border-color: rgba(59,130,246,.65) !important;
  box-shadow: 0 0 0 3px rgba(59,130,246,.14) !important;
  background-color: var(--field) !important;
  background-image:
    radial-gradient(circle at calc(100% - 14px) 14px, rgba(59,130,246,1) 0 4px, rgba(59,130,246,0) 5px);
  background-repeat:no-repeat;
}

.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:860px){.row{grid-template-columns:1fr}}
.small{font-size:12px;color:var(--muted);line-height:1.35}

.btns{display:flex;gap:10px;flex-wrap:wrap}
.btn{appearance:none;border:none;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:800;background:var(--brand-red);color:#fff}
.btn:hover{background:var(--brand-red-2)}
.btn.ghost{background:var(--field);border:1px solid var(--border);color:var(--text);font-weight:700}
.btn.ghost:hover{background:#dcdcdc}

.legend{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;color:#475569;font-size:12px}

/* KPI header row */
.kpiBar{
  width:100%;
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap:10px;
  margin-top:10px;
}
@media(max-width:1480px){.kpiBar{grid-template-columns:repeat(2, minmax(0,1fr))}}
.stat{
  background:var(--field);
  border:1px solid var(--border);
  border-radius:14px;
  padding:10px 12px;
}
.stat .label{color:#475569;font-size:12px}
.stat .value{font-size:18px;font-weight:900;margin-top:6px}
.mono{font-variant-numeric:tabular-nums}
.good{outline:2px solid rgba(16,185,129,.35)}
.warn{outline:2px solid rgba(245,158,11,.35)}
.bad{ outline:2px solid rgba(244,63,94,.35)}

/* Tables */
.table-wrap{overflow:auto;border:1px solid #e5e7eb;border-radius:14px;background:#fff}
table{width:100%;border-collapse:collapse;font-size:13px;min-width:860px} /* smaller min width */
th,td{padding:10px;border-bottom:1px solid #e5e7eb;vertical-align:top}
th{text-align:left;color:#0f172a;font-weight:800;background:#f3f4f6;font-size:12px}
.right{text-align:right}
td input, td select, td textarea{padding:12px;border-radius:12px;border:1px solid var(--border);background:var(--field)}
td textarea{min-height:92px;height:92px;line-height:1.3}
.footer{margin:10px 0 0;color:var(--muted);font-size:12px;text-align:center}
@media print{
  header,.btns,.footer{display:none !important}.container{max-width:none;margin:0}.card{box-shadow:none}table{min-width:0}}

/* ===== PRINT (PDF) ===== */
@page{ size: A4 landscape; margin: 10mm; }
@media print{
  body{background:#fff}
  .container{max-width:none;margin:0;padding:0 8mm}
  .card{box-shadow:none}
  /* hide only controls, keep KPI */
  .btns{display:none !important}
  .legend{display:none !important}
  .kpiBar{grid-template-columns:repeat(6, minmax(0,1fr)); gap:6px; margin-top:6px}
  .stat{padding:8px}
  .stat .value{font-size:14px}
  .stat .label{font-size:10px}
  table{min-width:0}
}

/* ===== Modes ===== */
body.client-mode #projectRisksWrap{ display:none !important; }
body.client-mode #kRisk, body.client-mode #kFeas, body.client-mode #kProdFeas, body.client-mode #kReady, body.client-mode #kProb{ display:none !important; }
body.client-mode #clientSummaryBlock{ display:block !important; }
body.internal-mode #clientSummaryBlock{ display:none !important; }

body.quick-mode [data-mode="deep"]{ display:none !important; }




/* === Virt multiselect (native checkboxes) === */
.virt-wrapper{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
  gap:10px;
  margin-top:10px;
}
.virt-item{
  display:flex;
  align-items:center;
  gap:8px;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.06);
  cursor:pointer;
  font-weight:700;
}
.virt-item input{
  width:16px;
  height:16px;
  cursor:pointer;
}
.virt-hint{margin-top:8px;color:var(--muted);font-size:12px;}



/* === UI PATCH v7.15: resizable req metric + wider PSI match column === */
#reqTbody textarea{resize:both;}
#reqTbody td:nth-child(7) textarea, 
#reqTbody td:nth-child(7) input{
  width:100% !important;
  min-height:64px !important;
  resize:both !important;
}
/* PSI table: widen "–°–æ–æ—Ç–≤. (–î–∞/–ù–µ—Ç)" column */
#psiTable th:nth-child(6), #psiTable td:nth-child(6){
  min-width:130px !important;
  width:130px !important;
}
#psiTable td:nth-child(6) select{
  min-width:110px !important;
}

/* ===== Multi-page views (split tool) ===== */
body.view-indices #cardMaturity,
body.view-indices #cardFinance,
body.view-indices #cardReq,
body.view-indices #cardPSI,


body.view-interview #cardReq,
body.view-interview #cardPSI,


body.view-req #cardMaturity,
body.view-req #cardFinance,
body.view-req #cardPSI{ display:none !important; }

body.view-psi #cardMaturity,
body.view-psi #cardFinance,
body.view-psi #cardReq{ display:none !important; }

/* In focused views: collapse Passport card to only company (+industry) row */
body.view-indices #cardPassport .hr,
body.view-indices #cardPassport h3,
body.view-indices #cardPassport .small,
body.view-indices #cardPassport .virt-wrapper,
body.view-indices #cardPassport .virt-hint,
body.view-indices #cardPassport .row:not(:first-of-type){ display:none !important; }

body.view-req #cardPassport .hr,
body.view-req #cardPassport h3,
body.view-req #cardPassport .small,
body.view-req #cardPassport .virt-wrapper,
body.view-req #cardPassport .virt-hint,
body.view-req #cardPassport .row:not(:first-of-type){ display:none !important; }

body.view-psi #cardPassport .hr,
body.view-psi #cardPassport h3,
body.view-psi #cardPassport .small,
body.view-psi #cardPassport .virt-wrapper,
body.view-psi #cardPassport .virt-hint,
body.view-psi #cardPassport .row:not(:first-of-type){ display:none !important; }


/* === Suggest timestamp formatting === */
.companySuggestMeta{display:flex;gap:10px;align-items:baseline;flex-wrap:wrap}
.companySuggestMeta .dt-date{font-weight:800}
.companySuggestMeta .dt-time{font-variant-numeric:tabular-nums;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
.companySuggestMeta .dt-tz{opacity:.8}

/* === View flags === */
body.no-kpi .kpiBar{display:none !important;}


.benchWrap{display:none!important;}

#benchBadge,#benchTransparencyCard,#benchDetails,#benchProfileLabel{display:none!important;}

.dockLoadBtn{border:1px solid var(--border);background:var(--field);border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer}
.dockLoadBtn:hover{filter:brightness(0.98)}
.dockTop{display:flex;gap:10px;align-items:center}

/* PSI_ONLY_HIDE */
#cardReq,#projectRisksWrap,#cardReq + .hr{display:none!important;}


<style id="kpi-modal-css">
/* ===== KPI explain modal ===== */
.kpiModal{position:fixed;inset:0;display:none;z-index:9999}
.kpiModal[aria-hidden="false"]{display:block}
.kpiModal .backdrop{position:absolute;inset:0;background:rgba(17,24,39,.45);backdrop-filter: blur(6px);}
.kpiModal .dialog{
  position:relative;max-width:920px;margin:6vh auto;background:#fff;border:1px solid #e5e7eb;border-radius:18px;
  box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden;
}
.kpiModal .head{display:flex;align-items:flex-start;justify-content:space-between;gap:14px;padding:16px 18px;background:#f8fafc;border-bottom:1px solid #e5e7eb}
.kpiModal .title{margin:0;font-size:16px;font-weight:900;color:#0f172a}
.kpiModal .sub{margin-top:6px;color:#64748b;font-size:12px;line-height:1.35}
.kpiModal .closeBtn{appearance:none;border:none;background:#e5e7eb;color:#0f172a;border-radius:12px;padding:8px 10px;cursor:pointer;font-weight:900}
.kpiModal .closeBtn:hover{background:#dcdcdc}
.kpiModal .body{padding:14px 18px 18px 18px;max-height:72vh;overflow:auto}
.kpiModal .sect{border:1px solid #e5e7eb;border-radius:14px;padding:12px 12px;margin-top:10px}
.kpiModal .sect h3{margin:0 0 6px 0;font-size:13px;color:#0f172a}
.kpiModal .sect p, .kpiModal .sect li{margin:0;color:#334155;font-size:13px;line-height:1.5}
.kpiModal .sect ul{margin:8px 0 0 18px}
.kpiModal .note{margin-top:10px;color:#64748b;font-size:12px}
.kpi-clickable{cursor:pointer;user-select:none}
.kpi-clickable:active{transform:translateY(1px)}
</style>


<style id="gs-reverse-sync-css">
/* Reverse sync (Google Sheets) ‚Äî company autocomplete */
.companySuggestWrap{ position:relative; }
.companySuggestDropdown{
  position:absolute; left:0; right:0; top:100%;
  margin-top:6px;
  background:#ffffff;
  border:1px solid #e5e7eb;
  border-radius:14px;
  box-shadow:0 20px 40px rgba(0,0,0,.12);
  overflow:hidden;
  display:none;
  z-index:99999;
}
.companySuggestItem{
  padding:10px 12px;
  cursor:pointer;
  border-bottom:1px solid #eef2f7;
}
.companySuggestItem:last-child{ border-bottom:none; }
.companySuggestItem:hover{ background:#f8fafc; }
.companySuggestTitle{ font-weight:900; color:#0f172a; font-size:13px; }
.companySuggestMeta{ color:#64748b; font-size:12px; margin-top:3px; }
.companySuggestEmpty{
  padding:10px 12px;
  color:#64748b;
  font-size:12px;
}
</style>


<style id="global-loader-css">
#globalLoader{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:100000;background:rgba(255,255,255,.65);backdrop-filter: blur(6px);}
#globalLoader .box{background:#fff;border:1px solid #e5e7eb;border-radius:18px;box-shadow:0 20px 50px rgba(0,0,0,.18);padding:16px 18px;min-width:280px;max-width:520px;display:flex;gap:12px;align-items:center}
#globalLoader .spinner{width:22px;height:22px;border-radius:999px;border:3px solid #e5e7eb;border-top-color:#0ea5e9;animation:glspin 0.9s linear infinite}
#globalLoader .title{font-weight:900;color:#0f172a;font-size:13px;margin:0}
#globalLoader .sub{color:#64748b;font-size:12px;margin:2px 0 0 0;line-height:1.35}
@keyframes glspin{to{transform:rotate(360deg)}}
</style>

</head>
<body class="view-psi no-kpi">
  <div class="quickDock">
    <div class="card pad">
      <div class="dockTitle">–ë—ã—Å—Ç—Ä—ã–π –≤—Ö–æ–¥</div>
      <div class="dockSearchWrap dockTop">
        <div class="dockIcon">üîé</div>
        <input id="dockCompany" class="dockSearch" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–ø–∞–Ω–∏—é" autocomplete="off"/>
        <button id="dockLoadBtn" class="dockLoadBtn" type="button" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
      </div>
      <div id="dockSuggest" class="dockSuggest"></div>

      <div style="height:12px"></div>
      <div class="dockTitle" style="margin-bottom:0">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</div>
      <div class="toolGrid">
        <a class="tool" href="index.html"><div class="tIcon">üè†</div><div><div class="tName">–î–∞—à–±–æ—Ä–¥</div><div class="tDesc">PSI Control Center</div></div></a>
<a class="tool" href="view_1_indices.html"><div class="tIcon">üìä</div><div><div class="tName">–ò–Ω–¥–µ–∫—Å—ã</div><div class="tDesc">–∏—Ç–æ–≥–∏</div></div></a>
        <a class="tool" href="view_2_interview.html"><div class="tIcon">üéØ</div><div><div class="tName">–ò–Ω—Ç–µ—Ä–≤—å—é</div><div class="tDesc">1‚Äì3</div></div></a>
        <a class="tool" href="view_3_requirements.html"><div class="tIcon">üß™</div><div><div class="tName">–ü–∏–ª–æ—Ç</div><div class="tDesc">—Ä–∞–∑–¥–µ–ª 4</div></div></a>
        <a class="tool" href="view_3b_product.html"><div class="tIcon">üß©</div><div><div class="tName">–ü—Ä–æ–¥—É–∫—Ç</div><div class="tDesc">—Ä–∞–∑–¥–µ–ª 6</div></div></a>
        <a class="tool" href="view_4_psi.html"><div class="tIcon">üìà</div><div><div class="tName">–ü–°–ò</div><div class="tDesc">—Ä–∞–∑–¥–µ–ª 5</div></div></a>
        <a class="tool" href="view_5_full.html"><div class="tIcon">üìÑ</div><div><div class="tName">–ü–æ–ª–Ω–∞—è –∫–∞—Ä—Ç–∞</div><div class="tDesc">–≤—Å—ë</div></div></a>
      </div>
    </div>
  </div>
<div class="container">
  <header >
    <div>
      <h1>–ö–∞—Ä—Ç–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è + –ü–°–ò (–ø–∏–ª–æ—Ç) ‚Äî –ò–Ω—Ñ–µ—Ä–∏—Ç –ò–¢–ú–µ–Ω</h1>
      <div class="legend">
        <span class="pill">–¢–µ—Ö/–ü—Ä–æ—Ü: 0 = –Ω–µ—Ç ¬∑ 1 = —á–∞—Å—Ç–∏—á–Ω–æ ¬∑ 2 = –µ—Å—Ç—å</span>
        <span class="pill">–†–∏—Å–∫–∏: 1 = –¥–∞ ¬∑ 0 = –Ω–µ—Ç</span>
        <span class="pill">–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å: –≤–ª–∏—è–µ—Ç –Ω–∞ ¬´–∏–Ω–¥–µ–∫—Å —Ä–µ–∞–ª–∏–∑—É–µ–º–æ—Å—Ç–∏¬ª</span>
        <span class="pill">–ü–°–ò: ¬´–ü—Ä–∏–Ω—è–ª–∏?¬ª = –î–∞/–ù–µ—Ç</span>
      </div>
    </div>
    <div class="btns">
      <label style="display:grid;gap:6px;font-size:12px;min-width:180px">–í–µ—Ä—Å–∏—è PDF
        <select id="pdfMode" style="padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--field);font-weight:700">
          <option value="internal">–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è</option>
          <option value="client">–ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è</option>
        </select>
      </label>
      <label style="display:grid;gap:6px;font-size:12px;min-width:180px">–†–µ–∂–∏–º –∏–Ω—Ç–µ—Ä–≤—å—é
        <select id="interviewMode" style="padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--field);font-weight:700">
          <option value="quick">–ë—ã—Å—Ç—Ä—ã–π</option>
          <option value="deep">–ì–ª—É–±–æ–∫–∏–π</option>
        </select>
      </label>
      <input id="benchMode" type="hidden" value="client">
<div id="reqStatus" style="align-self:end;color:#b91c1c;font-size:12px;display:none;max-width:260px;line-height:1.2"></div>

      <button class="btn ghost" id="btnLoadCompany">–ü–æ–¥–≥—Ä—É–∑–∏—Ç—å</button>
      <button class="btn" id="btnRecalc">–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å</button>
<button class="btn ghost" id="btnPrint">–ü–µ—á–∞—Ç—å / PDF</button>
      <button class="btn ghost" id="btnExportXlsx">–í—ã–≥—Ä—É–∑–∏—Ç—å Excel</button>
      <button class="btn ghost" id="btnCLevel">C-level –≤—ã–≤–æ–¥</button>
    </div>

    <!-- KPI moved to header -->
    <div class="kpiBar">
  <div class="kpiGroupTitle">–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –∏–Ω–¥–µ–∫—Å—ã</div>

  <div class="stat" id="kPSI">
    <div class="label">PSI 2.0 (–∏—Ç–æ–≥)</div>
    <div class="value mono" id="psi2Score">‚Äî%</div>
    <div class="small" id="psi2Label">‚Äî</div>
  </div>

  <div class="stat" id="kCoI">
    <div class="label">Cost of Inaction (‚ÇΩ/–≥–æ–¥)</div>
    <div class="value mono" id="coiRub">‚Äî</div>
    <div class="small">–ü–æ—Ç–µ—Ä–∏ –æ—Ç —Ä—É—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π, –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ –ü–û/VM –∏ –ø—Ä–æ—Å—Ç–æ–µ–≤.</div>
  </div>

  <div class="stat" id="kRecover">
    <div class="label">–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –≤–æ–∑–≤—Ä–∞—Ç–∞ –±—é–¥–∂–µ—Ç–∞</div>
    <div class="value mono" id="recoverIndex">‚Äî%</div>
    <div class="small" id="recoverLabel">–õ–∏—Ü–µ–Ω–∑–∏–∏ –∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã.</div>
  </div>

  <div class="stat" id="kTech">
    <div class="label">–ò–Ω–¥–µ–∫—Å —Ç–µ—Ö. –∑—Ä–µ–ª–æ—Å—Ç–∏</div>
    <div class="value mono" id="techIndex">‚Äî%</div>
    <div class="small">–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –ø–æ –¥–∞–Ω–Ω—ã–º/–∏—Å—Ç–æ—á–Ω–∏–∫–∞–º.</div>
  </div>

  <div class="stat" id="kProc">
    <div class="label">–ò–Ω–¥–µ–∫—Å –ø—Ä–æ—Ü–µ—Å—Å–Ω–æ–π –∑—Ä–µ–ª–æ—Å—Ç–∏</div>
    <div class="value mono" id="procIndex">‚Äî%</div>
    <div class="small">–ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å –≤–Ω–µ–¥—Ä–µ–Ω–∏—è.</div>
  </div>

  <div class="kpiGroupTitle">–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∏–Ω–¥–µ–∫—Å—ã</div>

  <div class="stat" id="kCrit">
    <div class="label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞</div>
    <div class="value mono" id="critScore">‚Äî%</div>
    <div class="small" id="critLabel">‚Äî</div>
  </div>

  <div class="stat" id="kFeas">
    <div class="label">–ò–Ω–¥–µ–∫—Å —Ä–µ–∞–ª–∏–∑—É–µ–º–æ—Å—Ç–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ –ø–∏–ª–æ—Ç—É</div>
    <div class="value mono" id="feasScore">‚Äî%</div>
    <div class="small">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª –ø–æ ¬´–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏¬ª (—Ä–∞–∑–¥–µ–ª 4).</div>
  </div>

  <div class="stat" id="kProdFeas">
    <div class="label">–ò–Ω–¥–µ–∫—Å —Ä–µ–∞–ª–∏–∑—É–µ–º–æ—Å—Ç–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ –ø—Ä–æ–¥—É–∫—Ç—É</div>
    <div class="value mono" id="prodFeasScore">‚Äî%</div>
    <div class="small">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª –ø–æ ¬´–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏¬ª (—Ä–∞–∑–¥–µ–ª 6).</div>
  </div>

  <div class="stat" id="kPain">
    <div class="label">–ò–Ω–¥–µ–∫—Å —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–≥–æ –¥–∞–≤–ª–µ–Ω–∏—è</div>
    <div class="value mono" id="painIndex">‚Äî%</div>
    <div class="small" id="painLabel">‚Äî</div>
  </div>

  <div class="stat" id="kProb">
    <div class="label">–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Å–¥–µ–ª–∫–∏</div>
    <div class="value mono" id="probIndex">‚Äî%</div>
    <div class="small" id="probLabel">‚Äî</div>
  </div>
</div>
  </header>

  <div class="grid">

  <div class="card" id="cLevelBlock" style="display:none">
    <h2>C-level –≤—ã–≤–æ–¥ (–∞–≤—Ç–æ)</h2>
    <div class="small">–°—Ñ–æ—Ä–º–∏—Ä—É–π—Ç–µ –∫—Ä–∞—Ç–∫–∏–π –≤—ã–≤–æ–¥ –¥–ª—è CEO/CFO/CIO: ¬´–≥–¥–µ –ø—Ä–æ—Å–µ–¥–∞–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ä—ã–Ω–∫–∞¬ª, ¬´—Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —ç—Ñ—Ñ–µ–∫—Ç¬ª, ¬´—Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥¬ª.</div>
    <div class="row" style="margin-top:10px">
      <div style="grid-column:1 / -1;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <span class="pill" id="dataAccuracyPill">–¢–æ—á–Ω–æ—Å—Ç—å –æ—Ç—á—ë—Ç–∞: ‚Äî%</span>
        <span class="pill" id="dataSourcesPill">–ò—Å—Ç–æ—á–Ω–∏–∫–∏: ‚Äî</span>
      </div>
    </div>
    <div class="small" style="margin-top:6px">–ß—Ç–æ–±—ã –ø–æ–≤—ã—Å–∏—Ç—å —Ç–æ—á–Ω–æ—Å—Ç—å, –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ 3‚Äì5 –≤–æ–ø—Ä–æ—Å–æ–≤ –Ω–∏–∂–µ (–ø–æ–¥–±–∏—Ä–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ –≤–ª–∏—è–Ω–∏—é –Ω–∞ PSI).</div>
    <div class="card" style="margin-top:10px;background:rgba(255,255,255,.04)">
      <h3 style="margin:0 0 8px">–¢–æ–ø‚Äë–≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è —Ç–æ—á–Ω–æ—Å—Ç–∏</h3>
      <ol id="topQuestions" class="small" style="margin:0;padding-left:18px;line-height:1.45"></ol>
    </div>
    <div class="card" id="benchTransparencyCard" style="margin-top:10px;background:rgba(255,255,255,.04)">
      <details id="benchDetails" style="cursor:pointer">
        <summary style="font-weight:900">–ü–æ–∫–∞–∑–∞—Ç—å, –∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –ø–æ –±–µ–Ω—á–º–∞—Ä–∫–∞–º</summary>
        <div class="small" id="benchDetailsMeta" style="margin-top:10px;opacity:.9"></div>
        <div style="overflow:auto;margin-top:10px">
          <table class="table" style="min-width:760px">
            <thead>
              <tr>
                <th>–ü–∞—Ä–∞–º–µ—Ç—Ä</th>
                <th>–ó–Ω–∞—á–µ–Ω–∏–µ</th>
                <th>P25‚ÄìP75</th>
                <th>–ò—Å—Ç–æ—á–Ω–∏–∫</th>
              </tr>
            </thead>
            <tbody id="benchDetailsTbody"></tbody>
          </table>
        </div>
      </details>
    </div>

    <div class="row" style="margin-top:10px">
      <label style="grid-column:1 / -1">–¢–µ–∫—Å—Ç –≤—ã–≤–æ–¥–∞
        <textarea id="cLevelText" placeholder="–ù–∞–∂–º–∏—Ç–µ ¬´C-level –≤—ã–≤–æ–¥¬ª –≤–≤–µ—Ä—Ö—É ‚Äî —Å—é–¥–∞ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—Å—è —Ç–µ–∫—Å—Ç."></textarea>
      </label>
    </div>
    <div class="btns" style="margin-top:10px">
      <button class="btn ghost" id="btnCopyCLevel">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      <button class="btn ghost" id="btnHideCLevel">–°–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

    <div class="card" id="cardPassport">
      <h2>1) –ü–∞—Å–ø–æ—Ä—Ç –ø—Ä–æ–µ–∫—Ç–∞</h2>

<div class="row">
        <label>–ö–æ–º–ø–∞–Ω–∏—è
          <input id="company" placeholder="–û–û–û ¬´–ü—Ä–æ–º—Ä–µ—Å—É—Ä—Å¬ª">
        </label>
        <label>–û—Ç—Ä–∞—Å–ª—å
          <select id="industry">
            <option value="">‚Äî –≤—ã–±—Ä–∞—Ç—å ‚Äî</option>
            <option>–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å</option><option>–¢–µ–ª–µ–∫–æ–º</option><option>–†–∏—Ç–µ–π–ª</option>
            <option>–§–∏–Ω–∞–Ω—Å—ã</option><option>–ì–æ—Å—Å–µ–∫—Ç–æ—Ä</option><option>–ò–¢/–∏–Ω—Ç–µ–≥—Ä–∞—Ç–æ—Ä</option><option>–î—Ä—É–≥–æ–µ</option>
          </select>
        </label>
      </div>
      <div class="row" style="margin-top:10px">
        <label>Sales –º–µ–Ω–µ–¥–∂–µ—Ä (–§–ò–û)
          <input id="sales_manager" placeholder="‚Äî" disabled>
        </label>
        <label>Pre-Sale –º–µ–Ω–µ–¥–∂–µ—Ä (–§–ò–û)
          <input id="presale_manager" placeholder="‚Äî" disabled>
        </label>
      </div>


      <div class="row" style="margin-top:10px">
        <label>–õ–ü–† / –∫–æ–Ω—Ç–∞–∫—Ç
          <input id="lpr" placeholder="–§–ò–û, –¥–æ–ª–∂–Ω–æ—Å—Ç—å, –∫–æ–Ω—Ç–∞–∫—Ç—ã">
        </label>
        <!-- removed status block as requested -->
        <label>–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö (—Å–≤–æ–±–æ–¥–Ω—ã–π –≤–≤–æ–¥)
          <input id="sources" placeholder="AD, SCCM, VMware, SNMP, IPMI, MS SQL, API‚Ä¶">
        </label>
      </div>

      <div class="row" style="margin-top:10px">
        <label>–ö–æ–ª-–≤–æ —Ä–∞–±–æ—á–∏—Ö –º–µ—Å—Ç
          <input id="workplaces" type="number" min="0" step="1" value="0">
        </label>
        <label>–ö–æ–ª-–≤–æ —Å–µ—Ä–≤–µ—Ä–æ–≤
          <input id="servers" type="number" min="0" step="1" value="0">
        </label>
      </div>

      <div class="row" style="margin-top:10px">
        <label>–ö–æ–ª-–≤–æ —Ñ–∏–ª–∏–∞–ª–æ–≤
          <input id="branches" type="number" min="0" step="1" value="0">
        </label>
</div>

      <div class="row" style="margin-top:10px">
        <label>–ó–∞–∫—Ä—ã—Ç—ã–π –∫–æ–Ω—Ç—É—Ä
          <select id="closed"><option value="">‚Äî</option><option>–î–∞</option><option>–ù–µ—Ç</option></select>
        </label>
        <label>–ü—Ä–∏–º–µ—á–∞–Ω–∏—è –ø–æ —Å—Ä–µ–¥–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
          <input id="envNote" placeholder="–ù–∞–ø—Ä.: —Ñ–∏–ª–∏–∞–ª—å–Ω–∞—è —Å–µ—Ç—å, VDI, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –ò–ë">
        </label>
      </div>


      <div data-mode="deep">

<h3 style="margin:14px 0 6px">–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (–¥–æ–ø. –≤–æ–ø—Ä–æ—Å—ã)</h3>
      <div class="small">–ù–∞—Ç–∏–≤–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –æ—Ü–µ–Ω–∫–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö.</div>
<div class="row" style="margin-top:10px">
        <label>–í–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è
          
<input id="virt" type="hidden" value="">
<div class="virt-wrapper">
  <label class="virt-item"><input type="checkbox" value="VMware"> VMware</label>
  <label class="virt-item"><input type="checkbox" value="Hyper-V"> Hyper‚ÄëV</label>
  <label class="virt-item"><input type="checkbox" value="KVM/Proxmox"> KVM / Proxmox</label>
  <label class="virt-item"><input type="checkbox" value="–î—Ä—É–≥–∞—è"> –î—Ä—É–≥–∞—è</label>
  <label class="virt-item"><input type="checkbox" value="–ù–µ—Ç"> –ù–µ—Ç</label>
</div>
<div class="virt-hint">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤.</div>

        </label>
        <label>–ú–æ–¥–µ–ª—å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
          <select id="hostingModel">
            <option value="">‚Äî</option>
            <option>On‚Äëprem</option>
            <option>–ì–∏–±—Ä–∏–¥</option>
            <option>–ü—É–±–ª–∏—á–Ω–æ–µ –æ–±–ª–∞–∫–æ</option>
          </select>
        </label>
      </div>

      <div class="row" style="margin-top:10px">
        <label>–î–æ–º–µ–Ω—ã AD / –∫–∞—Ç–∞–ª–æ–≥–æ–≤ (–∫–æ–ª-–≤–æ)
          <input id="adDomains" type="number" min="0" step="1" value="0">
        </label>
        <label>–°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è —Å–µ—Ç–∏
          <select id="netSeg">
            <option value="">‚Äî</option>
            <option>Prod/Test/Dev –†–∞–∑–¥–µ–ª–µ–Ω—ã</option>
            <option>–ï—Å—Ç—å —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è (—á–∞—Å—Ç–∏—á–Ω–æ)</option>
            <option>–ù–µ—Ç</option>
          </select>
        </label>
      </div>

      <div class="row" style="margin-top:10px">
        <label>–¢–µ—Ä–º–∏–Ω–∞–ª—å–Ω—ã–µ —Ñ–µ—Ä–º—ã / RDS / VDI farms
          <select id="terminalFarms">
            <option value="">‚Äî</option>
            <option>–î–∞</option>
            <option>–ù–µ—Ç</option>
          </select>
        </label>
        <label>–í–æ–∑—Ä–∞—Å—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∂–µ–ª–µ–∑–∞
          <select id="hwAge">
            <option value="">‚Äî</option>
            <option>–¥–æ 3 –ª–µ—Ç</option>
            <option>3‚Äì5 –ª–µ—Ç</option>
            <option>5+ –ª–µ—Ç</option>
          </select>
        </label>
      </div>

      <div class="row" style="margin-top:10px">
<label>–†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤
          <select id="redundancy">
            <option value="">‚Äî</option>
            <option>–ï—Å—Ç—å</option>
            <option>–ß–∞—Å—Ç–∏—á–Ω–æ</option>
            <option>–ù–µ—Ç</option>
          </select>
        </label>
      </div>


      
</div>

<div class="hr"></div>

      </div>

    <div class="card" id="cardMaturity">
      <h2>2) –ó—Ä–µ–ª–æ—Å—Ç—å –∏ —Ä–∏—Å–∫–∏ (–¥–ª—è –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏)</h2>
      <div class="small">–ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ –∏–Ω—Ç–µ—Ä–≤—å—é. –ò–Ω–¥–µ–∫—Å—ã —Å—á–∏—Ç–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–≤ —à–∞–ø–∫–µ).</div>

      <h3>2.1 –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∑—Ä–µ–ª–æ—Å—Ç—å</h3>
      <div class="table-wrap">
        <table>
          <thead><tr><th>–ö—Ä–∏—Ç–µ—Ä–∏–π</th><th style="width:170px">–ë–∞–ª–ª (0‚Äì2)</th><th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th></tr></thead>
          <tbody id="techTbody"></tbody>
        </table>
      </div>

      <h3>2.2 –ü—Ä–æ—Ü–µ—Å—Å–Ω–∞—è –∑—Ä–µ–ª–æ—Å—Ç—å</h3>
      <div class="table-wrap">
        <table>
          <thead><tr><th>–ö—Ä–∏—Ç–µ—Ä–∏–π</th><th style="width:170px">–ë–∞–ª–ª (0‚Äì2)</th><th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th></tr></thead>
          <tbody id="procTbody"></tbody>
        </table>
      </div>

      <h3>2.3 –†–∏—Å–∫-–ø—Ä–æ—Ñ–∏–ª—å</h3>
      <div class="table-wrap">
        <table>
          <thead><tr><th>–§–∞–∫—Ç–æ—Ä</th><th style="width:170px">–ï—Å—Ç—å? (0/1)</th><th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th></tr></thead>
          <tbody id="riskTbody"></tbody>
        </table>
      </div>

      <div class="hr"></div>

      </div>

    <div class="card" id="cardFinance">
      <h2>3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞ (–¥–ª—è ROI / Cost of Inaction)</h2>
<div class="small">–í–∫–ª—é—á–∞–µ—Ç –ª–∏—Ü–µ–Ω–∑–∏–∏, —Ä—É—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, –ø—Ä–æ—Å—Ç–æ–∏ –∏ –≤–ª–∏—è–Ω–∏–µ –∂–µ–ª–µ–∑–∞.</div>
      <div class="small">–≠—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã–π –±–ª–æ–∫ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ ROI –∏ –≤ —Ä–∞—Å—á–µ—Ç–∞—Ö –ø–æ—Ç–µ—Ä—å.</div>

      <div class="row" style="margin-top:10px">
        <label>–°—Ä–µ–¥–Ω—è—è –∑–∞—Ä–ø–ª–∞—Ç–∞ IT (‚ÇΩ/–º–µ—Å) GROSS
          <input id="salary" type="number" min="0" step="1000" value="0">
        </label>
        <label>–ö–æ–ª-–≤–æ IT —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
          <input id="itCount" type="number" min="0" step="1" value="0">
        </label>
      </div>

      <div class="row" style="margin-top:10px">
        <label>% —Ä—É—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
          <input id="manualPct" type="number" min="0" max="100" step="1" value="0">
        </label>
        <label>–ë—é–¥–∂–µ—Ç –Ω–∞ –ª–∏—Ü–µ–Ω–∑–∏–∏ (‚ÇΩ/–≥–æ–¥)
          <input id="licBudget" type="number" min="0" step="10000" value="0">
        </label>
      </div>

      <div class="row" style="margin-top:10px">
        <label>% –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ –ü–û (–æ—Ü–µ–Ω–∫–∞)
          <input id="unusedPct" type="number" min="0" max="100" step="1" value="0">
        </label>
        <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Ä–∞—Å—á–µ—Ç—É
          <input id="finNote" placeholder="–û—Ç–∫—É–¥–∞ —Ü–∏—Ñ—Ä—ã / –∫—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª">
        </label>
      
      <div data-mode="deep">
<div class="row" style="margin-top:10px">
        <label>% –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö VM / –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ (–æ—Ü–µ–Ω–∫–∞)
          <input id="vmUnusedPct" type="number" min="0" max="100" step="1" value="0">
        </label>
        <label>–ù–µ–∑–∞–º–µ–Ω–∏–º—ã–µ –ò–¢-—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ (bus-factor ‚â§2)
          <select id="keyPeopleRisk">
            <option value="">‚Äî</option>
            <option>–î–∞</option>
            <option>–ù–µ—Ç</option>
          </select>
        </label>
      </div>

      <div class="row" style="margin-top:10px">
        <label>–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ –∑–Ω–∞–Ω–∏–π (0‚Äì2)
          <select id="docScore">
            <option value="0">0 ‚Äî –Ω–µ—Ç</option>
            <option value="1">1 ‚Äî —á–∞—Å—Ç–∏—á–Ω–æ</option>
            <option value="2">2 ‚Äî –µ—Å—Ç—å</option>
          </select>
        </label>
        <label>% —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –û–°/–ü–û (–æ—Ü–µ–Ω–∫–∞)
          <input id="obsoletePct" type="number" min="0" max="100" step="1" value="0">
        </label>
      </div>

</div>
</div>

      <div data-mode="deep">
<h3 style="margin:14px 0 6px">–ñ–µ–ª–µ–∑–æ –∏ –ø—Ä–æ—Å—Ç–æ–∏ (–¥–ª—è CoI)</h3>
      <div class="small">–î–æ–ø–æ–ª–Ω—è–µ—Ç Cost of Inaction: –ø—Ä–æ—Å—Ç–æ–∏ –∏ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∂–µ–ª–µ–∑–∞.</div>
      <div class="row" style="margin-top:10px">
        <label>–ë—é–¥–∂–µ—Ç –Ω–∞ –∂–µ–ª–µ–∑–æ (‚ÇΩ/–≥–æ–¥) <span class="small" style="opacity:.8">(–æ—Ü–µ–Ω–æ—á–Ω–æ)</span>
          <input id="hwBudget" type="number" min="0" step="10000" value="0">
        </label>
        <label>–ê–º–æ—Ä—Ç–∏–∑–∞—Ü–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∂–µ–ª–µ–∑–∞ (–ø–ª–∞–Ω –µ—Å—Ç—å?)
          <select id="hwPlan">
            <option value="">‚Äî</option>
            <option>–î–∞</option>
            <option>–ß–∞—Å—Ç–∏—á–Ω–æ</option>
            <option>–ù–µ—Ç</option>
          </select>
        </label>
      </div>

      <div class="row" style="margin-top:10px">
        <label>–ü—Ä–æ—Å—Ç–æ–∏/–∏–Ω—Ü–∏–¥–µ–Ω—Ç—ã: —á–∞—Å–æ–≤ –ø—Ä–æ—Å—Ç–æ—è –≤ –≥–æ–¥ <span class="small" style="opacity:.8">(–æ—Ü–µ–Ω–æ—á–Ω–æ)</span>
          <input id="downtimeHours" type="number" min="0" step="1" value="0">
        </label>
        <label>–°—Ç–æ–∏–º–æ—Å—Ç—å —á–∞—Å–∞ –ø—Ä–æ—Å—Ç–æ—è (‚ÇΩ/—á–∞—Å) <span class="small" style="opacity:.8">(–¥–ª—è –±–∏–∑–Ω–µ—Å–∞)</span>
          <input id="downtimeCost" type="number" min="0" step="1000" value="0">
        </label>
      </div>

      <div class="row" style="margin-top:10px">
        <label>–ò–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤ –≤ –º–µ—Å—è—Ü (–≤ —Å—Ä–µ–¥–Ω–µ–º) <span class="small" style="opacity:.8">(–æ—Ü–µ–Ω–æ—á–Ω–æ)</span>
          <input id="incidentsPerMonth" type="number" min="0" step="1" value="0">
        </label>
        <label>–°–µ—Ä–≤–∏—Å-–¥–µ—Å–∫ –µ—Å—Ç—å?
          <select id="serviceDesk">
            <option value="">‚Äî</option>
            <option>–î–∞</option>
            <option>–ù–µ—Ç</option>
          </select>
        </label>
      </div>


      
</div>
<div class="hr"></div>

      
      <div class="hr"></div>

      </div>

    <div class="card" id="cardReq">
      <h2>4) –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø–∏–ª–æ—Ç—É ‚Äî —Ä–µ–µ—Å—Ç—Ä</h2>
      <div class="small">–ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –∏–Ω—Ç–µ—Ä–≤—å—é/–¥–µ–º–æ. –≠—Ç–æ –æ—Å–Ω–æ–≤–∞ –¥–ª—è –ü–°–ò –∏ –ø—Ä–∏–µ–º–∫–∏. <b>–°—Ç–∞—Ç—É—Å —É–±—Ä–∞–Ω</b> ‚Äî –¥–æ–∫—É–º–µ–Ω—Ç —Å—Ç–∞—Ç–∏—á–Ω—ã–π.</div>

      <div class="btns" style="margin:10px 0 6px">
        <button class="btn ghost" id="btnAddReq">+ –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ</button>
        <button class="btn ghost" id="btnClearReq">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:54px">‚Ññ</th>
              <th style="min-width:220px">–ë–∏–∑–Ω–µ—Å –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å</th>
              <th style="min-width:340px">–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞</th>
              <th style="width:160px">–¢–∏–ø</th>
              <th style="width:140px">–û–±—è–∑–∞—Ç.</th>
              <th style="width:220px">–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å</th>
              <th style="min-width:240px">–ú–µ—Ç—Ä–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏</th>
            </tr>
          </thead>
          <tbody id="reqTbody"></tbody>
        </table>
      </div>

      
      <div class="hr"></div>
      <div class="hr"></div>

      </div>

    <div class="card" id="cardPSI">
      <h2>5) –ü–°–ò ‚Äî —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø—Ä–∏–µ–º–∫–∞</h2>
      <div class="small">–ü–æ –∏—Ç–æ–≥–∞–º –ø–∏–ª–æ—Ç–∞: —Ñ–∏–∫—Å–∏—Ä—É–µ–º ¬´–æ–∂–∏–¥–∞–Ω–∏–µ ‚Üí —Ñ–∞–∫—Ç ‚Üí —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ¬ª –∏ —Ä–µ—à–µ–Ω–∏–µ ¬´–ø—Ä–∏–Ω—è–ª–∏/–Ω–µ –ø—Ä–∏–Ω—è–ª–∏¬ª.</div>

      <div class="btns" style="margin:10px 0 6px">
        <button class="btn ghost" id="btnAddPsi">+ –î–æ–±–∞–≤–∏—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π</button>
        <button class="btn ghost" id="btnClearPsi">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>

      <div class="table-wrap">
        <table id="psiTable">
          <thead>
            <tr>
              <th style="width:54px">‚Ññ</th>
              <th style="min-width:260px">–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è</th>
              <th style="min-width:260px">–°—Ü–µ–Ω–∞—Ä–∏–π –ø—Ä–æ–≤–µ—Ä–∫–∏</th>
              <th style="min-width:260px">–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</th>
              <th style="min-width:260px">–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</th>
              <th style="width:170px">–°–æ–æ—Ç–≤. (–î–∞/–ù–µ—Ç)</th>
              <th style="width:190px">–ü—Ä–∏–Ω—è–ª–∏? (–î–∞/–ù–µ—Ç)</th>
              <th style="min-width:260px">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
            </tr>
          </thead>
          <tbody id="psiTbody"></tbody>
        </table>
      </div>
      <div class="hr"></div>

      <h2>6) –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø—Ä–æ–¥—É–∫—Ç—É ‚Äî —Ä–µ–µ—Å—Ç—Ä</h2>
      <div class="small">–§–∏–∫—Å–∏—Ä—É–µ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø—Ä–æ–¥—É–∫—Ç—É (–¥–ª—è roadmap/–æ—Ü–µ–Ω–∫–∏). –ò–Ω–¥–µ–∫—Å ‚Äî –ø–æ ¬´–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏¬ª.</div>

      <div class="btns" style="margin:10px 0 6px">
        <button class="btn ghost" id="btnAddProdReq">+ –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ</button>
        <button class="btn ghost" id="btnClearProdReq">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:54px">‚Ññ</th>
              <th style="min-width:260px">–ë–∏–∑–Ω–µ—Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ</th>
              <th style="min-width:340px">–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ</th>
              <th style="width:160px">–¢–∏–ø</th>
              <th style="width:140px">–û–±—è–∑–∞—Ç.</th>
              <th style="width:220px">–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å</th>
            </tr>
          </thead>
          <tbody id="prodReqTbody"></tbody>
        </table>
      </div>


      
      <div id="projectRisksWrap">
        <h2>5.1) –†–∏—Å–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ (–∫–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞)</h2>
        <div class="small">–†–∞–∑–¥–µ–ª –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è. –í –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π –≤–µ—Ä—Å–∏–∏ PDF —Å–∫—Ä—ã—Ç.</div>

        <div class="table-wrap" style="margin-top:10px">
          <table>
            <thead>
              <tr>
                <th style="width:220px">–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä</th>
                <th>–£—Å–ª–æ–≤–∏–µ</th>
                <th style="width:180px">–°—Ç–∞—Ç—É—Å</th>
                <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
              </tr>
            </thead>
            <tbody id="projectRisks"></tbody>
          </table>
        </div>

        <div class="row" style="margin-top:10px">
          <label>–£—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ (–∏—Ç–æ–≥)
            <input id="riskLevelText" readonly>
          </label>
          <label>–ß—Ç–æ –º–æ–∂–µ—Ç –ø–æ–π—Ç–∏ –Ω–µ —Ç–∞–∫ (–∫—Ä–∞—Ç–∫–æ)
            <input id="riskNotes" placeholder="–ù–∞–ø—Ä.: –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º, –Ω–µ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞, —Ä–∞–∑–º—ã—Ç—ã–π –ø–µ—Ä–∏–º–µ—Ç—Ä...">
          </label>
        </div>

        <div class="hr"></div>
      </div>

      


      
<div class="hr"></div>

      

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
function hidePsiExtras(){
  // PSI-only: hide Product Requirements and Project Risks blocks
  const prodH2 = Array.from(document.querySelectorAll("h2")).find(h=> (h.textContent||"").trim().startsWith("6)"));
  if(prodH2){
    // hide everything from this heading to the end of its card
    let node=prodH2;
    while(node){
      const next=node.nextElementSibling;
      node.style.display="none";
      if(!next) break;
      node=next;
      if(node.classList && node.classList.contains("hr")) break;
    }
  }
  const prWrap=document.getElementById("projectRisksWrap");
  if(prWrap){ prWrap.style.display="none"; }
}
window.addEventListener("DOMContentLoaded", hidePsiExtras);

const TECH = [
  {label:"T1. –ï—Å—Ç—å –ª–∏ –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–º –ü–û?", mode:"both"},
  {label:"T2. –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω –ª–∏ —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –æ–± –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–µ (–±–µ–∑ —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞)?", mode:"both"},
  {label:"T3. –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ –ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –¥—É–±–ª–µ–π —É—Å—Ç—Ä–æ–π—Å—Ç–≤?", mode:"both"},
  {label:"T4. –ï—Å—Ç—å –ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –≤ —Å–µ—Ç–∏?", mode:"both"},
  {label:"T5. –û–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ª–∏ –¥–∞–Ω–Ω—ã–µ –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –∏ –ü–û –±–µ–∑ —Ä—É—á–Ω–æ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞?", mode:"both"},
  {label:"T6. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ª–∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –ü–û?", mode:"deep"},
  {label:"T7. –ï—Å—Ç—å –ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—è–≤–ª–µ–Ω–∏–µ –Ω–µ—Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–æ–≥–æ –∏–ª–∏ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω–æ–≥–æ –ü–û?", mode:"deep"},
  {label:"T8. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏ –¥–∞–Ω–Ω—ã–µ –æ–± –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏ –≤ –¥—Ä—É–≥–∏—Ö —Å–∏—Å—Ç–µ–º–∞—Ö (ITSM, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –ª–∏—Ü–µ–Ω–∑–∏—Ä–æ–≤–∞–Ω–∏–µ)?", mode:"deep"},
  {label:"T9. –û—Ö–≤–∞—á–µ–Ω—ã –ª–∏ —Å–±–æ—Ä–æ–º –¥–∞–Ω–Ω—ã—Ö –≤—Å–µ —Å–µ–≥–º–µ–Ω—Ç—ã –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (VDI, —Ñ–∏–ª–∏–∞–ª—ã, –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç—É—Ä—ã)?", mode:"deep"},
  {label:"T10. –í–æ–∑–º–æ–∂–Ω–æ –ª–∏ —Ä–∞—Å—à–∏—Ä—è—Ç—å –º–æ–¥–µ–ª—å —Å–æ–±–∏—Ä–∞–µ–º—ã—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –±–µ–∑ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏?", mode:"deep"}
];

const PROC = [
  {label:"P1. –§–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å —É—á–µ—Ç–∞ –ò–¢-–∞–∫—Ç–∏–≤–æ–≤?", mode:"both"},
  {label:"P2. –ù–∞–∑–Ω–∞—á–µ–Ω –ª–∏ –≤–ª–∞–¥–µ–ª–µ—Ü –ø—Ä–æ—Ü–µ—Å—Å–∞ —É—á–µ—Ç–∞ –∞–∫—Ç–∏–≤–æ–≤?", mode:"both"},
  {label:"P3. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏ –¥–∞–Ω–Ω—ã–µ –æ–± –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏?", mode:"both"},
  {label:"P4. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏ –¥–∞–Ω–Ω—ã–µ –æ–± –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞–º–∏?", mode:"both"},
  {label:"P5. –ï—Å—Ç—å –ª–∏ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç –∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –∏ –ü–û?", mode:"both"},
  {label:"P6. –ü—Ä–æ–≤–æ–¥–∏—Ç—Å—è –ª–∏ —Ä–µ–≥—É–ª—è—Ä–Ω–∞—è —Å–≤–µ—Ä–∫–∞ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å —É—á–µ—Ç–Ω–æ–π?", mode:"deep"},
  {label:"P7. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏ –¥–∞–Ω–Ω—ã–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–∫—É–ø–æ–∫ –ü–û?", mode:"deep"},
  {label:"P8. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã—Ö —Ä–∏—Å–∫–æ–≤?", mode:"deep"},
  {label:"P9. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–µ—â–µ–Ω–Ω–æ–≥–æ –ü–û?", mode:"deep"},
  {label:"P10. –ï—Å—Ç—å –ª–∏ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç —Ä–µ–∞–∫—Ü–∏–∏ –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ/–Ω–µ—É—á—Ç–µ–Ω–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞?", mode:"deep"}
];

const RISK = [
  {label:"–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–∞—è (–º–Ω–æ–≥–æ —Ñ–∏–ª–∏–∞–ª–æ–≤/–ø–ª–æ—â–∞–¥–æ–∫)", mode:"both"},
  {label:"–ü–∞—Ä–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –±—ã—Å—Ç—Ä–æ —Ä–∞—Å—Ç–µ—Ç/–º–µ–Ω—è–µ—Ç—Å—è", mode:"both"},
  {label:"–ú–Ω–æ–≥–æ —Ä—É—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —É—á–µ—Ç–µ –∞–∫—Ç–∏–≤–æ–≤", mode:"both"},
  {label:"–ï—Å—Ç—å —Ä–∏—Å–∫ –Ω–µ—É—á—Ç–µ–Ω–Ω—ã—Ö —É—Å—Ç–∞–Ω–æ–≤–æ–∫ –ü–û", mode:"both"},
  {label:"–ï—Å—Ç—å —á–∞—Å—Ç—ã–µ –∏–Ω—Ü–∏–¥–µ–Ω—Ç—ã/–ø—Ä–æ—Å—Ç–æ–∏ (–ø–æ –æ—â—É—â–µ–Ω–∏—è–º –±–∏–∑–Ω–µ—Å–∞)", mode:"both"},
  {label:"–ë—ã–ª–∏ –≤–Ω–µ—à–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –≥–æ–¥–∞", mode:"deep"},
  {label:"–ü–ª–∞–Ω–∏—Ä—É—é—Ç—Å—è –∫—Ä—É–ø–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≤ 12 –º–µ—Å—è—Ü–µ–≤ (–º–∏–≥—Ä–∞—Ü–∏–∏/—Å–ª–∏—è–Ω–∏—è)", mode:"deep"},
  {label:"–í—ã—Å–æ–∫–∞—è —Ç–µ–∫—É—á–µ—Å—Ç—å –ò–¢-–ø–µ—Ä—Å–æ–Ω–∞–ª–∞/—Å–º–µ–Ω–∞ –ø–æ–¥—Ä—è–¥—á–∏–∫–æ–≤", mode:"deep"}
];

const FEAS_OPTIONS = [
  { label: "‚Äî", score: null },
  { label: "–ü–æ–ª–Ω–æ—Å—Ç—å—é", score: 1.00 },
  { label: "–ß–∞—Å—Ç–∏—á–Ω–æ", score: 0.60 },
  { label: "–ù–µ—Ç", score: 0.00 },
  { label: "–ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏", score: 0.00 },
  { label: "–•–∞—Ä–¥ –∫–æ–¥ (—Å–∫–æ—Ä–æ)", score: 0.70 },
  { label: "–•–∞—Ä–¥ –∫–æ–¥ (–°–∫–æ—Ä–æ)", score: 0.70 },
  { label: "–•–∞—Ä–¥ –∫–æ–¥ (–Ω–µ —Å–∫–æ—Ä–æ)", score: 0.30 },
  { label: "–¢—Ä–µ–±—É–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç", score: 0.50 },
];

function fmtMoney(n){ if(!isFinite(n)) return "‚Äî"; return Math.round(n).toLocaleString("ru-RU")+" ‚ÇΩ"; }
function clampInt(v,min,max){ v=parseInt(v,10); if(isNaN(v)) v=min; return Math.min(max,Math.max(min,v)); }
function clamp(v,min,max){ v=+v; if(!isFinite(v)) return min; return Math.min(max, Math.max(min, v)); }
function debounce(fn,ms){ let t; return (...a)=>{clearTimeout(t); t=setTimeout(()=>fn(...a),ms)}; }
const avg = arr => arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0;


/* ===================== Benchmark engine (Iteration 1 + 2) ===================== */

// Benchmarks are *synthetic but realistic* ranges (P25‚ÄìP75) by Industry + Size bucket.
// NOTE: All values are percentages unless stated otherwise.
const BENCH = {
  "–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å": {
    "1-2k":   { manualPct:{m:34,p25:26,p75:44}, unusedPct:{m:18,p25:12,p75:27}, vmUnusedPct:{m:22,p25:15,p75:32},
              incidentsPerMonth:{m:14,p25:8,p75:22}, downtimeHours:{m:26,p25:14,p75:40}, downtimeCost:{m:350000,p25:120000,p75:650000},
              obsoletePct:{m:32,p25:22,p75:44}, keyPeopleRisk:{m:1,p25:1,p75:2}, docScore:{m:0.8,p25:0,p75:1} },
    "2-10k":  { manualPct:{m:38,p25:30,p75:50}, unusedPct:{m:20,p25:13,p75:30}, vmUnusedPct:{m:26,p25:18,p75:36},
              incidentsPerMonth:{m:22,p25:14,p75:35}, downtimeHours:{m:42,p25:24,p75:70}, downtimeCost:{m:550000,p25:220000,p75:1000000},
              obsoletePct:{m:35,p25:25,p75:48}, keyPeopleRisk:{m:1,p25:1,p75:2}, docScore:{m:0.7,p25:0,p75:1} },
    "10k+":   { manualPct:{m:42,p25:34,p75:54}, unusedPct:{m:22,p25:15,p75:34}, vmUnusedPct:{m:28,p25:20,p75:38},
              incidentsPerMonth:{m:30,p25:18,p75:45}, downtimeHours:{m:60,p25:36,p75:95}, downtimeCost:{m:900000,p25:350000,p75:1700000},
              obsoletePct:{m:30,p25:20,p75:42}, keyPeopleRisk:{m:1,p25:1,p75:2}, docScore:{m:0.9,p25:0,p75:2} }
  },
  "–§–∏–Ω–∞–Ω—Å—ã": {
    "1-2k":   { manualPct:{m:28,p25:20,p75:38}, unusedPct:{m:16,p25:10,p75:24}, vmUnusedPct:{m:20,p25:12,p75:30},
              incidentsPerMonth:{m:10,p25:6,p75:16}, downtimeHours:{m:18,p25:10,p75:28}, downtimeCost:{m:650000,p25:250000,p75:1300000},
              obsoletePct:{m:22,p25:14,p75:32}, keyPeopleRisk:{m:1,p25:1,p75:2}, docScore:{m:1.2,p25:1,p75:2} },
    "2-10k":  { manualPct:{m:32,p25:24,p75:42}, unusedPct:{m:18,p25:12,p75:27}, vmUnusedPct:{m:22,p25:14,p75:32},
              incidentsPerMonth:{m:16,p25:10,p75:26}, downtimeHours:{m:30,p25:18,p75:48}, downtimeCost:{m:1100000,p25:450000,p75:2200000},
              obsoletePct:{m:24,p25:16,p75:36}, keyPeopleRisk:{m:1,p25:1,p75:2}, docScore:{m:1.3,p25:1,p75:2} },
    "10k+":   { manualPct:{m:34,p25:26,p75:44}, unusedPct:{m:20,p25:13,p75:30}, vmUnusedPct:{m:24,p25:16,p75:34},
              incidentsPerMonth:{m:22,p25:14,p75:34}, downtimeHours:{m:44,p25:28,p75:70}, downtimeCost:{m:1800000,p25:800000,p75:3500000},
              obsoletePct:{m:20,p25:12,p75:30}, keyPeopleRisk:{m:1,p25:1,p75:2}, docScore:{m:1.5,p25:1,p75:2} }
  },
  "–¢–µ–ª–µ–∫–æ–º": {
    "1-2k":   { manualPct:{m:32,p25:24,p75:42}, unusedPct:{m:17,p25:11,p75:26}, vmUnusedPct:{m:24,p25:16,p75:34},
              incidentsPerMonth:{m:18,p25:10,p75:28}, downtimeHours:{m:34,p25:20,p75:52}, downtimeCost:{m:500000,p25:200000,p75:950000},
              obsoletePct:{m:28,p25:18,p75:40}, keyPeopleRisk:{m:1,p25:1,p75:2}, docScore:{m:0.9,p25:0,p75:2} },
    "2-10k":  { manualPct:{m:36,p25:28,p75:48}, unusedPct:{m:19,p25:12,p75:29}, vmUnusedPct:{m:28,p25:20,p75:38},
              incidentsPerMonth:{m:28,p25:16,p75:42}, downtimeHours:{m:55,p25:34,p75:85}, downtimeCost:{m:850000,p25:350000,p75:1600000},
              obsoletePct:{m:30,p25:20,p75:42}, keyPeopleRisk:{m:1,p25:1,p75:2}, docScore:{m:0.8,p25:0,p75:1} },
    "10k+":   { manualPct:{m:38,p25:30,p75:50}, unusedPct:{m:20,p25:13,p75:31}, vmUnusedPct:{m:30,p25:22,p75:40},
              incidentsPerMonth:{m:36,p25:22,p75:55}, downtimeHours:{m:80,p25:50,p75:120}, downtimeCost:{m:1400000,p25:650000,p75:2600000},
              obsoletePct:{m:26,p25:16,p75:38}, keyPeopleRisk:{m:1,p25:1,p75:2}, docScore:{m:1.0,p25:0,p75:2} }
  },
  "–†–∏—Ç–µ–π–ª": {
    "1-2k":   { manualPct:{m:36,p25:28,p75:46}, unusedPct:{m:19,p25:12,p75:28}, vmUnusedPct:{m:20,p25:12,p75:30},
              incidentsPerMonth:{m:16,p25:10,p75:26}, downtimeHours:{m:28,p25:16,p75:44}, downtimeCost:{m:250000,p25:90000,p75:500000},
              obsoletePct:{m:34,p25:24,p75:46}, keyPeopleRisk:{m:2,p25:1,p75:2}, docScore:{m:0.6,p25:0,p75:1} },
    "2-10k":  { manualPct:{m:40,p25:32,p75:52}, unusedPct:{m:22,p25:14,p75:34}, vmUnusedPct:{m:24,p25:16,p75:34},
              incidentsPerMonth:{m:24,p25:14,p75:38}, downtimeHours:{m:46,p25:28,p75:72}, downtimeCost:{m:420000,p25:160000,p75:850000},
              obsoletePct:{m:36,p25:26,p75:50}, keyPeopleRisk:{m:2,p25:1,p75:2}, docScore:{m:0.6,p25:0,p75:1} },
    "10k+":   { manualPct:{m:42,p25:34,p75:54}, unusedPct:{m:24,p25:16,p75:36}, vmUnusedPct:{m:26,p25:18,p75:36},
              incidentsPerMonth:{m:32,p25:20,p75:50}, downtimeHours:{m:70,p25:44,p75:110}, downtimeCost:{m:650000,p25:260000,p75:1300000},
              obsoletePct:{m:32,p25:22,p75:46}, keyPeopleRisk:{m:2,p25:1,p75:2}, docScore:{m:0.7,p25:0,p75:2} }
  },
  "–ì–æ—Å—Å–µ–∫—Ç–æ—Ä": {
    "1-2k":   { manualPct:{m:40,p25:32,p75:52}, unusedPct:{m:14,p25:9,p75:22}, vmUnusedPct:{m:18,p25:10,p75:28},
              incidentsPerMonth:{m:12,p25:7,p75:20}, downtimeHours:{m:22,p25:12,p75:36}, downtimeCost:{m:120000,p25:50000,p75:260000},
              obsoletePct:{m:42,p25:32,p75:55}, keyPeopleRisk:{m:2,p25:1,p75:2}, docScore:{m:0.7,p25:0,p75:1} },
    "2-10k":  { manualPct:{m:44,p25:36,p75:56}, unusedPct:{m:16,p25:10,p75:25}, vmUnusedPct:{m:20,p25:12,p75:30},
              incidentsPerMonth:{m:18,p25:10,p75:30}, downtimeHours:{m:36,p25:20,p75:60}, downtimeCost:{m:180000,p25:80000,p75:400000},
              obsoletePct:{m:45,p25:35,p75:60}, keyPeopleRisk:{m:2,p25:1,p75:2}, docScore:{m:0.7,p25:0,p75:1} },
    "10k+":   { manualPct:{m:46,p25:38,p75:58}, unusedPct:{m:18,p25:12,p75:28}, vmUnusedPct:{m:22,p25:14,p75:32},
              incidentsPerMonth:{m:24,p25:14,p75:40}, downtimeHours:{m:55,p25:34,p75:90}, downtimeCost:{m:260000,p25:120000,p75:550000},
              obsoletePct:{m:40,p25:30,p75:55}, keyPeopleRisk:{m:2,p25:1,p75:2}, docScore:{m:0.8,p25:0,p75:2} }
  },
  "–ò–¢/–∏–Ω—Ç–µ–≥—Ä–∞—Ç–æ—Ä": {
    "1-2k":   { manualPct:{m:30,p25:22,p75:40}, unusedPct:{m:21,p25:13,p75:32}, vmUnusedPct:{m:26,p25:18,p75:36},
              incidentsPerMonth:{m:14,p25:8,p75:22}, downtimeHours:{m:20,p25:12,p75:32}, downtimeCost:{m:220000,p25:90000,p75:500000},
              obsoletePct:{m:24,p25:16,p75:34}, keyPeopleRisk:{m:1,p25:1,p75:2}, docScore:{m:0.9,p25:0,p75:2} },
    "2-10k":  { manualPct:{m:34,p25:26,p75:46}, unusedPct:{m:24,p25:16,p75:36}, vmUnusedPct:{m:30,p25:22,p75:40},
              incidentsPerMonth:{m:20,p25:12,p75:32}, downtimeHours:{m:32,p25:20,p75:50}, downtimeCost:{m:350000,p25:150000,p75:800000},
              obsoletePct:{m:26,p25:18,p75:38}, keyPeopleRisk:{m:1,p25:1,p75:2}, docScore:{m:1.0,p25:0,p75:2} },
    "10k+":   { manualPct:{m:36,p25:28,p75:48}, unusedPct:{m:26,p25:18,p75:38}, vmUnusedPct:{m:32,p25:24,p75:42},
              incidentsPerMonth:{m:26,p25:16,p75:40}, downtimeHours:{m:44,p25:28,p75:70}, downtimeCost:{m:600000,p25:250000,p75:1300000},
              obsoletePct:{m:22,p25:14,p75:34}, keyPeopleRisk:{m:1,p25:1,p75:2}, docScore:{m:1.1,p25:0,p75:2} }
  }
};

function sizeBucket(totalEndpoints){
  const n = +totalEndpoints || 0;
  if(n <= 2000) return "1-2k";
  if(n <= 10000) return "2-10k";
  return "10k+";
}

function getProfile(){
  const industry = (document.getElementById("industry")?.value || "").trim() || "–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å";
  const workplaces = (+document.getElementById("workplaces")?.value || 0);
  const servers = (+document.getElementById("servers")?.value || 0);
  const total = workplaces + servers;
  const bucket = sizeBucket(total);
  const vdi = (document.getElementById("vdi")?.value || "").trim();
  const closed = (document.getElementById("closed")?.value || "").trim();
  const branches = (+document.getElementById("branches")?.value || 0);
  return {industry, bucket, total, workplaces, servers, vdi, closed, branches};
}


const BENCH_MATURITY = {
  "–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å": {"1-2k":{techMaturityPct:{m:52,p25:40,p75:64}, procMaturityPct:{m:46,p25:34,p75:58}, riskProb:{m:0.32,p25:0.22,p75:0.44}, feasibilityPct:{m:62,p25:50,p75:74}, changeMaturityPct:{m:42,p25:30,p75:55}, scalabilityPct:{m:50,p25:38,p75:62}, aiReadinessPct:{m:44,p25:32,p75:58}},
                     "2-10k":{techMaturityPct:{m:56,p25:44,p75:68}, procMaturityPct:{m:50,p25:38,p75:62}, riskProb:{m:0.36,p25:0.25,p75:0.48}, feasibilityPct:{m:60,p25:48,p75:72}, changeMaturityPct:{m:46,p25:34,p75:58}, scalabilityPct:{m:54,p25:42,p75:66}, aiReadinessPct:{m:46,p25:34,p75:60}},
                     "10k+":{techMaturityPct:{m:60,p25:48,p75:72}, procMaturityPct:{m:54,p25:42,p75:66}, riskProb:{m:0.34,p25:0.24,p75:0.46}, feasibilityPct:{m:58,p25:46,p75:70}, changeMaturityPct:{m:50,p25:38,p75:62}, scalabilityPct:{m:58,p25:46,p75:70}, aiReadinessPct:{m:50,p25:38,p75:64}} },
  "–§–∏–Ω–∞–Ω—Å—ã": {"1-2k":{techMaturityPct:{m:58,p25:46,p75:70}, procMaturityPct:{m:56,p25:44,p75:68}, riskProb:{m:0.38,p25:0.28,p75:0.52}, feasibilityPct:{m:64,p25:52,p75:76}, changeMaturityPct:{m:52,p25:40,p75:64}, scalabilityPct:{m:56,p25:44,p75:68}, aiReadinessPct:{m:52,p25:40,p75:66}},
             "2-10k":{techMaturityPct:{m:62,p25:50,p75:74}, procMaturityPct:{m:60,p25:48,p75:72}, riskProb:{m:0.40,p25:0.30,p75:0.54}, feasibilityPct:{m:62,p25:50,p75:74}, changeMaturityPct:{m:56,p25:44,p75:68}, scalabilityPct:{m:60,p25:48,p75:72}, aiReadinessPct:{m:56,p25:44,p75:70}},
             "10k+":{techMaturityPct:{m:66,p25:54,p75:78}, procMaturityPct:{m:64,p25:52,p75:76}, riskProb:{m:0.36,p25:0.26,p75:0.50}, feasibilityPct:{m:60,p25:48,p75:72}, changeMaturityPct:{m:60,p25:48,p75:72}, scalabilityPct:{m:62,p25:50,p75:74}, aiReadinessPct:{m:60,p25:48,p75:74}} },
  "–¢–µ–ª–µ–∫–æ–º": {"1-2k":{techMaturityPct:{m:56,p25:44,p75:68}, procMaturityPct:{m:50,p25:38,p75:62}, riskProb:{m:0.34,p25:0.24,p75:0.48}, feasibilityPct:{m:60,p25:48,p75:72}, changeMaturityPct:{m:48,p25:36,p75:60}, scalabilityPct:{m:56,p25:44,p75:68}, aiReadinessPct:{m:54,p25:42,p75:68}},
             "2-10k":{techMaturityPct:{m:60,p25:48,p75:72}, procMaturityPct:{m:54,p25:42,p75:66}, riskProb:{m:0.36,p25:0.26,p75:0.50}, feasibilityPct:{m:58,p25:46,p75:70}, changeMaturityPct:{m:52,p25:40,p75:64}, scalabilityPct:{m:60,p25:48,p75:72}, aiReadinessPct:{m:58,p25:46,p75:72}},
             "10k+":{techMaturityPct:{m:64,p25:52,p75:76}, procMaturityPct:{m:58,p25:46,p75:70}, riskProb:{m:0.34,p25:0.24,p75:0.48}, feasibilityPct:{m:56,p25:44,p75:68}, changeMaturityPct:{m:56,p25:44,p75:68}, scalabilityPct:{m:64,p25:52,p75:76}, aiReadinessPct:{m:62,p25:50,p75:76}} },
  "–†–∏—Ç–µ–π–ª": {"1-2k":{techMaturityPct:{m:50,p25:38,p75:62}, procMaturityPct:{m:44,p25:32,p75:56}, riskProb:{m:0.30,p25:0.20,p75:0.42}, feasibilityPct:{m:64,p25:52,p75:76}, changeMaturityPct:{m:40,p25:28,p75:52}, scalabilityPct:{m:52,p25:40,p75:64}, aiReadinessPct:{m:46,p25:34,p75:60}},
           "2-10k":{techMaturityPct:{m:54,p25:42,p75:66}, procMaturityPct:{m:48,p25:36,p75:60}, riskProb:{m:0.32,p25:0.22,p75:0.44}, feasibilityPct:{m:62,p25:50,p75:74}, changeMaturityPct:{m:44,p25:32,p75:56}, scalabilityPct:{m:56,p25:44,p75:68}, aiReadinessPct:{m:50,p25:38,p75:64}},
           "10k+":{techMaturityPct:{m:58,p25:46,p75:70}, procMaturityPct:{m:52,p25:40,p75:64}, riskProb:{m:0.30,p25:0.20,p75:0.42}, feasibilityPct:{m:60,p25:48,p75:72}, changeMaturityPct:{m:48,p25:36,p75:60}, scalabilityPct:{m:60,p25:48,p75:72}, aiReadinessPct:{m:54,p25:42,p75:68}} },
  "–ì–æ—Å—Å–µ–∫—Ç–æ—Ä": {"1-2k":{techMaturityPct:{m:48,p25:36,p75:60}, procMaturityPct:{m:46,p25:34,p75:58}, riskProb:{m:0.42,p25:0.32,p75:0.56}, feasibilityPct:{m:58,p25:46,p75:70}, changeMaturityPct:{m:44,p25:32,p75:56}, scalabilityPct:{m:46,p25:34,p75:58}, aiReadinessPct:{m:38,p25:28,p75:52}},
             "2-10k":{techMaturityPct:{m:52,p25:40,p75:64}, procMaturityPct:{m:50,p25:38,p75:62}, riskProb:{m:0.44,p25:0.34,p75:0.58}, feasibilityPct:{m:56,p25:44,p75:68}, changeMaturityPct:{m:48,p25:36,p75:60}, scalabilityPct:{m:50,p25:38,p75:62}, aiReadinessPct:{m:40,p25:30,p75:54}},
             "10k+":{techMaturityPct:{m:56,p25:44,p75:68}, procMaturityPct:{m:54,p25:42,p75:66}, riskProb:{m:0.40,p25:0.30,p75:0.54}, feasibilityPct:{m:54,p25:42,p75:66}, changeMaturityPct:{m:52,p25:40,p75:64}, scalabilityPct:{m:52,p25:40,p75:64}, aiReadinessPct:{m:44,p25:32,p75:58}} },
  "–ò–¢/–ò–Ω—Ç–µ–≥—Ä–∞—Ç–æ—Ä—ã": {"1-2k":{techMaturityPct:{m:62,p25:50,p75:74}, procMaturityPct:{m:54,p25:42,p75:66}, riskProb:{m:0.28,p25:0.18,p75:0.40}, feasibilityPct:{m:66,p25:54,p75:78}, changeMaturityPct:{m:54,p25:42,p75:66}, scalabilityPct:{m:62,p25:50,p75:74}, aiReadinessPct:{m:60,p25:48,p75:74}},
                   "2-10k":{techMaturityPct:{m:66,p25:54,p75:78}, procMaturityPct:{m:58,p25:46,p75:70}, riskProb:{m:0.30,p25:0.20,p75:0.42}, feasibilityPct:{m:64,p25:52,p75:76}, changeMaturityPct:{m:58,p25:46,p75:70}, scalabilityPct:{m:66,p25:54,p75:78}, aiReadinessPct:{m:64,p25:52,p75:78}},
                   "10k+":{techMaturityPct:{m:70,p25:58,p75:82}, procMaturityPct:{m:62,p25:50,p75:74}, riskProb:{m:0.28,p25:0.18,p75:0.40}, feasibilityPct:{m:62,p25:50,p75:74}, changeMaturityPct:{m:62,p25:50,p75:74}, scalabilityPct:{m:70,p25:58,p75:82}, aiReadinessPct:{m:68,p25:56,p75:82}} }
};

const DEFAULT_BENCH = {
  techMaturityPct:{m:56,p25:44,p75:68},
  procMaturityPct:{m:52,p25:40,p75:64},
  riskProb:{m:0.34,p25:0.24,p75:0.48},
  feasibilityPct:{m:60,p25:48,p75:72},
  changeMaturityPct:{m:50,p25:38,p75:62},
  scalabilityPct:{m:56,p25:44,p75:68},
  aiReadinessPct:{m:50,p25:38,p75:64}
};

// Small deterministic jitter (so the same profile gives stable output inside range).
function stableJitter(seedStr, p25, p75){
  const s = seedStr.split("").reduce((a,c)=>a + c.charCodeAt(0), 0);
  const t = (Math.sin(s*999) + 1) / 2; // 0..1
  return p25 + (p75 - p25) * t;
}

// Estimate parameter value using: client input -> (optional) interview mapping -> benchmark.
function estimateParam(key, opts={}){
  const mode = (opts && opts.forceBenchHint) ? "bench" : (document.getElementById("benchMode")?.value || "mixed"); // mixed|client|bench
  const prof = getProfile();
  const bench = (BENCH_MATURITY[prof.industry] && BENCH_MATURITY[prof.industry][prof.bucket] && BENCH_MATURITY[prof.industry][prof.bucket][key])
    || (BENCH[prof.industry] && BENCH[prof.industry][prof.bucket] && BENCH[prof.industry][prof.bucket][key])
    || (BENCH_MATURITY["–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å"] && BENCH_MATURITY["–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å"][prof.bucket] && BENCH_MATURITY["–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å"][prof.bucket][key])
    || (BENCH["–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å"] && BENCH["–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å"][prof.bucket] && BENCH["–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å"][prof.bucket][key])
    || DEFAULT_BENCH[key];

  const el = document.getElementById(opts.elId || key);
  const raw = (el && ("value" in el)) ? String(el.value).trim() : "";
  const hasClient = raw !== "" && isFinite(+raw);

  // Benchmark base with stable jitter inside P25‚ÄìP75
  const benchVal = stableJitter(`${prof.industry}|${prof.bucket}|${prof.total}|${key}`, bench.p25, bench.p75);

  // Adjustments (lightweight, to avoid "one number for all")
  let adj = 0;
  if(key === "manualPct"){
    if(prof.branches >= 10) adj += 4;
    if(prof.vdi === "–î–∞") adj -= 2;
    if(prof.closed === "–î–∞") adj += 2;
  }
  if(key === "incidentsPerMonth"){
    if(prof.branches >= 10) adj += 3;
    if(prof.closed === "–î–∞") adj += 2;
  }
  if(key === "unusedPct"){
    if(prof.vdi === "–î–∞") adj += 2;
  }
  if(key === "obsoletePct"){
    if(prof.closed === "–î–∞") adj += 3;
  }
  const benchAdj = benchVal + adj;

  if(mode === "bench"){
    return {v:benchAdj, src:"bench", range:[bench.p25+adj, bench.p75+adj], prof};
  }

  if(mode === "client"){
    if(hasClient) return {v:+raw, src:"client", range:null, prof};
    return {v:NaN, src:"missing", range:null, prof};
  }

  // mixed
  if(hasClient) return {v:+raw, src:"client", range:bench ? [bench.p25+adj, bench.p75+adj] : null, prof};
  return {v:benchAdj, src:"bench", range:[bench.p25+adj, bench.p75+adj], prof};
}

// Confidence scoring: client=1.0, interview=0.6 (reserved), bench=0.35, missing=0
function srcWeight(src){
  if(src==="client") return 1.0;
  if(src==="interview") return 0.6;
  if(src==="bench") return 0.35;
  return 0.0;
}

let LAST_EST = {params:{}, confidence:{}, accuracy:0};

function formatRange(r){
  if(!r || !isFinite(r[0]) || !isFinite(r[1])) return "‚Äî";
  const a = Math.round(r[0]);
  const b = Math.round(r[1]);
  return `${a}‚Äì${b}`;
}

function updateDataAccuracyUI(){
  const pill = document.getElementById("dataAccuracyPill");
  const pill2 = document.getElementById("dataSourcesPill");
  if(pill){
    const a = Math.round(LAST_EST.accuracy || 0);
    pill.textContent = `–¢–æ—á–Ω–æ—Å—Ç—å –æ—Ç—á—ë—Ç–∞: ${isFinite(a)?a:0}%`;
  }
  if(pill2){
    const c = Object.values(LAST_EST.params||{}).filter(p=>p.src==="client").length;
    const b = Object.values(LAST_EST.params||{}).filter(p=>p.src==="bench").length;
    pill2.textContent = `–ò—Å—Ç–æ—á–Ω–∏–∫–∏: üü¢${c} / üîµ${b}`;
  }
}

function updateTopQuestions(){
  const ol = document.getElementById("topQuestions");
  if(!ol) return;

  // Information gain approximated by how much a missing param influences weighted PSI.
  const impact = [
    {key:"manualPct", label:"% —Ä—É—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –ò–¢ (–æ—Ü–µ–Ω–∫–∞)", gain:0.20+0.08},
    {key:"unusedPct", label:"% –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ –ü–û/–ª–∏—Ü–µ–Ω–∑–∏–π (–æ—Ü–µ–Ω–∫–∞)", gain:0.15},
    {key:"vmUnusedPct", label:"% –ø—Ä–æ—Å—Ç–∞–∏–≤–∞—é—â–∏—Ö VM/–≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ (–æ—Ü–µ–Ω–∫–∞)", gain:0.15},
    {key:"incidentsPerMonth", label:"–ò–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤ –≤ –º–µ—Å—è—Ü (—Å—Ä–µ–¥–Ω–µ–µ)", gain:0.20+0.08},
    {key:"downtimeHours", label:"–ß–∞—Å–æ–≤ –ø—Ä–æ—Å—Ç–æ—è –≤ –≥–æ–¥ (–æ—Ü–µ–Ω–∫–∞)", gain:0.20},
    {key:"downtimeCost", label:"–°—Ç–æ–∏–º–æ—Å—Ç—å —á–∞—Å–∞ –ø—Ä–æ—Å—Ç–æ—è (‚ÇΩ/—á–∞—Å)", gain:0.20},
    {key:"obsoletePct", label:"–î–æ–ª—è —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –û–°/–ü–û (%)", gain:0.10},
    {key:"keyPeopleRisk", label:"–ï—Å—Ç—å –ª–∏ ¬´–Ω–µ–∑–∞–º–µ–Ω–∏–º—ã–µ¬ª —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã? (–î–∞/–ù–µ—Ç)", gain:0.10},
    {key:"docScore", label:"–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (–ù–µ—Ç/–ß–∞—Å—Ç–∏—á–Ω–æ/–î–∞)", gain:0.10}
  ];

  const missing = impact
    .map(x=>({ ...x, src: LAST_EST.params?.[x.key]?.src || "missing" }))
    .filter(x=>x.src==="missing")
    .sort((a,b)=>b.gain-a.gain)
    .slice(0,5);

  ol.innerHTML = "";
  if(missing.length===0){
    const li=document.createElement("li");
    li.textContent="–í—Å–µ –∫–ª—é—á–µ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã —É–∂–µ –¥–∞–Ω—ã ‚Äî —Ç–æ—á–Ω–æ—Å—Ç—å –±–ª–∏–∑–∫–∞ –∫ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π.";
    ol.appendChild(li);
    return;
  }
  missing.forEach(x=>{
    const li=document.createElement("li");
    li.innerHTML = `<b>${x.label}</b> ‚Äî –ø–æ–≤—ã—Å–∏—Ç —Ç–æ—á–Ω–æ—Å—Ç—å –∏ –∫–∞—á–µ—Å—Ç–≤–æ –≤—ã–≤–æ–¥–∞ –ø–æ PSI (–≤–ª–∏—è–Ω–∏–µ: ~${Math.round(x.gain*100)}%).`;
    ol.appendChild(li);
  });
}

function paintStat(elId, pct, higherBetter=true){
  const el=document.getElementById(elId);
  el.classList.remove("good","warn","bad");
  if(!isFinite(pct)) return;
  if(higherBetter){
    if(pct>=75) el.classList.add("good");
    else if(pct>=45) el.classList.add("warn");
    else el.classList.add("bad");
  } else {
    if(pct<=25) el.classList.add("good");
    else if(pct<=55) el.classList.add("warn");
    else el.classList.add("bad");
  }
}
function paintRisk(score){
  const el=document.getElementById("kRisk");
  el.classList.remove("good","warn","bad");
  if(!isFinite(score)) return;
  if(score<=1) el.classList.add("good");
  else if(score<=3) el.classList.add("warn");
  else el.classList.add("bad");
}

function createScoreRow(tbody,item,type){
  const label = (typeof item==="string") ? item : (item?.label||"");
  const mode = (typeof item==="string") ? "both" : (item?.mode||"both");
  const tr=document.createElement("tr");
  tr.dataset.mode = mode;

  tr.innerHTML = `
    <td>
      <span class="statusDot dotRed maturityDot" style="margin-right:10px" title="–ü–æ–ª–µ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ"></span>
      ${label}
    </td>
    <td>
      <select class="${type}-score" data-origin="">
        ${type==="risk"
          ? `<option value="">‚Äî</option><option value="0">–ù–µ—Ç</option><option value="1">–î–∞</option>`
          : `<option value="">‚Äî</option><option value="0">–ù–µ—Ç</option><option value="1">–ß–∞—Å—Ç–∏—á–Ω–æ</option><option value="2">–î–∞</option>`
        }
      </select>
    </td>
    <td><input class="${type}-note" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–ø–æ –∂–µ–ª–∞–Ω–∏—é)"></td>
  `;
  tbody.appendChild(tr);

  // dot behavior: red(empty) / green(user) / blue(synthetic)
  const dot = tr.querySelector(".maturityDot");
  const sel = tr.querySelector("select");
  const updateDot = ()=>{
    if(!dot || !sel) return;
    const v = (sel.value ?? "").toString().trim();
    if(!v){
      dot.classList.remove("dotBlue","dotGreen");
      dot.classList.add("dotRed");
      dot.title = "–ü–æ–ª–µ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ";
      return;
    }
    const synthetic = (sel.dataset.synthetic === "1") || (sel.dataset.origin === "synthetic");
    dot.classList.remove("dotRed","dotBlue","dotGreen");
    dot.classList.add(synthetic ? "dotBlue" : "dotGreen");
    dot.title = synthetic ? "–°–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ (–º–æ–∂–Ω–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å)" : "–ó–∞–ø–æ–ª–Ω–µ–Ω–æ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º";
  };

  // user edit -> user origin, clear synthetic
  sel.addEventListener("change", ()=>{
    sel.dataset.origin = "user";
    if(sel.dataset.synthetic === "1") delete sel.dataset.synthetic;
    updateDot();
  }, {passive:true});

  updateDot();
}

function ensureBaseTables(){
  const techTb=document.getElementById("techTbody");
  const procTb=document.getElementById("procTbody");
  const riskTb=document.getElementById("riskTbody");
  techTb.innerHTML=""; procTb.innerHTML=""; riskTb.innerHTML="";
  TECH.forEach(x=>createScoreRow(techTb,x,"tech"));
  PROC.forEach(x=>createScoreRow(procTb,x,"proc"));
  RISK.forEach(x=>createScoreRow(riskTb,x,"risk"));
}

function addReqRow(data){
  const tb=document.getElementById("reqTbody");
  const idx=tb.children.length+1;
  const feasOptions = FEAS_OPTIONS.map(o=>`<option value="${o.label}">${o.label}</option>`).join("");
  const tr=document.createElement("tr");
  tr.innerHTML = `
    <td class="right mono">${idx}</td>
    <td><textarea class="req-owner" placeholder="–ë–∏–∑–Ω–µ—Å –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å / –∑–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ?"></textarea></td>
    <td><textarea class="req-text" placeholder="–ß—Ç–æ –∏–º–µ–Ω–Ω–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–æ/–ø–æ–∫–∞–∑–∞–Ω–æ –Ω–∞ –ø–∏–ª–æ—Ç–µ?"></textarea></td>
    <td>
      <select class="req-type">
        <option>–¢–µ—Ö</option><option>–ò–ë</option><option>–ë–∏–∑–Ω–µ—Å</option><option>–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</option><option>–û—Ç—á–µ—Ç—ã</option>
      </select>
    </td>
    <td>
      <select class="req-must"><option value="–î–∞">–î–∞</option><option value="–ù–µ—Ç">–ù–µ—Ç</option></select>
    </td>
    <td><select class="req-feas">${feasOptions}</select></td>
    <td><textarea class="req-metric" placeholder="–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä—è–µ–º? (–º–µ—Ç—Ä–∏–∫–∞/–æ—Ç—á–µ—Ç/—Å–∫—Ä–∏–Ω)"></textarea></td>
  `;
  tb.appendChild(tr);

  if(data){
    tr.querySelector(".req-text").value = data.text || "";
    tr.querySelector(".req-type").value = data.type || "–¢–µ—Ö";
    tr.querySelector(".req-must").value = data.must || "–î–∞";
    tr.querySelector(".req-feas").value = data.feas || "‚Äî";
    tr.querySelector(".req-metric").value = data.metric || "";
    tr.querySelector(".req-owner").value = data.owner || "";
  }

  tr.querySelectorAll("input,select,textarea").forEach(el=>{
    el.addEventListener("input", debounce(recalc,120));
    el.addEventListener("change", recalc);
  });
  recalc();
}


const PROD_FEAS_OPTIONS = [
  { label: "‚Äî", score: null },
  { label: "–ü–æ–ª–Ω–æ—Å—Ç—å—é", score: 1.00 },
  { label: "–ß–∞—Å—Ç–∏—á–Ω–æ", score: 0.60 },
  { label: "–ù–µ—Ç", score: 0.00 },
  { label: "–•–∞—Ä–¥ –∫–æ–¥ (–°–∫–æ—Ä–æ)", score: 0.70 },
  { label: "–•–∞—Ä–¥ –∫–æ–¥ (—Å–∫–æ—Ä–æ)", score: 0.70 },
  { label: "–•–∞—Ä–¥ –∫–æ–¥ (–Ω–µ —Å–∫–æ—Ä–æ)", score: 0.30 },
  { label: "–¢—Ä–µ–±—É–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç", score: 0.50 },
];

function addProdReqRow(data){
  const tb=document.getElementById("prodReqTbody");
  if(!tb) return;
  const idx=tb.children.length+1;
  const feasOptions = PROD_FEAS_OPTIONS.map(o=>`<option value="${o.label}">${o.label}</option>`).join("");
  const tr=document.createElement("tr");
  tr.innerHTML = `
    <td class="right mono">${idx}</td>
    <td><textarea class="prod-biz" placeholder="–ó–∞—á–µ–º –±–∏–∑–Ω–µ—Å—É? –∫–∞–∫—É—é —Ü–µ–Ω–Ω–æ—Å—Ç—å –¥–∞—ë—Ç?"></textarea></td>
    <td><textarea class="prod-func" placeholder="–ß—Ç–æ –∏–º–µ–Ω–Ω–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ –ø—Ä–æ–¥—É–∫—Ç–µ?"></textarea></td>
    <td>
      <select class="prod-type">
        <option>–¢–µ—Ö</option><option>–ò–ë</option><option>–ë–∏–∑–Ω–µ—Å</option><option>–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</option><option>–û—Ç—á–µ—Ç—ã</option>
      </select>
    </td>
    <td>
      <select class="prod-must"><option value="–î–∞">–î–∞</option><option value="–ù–µ—Ç">–ù–µ—Ç</option></select>
    </td>
    <td><select class="prod-feas">${feasOptions}</select></td>
  `;
  tb.appendChild(tr);

  if(data){
    tr.querySelector(".prod-biz").value = data.biz || data.owner || "";
    tr.querySelector(".prod-func").value = data.func || data.text || "";
    tr.querySelector(".prod-type").value = data.type || "–¢–µ—Ö";
    tr.querySelector(".prod-must").value = data.must || "–î–∞";
    tr.querySelector(".prod-feas").value = data.feas || "‚Äî";
  }

  tr.querySelectorAll("input,select,textarea").forEach(el=>{
    el.addEventListener("input", debounce(recalc,120));
    el.addEventListener("change", recalc);
  });
  recalc();
}

function addPsiRow(data){
  const tb=document.getElementById("psiTbody");
  const idx=tb.children.length+1;
  const tr=document.createElement("tr");
  tr.innerHTML = `
    <td class="right mono">${idx}</td>
    <td><textarea class="psi-req" placeholder="–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ / —á—Ç–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º?"></textarea></td>
    <td><textarea class="psi-scn" placeholder="–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º? (—Ñ—É–Ω–∫—Ü–∏—è/—Å—Ü–µ–Ω–∞—Ä–∏–π)"></textarea></td>
    <td><textarea class="psi-exp" placeholder="–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç"></textarea></td>
    <td><textarea class="psi-act" placeholder="–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç"></textarea></td>
    <td>
      <select class="psi-ok"><option value="">‚Äî</option><option value="–î–∞">–î–∞</option><option value="–ù–µ—Ç">–ù–µ—Ç</option></select>
    </td>
    <td>
      <select class="psi-acc"><option value="">‚Äî</option><option value="–î–∞">–î–∞</option><option value="–ù–µ—Ç">–ù–µ—Ç</option></select>
    </td>
    <td><textarea class="psi-note" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π/–∑–∞–º–µ—á–∞–Ω–∏—è"></textarea></td>
  `;
  tb.appendChild(tr);

  if(data){
    tr.querySelector(".psi-req").value = data.req || "";
    tr.querySelector(".psi-scn").value = data.scn || "";
    tr.querySelector(".psi-exp").value = data.exp || "";
    tr.querySelector(".psi-act").value = data.act || "";
    tr.querySelector(".psi-ok").value = data.ok || "";
    tr.querySelector(".psi-acc").value = data.acc || "";
    tr.querySelector(".psi-note").value = data.note || "";
  }
  tr.querySelectorAll("input,select,textarea").forEach(el=>{
    el.addEventListener("input", debounce(recalc,120));
    el.addEventListener("change", recalc);
  });
  recalc();
}


function painLevelLabel(pct){
  if(!isFinite(pct)) return "‚Äî";
  if(pct >= 75) return "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ";
  if(pct >= 50) return "–í—ã—Å–æ–∫–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ";
  if(pct >= 25) return "–°—Ä–µ–¥–Ω–µ–µ –¥–∞–≤–ª–µ–Ω–∏–µ";
  return "–ù–∏–∑–∫–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ";
}
function readinessLabel(pct){
  if(!isFinite(pct)) return "‚Äî";
  if(pct >= 90) return "–ì–æ—Ç–æ–≤ –∫ –ü–°–ò";
  if(pct >= 70) return "–ì–æ—Ç–æ–≤";
  if(pct >= 40) return "–£—Å–ª–æ–≤–Ω–æ –≥–æ—Ç–æ–≤";
  return "–ù–µ –≥–æ—Ç–æ–≤";
}
function probabilityLabel(pct){
  if(!isFinite(pct)) return "‚Äî";
  if(pct >= 80) return "–ü–æ—á—Ç–∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ";
  if(pct >= 60) return "–í—ã—Å–æ–∫–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å";
  if(pct >= 30) return "–°—Ä–µ–¥–Ω—è—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å";
  return "–ù–∏–∑–∫–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å";
}


function computePSIFromDom(){
  // Robust PSI fallback: compute from already-rendered KPI values so PSI never stays "‚Äî%"
  const numFromEl = (id)=>{
    const el=document.getElementById(id);
    if(!el) return NaN;
    const t=(el.textContent||"").replace("%","").replace(/\s+/g," ").trim();
    const n=parseFloat(t.replace(",","."));
    return Number.isFinite(n)?n:NaN;
  };
  const tech=numFromEl("techIndex");
  const proc=numFromEl("procIndex");
  const recover=numFromEl("recoverIndex");
  const bus=numFromEl("busIndex");
  const obsol=numFromEl("obsolIndex");
  const ai=numFromEl("aiIndex");

  // If we have at least tech/proc, compute; otherwise leave as ‚Äî
  const parts=[
    {v:tech, w:0.30},   // proxy for "control" and tech maturity
    {v:proc, w:0.20},   // process maturity
    {v:recover, w:0.15},
    {v:bus, w:0.10},
    {v:obsol, w:0.10},
    {v:ai, w:0.15},
  ];
  const valid=parts.filter(p=>Number.isFinite(p.v) && p.w>0);
  if(!valid.length){ return NaN; }
  const sumW=valid.reduce((a,p)=>a+p.w,0);
  let psi=valid.reduce((a,p)=>a+p.v*p.w,0)/sumW;
  psi=Math.round(clamp(psi,0,100));
  const scoreEl=document.getElementById("psi2Score");
  const labelEl=document.getElementById("psi2Label");
  if(scoreEl) scoreEl.textContent = `${psi}%`;
  if(labelEl) labelEl.textContent = (psi>=75 ? "–ó–µ–ª—ë–Ω–∞—è –∑–æ–Ω–∞" : (psi>=45 ? "–ñ—ë–ª—Ç–∞—è –∑–æ–Ω–∞" : "–ö—Ä–∞—Å–Ω–∞—è –∑–æ–Ω–∞"));
  try{ paintStat("kPSI", psi, true); }catch(_e){}
  return psi;
}


/* ===== Quick interview: synthetic defaults for hidden (deep) fields ===== */
function applyQuickSynthetics(){
  const mode = document.getElementById("interviewMode")?.value || "quick";
  const isQuick = (mode === "quick");

  // Helpers for maturity tables
  const setRowScoreByLabel = (tbodyId, labelStartsWith, val)=>{
    const tb = document.getElementById(tbodyId);
    if(!tb) return;
    const rows = [...tb.querySelectorAll("tr")];
    const tr = rows.find(r=>{
      const td = r.querySelector("td");
      const txt = (td?.innerText || "").replace(/\s+/g," ").trim();
      return txt.startsWith(labelStartsWith);
    });
    if(!tr) return;
    const sel = tr.querySelector("select");
    if(!sel) return;
    const cur = (sel.value ?? "").trim();
    if(cur !== "" && cur !== "0" && sel.dataset.synthetic !== "1") return;
    sel.value = String(val);
    sel.dataset.synthetic = "1";
    sel.dataset.origin = "synthetic";
  };

  // In QUICK mode: default all hidden deep maturity rows to 0 unless user filled
  if(isQuick){
    ["techTbody","procTbody","riskTbody"].forEach(tbid=>{
      const tb=document.getElementById(tbid);
      if(!tb) return;
      tb.querySelectorAll("tr").forEach(tr=>{
        if(tr.dataset.mode !== "deep") return;
        const sel = tr.querySelector("select");
        if(!sel) return;
        const cur = (sel.value ?? "").trim();
        if(cur !== "" && cur !== "0" && sel.dataset.synthetic !== "1") return;
        sel.value = "0";
        sel.dataset.synthetic = "1";
        sel.dataset.origin = "synthetic";
      });
    });
  }

  // Read passport values for synthetic logic
  const workplaces = Number(document.getElementById("workplaces")?.value || 0);
  const servers = Number(document.getElementById("servers")?.value || 0);
  const endpoints = Math.max(0, workplaces + servers);
  const branches = Number(document.getElementById("branches")?.value || 0);

  // Infrastructure synthetic defaults
  const setSynthSelect = (id, v)=>{
    const el = document.getElementById(id);
    if(!el) return;
    const cur = (el.value ?? "").toString().trim();
    if(cur !== "" && el.dataset.synthetic !== "1") return;
    el.value = v;
    el.dataset.synthetic = "1";
    el.dataset.origin = "synthetic";
  };
  setSynthSelect("hostingModel", "On‚Äëprem");
  setSynthSelect("netSeg", "Prod/Test/Dev –†–∞–∑–¥–µ–ª–µ–Ω—ã");

  // Risk synthetics (as requested)
  setRowScoreByLabel("riskTbody", "–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–∞—è", branches > 1 ? 1 : 0);
  setRowScoreByLabel("riskTbody", "–ü–∞—Ä–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –±—ã—Å—Ç—Ä–æ —Ä–∞—Å—Ç–µ—Ç/–º–µ–Ω—è–µ—Ç—Å—è", 0);
  setRowScoreByLabel("riskTbody", "–ü–ª–∞–Ω–∏—Ä—É—é—Ç—Å—è –∫—Ä—É–ø–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã", endpoints > 5000 ? 1 : 0);
  setRowScoreByLabel("riskTbody", "–í—ã—Å–æ–∫–∞—è —Ç–µ–∫—É—á–µ—Å—Ç—å –ò–¢-–ø–µ—Ä—Å–æ–Ω–∞–ª–∞", 0);

  // Finance synthetic defaults
  const setSynthField = (id, v)=>{
    const el = document.getElementById(id);
    if(!el) return;
    const cur = (el.value ?? "").toString().trim();
    if(cur !== "" && cur !== "0" && el.dataset.synthetic !== "1") return;
    el.value = String(v);
    el.dataset.synthetic = "1";
    el.dataset.origin = "synthetic";
  };
  setSynthField("salary", 300000);
  setSynthField("manualPct", 20);
  setSynthField("unusedPct", 10);
  setSynthField("vmUnusedPct", 10);
  setSynthField("downtimeHours", 120);
  setSynthField("downtimeCost", 150000);
  setSynthField("incidentsPerMonth", 4);
  setSynthField("obsoletePct", 15);

  setSynthSelect("serviceDesk", "–î–∞");
  setSynthSelect("keyPeopleRisk", "–î–∞");

  // Endpoint budgets synthetic mapping (SW/HW) using provided table
  const virtStr = (document.getElementById("virt")?.value || "").toString();
  const hasVirt = virtStr && !virtStr.includes("–ù–µ—Ç");
  const band = (n)=>{
    if(n>=20000) return "20000+";
    if(n>=5000) return "5000-20000";
    if(n>=1000) return "1000-5000";
    return "100-1000";
  };
  const COSTS = {
    "100-1000":   { noVirt:{sw:17000, hw:37000}, virt:{sw:19040, hw:31450} },
    "1000-5000":  { noVirt:{sw:15300, hw:33300}, virt:{sw:17136, hw:28305} },
    "5000-20000": { noVirt:{sw:13600, hw:29600}, virt:{sw:15232, hw:25160} },
    "20000+":     { noVirt:{sw:11900, hw:25900}, virt:{sw:13328, hw:22015} }
  };
  const b = band(endpoints);
  const c = (COSTS[b] || COSTS["100-1000"])[hasVirt ? "virt" : "noVirt"];
  setSynthField("licBudget", Math.round(endpoints * c.sw));
  setSynthField("hwBudget", Math.round(endpoints * c.hw));
}

/* ===== Synthetic marker UX: blue dot + auto-clear on manual edits ===== */
function applySyntheticTitles(){
  document.querySelectorAll('input[data-synthetic="1"], select[data-synthetic="1"], textarea[data-synthetic="1"]').forEach(el=>{
    if(!el.title) el.title = "–°–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ (–±—ã—Å—Ç—Ä–æ–µ –∏–Ω—Ç–µ—Ä–≤—å—é). –ò–∑–º–µ–Ω–∏—Ç–µ –≤—Ä—É—á–Ω—É—é ‚Äî –º–µ—Ç–∫–∞ –∏—Å—á–µ–∑–Ω–µ—Ç.";
  });
}

// Clear marker once user changes value manually
function installSyntheticAutoClear(){
  const clear = (el)=>{
    if(!el || !el.dataset) return;
    if(el.dataset.synthetic === "1"){
      delete el.dataset.synthetic;
      el.title = "";
    }
  };
  document.addEventListener("input", (e)=>clear(e.target), true);
  document.addEventListener("change", (e)=>clear(e.target), true);
}
installSyntheticAutoClear();

// Ensure titles are applied after quick synthetics
try{
  const __origApplyQuickSynthetics = applyQuickSynthetics;
  applyQuickSynthetics = function(){
    __origApplyQuickSynthetics();
    applySyntheticTitles();
  };
}catch(_e){}


// If user edits a field we previously filled synthetically ‚Äî stop treating it as synthetic.
document.addEventListener("input",(e)=>{
  const t = e.target;
  if(t && t.dataset && t.dataset.synthetic === "1"){
    t.dataset.synthetic = "0";
  }
},{capture:true});
/* ====================================================================== */

function recalc(){
  console.log("recalc() clicked", new Date().toISOString());
  try{ applyQuickSynthetics(); }catch(e){}


// maturity indices (with benchmark fallback)
const techSel=[...document.querySelectorAll(".tech-score")];
const procSel=[...document.querySelectorAll(".proc-score")];
const riskSel=[...document.querySelectorAll(".risk-score")];

const techAnswered=techSel.filter(s=>String(s.value).trim()!=="").map(s=>clampInt(s.value,0,2));
const procAnswered=procSel.filter(s=>String(s.value).trim()!=="").map(s=>clampInt(s.value,0,2));
const riskAnswered=riskSel.filter(s=>String(s.value).trim()!=="").map(s=>clampInt(s.value,0,1));
const riskScores = riskAnswered;

const modeTop = (document.getElementById("benchMode")?.value || "mixed"); // mixed|client|bench

// benchmark-based fallbacks for maturity/risk (segment-aware)
const estM = {};
estM.techMaturityPct = estimateParam("techMaturityPct", {elId:"__none__"});
estM.procMaturityPct = estimateParam("procMaturityPct", {elId:"__none__"});
estM.riskProb = estimateParam("riskProb", {elId:"__none__"});

const techIndex = (techAnswered.length>0)
  ? Math.round((avg(techAnswered)/2)*100)
  : (modeTop==="client" ? NaN : Math.round(estM.techMaturityPct.v));

const procIndex = (procAnswered.length>0)
  ? Math.round((avg(procAnswered)/2)*100)
  : (modeTop==="client" ? NaN : Math.round(estM.procMaturityPct.v));

const riskIndex = (riskAnswered.length>0)
  ? riskAnswered.reduce((a,b)=>a+b,0)
  : (modeTop==="client" ? NaN : Math.round(clamp(estM.riskProb.v,0,1)*riskSel.length));

  document.getElementById("techIndex").textContent = isFinite(techIndex)? `${techIndex}%` : "‚Äî%";
  document.getElementById("procIndex").textContent = isFinite(procIndex)? `${procIndex}%` : "‚Äî%";
  document.getElementById("riskIndex").textContent = isFinite(riskIndex)? `${riskIndex}` : "‚Äî";

  paintStat("kTech", techIndex, true);
  paintStat("kProc", procIndex, true);
  paintRisk(riskIndex);

  // ===== Data estimation (client + benchmark) =====
  const est = {};
  est.manualPct = estimateParam("manualPct", {elId:"manualPct"});
  est.unusedPct = estimateParam("unusedPct", {elId:"unusedPct"});
  est.vmUnusedPct = estimateParam("vmUnusedPct", {elId:"vmUnusedPct"});
  est.downtimeHours = estimateParam("downtimeHours", {elId:"downtimeHours"});
  est.downtimeCost = estimateParam("downtimeCost", {elId:"downtimeCost"});
  est.incidentsPerMonth = estimateParam("incidentsPerMonth", {elId:"incidentsPerMonth"});
  est.obsoletePct = estimateParam("obsoletePct", {elId:"obsoletePct"});
  est.keyPeopleRisk = estimateParam("keyPeopleRisk", {elId:"keyPeopleRisk"});
  est.docScore = estimateParam("docScore", {elId:"docScore"});

  // store last estimates for UI + modal
  LAST_EST.params = est;

  // overall accuracy proxy (0..100)
  const accKeys = ["manualPct","unusedPct","vmUnusedPct","downtimeHours","downtimeCost","incidentsPerMonth","obsoletePct","keyPeopleRisk","docScore"];
  const acc = accKeys.reduce((a,k)=>a + srcWeight(est[k]?.src||"missing"),0) / accKeys.length;
  LAST_EST.accuracy = Math.round(acc*100);

  updateDataAccuracyUI();
  updateTopQuestions();

  // Cost of inaction
  const salary=+document.getElementById("salary").value||0;
  const itCount=+document.getElementById("itCount").value||0;
  const manualPct=(isFinite(est.manualPct.v)?est.manualPct.v:0)/100;
  const licBudget=+document.getElementById("licBudget").value||0;
  const unusedPct=(isFinite(est.unusedPct.v)?est.unusedPct.v:0)/100;
  const downtimeHours=isFinite(est.downtimeHours.v)?est.downtimeHours.v:0;
  const downtimeCost=isFinite(est.downtimeCost.v)?est.downtimeCost.v:0;

  const lossManual=salary*12*itCount*manualPct;
  const lossUnused=licBudget*unusedPct;
  const lossDowntime=downtimeHours*downtimeCost;
  const lossTotal=lossManual+lossUnused+lossDowntime;

  document.getElementById("coiTotal").textContent = fmtMoney(lossTotal);
  document.getElementById("coiBreakdown").textContent =
    `–†—É—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏: ${fmtMoney(lossManual)} ¬∑ –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–µ –ü–û: ${fmtMoney(lossUnused)} ¬∑ –ü—Ä–æ—Å—Ç–æ–∏: ${fmtMoney(lossDowntime)}`;
  paintStat("kCoI", lossTotal>0 ? 10 : NaN, false); // just adds outline if filled

  // Feasibility from requirements
  const reqRows=[...document.querySelectorAll("#reqTbody tr")];
  const feasVals=[];
  let totalReq=0, mustReq=0;
  reqRows.forEach(r=>{
    const text=(r.querySelector(".req-text")?.value||"").trim();
    if(!text) return;
    totalReq += 1;
    const must = r.querySelector(".req-must")?.value || "–î–∞";
    if(must==="–î–∞") mustReq += 1;
    const feas = r.querySelector(".req-feas")?.value || "‚Äî";
    const opt = FEAS_OPTIONS.find(o=>o.label===feas);
    if(opt && typeof opt.score === "number") feasVals.push(opt.score);
  });
  const estFeas = estimateParam("feasibilityPct", {elId:"__none__"});
  const feasPct = feasVals.length ? Math.round(avg(feasVals)*100) : ((modeTop==="client")?NaN:Math.round(estFeas.v));
  document.getElementById("feasScore").textContent = isFinite(feasPct) ? `${feasPct}%` : "‚Äî%";
  paintStat("kFeas", isFinite(feasPct)?feasPct:NaN, true);

  // Product requirements feasibility (section 6)
  const prodReqRows=[...document.querySelectorAll("#prodReqTbody tr")];
  const prodFeasVals=[];
  prodReqRows.forEach(r=>{
    const func=(r.querySelector(".prod-func")?.value||"").trim();
    const biz=(r.querySelector(".prod-biz")?.value||"").trim();
    if(!func && !biz) return;
    const feas = r.querySelector(".prod-feas")?.value || "‚Äî";
    const opt = PROD_FEAS_OPTIONS.find(o=>o.label===feas);
    if(opt && typeof opt.score === "number") prodFeasVals.push(opt.score);
  });
  const prodFeasPct = prodFeasVals.length ? Math.round(avg(prodFeasVals)*100) : NaN;
  const prodEl=document.getElementById("prodFeasScore");
  if(prodEl) prodEl.textContent = isFinite(prodFeasPct) ? `${prodFeasPct}%` : "‚Äî%";
  if(document.getElementById("kProdFeas")) paintStat("kProdFeas", isFinite(prodFeasPct)?prodFeasPct:NaN, true);

  // ----- Criticality & client summary -----
  const maturityAvg = Math.round((techIndex + procIndex) / 2);
  const crit = computeCriticality(lossTotal, riskIndex, maturityAvg);
  const critLbl = criticalityLabel(crit);

  const critScoreEl=document.getElementById("critScore"); if(critScoreEl) critScoreEl.textContent = isFinite(crit) ? (crit + "%") : "‚Äî%";
  const critLabelEl=document.getElementById("critLabel"); if(critLabelEl) critLabelEl.textContent = critLbl;

  const mLvl = maturityLevel(maturityAvg);
  const coiText = fmtMoney(lossTotal);
  const maturityLevelTextEl=document.getElementById("maturityLevelText"); if(maturityLevelTextEl) maturityLevelTextEl.value = mLvl;
  const critLabelClientEl=document.getElementById("critLabelClient"); if(critLabelClientEl) critLabelClientEl.value = critLbl;
  const coiClientEl=document.getElementById("coiClient"); if(coiClientEl) coiClientEl.value = coiText;
  const clientOneLinerEl=document.getElementById("clientOneLiner"); if(clientOneLinerEl) clientOneLinerEl.value = `–ó—Ä–µ–ª–æ—Å—Ç—å: ${mLvl}. –ü–æ—Ç–µ—Ä–∏: ${coiText}/–≥–æ–¥. –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${critLbl}.`;

  try{
// ----- Project risks table (internal control) -----
  const risks = [];
  risks.push({name:"–ó—Ä–µ–ª–æ—Å—Ç—å", cond:"–°—Ä–µ–¥–Ω—è—è –∑—Ä–µ–ª–æ—Å—Ç—å < 40%", hit: maturityAvg < 40, note:`–°–µ–π—á–∞—Å: ${maturityAvg}%`});
  risks.push({name:"–†–∏—Å–∫-–ø—Ä–æ—Ñ–∏–ª—å", cond:"–ò–Ω–¥–µ–∫—Å —Ä–∏—Å–∫–∞ ‚â• 3", hit: riskIndex >= 3, note:`–°–µ–π—á–∞—Å: ${riskIndex}`});
  risks.push({name:"–†–µ–∞–ª–∏–∑—É–µ–º–æ—Å—Ç—å", cond:"–ò–Ω–¥–µ–∫—Å —Ä–µ–∞–ª–∏–∑—É–µ–º–æ—Å—Ç–∏ < 60%", hit: isFinite(feasPct) ? (feasPct < 60) : true, note:`–°–µ–π—á–∞—Å: ${isFinite(feasPct)?feasPct:"‚Äî"}%`});
  const reqFilled = [...document.querySelectorAll("#reqTbody tr")].some(r=> (r.querySelector(".req-text")?.value||"").trim());
  risks.push({name:"–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è", cond:"–ù–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π", hit: !reqFilled, note: reqFilled ? "OK" : "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ä–µ–µ—Å—Ç—Ä —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π"});
  const hasLpr = ((document.getElementById("lpr")?.value||"").trim().length > 0);
  risks.push({name:"–õ–ü–†", cond:"–ù–µ —É–∫–∞–∑–∞–Ω –õ–ü–†/–∫–æ–Ω—Ç–∞–∫—Ç", hit: !hasLpr, note: hasLpr ? "OK" : "–£–∫–∞–∂–∏—Ç–µ –õ–ü–†"});

  const hitCount = risks.filter(r=>r.hit).length;
  const riskLevel = hitCount >= 3 ? "–í—ã—Å–æ–∫–∏–π" : (hitCount === 2 ? "–°—Ä–µ–¥–Ω–∏–π" : "–ù–∏–∑–∫–∏–π");
  const riskLevelEl = document.getElementById("riskLevelText");
  if(riskLevelEl) riskLevelEl.value = `${riskLevel} (—Ç—Ä–∏–≥–≥–µ—Ä–æ–≤: ${hitCount})`;

  const tb = document.getElementById("projectRisks");
  if(tb){
    tb.innerHTML = "";
    risks.forEach(r=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `<td><b>${r.name}</b></td><td>${r.cond}</td><td>${r.hit ? "‚ö†Ô∏è –ï—Å—Ç—å —Ä–∏—Å–∫" : "‚úÖ –û–ö"}</td><td>${r.note||""}</td>`;
      tb.appendChild(tr);
    });
  }


  // ----- Indices: Pain / Readiness / Deal probability -----
  const projCostBase = ( (+document.getElementById("workplaces")?.value||0) + (+document.getElementById("servers")?.value||0) ) * 1300;
  const capPain = projCostBase > 0 ? projCostBase : 5_000_000;
  const painScore = ((lossTotal/capPain)*0.6) + (manualPct*0.2) + ((lossDowntime/capPain)*0.2);
  const painPct = Math.round(clamp(painScore, 0, 2) * 50); // 0..100
  document.getElementById("painIndex").textContent = isFinite(painPct) ? `${painPct}%` : "‚Äî%";
  document.getElementById("painLabel").textContent = painLevelLabel(painPct);
  paintStat("kPain", isFinite(painPct)?painPct:NaN, true);

  const missingNow = validateRequired();
  const hasCompany = !missingNow.includes("–ö–æ–º–ø–∞–Ω–∏—è");
  const hasSources = ((document.getElementById("sources")?.value||"").trim().length > 0);
  const hasReq = reqFilled;
  const hasPsi2 = !missingNow.some(x=>x.startsWith("–ü–°–ò:"));
  const feasOk = isFinite(feasPct) ? (feasPct >= 50) : false;
  const riskOk = riskIndex <= 3;
  const readinessParts = [hasCompany, hasSources, hasReq, hasPsi2, feasOk, riskOk];
  const readyPct = Math.round(100 * (readinessParts.filter(Boolean).length / readinessParts.length));
  document.getElementById("readyIndex").textContent = isFinite(readyPct) ? `${readyPct}%` : "‚Äî%";
  document.getElementById("readyLabel").textContent = readinessLabel(readyPct);
  paintStat("kReady", isFinite(readyPct)?readyPct:NaN, true);

  const riskNorm = clamp(riskIndex/5, 0, 1);
  const prob = ( (isFinite(feasPct)?feasPct/100:0) * 0.35 ) +
               ( (1 - riskNorm) * 0.25 ) +
               ( (isFinite(painPct)?painPct/100:0) * 0.25 ) +
               ( (isFinite(procIndex)?procIndex/100:0) * 0.15 );
  const probPct = Math.round(clamp(prob, 0, 1) * 100);
  document.getElementById("probIndex").textContent = isFinite(probPct) ? `${probPct}%` : "‚Äî%";
  document.getElementById("probLabel").textContent = probabilityLabel(probPct);
  paintStat("kProb", isFinite(probPct)?probPct:NaN, true);

  // ===== Additional indices (PSI 2.0) =====
  const vmUnusedPct = (+document.getElementById("vmUnusedPct")?.value || 0);
  const keyPeopleRiskStr = (document.getElementById("keyPeopleRisk")?.value || "");
  let keyPeopleRisk = keyPeopleRiskStr === "–î–∞" ? 1 : (keyPeopleRiskStr === "–ù–µ—Ç" ? 0 : NaN);
  if(!isFinite(keyPeopleRisk) && isFinite(est.keyPeopleRisk.v)) keyPeopleRisk = est.keyPeopleRisk.v >= 0.5 ? 1 : 0;
  const docScoreRaw = (document.getElementById("docScore")?.value || "").trim();
  let docScore = docScoreRaw==="" ? NaN : clampInt(docScoreRaw, 0, 2);
  if(!isFinite(docScore) && isFinite(est.docScore.v)) docScore = clampInt(String(Math.round(est.docScore.v)), 0, 2);
  const obsoletePct = isFinite(est.obsoletePct.v)?est.obsoletePct.v:(+document.getElementById("obsoletePct")?.value || 0);

  // Recoverable Budget Index (licenses + VM) ‚Äî higher is better
  const L = clamp((isFinite(est.unusedPct.v)?est.unusedPct.v:(+document.getElementById("unusedPct").value || 0))/100, 0, 1);
  const V = clamp((isFinite(est.vmUnusedPct.v)?est.vmUnusedPct.v:vmUnusedPct)/100, 0, 1);
  const L_norm = clamp(L/0.25, 0, 1);
  const V_norm = clamp(V/0.30, 0, 1);
  let recover = 100 * (1 - (0.6*L_norm + 0.4*V_norm));
  recover = Math.round(clamp(recover, 0, 100));
  document.getElementById("recoverIndex").textContent = isFinite(recover) ? `${recover}%` : "‚Äî%";
  document.getElementById("recoverLabel").textContent = recover>=75 ? "–í—ã—Å–æ–∫–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª" : (recover>=45 ? "–°—Ä–µ–¥–Ω–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª" : "–ù–∏–∑–∫–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª");
  paintStat("kRecover", isFinite(recover)?recover:NaN, true);

  // Bus-factor Index ‚Äî higher is better
  let bus = NaN;
  if(isFinite(keyPeopleRisk)) {
    bus = 100 - (keyPeopleRisk*40 + (2 - docScore)*20);
    bus = Math.round(clamp(bus, 0, 100));
  }
  document.getElementById("busIndex").textContent = isFinite(bus) ? `${bus}%` : "‚Äî%";
  document.getElementById("busLabel").textContent = isFinite(bus) ? (bus>=75 ? "–ù–∏–∑–∫–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å" : (bus>=45 ? "–°—Ä–µ–¥–Ω—è—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å" : "–í—ã—Å–æ–∫–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å")) : "‚Äî";
  paintStat("kBus", isFinite(bus)?bus:NaN, true);

  // Tech Obsolescence Index ‚Äî higher is better
  const ageSel = (document.getElementById("hwAge")?.value || "");
  const ageFactor = (ageSel==="–¥–æ 3 –ª–µ—Ç") ? 10 : (ageSel==="3‚Äì5 –ª–µ—Ç" ? 25 : (ageSel==="5+ –ª–µ—Ç" ? 45 : 0));
  let obsol = 100 - (clamp(obsoletePct,0,100)*1.2 + ageFactor);
  obsol = Math.round(clamp(obsol, 0, 100));
  document.getElementById("obsolIndex").textContent = isFinite(obsol) ? `${obsol}%` : "‚Äî%";
  document.getElementById("obsolLabel").textContent = obsol>=75 ? "–û–ö" : (obsol>=45 ? "–ù—É–∂–Ω–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è" : "–í—ã—Å–æ–∫–∏–π —Ç–µ—Ö–¥–æ–ª–≥");
  paintStat("kObsol", isFinite(obsol)?obsol:NaN, true);

  // AI Readiness Index ‚Äî higher is better (tech+proc+richness of sources)
  const sourcesStr = (document.getElementById("sources")?.value || "");
  const srcCount = sourcesStr.split(",").map(s=>s.trim()).filter(Boolean).length;
  const srcNorm = clamp(srcCount/6, 0, 1);
  let ai = ( (isFinite(techIndex)?techIndex:0) * 0.50 ) + ( (isFinite(procIndex)?procIndex:0) * 0.30 ) + (srcNorm * 100 * 0.20);
  ai = Math.round(clamp(ai, 0, 100));
  document.getElementById("aiIndex").textContent = isFinite(ai) ? `${ai}%` : "‚Äî%";
  document.getElementById("aiLabel").textContent = ai>=75 ? "–ì–æ—Ç–æ–≤–æ" : (ai>=45 ? "–ß–∞—Å—Ç–∏—á–Ω–æ –≥–æ—Ç–æ–≤–æ" : "–ù—É–∂–Ω–æ –Ω–∞–≤–µ—Å—Ç–∏ –ø–æ—Ä—è–¥–æ–∫ –≤ –¥–∞–Ω–Ω—ã—Ö");
  paintStat("kAI", isFinite(ai)?ai:NaN, true);

  // Cost of Inaction score for PSI (normalize by baseline spend, 0‚Äì4% = ok)
  const hwBudget = (+document.getElementById("hwBudget")?.value || 0);
  const baseline = (salary*12*itCount) + licBudget + hwBudget;
  let coiScore = NaN;
  if(baseline>0){
    const share = clamp(lossTotal / baseline, 0, 1);
    coiScore = 100 * (1 - clamp(share/0.04, 0, 1)); // 4% = 0 score, 0% = 100
    coiScore = Math.round(clamp(coiScore, 0, 100));
  }

  // Regulatory readiness proxy (based on risk flags: audits + unaccounted software)
  const auditIdx = RISK.findIndex(x=>x.label && x.label.toLowerCase().includes("–ø—Ä–æ–≤–µ—Ä"));
  const unlicensedIdx = RISK.findIndex(x=>x.label && x.label.toLowerCase().includes("–Ω–µ—É—á—Ç–µ–Ω–Ω—ã—Ö —É—Å—Ç–∞–Ω–æ–≤–æ–∫"));
  const auditFlag = auditIdx>=0 ? (riskScores[auditIdx]||0) : 0;
  const unlicensedFlag = unlicensedIdx>=0 ? (riskScores[unlicensedIdx]||0) : 0;
  const reg = Math.round(clamp(100 - (auditFlag*40 + unlicensedFlag*60), 0, 100));

  // IT Reactivity proxy (incidents + manual ops)
  const incidentsPerMonth = isFinite(est.incidentsPerMonth.v)?est.incidentsPerMonth.v:(+document.getElementById("incidentsPerMonth")?.value || 0);
  const incNorm = clamp(incidentsPerMonth/30, 0, 1);
  const manNorm = clamp((isFinite(est.manualPct.v)?est.manualPct.v:(+document.getElementById("manualPct").value||0))/60, 0, 1);
  const reactivity = Math.round(100 * (1 - clamp(0.6*incNorm + 0.4*manNorm, 0, 1)));

  // Change maturity proxy (use process maturity)
  const change = Math.round(clamp(procIndex,0,100));

  // Scalability proxy (branches + growth risk flag)
  const branches = (+document.getElementById("branches")?.value || 0);
  const growthIdx = RISK.findIndex(x=>x.label && x.label.toLowerCase().includes("—Ä–∞—Å—Ç–µ—Ç/–º–µ–Ω—è–µ—Ç—Å—è"));
  const growthFlag = growthIdx>=0 ? (riskScores[growthIdx]||0) : 0;
  const brNorm = clamp(branches/20, 0, 1);
  const scalability = Math.round(clamp( (techIndex*0.5 + procIndex*0.3 + (1 - (0.6*brNorm + 0.4*growthFlag))*100*0.2), 0, 100));

  // PSI 2.0 weighted score (0‚Äì100)
  const w = {
    coi:0.20, recover:0.15, control:0.15, bus:0.10, reg:0.10,
    obsol:0.10, react:0.08, change:0.05, scale:0.04, ai:0.03
  };
  const control = Math.round(clamp(techIndex,0,100));
  const parts = [
    {v:coiScore, w:w.coi},
    {v:recover, w:w.recover},
    {v:control, w:w.control},
    {v:bus, w:w.bus},
    {v:reg, w:w.reg},
    {v:obsol, w:w.obsol},
    {v:reactivity, w:w.react},
    {v:change, w:w.change},
    {v:scalability, w:w.scale},
    {v:ai, w:w.ai},
  ];
  const normalizedParts = parts.map(p=>({v:Number(p.v), w:Number(p.w)}));
  const valid = normalizedParts.filter(p=>Number.isFinite(p.v) && Number.isFinite(p.w) && p.w>0);
  const sumW = valid.reduce((a,p)=>a+p.w,0);
  let psi2 = NaN;
  if(sumW>0){
    psi2 = valid.reduce((a,p)=>a + p.v*p.w,0) / sumW;
    psi2 = Math.round(clamp(psi2, 0, 100));
  } else {
    // fallback: if everything missing, at least anchor PSI to visible core indices
    const core = [techIndex, procIndex].map(Number).filter(Number.isFinite);
    if(core.length) psi2 = Math.round(core.reduce((a,b)=>a+b,0)/core.length);
  }
  document.getElementById("psi2Score").textContent = isFinite(psi2) ? `${psi2}%` : "‚Äî%";
  document.getElementById("psi2Label").textContent = isFinite(psi2) ? (psi2>=75 ? "–ó–µ–ª—ë–Ω–∞—è –∑–æ–Ω–∞" : (psi2>=45 ? "–ñ—ë–ª—Ç–∞—è –∑–æ–Ω–∞" : "–ö—Ä–∞—Å–Ω–∞—è –∑–æ–Ω–∞")) : "‚Äî";
  try{ paintStat("kPSI", Number.isFinite(psi2)?psi2:NaN, true); }catch(_e){}
  try{ renderBenchHints(); }catch(_e){}

}catch(e){ console.error('recalc tail error', e); }
// Required fields gate (PDF)

  // Always recompute PSI from DOM as a final fallback
  try{ if(!isFinite(parseFloat((document.getElementById('psi2Score')?.textContent||'').replace('%','')))) computePSIFromDom(); }catch(_e){}
  updateRequiredUI();
}

function collect(){
  const get=id=>document.getElementById(id)?.value ?? "";
  return {
    meta:{
      company:get("company"), industry:get("industry"), sales_manager:get("sales_manager"), presale_manager:get("presale_manager"), lpr:get("lpr"),
      workplaces:+get("workplaces")||0, servers:+get("servers")||0, branches:+get("branches")||0,
      vdi:get("vdi"), closed:get("closed"), sources:get("sources"), envNote:get("envNote"), benchMode:get("benchMode"), interviewMode:get("interviewMode"), pdfMode:get("pdfMode"),
      virt:get("virt"), hostingModel:get("hostingModel"), adDomains:get("adDomains"), netSeg:get("netSeg"), terminalFarms:get("terminalFarms"), hwAge:get("hwAge"), hwAccounting:get("hwAccounting"), redundancy:get("redundancy")
    },
    maturity:{
      tech: TECH.map((k,i)=>({key:k, score: clampInt(document.querySelectorAll(".tech-score")[i].value,0,2), note: document.querySelectorAll(".tech-note")[i].value||""})),
      proc: PROC.map((k,i)=>({key:k, score: clampInt(document.querySelectorAll(".proc-score")[i].value,0,2), note: document.querySelectorAll(".proc-note")[i].value||""})),
      risk: RISK.map((k,i)=>({key:k, score: clampInt(document.querySelectorAll(".risk-score")[i].value,0,1), note: document.querySelectorAll(".risk-note")[i].value||""})),
    },
    finance:{
      salary:+get("salary")||0, itCount:+get("itCount")||0, manualPct:+get("manualPct")||0,
      licBudget:+get("licBudget")||0, unusedPct:+get("unusedPct")||0, vmUnusedPct:+get("vmUnusedPct")||0,
      hwBudget:+get("hwBudget")||0, hwPlan:get("hwPlan"),
      downtimeHours:+get("downtimeHours")||0, downtimeCost:+get("downtimeCost")||0,
      incidentsPerMonth:+get("incidentsPerMonth")||0, serviceDesk:get("serviceDesk"),
      keyPeopleRisk:get("keyPeopleRisk"), docScore:clampInt(get("docScore"),0,2), obsoletePct:+get("obsoletePct")||0,
      note:get("finNote")
    },
    requirements:[...document.querySelectorAll("#reqTbody tr")].map(r=>({
      text:r.querySelector(".req-text")?.value||"",
      type:r.querySelector(".req-type")?.value||"–¢–µ—Ö",
      must:r.querySelector(".req-must")?.value||"–î–∞",
      feas:r.querySelector(".req-feas")?.value||"‚Äî",
      metric:r.querySelector(".req-metric")?.value||"",
      owner:r.querySelector(".req-owner")?.value||"",
    })),
    productRequirements:[...document.querySelectorAll("#prodReqTbody tr")].map(r=>({
      biz:r.querySelector(".prod-biz")?.value||"",
      func:r.querySelector(".prod-func")?.value||"",
      type:r.querySelector(".prod-type")?.value||"–¢–µ—Ö",
      must:r.querySelector(".prod-must")?.value||"–î–∞",
      feas:r.querySelector(".prod-feas")?.value||"‚Äî",
    })),
    psi:[...document.querySelectorAll("#psiTbody tr")].map(r=>({
      req:r.querySelector(".psi-req")?.value||"",
      scn:r.querySelector(".psi-scn")?.value||"",
      exp:r.querySelector(".psi-exp")?.value||"",
      act:r.querySelector(".psi-act")?.value||"",
      ok:r.querySelector(".psi-ok")?.value||"",
      acc:r.querySelector(".psi-acc")?.value||"",
      note:r.querySelector(".psi-note")?.value||"",
    })),
    pilot:{
      goal:get("pilotGoal"), tasks:get("pilotTasks_removed"), kpi:get("pilotKpi_removed"), scope:get("pilotScope"),
      summary:get("pilotSummary"), decision:get("pilotDecision"), recommendedConfig:get("recommendedConfig")
    },
    projectRisks:{
      level:(document.getElementById("riskLevelText")?.value||""),
      notes:(document.getElementById("riskNotes")?.value||""),
      table:[...document.querySelectorAll("#projectRisks tr")].map(r=>({
        indicator:(r.querySelector("td:nth-child(1)")?.innerText||"").trim(),
        condition:(r.querySelector("td:nth-child(2)")?.innerText||"").trim(),
        status:(r.querySelector("td:nth-child(3)")?.innerText||"").trim(),
        comment:(r.querySelector("td:nth-child(4)")?.innerText||"").trim(),
      }))
    },
    kpi:{
      psi2:(document.getElementById("psi2Score")?.textContent||"").trim(),
      psi2Zone:(document.getElementById("psi2Label")?.textContent||"").trim(),
      tech:(document.getElementById("techIndex")?.textContent||"").trim(),
      proc:(document.getElementById("procIndex")?.textContent||"").trim(),
      risk:(document.getElementById("riskIndex")?.textContent||"").trim(),
      coi:(document.getElementById("coiTotal")?.textContent||"").trim(),
      feas:(document.getElementById("feasScore")?.textContent||"").trim(),
      prodFeas:(document.getElementById("prodFeasScore")?.textContent||"").trim(),
      pain:(document.getElementById("painIndex")?.textContent||"").trim(),
      ready:(document.getElementById("readyIndex")?.textContent||"").trim(),
      prob:(document.getElementById("probIndex")?.textContent||"").trim(),
      recover:(document.getElementById("recoverIndex")?.textContent||"").trim(),
      bus:(document.getElementById("busIndex")?.textContent||"").trim(),
      obsol:(document.getElementById("obsolIndex")?.textContent||"").trim(),
      ai:(document.getElementById("aiIndex")?.textContent||"").trim(),
      crit:(document.getElementById("critScore")?.textContent||"").trim(),
      critLabel:(document.getElementById("critLabel")?.textContent||"").trim(),
    },
    audit:{
      savedAt:new Date().toISOString(),
      version:"v7.0 (excel+gsync)"
    }
  };
}


function flattenForSheets(raw){
  // –î–µ–ª–∞–µ—Ç –ø–ª–æ—Å–∫–∏–π –æ–±—ä–µ–∫—Ç –¥–ª—è Google Sheets: –∫–ª—é—á–∏ –∏–∑ —à–∞–ø–∫–∏ (1-—è —Å—Ç—Ä–æ–∫–∞) –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞—Å—Ç—å.
  // 1) meta.* –ø–æ–¥–Ω–∏–º–∞–µ–º –Ω–∞ –≤–µ—Ä—Ö–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å (company, industry, ...).
  // 2) –¢–∞–∫–∂–µ –∫–ª–∞–¥–µ–º –≤—Å–µ –ø—É—Ç–∏ –≤–∏–¥–∞ a.b.c (–µ—Å–ª–∏ –≤ —à–∏—Ç–µ —Ç–∞–∫ –Ω–∞–∑–≤–∞–ª–∏ –∫–æ–ª–æ–Ω–∫—É).
  // 3) –ü–æ–ª–Ω—ã–π –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π payload –¥—É–±–ª–∏—Ä—É–µ–º –≤ –ø–æ–ª–µ 'payload' (–µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å –≤ —à–∞–ø–∫–µ).
  const out = {};
  const seenLeaf = new Map(); // leafKey -> count

  function walk(cur, prefix){
    if(cur === null || cur === undefined) return;
    if(Array.isArray(cur)){
      out[prefix] = JSON.stringify(cur);
      return;
    }
    if(typeof cur === "object"){
      for(const k in cur){
        const key = prefix ? (prefix + "." + k) : k;
        walk(cur[k], key);
      }
      return;
    }
    out[prefix] = cur;
    const leaf = String(prefix).split(".").pop();
    seenLeaf.set(leaf, (seenLeaf.get(leaf)||0) + 1);
  }

  if(raw && typeof raw === "object"){
    walk(raw, "");
    // lift meta.*
    if(raw.meta && typeof raw.meta === "object"){
      for(const k in raw.meta){ out[k] = raw.meta[k]; }
    }
    // optional: lift KPI to simple names too
    if(raw.kpi && typeof raw.kpi === "object"){
      for(const k in raw.kpi){
        out[k] = out[k] ?? raw.kpi[k];         // if sheet uses 'psi2Score' etc
        out["kpi."+k] = raw.kpi[k];            // if sheet uses dot notation
      }
    }
    // include full payload
    out.payload = raw;
  }
  // Remove accidental empty key if any
  if(out[""] !== undefined) delete out[""];
  return out;
}




function apply(data){
  if(!data) return;
  const set=(id,v)=>{const el=document.getElementById(id); if(el) el.value = v ?? "";};

  const m=data.meta||{};
  set("company",m.company); set("industry",m.industry); set("lpr",m.lpr); set("sources",m.sources); set("envNote",m.envNote);
  set("workplaces",m.workplaces); set("servers",m.servers); set("branches",m.branches); set("vdi",m.vdi); set("closed",m.closed);
  set("benchMode",m.benchMode); set("interviewMode",m.interviewMode); set("pdfMode",m.pdfMode);

  const mat=data.maturity||{};
  if(mat.tech) mat.tech.forEach((x,i)=>{const s=document.querySelectorAll(".tech-score")[i]; const n=document.querySelectorAll(".tech-note")[i]; if(s) s.value=String(x.score??0); if(n) n.value=x.note??"";});
  if(mat.proc) mat.proc.forEach((x,i)=>{const s=document.querySelectorAll(".proc-score")[i]; const n=document.querySelectorAll(".proc-note")[i]; if(s) s.value=String(x.score??0); if(n) n.value=x.note??"";});
  if(mat.risk) mat.risk.forEach((x,i)=>{const s=document.querySelectorAll(".risk-score")[i]; const n=document.querySelectorAll(".risk-note")[i]; if(s) s.value=String(x.score??0); if(n) n.value=x.note??"";});

  const f=data.finance||{};
  set("salary",f.salary); set("itCount",f.itCount); set("manualPct",f.manualPct);
  set("licBudget",f.licBudget); set("unusedPct",f.unusedPct); set("vmUnusedPct",f.vmUnusedPct);
  set("hwBudget",f.hwBudget); set("hwPlan",f.hwPlan);
  set("downtimeHours",f.downtimeHours); set("downtimeCost",f.downtimeCost);
  set("incidentsPerMonth",f.incidentsPerMonth); set("serviceDesk",f.serviceDesk);
  set("keyPeopleRisk",f.keyPeopleRisk); set("docScore",f.docScore); set("obsoletePct",f.obsoletePct);
  set("finNote",f.note);

  // requirements
  const __reqTb=document.getElementById("reqTbody");
  if(__reqTb) __reqTb.innerHTML="";
  (data.requirements||[]).forEach(r=>addReqRow(r));
  // product requirements
  const prTb=document.getElementById("prodReqTbody");
  if(prTb){ prTb.innerHTML=""; (data.productRequirements||[]).forEach(r=>addProdReqRow(r)); }
  // psi
  const __psiTb=document.getElementById("psiTbody");
  if(__psiTb) __psiTb.innerHTML="";
  (data.psi||[]).forEach(r=>addPsiRow(r));
  const p=data.pilot||{};
  set("pilotGoal",p.goal); set("pilotTasks_removed",p.tasks); set("pilotKpi_removed",p.kpi); set("pilotScope",p.scope);
  set("pilotSummary",p.summary); set("pilotDecision",p.decision); set("recommendedConfig",p.recommendedConfig);

  const pr=(data.projectRisks||{});
  set("riskLevelText", pr.level);
  set("riskNotes", pr.notes);

  recalc();
}

function seedReq(){
  const presets=[
    {text:"–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ Active Directory / FreeIPA –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤", type:"–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏", must:"–î–∞", feas:"–ü–æ–ª–Ω–æ—Å—Ç—å—é", metric:"–û—Ç—á–µ—Ç/—Å–∫—Ä–∏–Ω –ø–æ –Ω–∞–π–¥–µ–Ω–Ω—ã–º –æ–±—ä–µ–∫—Ç–∞–º", owner:"–ö–ª–∏–µ–Ω—Ç+–ü—Ä–µ—Å–µ–π–ª"},
    {text:"–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è –ø–∏–ª–æ—Ç–Ω–æ–π –∑–æ–Ω—ã (‚â•95% —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –≤ –ø–µ—Ä–∏–º–µ—Ç—Ä–µ)", type:"–¢–µ—Ö", must:"–î–∞", feas:"–ü–æ–ª–Ω–æ—Å—Ç—å—é", metric:"–û—Ç—á–µ—Ç –ø–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º + —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å —ç—Ç–∞–ª–æ–Ω–æ–º", owner:"–ü—Ä–µ—Å–µ–π–ª"},
    {text:"–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –ü–û (–¥–æ–ª—è –Ω–µ—Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–æ–≥–æ ‚â§5%)", type:"–¢–µ—Ö", must:"–î–∞", feas:"–ß–∞—Å—Ç–∏—á–Ω–æ", metric:"–û—Ç—á–µ—Ç –ø–æ –ü–û", owner:"–ü—Ä–µ—Å–µ–π–ª"},
    {text:"–û—Ç—á–µ—Ç –ø–æ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω–æ–º—É/–Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ–º—É –ü–û", type:"–ò–ë", must:"–ù–µ—Ç", feas:"–¢—Ä–µ–±—É–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç", metric:"–°–ø–∏—Å–æ–∫/–æ—Ç—á–µ—Ç", owner:"–ü—Ä–µ—Å–µ–π–ª"},
  ];
  presets.forEach(p=>addReqRow(p));
}
function seedPsi(){
  const presets=[
    {req:"", scn:"–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –≤ –ø–∏–ª–æ—Ç–Ω–æ–π –∑–æ–Ω–µ", exp:"–°–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–µ—Ä–∏–º–µ—Ç—Ä—É, ‚â•95% –ø–æ–∫—Ä—ã—Ç–∏–µ", act:"", ok:"", acc:"", note:""},
    {req:"", scn:"–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –ü–û", exp:"–ù–µ—Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–æ–µ –ü–û ‚â§5% –∏ –≤—ã–¥–µ–ª–µ–Ω–æ –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–ø–∏—Å–∫–æ–º", act:"", ok:"", acc:"", note:""},
    {req:"", scn:"–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç—á–µ—Ç–∞ –ø–æ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω–æ–º—É –ü–û", exp:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω –æ—Ç—á–µ—Ç/—Å–ø–∏—Å–æ–∫ –ø–æ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º", act:"", ok:"", acc:"", note:""},
  ];
  presets.forEach(p=>addPsiRow(p));
}

document.getElementById("btnRecalc").addEventListener("click", recalc);
// ===== v7: Excel export + Google Sheets sync =====
const GOOGLE_SHEETS_WEBAPP_URL = (window.GS_WEBAPP_URL || "").trim();
console.log("‚úÖ Using Google Sheets WebApp URL:", GOOGLE_SHEETS_WEBAPP_URL);

function showLoader(title, sub){
  try{
    const el = document.getElementById("globalLoader");
    if(!el) return;
    const t = document.getElementById("globalLoaderTitle");
    const s = document.getElementById("globalLoaderSub");
    if(t) t.textContent = title || "–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶";
    if(s) s.textContent = sub || "Google Sheets –æ—Ç–≤–µ—á–∞–µ—Ç, —ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.";
    el.style.display = "flex";
    el.setAttribute("aria-hidden","false");
  }catch(_e){}
}
function hideLoader(){
  try{
    const el = document.getElementById("globalLoader");
    if(!el) return;
    el.style.display = "none";
    el.setAttribute("aria-hidden","true");
  }catch(_e){}
}

// –ï—Å–ª–∏ —É —Ç–µ–±—è –¥—Ä—É–≥–æ–π URL ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–º–µ–Ω—è–π —Å—Ç—Ä–æ–∫—É –≤—ã—à–µ.

function safeNum(v){
  const n = Number(String(v).replace(/[‚ÇΩ\s]/g,'').replace(',', '.').replace('%',''));
  return Number.isFinite(n) ? n : null;
}
function aoaSheet(rows){ return (window.XLSX ? XLSX.utils.aoa_to_sheet(rows) : null); }

function buildExcelWorkbook(payload){
  if(!window.XLSX) throw new Error("SheetJS (XLSX) –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è. –ü—Ä–æ–≤–µ—Ä—å –¥–æ—Å—Ç—É–ø –∫ CDN.");
  const wb = XLSX.utils.book_new();

  // Sheet: –ü–∞—Å–ø–æ—Ä—Ç + –§–∏–Ω–∞–Ω—Å—ã + KPI
  const m = payload.meta||{};
  const f = payload.finance||{};
  const k = payload.kpi||{};
  const s1 = [
    ["–†–∞–∑–¥–µ–ª","–ü–∞—Ä–∞–º–µ—Ç—Ä","–ó–Ω–∞—á–µ–Ω–∏–µ"],
    ["1) –ü–∞—Å–ø–æ—Ä—Ç","–ö–æ–º–ø–∞–Ω–∏—è", m.company||""],
    ["1) –ü–∞—Å–ø–æ—Ä—Ç","–û—Ç—Ä–∞—Å–ª—å", m.industry||""],
    ["1) –ü–∞—Å–ø–æ—Ä—Ç","–õ–ü–† / –∫–æ–Ω—Ç–∞–∫—Ç", m.lpr||""],
    ["1) –ü–∞—Å–ø–æ—Ä—Ç","–ò—Å—Ç–æ—á–Ω–∏–∫–∏", m.sources||""],
    ["1) –ü–∞—Å–ø–æ—Ä—Ç","–ü—Ä–∏–º–µ—á–∞–Ω–∏—è –ø–æ —Å—Ä–µ–¥–µ", m.envNote||""],
    ["1) –ü–∞—Å–ø–æ—Ä—Ç","–ö–æ–ª-–≤–æ —Ä–∞–±–æ—á–∏—Ö –º–µ—Å—Ç", m.workplaces??""],
    ["1) –ü–∞—Å–ø–æ—Ä—Ç","–ö–æ–ª-–≤–æ —Å–µ—Ä–≤–µ—Ä–æ–≤", m.servers??""],
    ["1) –ü–∞—Å–ø–æ—Ä—Ç","–ö–æ–ª-–≤–æ —Ñ–∏–ª–∏–∞–ª–æ–≤", m.branches??""],
    ["1) –ü–∞—Å–ø–æ—Ä—Ç","VDI", m.vdi||""],
    ["1) –ü–∞—Å–ø–æ—Ä—Ç","–ó–∞–∫—Ä—ã—Ç—ã–π –∫–æ–Ω—Ç—É—Ä", m.closed||""],
["1) –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞","–í–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è", m.virt||""],
    ["1) –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞","–ú–æ–¥–µ–ª—å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è", m.hostingModel||""],
    ["1) –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞","–î–æ–º–µ–Ω—ã AD / –∫–∞—Ç–∞–ª–æ–≥–æ–≤ (–∫–æ–ª-–≤–æ)", m.adDomains??""],
    ["1) –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞","–°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è —Å–µ—Ç–∏", m.netSeg||""],
    ["1) –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞","–¢–µ—Ä–º–∏–Ω–∞–ª—å–Ω—ã–µ —Ñ–µ—Ä–º—ã / RDS / VDI farms", m.terminalFarms||""],
    ["1) –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞","–í–æ–∑—Ä–∞—Å—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∂–µ–ª–µ–∑–∞", m.hwAge||""],
    ["1) –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞","–£—á–µ—Ç –∂–µ–ª–µ–∑–∞ (–∫–∞–∫ —Å–µ–π—á–∞—Å)", m.hwAccounting||""],
    ["1) –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞","–†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤", m.redundancy||""],
    ["","", ""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","–°—Ä–µ–¥–Ω—è—è –∑–∞—Ä–ø–ª–∞—Ç–∞ IT (‚ÇΩ/–º–µ—Å) GROSS", f.salary??""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","–ö–æ–ª-–≤–æ IT —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤", f.itCount??""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","% —Ä—É—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π", f.manualPct??""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","–ë—é–¥–∂–µ—Ç –Ω–∞ –ª–∏—Ü–µ–Ω–∑–∏–∏ (‚ÇΩ/–≥–æ–¥)", f.licBudget??""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","% –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ –ü–û", f.unusedPct??""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","% –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö VM", f.vmUnusedPct??""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","–ë—é–¥–∂–µ—Ç –Ω–∞ –∂–µ–ª–µ–∑–æ (‚ÇΩ/–≥–æ–¥)", f.hwBudget??""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","–ü–ª–∞–Ω –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∂–µ–ª–µ–∑–∞", f.hwPlan||""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","–ß–∞—Å–æ–≤ –ø—Ä–æ—Å—Ç–æ—è –≤ –≥–æ–¥", f.downtimeHours??""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","–°—Ç–æ–∏–º–æ—Å—Ç—å —á–∞—Å–∞ –ø—Ä–æ—Å—Ç–æ—è (‚ÇΩ/—á–∞—Å)", f.downtimeCost??""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","–ò–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤ –≤ –º–µ—Å—è—Ü", f.incidentsPerMonth??""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","–°–µ—Ä–≤–∏—Å-–¥–µ—Å–∫", f.serviceDesk||""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","Bus-factor ‚â§2 (–µ—Å—Ç—å?)", f.keyPeopleRisk||""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å (0‚Äì2)", f.docScore??""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","% —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –û–°/–ü–û", f.obsoletePct??""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π", f.note||""],
    ["","", ""],
    ["KPI (—à–∞–ø–∫–∞)","PSI 2.0", k.psi2||""],
    ["KPI (—à–∞–ø–∫–∞)","–ó–æ–Ω–∞ PSI", k.psi2Zone||""],
    ["KPI (—à–∞–ø–∫–∞)","–ò–Ω–¥–µ–∫—Å —Ç–µ—Ö. –∑—Ä–µ–ª–æ—Å—Ç–∏", k.tech||""],
    ["KPI (—à–∞–ø–∫–∞)","–ò–Ω–¥–µ–∫—Å –ø—Ä–æ—Ü. –∑—Ä–µ–ª–æ—Å—Ç–∏", k.proc||""],
    ["KPI (—à–∞–ø–∫–∞)","–ò–Ω–¥–µ–∫—Å —Ä–∏—Å–∫–∞", k.risk||""],
    ["KPI (—à–∞–ø–∫–∞)","Cost of Inaction (‚ÇΩ/–≥–æ–¥)", k.coi||""],
    ["KPI (—à–∞–ø–∫–∞)","–†–µ–∞–ª–∏–∑—É–µ–º–æ—Å—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π", k.feas||""],
    ["KPI (—à–∞–ø–∫–∞)","–≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ", k.pain||""],
    ["KPI (—à–∞–ø–∫–∞)","–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø–∏–ª–æ—Ç—É", k.ready||""],
    ["KPI (—à–∞–ø–∫–∞)","–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Å–¥–µ–ª–∫–∏", k.prob||""],
    ["KPI (—à–∞–ø–∫–∞)","–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –≤–æ–∑–≤—Ä–∞—Ç–∞ –±—é–¥–∂–µ—Ç–∞", k.recover||""],
    ["KPI (—à–∞–ø–∫–∞)","–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –ª—é–¥–µ–π", k.bus||""],
    ["KPI (—à–∞–ø–∫–∞)","–¢–µ—Ö. —Å—Ç–∞—Ä–µ–Ω–∏–µ", k.obsol||""],
    ["KPI (—à–∞–ø–∫–∞)","–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ò–ò", k.ai||""],
    ["KPI (—à–∞–ø–∫–∞)","–ö–∞—Ç–µ–≥–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞", k.crit||""],
    ["KPI (—à–∞–ø–∫–∞)","–ö–∞—Ç–µ–≥–æ—Ä–∏—è (–ª–µ–π–±–ª)", k.critLabel||""],
  ];
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(s1), "01_–ü–∞—Å–ø–æ—Ä—Ç+KPI");

  // Sheet: 2.1
  const tech = (payload.maturity?.tech||[]).map(x=>[x.key?.label||"", x.score, x.note||""]);
  tech.unshift(["–ö—Ä–∏—Ç–µ—Ä–∏–π","–ë–∞–ª–ª (0‚Äì2)","–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"]);
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(tech), "02_–¢–µ—Ö_2.1");

  // Sheet: 2.2
  const proc = (payload.maturity?.proc||[]).map(x=>[x.key?.label||"", x.score, x.note||""]);
  proc.unshift(["–ö—Ä–∏—Ç–µ—Ä–∏–π","–ë–∞–ª–ª (0‚Äì2)","–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"]);
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(proc), "03_–ü—Ä–æ—Ü_2.2");

  // Sheet: 2.3
  const risk = (payload.maturity?.risk||[]).map(x=>[x.key?.label||"", x.score, x.note||""]);
  risk.unshift(["–§–∞–∫—Ç–æ—Ä","–ï—Å—Ç—å? (0/1)","–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"]);
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(risk), "04_–†–∏—Å–∫–∏_2.3");

  // Sheet: 4 –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
  const req = (payload.requirements||[]).map((r,i)=>[i+1, r.text||"", r.type||"", r.must||"", r.feas||"", r.metric||"", r.owner||""]);
  req.unshift(["‚Ññ","–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞","–¢–∏–ø","–û–±—è–∑–∞—Ç.","–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å","–ú–µ—Ç—Ä–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏","–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π"]);
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(req), "05_–¢—Ä–µ–±_4");

  // Sheet: 5 –ü–°–ò
  const psi = (payload.psi||[]).map((r,i)=>[i+1, r.scn||"", r.exp||"", r.act||"", r.ok||"", r.acc||"", r.note||""]);
  psi.unshift(["‚Ññ","–°—Ü–µ–Ω–∞—Ä–∏–π","–û–∂–∏–¥–∞–Ω–∏–µ","–§–∞–∫—Ç","–°–æ–æ—Ç–≤.","–ü—Ä–∏–Ω—è–ª–∏?","–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"]);
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(psi), "06_–ü–°–ò_5");

  // Sheet: 5.1 –†–∏—Å–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞
  const pr = payload.projectRisks||{};
  const prHead = [
    ["–ü–∞—Ä–∞–º–µ—Ç—Ä","–ó–Ω–∞—á–µ–Ω–∏–µ"],
    ["–£—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ (–∏—Ç–æ–≥)", pr.level||""],
    ["–ß—Ç–æ –º–æ–∂–µ—Ç –ø–æ–π—Ç–∏ –Ω–µ —Ç–∞–∫ (–∫—Ä–∞—Ç–∫–æ)", pr.notes||""],
    ["",""],
    ["–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä","–£—Å–ª–æ–≤–∏–µ","–°—Ç–∞—Ç—É—Å","–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"],
  ];
  const prRows = (pr.table||[]).map(x=>[x.indicator||"", x.condition||"", x.status||"", x.comment||""]);
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(prHead.concat(prRows)), "07_–†–∏—Å–∫–∏_5.1");

  return wb;
}

function exportExcel(){
  try{
    recalc();
    try{ const vboxes=document.querySelectorAll(".virt-wrapper input[type=checkbox]"); if(vboxes && vboxes.length){ const sel=[...vboxes].filter(b=>b.checked).map(b=>b.value).join("; "); const hv=document.getElementById("virt"); if(hv) hv.value=sel; } }catch(e){} // —á—Ç–æ–±—ã KPI –∏ —Ä–∏—Å–∫–∏ —Ç–æ—á–Ω–æ –æ–±–Ω–æ–≤–∏–ª–∏—Å—å
    const payload = collect();
    const wb = buildExcelWorkbook(payload);
    const nameBase = (payload.meta?.company||"ITMen_PSI").replace(/[^\p{L}\p{N}_\- ]/gu,"").trim().slice(0,60) || "ITMen_PSI";
    const fname = `${nameBase}_PSI_v7.xlsx`;
    XLSX.writeFile(wb, fname);
  }catch(e){
    console.error(e);
    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–≥—Ä—É–∑–∏—Ç—å Excel: " + (e?.message||e));
  }
}

let _gsyncTimer = null;
async function syncToGoogleSheets(reason){
  // GitHub Pages CSP —á–∞—Å—Ç–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç fetch/beacon –Ω–∞ –≤–Ω–µ—à–Ω–∏–µ –¥–æ–º–µ–Ω—ã (connect-src 'self').
  // –ü–æ—ç—Ç–æ–º—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ —Å–∫—Ä—ã—Ç—É—é HTML-—Ñ–æ—Ä–º—É –≤ iframe (—ç—Ç–æ –Ω–µ fetch –∏ –æ–±—ã—á–Ω–æ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è).
  clearTimeout(_gsyncTimer);
  _gsyncTimer = setTimeout(async ()=>{
    try{
      try{ recalc(); }catch(_e){}
      const payloadRaw = collect();
      payloadRaw.audit = payloadRaw.audit || {};
      payloadRaw.audit.syncReason = reason || "manual";
      payloadRaw.audit.syncedAt = new Date().toISOString();
      const payload = flattenForSheets(payloadRaw);

      const st = document.getElementById("gsyncStatus");
      const url = (typeof GOOGLE_SHEETS_WEBAPP_URL === "string" ? GOOGLE_SHEETS_WEBAPP_URL : "") || "";
      if(!url) throw new Error("GOOGLE_SHEETS_WEBAPP_URL is not set");

      if(st){
        st.style.display="block";
        st.style.color="#0ea5e9";
        st.textContent="‚è´ –û—Ç–ø—Ä–∞–≤–ª—è—é –≤ Google Sheets‚Ä¶";
      }

      const form = document.getElementById("gsyncForm");
      const frame = document.getElementById("gsyncFrame");
      if(!form || !frame) throw new Error("gsync form/iframe not found");

      form.action = url;
      const payloadInput = form.querySelector('input[name="payload"]');
      payloadInput.value = JSON.stringify(payload);

      let done = false;
      const onload = () => {
        if(done) return;
        done = true;
        try{ frame.removeEventListener("load", onload); }catch(_){}
        if(st){
          st.style.color = "#16a34a";
          st.textContent = "‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Google Sheets.";
          setTimeout(()=>{ try{ st.style.display='none'; }catch(_e){} }, 3500);
        }
      };
      try{ frame.addEventListener("load", onload); }catch(_){}

      form.submit();

      setTimeout(()=>{
        if(done) return;
        done = true;
        if(st){
          st.style.color = "#16a34a";
          st.textContent = "‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ).";
          setTimeout(()=>{ try{ st.style.display='none'; }catch(_e){} }, 3500);
        }
      }, 1500);

    }catch(err){
      console.error("gsync error", err);
      const st = document.getElementById("gsyncStatus");
      if(st){
        st.style.display="block";
        st.style.color="#b91c1c";
        st.textContent="‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: " + ((err && err.message) ? err.message : err);
        setTimeout(()=>{ try{ st.style.display='none'; }catch(_e){} }, 6500);
      }
    }
  }, 200);
}

document.getElementById("btnExportXlsx")?.addEventListener("click", exportExcel);

// –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å = —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å (–ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
document.getElementById("btnRecalc").addEventListener("click", ()=>{ try{ recalc(); }catch(e){ console.warn("recalc() failed", e); } });

// –ü–µ—á–∞—Ç—å / –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ PDF = —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≤ Google Sheets
document.getElementById("btnPrint").addEventListener("click", ()=>{ try{ syncToGoogleSheets("pdf"); }catch(e){ console.warn("syncToGoogleSheets failed", e); } window.print(); });

document.getElementById("btnCLevel").addEventListener("click", ()=>{
  try{
    recalc(); // ensure latest
    const company = (document.getElementById("company").value || "–ö–æ–º–ø–∞–Ω–∏—è").trim();
    const psi2 = document.getElementById("psi2Score").textContent.replace("%","").trim();
    const psi2n = parseInt(psi2,10);
    const zone = document.getElementById("psi2Label").textContent;

    const coi = document.getElementById("coiTotal").textContent;
    const rec = document.getElementById("recoverIndex").textContent;
    const bus = document.getElementById("busIndex").textContent;
    const ob = document.getElementById("obsolIndex").textContent;
    const ai = document.getElementById("aiIndex").textContent;

    const topGaps = [];
    const pushGap = (name, val, hint)=>{
      const n = parseInt(String(val).replace("%","").trim(),10);
      if(isFinite(n) && n < 45) topGaps.push({name, n, hint});
    };
    pushGap("–£–ø—Ä–∞–≤–ª—è–µ–º–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö (—Ç–µ—Ö. –∑—Ä–µ–ª–æ—Å—Ç—å)", document.getElementById("techIndex").textContent, "–ù—É–∂–µ–Ω –µ–¥–∏–Ω—ã–π —Ä–µ–µ—Å—Ç—Ä –∞–∫—Ç–∏–≤–æ–≤ –∏ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π —Å–±–æ—Ä.");
    pushGap("–ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å –≤–Ω–µ–¥—Ä–µ–Ω–∏—è (–ø—Ä–æ—Ü. –∑—Ä–µ–ª–æ—Å—Ç—å)", document.getElementById("procIndex").textContent, "–ù—É–∂–Ω—ã —Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã –∏ —Ä–æ–ª–∏: –∫—Ç–æ –≤–ª–∞–¥–µ–ª–µ—Ü –¥–∞–Ω–Ω—ã—Ö/–ø—Ä–æ—Ü–µ—Å—Å–æ–≤.");
    pushGap("–í–æ–∑–≤—Ä–∞—Ç –±—é–¥–∂–µ—Ç–∞", rec, "–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ª–∏—Ü–µ–Ω–∑–∏–π/VM –¥–∞—ë—Ç –±—ã—Å—Ç—Ä—ã–π —ç—Ñ—Ñ–µ–∫—Ç.");
    pushGap("–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –ª—é–¥–µ–π", bus, "–°–Ω–∏–∑–∏—Ç—å bus-factor: –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è, —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã, –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∞–∫—Ç–∏–≤–æ–≤.");
    pushGap("–¢–µ—Ö–¥–æ–ª–≥", ob, "–ü–ª–∞–Ω –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –û–°/–ü–û –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –≤–µ—Ä—Å–∏–π/–ø–æ–¥–¥–µ—Ä–∂–∫–∏.");
    pushGap("–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏/–ò–ò", ai, "–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏ –µ–¥–∏–Ω—ã–π —Å–ª–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π.");

    topGaps.sort((a,b)=>a.n-b.n);
    const gapsText = topGaps.slice(0,4).map(g=>`‚Ä¢ ${g.name}: ${g.n}% ‚Äî ${g.hint}`).join("\n");

    const nextStep = "–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –ø–∏–ª–æ—Ç 4‚Äì6 –Ω–µ–¥–µ–ª—å –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –ø–µ—Ä–∏–º–µ—Ç—Ä–µ (–æ—Ñ–∏—Å/—Ñ–∏–ª–∏–∞–ª/VDI) —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞ –∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º –µ–¥–∏–Ω–æ–≥–æ —Ä–µ–µ—Å—Ç—Ä–∞ –∞–∫—Ç–∏–≤–æ–≤.";
    const text =
`C-level summary ‚Äî ${company}

PSI 2.0: ${isFinite(psi2n)?psi2n+"%":"‚Äî"} (${zone})

–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —ç—Ñ—Ñ–µ–∫—Ç (–æ—Ü–µ–Ω–∫–∞):
‚Ä¢ Cost of Inaction: ${coi} –≤ –≥–æ–¥ (—Ä—É—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ + –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–µ –ü–û + –ø—Ä–æ—Å—Ç–æ–∏)
‚Ä¢ –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –≤–æ–∑–≤—Ä–∞—Ç–∞ –±—é–¥–∂–µ—Ç–∞: ${rec}

–ö–ª—é—á–µ–≤—ã–µ –∑–æ–Ω—ã –ø—Ä–æ—Å–∞–¥–∫–∏ (—Ö—É–∂–µ ¬´–∑–¥–æ—Ä–æ–≤–æ–≥–æ —Ä—ã–Ω–∫–∞¬ª):
${gapsText || "‚Ä¢ –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –∫–ª—é—á–µ–≤—ã—Ö —Ä–∞–∑—Ä—ã–≤–æ–≤ ‚Äî –∑–∞–ø–æ–ª–Ω–∏—Ç–µ 3‚Äì5 –ø–æ–ª–µ–π (–ª–∏—Ü–µ–Ω–∑–∏–∏/VM/—Ç–µ—Ö–¥–æ–ª–≥/bus-factor)."}

–ß—Ç–æ –¥–∞—Å—Ç –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ:
‚Ä¢ –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ–± –ò–¢-–∞–∫—Ç–∏–≤–∞—Ö –∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
‚Ä¢ –°–Ω–∏–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–ø–ª–∞—Ç—ã –∑–∞ –ª–∏—Ü–µ–Ω–∑–∏–∏/—Ä–µ—Å—É—Ä—Å—ã –∏ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ —Ä—É—á–Ω—ã—Ö —Ç—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç
‚Ä¢ –°–Ω–∏–∂–µ–Ω–∏–µ —Ä–∏—Å–∫–æ–≤ –ø—Ä–æ–≤–µ—Ä–æ–∫ –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤

${nextStep}
`;
    const block = document.getElementById("cLevelBlock");
    const ta = document.getElementById("cLevelText");
    if(block && ta){
      ta.value = text;
      block.style.display = "block";
      block.scrollIntoView({behavior:"smooth", block:"start"});
    }
  }catch(e){
    console.error(e);
    alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –≤—ã–≤–æ–¥: " + e);
  }
});

document.getElementById("btnCopyCLevel").addEventListener("click", async ()=>{
  const ta=document.getElementById("cLevelText");
  if(!ta) return;
  try{ await navigator.clipboard.writeText(ta.value||""); }
  catch(e){ ta.select(); document.execCommand("copy"); }
});

document.getElementById("btnHideCLevel").addEventListener("click", ()=>{
  const block=document.getElementById("cLevelBlock");
  if(block) block.style.display="none";
});

document.getElementById("btnAddReq").addEventListener("click", ()=>addReqRow());
if(document.getElementById("btnAddProdReq")) document.getElementById("btnAddProdReq").addEventListener("click", ()=>addProdReqRow());
document.getElementById("btnClearReq").addEventListener("click", ()=>{
  if(confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è?")){ const __reqTb=document.getElementById("reqTbody");
  if(__reqTb) __reqTb.innerHTML=""; recalc(); }
});
if(document.getElementById("btnClearProdReq")) document.getElementById("btnClearProdReq").addEventListener("click", ()=>{
  if(confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø—Ä–æ–¥—É–∫—Ç—É?")){ const __prodTb=document.getElementById("prodReqTbody");
  if(__prodTb) __prodTb.innerHTML=""; recalc(); }
});
document.getElementById("btnAddPsi").addEventListener("click", ()=>addPsiRow());
document.getElementById("btnClearPsi").addEventListener("click", ()=>{
  if(confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –ü–°–ò?")){ const __psiTb=document.getElementById("psiTbody");
  if(__psiTb) __psiTb.innerHTML=""; recalc(); }
});

ensureBaseTables();
recalc();

const pdfModeEl = document.getElementById("pdfMode");
if(pdfModeEl){
  pdfModeEl.addEventListener("change", (e)=>{ setMode(e.target.value); recalc(); });
  setMode(pdfModeEl.value || "internal");
} else {
  setMode("internal");
}
updateRequiredUI();

const interviewModeEl = document.getElementById("interviewMode");
if(interviewModeEl){
  interviewModeEl.addEventListener("change",(e)=>{ setInterviewMode(e.target.value); recalc(); });
  setInterviewMode(interviewModeEl.value || "quick");
} else {
  setInterviewMode("quick");

const benchModeEl = document.getElementById("benchMode");
if(benchModeEl){
  benchModeEl.addEventListener("change",(e)=>{ recalc(); });
  if(!benchModeEl.value) benchModeEl.value = "mixed";
} else {
  // noop
}

}


/* ===================== Governance V2 additions ===================== */
function maturityLevel(maturityPct){
  if(!isFinite(maturityPct)) return "‚Äî";
  if(maturityPct >= 75) return "–í—ã—Å–æ–∫–∞—è";
  if(maturityPct >= 50) return "–°—Ä–µ–¥–Ω—è—è";
  if(maturityPct >= 35) return "–ù–∏–∂–µ —Å—Ä–µ–¥–Ω–µ–≥–æ";
  return "–ù–∏–∑–∫–∞—è";
}
function criticalityLabel(score){
  if(!isFinite(score)) return "‚Äî";
  if(score >= 75) return "–°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∞—è";
  if(score >= 50) return "–í—ã—Å–æ–∫–∞—è";
  if(score >= 25) return "–ó–Ω–∞—á–∏–º–∞—è";
  return "–ù–∏–∑–∫–∞—è";
}
function computeCriticality(coiRub, riskIdx01to5, maturityAvgPct){
  const projCostBase2 = ( (+document.getElementById("workplaces")?.value||0) + (+document.getElementById("servers")?.value||0) ) * 1300;
  const cap = projCostBase2 > 0 ? projCostBase2 : 5_000_000; // –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –ø—Ä–∞–≤–∏–ª—É: 5 –º–ª–Ω = 100 –±–∞–ª–ª–æ–≤
  const coiScore = Math.min(100, (coiRub / cap) * 100);
  const riskScale = Math.min(5, Math.max(1, riskIdx01to5 || 0)); // 1..5
  const crit = (coiScore * riskScale * (100 - maturityAvgPct)) / 500; // ~0..100
  return Math.max(0, Math.min(100, Math.round(crit)));
}
function setMode(mode){
  document.body.classList.remove("client-mode","internal-mode");
  document.body.classList.add(mode === "client" ? "client-mode" : "internal-mode");
}

function setInterviewMode(mode){
  document.body.classList.remove("quick-mode","deep-mode");
  document.body.classList.add(mode === "deep" ? "deep-mode" : "quick-mode");
}

function validateRequired(){
  const missing = [];
  const v = (id)=> (document.getElementById(id)?.value || "").trim();
  if(!v("company")) missing.push("–ö–æ–º–ø–∞–Ω–∏—è");
const psiRows = [...document.querySelectorAll("#psiTbody tr")];
  const hasPsi = psiRows.some(r=>{
    const scn=(r.querySelector(".psi-scn")?.value||"").trim();
    const exp=(r.querySelector(".psi-exp")?.value||"").trim();
    return scn && exp;
  });
  if(!hasPsi) missing.push("–ü–°–ò: —Ö–æ—Ç—è –±—ã 1 —Å—Ü–µ–Ω–∞—Ä–∏–π (—Å—Ü–µ–Ω–∞—Ä–∏–π + –æ–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç)");
  return missing;
}
function updateRequiredUI(){
  const missing = validateRequired();
  const btnPrint = document.getElementById("btnPrint");
  const st = document.getElementById("reqStatus");
  const ok = missing.length === 0;
  if(btnPrint){
    btnPrint.disabled = !ok;
    btnPrint.style.opacity = ok ? "1" : ".45";
    btnPrint.style.cursor = ok ? "pointer" : "not-allowed";
  }
  if(st){
    st.style.display = ok ? "none" : "block";
    st.textContent = "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: " + missing.join(", ");
  }
}
/* =================================================================== */


/* KPI modal removed in PSI view */
/* KPI modal removed */
<!-- KPI Explain Modal removed -->
      <button class="closeBtn" id="kpiModalClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å" onclick="kpiModalClose()">‚úï</button>
    </div>
    <div class="body">
      <div class="sect">
        <h3>1) –ß—Ç–æ —ç—Ç–æ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏</h3>
        <p id="kpiModalWhat">‚Äî</p>
      </div>
      <div class="sect">
        <h3>2) –õ–æ–≥–∏–∫–∞ —Ä–∞—Å—á—ë—Ç–∞</h3>
        <p id="kpiModalHow">‚Äî</p>
      </div>
      <div class="sect">
        <h3>2.5) –î–∞–Ω–Ω—ã–µ –∏ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç—å</h3>
        <p id="kpiModalData">‚Äî</p>
        <div id="kpiModalUnc" class="small" style="margin-top:8px;display:none">
          <div style="display:flex;justify-content:space-between;gap:12px;margin-bottom:6px">
            <span>–î–∏–∞–ø–∞–∑–æ–Ω (P25‚ÄìP75) –ø–æ –±–µ–Ω—á–º–∞—Ä–∫—É</span><span class="mono" id="kpiModalRange">‚Äî</span>
          </div>
          <div style="height:10px;border-radius:999px;border:1px solid var(--border);background:rgba(0,0,0,.06);overflow:hidden">
            <div id="kpiModalRangeBar" style="height:100%;width:0%"></div>
          </div>
        </div>
      </div>

      <div class="sect">
        <h3>3) –ù–∞ —á—Ç–æ –≤–ª–∏—è–µ—Ç</h3>
        <p id="kpiModalImpact">‚Äî</p>
      </div>
      <div class="sect">
        <h3>4) –ß—Ç–æ –¥–µ–ª–∞—Ç—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º</h3>
        <div id="kpiModalDo">‚Äî</div>
      </div>
      <div class="note" id="kpiModalNote"></div>
    </div>
  </div>
</div>


<script id="field-status-dots">
(function(){
  const REQUIRED = new Set(["company","industry","sales","lpr"]);
  const DOT_STYLE = `
    .statusDot{display:inline-block;width:8px;height:8px;border-radius:999px;margin-left:8px;vertical-align:middle;box-shadow:0 0 0 2px rgba(15,23,42,.08) inset}
    .dotRed{background:#ef4444}
    .dotBlue{background:#2563eb}
    .dotGreen{background:#22c55e}
  `;
  try{
    const st = document.createElement("style");
    st.textContent = DOT_STYLE;
    document.head.appendChild(st);
  }catch(e){}

  function ensureDot(el){
    const id = el && el.id;
    if(!id || REQUIRED.has(id)) return null;
    const label = el.closest("label") || el.parentElement;
    if(!label) return null;
    let dot = label.querySelector(`.statusDot[data-for="${id}"]`);
    if(dot) return dot;
    dot = document.createElement("span");
    dot.className = "statusDot dotRed";
    dot.setAttribute("data-for", id);
    // place dot near the label title if possible; otherwise at end
    const firstText = label.childNodes && label.childNodes[0];
    label.appendChild(dot);
    return dot;
  }

  function setDot(dot, state){
    if(!dot) return;
    dot.classList.remove("dotRed","dotBlue","dotGreen");
    dot.classList.add(state==="blue" ? "dotBlue" : (state==="green" ? "dotGreen" : "dotRed"));
  }

  function updateOne(el){
    const id = el.id;
    if(!id || REQUIRED.has(id)) return;
    const dot = ensureDot(el);
    const v = (el.value ?? "").toString().trim();
    if(!v){ setDot(dot,"red"); return; }
    const src = el.dataset.origin || "user";
    setDot(dot, src==="synthetic" ? "blue" : "green");
  }

  function clearOptionalDefaults(){
    document.querySelectorAll("input,select,textarea").forEach(el=>{
      if(!el.id || REQUIRED.has(el.id)) return;
      if(el.tagName==="SELECT") return;
      const v = (el.value ?? "").toString().trim();
      if(v==="0") el.value="";
    });
  }

  function bind(){
    document.querySelectorAll("input,select,textarea").forEach(el=>{
      if(!el.id || REQUIRED.has(el.id)) return;
      ensureDot(el);
      el.addEventListener("input", ()=>{ el.dataset.origin="user"; updateOne(el); }, {passive:true});
      el.addEventListener("change", ()=>{ el.dataset.origin="user"; updateOne(el); }, {passive:true});
    });
  }

  function updateMaturityOne(tr){
    if(!tr) return;
    const dot = tr.querySelector(".maturityDot");
    const sel = tr.querySelector("select");
    if(!dot || !sel) return;
    const v = (sel.value ?? "").toString().trim();
    if(!v){
      dot.classList.remove("dotBlue","dotGreen");
      dot.classList.add("dotRed");
      dot.title = "–ü–æ–ª–µ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ";
      return;
    }
    const synthetic = (sel.dataset.synthetic === "1") || (sel.dataset.origin === "synthetic");
    dot.classList.remove("dotRed","dotBlue","dotGreen");
    dot.classList.add(synthetic ? "dotBlue" : "dotGreen");
    dot.title = synthetic ? "–°–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ (–º–æ–∂–Ω–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å)" : "–ó–∞–ø–æ–ª–Ω–µ–Ω–æ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º";
  }

  function updateAll(){
    document.querySelectorAll("input,select,textarea").forEach(updateOne);
    document.querySelectorAll("#techTbody tr, #procTbody tr, #riskTbody tr").forEach(updateMaturityOne);
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    clearOptionalDefaults();
    bind();
    // Update on recalcs as well
    const recalcBtn = document.getElementById("btnRecalc");
    if(recalcBtn) recalcBtn.addEventListener("click", ()=>setTimeout(updateAll, 50));
    updateAll();
  });
})();
</script>


  <!-- Hidden form/iframe for cross-origin POST (bypasses fetch/beacon CSP on GitHub Pages) -->
  <iframe id="gsyncFrame" name="gsyncFrame" style="display:none"></iframe>
  <form id="gsyncForm" target="gsyncFrame" method="POST" style="display:none">
    <input type="hidden" name="action" value="save">
    <input type="hidden" name="payload" value="">
  </form>


<script>

/* === ITMEN CSP-SAFE SAVE OVERRIDE (FORM POST) === */
function syncToGoogleSheets(){
  const base = (typeof window!=="undefined" && (window.GS_WEBAPP_URL || window.GOOGLE_SHEETS_WEBAPP_URL)) ? String(window.GS_WEBAPP_URL || window.GOOGLE_SHEETS_WEBAPP_URL).trim() : "";
  if(!base){ console.warn("Google Sheets URL is not set"); return; }
  const actionUrl = base + (base.includes("?") ? "&" : "?") + "action=save";
  const payload = (typeof buildSheetPayloadExact==="function") ? buildSheetPayloadExact() : {};
  // create hidden iframe + form
  let ifr = document.getElementById("gsHiddenFrame");
  if(!ifr){
    ifr = document.createElement("iframe");
    ifr.id = "gsHiddenFrame";
    ifr.name = "gsHiddenFrame";
    ifr.style.display = "none";
    document.body.appendChild(ifr);
  }
  let form = document.getElementById("gsHiddenForm");
  if(!form){
    form = document.createElement("form");
    form.id = "gsHiddenForm";
    form.method = "POST";
    form.target = "gsHiddenFrame";
    form.style.display = "none";
    document.body.appendChild(form);
  }
  form.action = actionUrl;
  let inp = form.querySelector('input[name="payload"]');
  if(!inp){
    inp = document.createElement("input");
    inp.type = "hidden";
    inp.name = "payload";
    form.appendChild(inp);
  }
  inp.value = JSON.stringify(payload);
  try{ form.submit(); console.log("‚úÖ Sheets sync sent (form-post)"); }
  catch(e){ console.error("‚ùå Sheets sync failed (form-post)", e); }
}
/* === end override === */

</script>


<script>
  // QuickDock (search + link company param)
  (function(){
    const WEBAPP_URL = (window.GS_WEBAPP_URL || window.GOOGLE_SHEETS_WEBAPP_URL || "").trim();
    const dockCompany = document.getElementById('dockCompany');
    const dockSuggest = document.getElementById('dockSuggest');
    if(!dockCompany) return;
    function jsonp(url, timeoutMs=15000){
      return new Promise((resolve, reject)=>{
        const cb = 'cb_' + Math.random().toString(36).slice(2);
        const s = document.createElement('script');
        const t = setTimeout(()=>{ cleanup(); reject(new Error('JSONP timeout')); }, timeoutMs);
        function cleanup(){
          clearTimeout(t);
          try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
          if(s.parentNode) s.parentNode.removeChild(s);
        }
        window[cb] = (data)=>{ cleanup(); resolve(data); };
        const sep = url.includes('?') ? '&' : '?';
        s.src = url + sep + 'callback=' + encodeURIComponent(cb);
        s.onerror = ()=>{ cleanup(); reject(new Error('JSONP error')); };
        document.body.appendChild(s);
      });
    }
    function getCompanyFromUrl(){
      try{ return (new URL(location.href)).searchParams.get('company') || ''; }catch(e){ return ''; }
    }
    function setCompanyInLinks(company){
      const qs = company ? ('?company='+encodeURIComponent(company)) : '';
      document.querySelectorAll('.quickDock a.tool').forEach(a=>{
        const href = a.getAttribute('href') || '';
        if(!href || href.startsWith('http')) return;
        const clean = href.split('?')[0];
        a.setAttribute('href', clean + qs);
      });
    }
    const initial = getCompanyFromUrl();
    dockCompany.value = initial;
    setCompanyInLinks(initial);
    let timer=null;
    dockCompany.addEventListener('input', ()=>{
      clearTimeout(timer);
      const q = dockCompany.value.trim();
      setCompanyInLinks(q);
      if(q.length < 3){ dockSuggest.style.display='none'; dockSuggest.innerHTML=''; return; }
      timer = setTimeout(()=>runSearch(q), 250);
    });
    dockCompany.addEventListener('keydown', (ev)=>{
      if(ev.key === 'Enter'){
        const c = dockCompany.value.trim();
        const u = new URL(location.href);
        if(c) u.searchParams.set('company', c); else u.searchParams.delete('company');
        location.href = u.toString();
      }
    });
    const dockLoadBtn = document.getElementById('dockLoadBtn');
    if(dockLoadBtn){ dockLoadBtn.addEventListener('click', ()=>{ const ev = new KeyboardEvent('keydown',{key:'Enter'}); dockCompany.dispatchEvent(ev); }); }
    async function runSearch(q){
      if(!WEBAPP_URL) return;
      try{
        const data = await jsonp(WEBAPP_URL + '?action=search&q=' + encodeURIComponent(q) + '&limit=10');
        const items = (data && data.ok && Array.isArray(data.items)) ? data.items : [];
        if(!items.length){ dockSuggest.style.display='none'; dockSuggest.innerHTML=''; return; }
        dockSuggest.innerHTML = items.map(it=>{
          const name = (it.company||'').replaceAll('"','&quot;');
          const meta = it.timestamp ? ('<span style="color:#6b7280;font-size:12px">–æ–±–Ω–æ–≤–ª–µ–Ω–æ: '+String(it.timestamp).replaceAll('<','&lt;')+'</span>') : '';
          return '<div class="dockItem" data-company="'+name+'"><b>'+name+'</b>'+meta+'</div>';
        }).join('');
        dockSuggest.style.display='block';
        dockSuggest.querySelectorAll('.dockItem').forEach(el=>{
          el.addEventListener('click', ()=>{
            const c = el.getAttribute('data-company')||'';
            dockSuggest.style.display='none';
            dockCompany.value = c;
            setCompanyInLinks(c);
            const u = new URL(location.href);
            u.searchParams.set('company', c);
            location.href = u.toString();
          });
        });
      }catch(e){ dockSuggest.style.display='none'; }
    }
  })();

// AUTOLOAD_COMPANY
(function(){
  const u=new URL(location.href);
  const c=(u.searchParams.get('company')||'').trim();
  if(!c) return;
  // Try to load latest row for this company via search+get
  const dock=document.getElementById('dockCompany');
  if(dock) dock.value=c;
  try{
    if(typeof loadCompanyByName==='function') { loadCompanyByName(c); return; }
  }catch(e){}
  try{
    // fallback: use search endpoint and take newest row
    const url = WEBAPP_URL + '?action=search&q=' + encodeURIComponent(c) + '&limit=20';
    jsonp(url).then(res=>{
      const items = (res && (res.items||res.results||res.data)) || [];
      const list = Array.isArray(items)?items:[];
      if(!list.length) return;
      // pick newest by row/timestamp
      list.sort((a,b)=> (Number(b.row||b.r||0)-Number(a.row||a.r||0)) || String(b.timestamp||b.ts||'').localeCompare(String(a.timestamp||a.ts||'')) );
      const row = list[0].row || list[0].r;
      if(!row) return;
      const gurl = WEBAPP_URL + '?action=get&row=' + encodeURIComponent(row);
      return jsonp(gurl);
    }).then(data=>{
      const payload = (data && (data.payload || data.data || data.item && data.item.payload)) || null;
      if(payload && typeof applyPayload==='function') applyPayload(payload);
      if(typeof recalc==='function') try{recalc();}catch(e){}
    }).catch(()=>{});
  }catch(e){}
})();
</script>

<div id="globalLoader" aria-hidden="true">
  <div class="box" role="status" aria-live="polite">
    <div class="spinner"></div>
    <div>
      <p class="title" id="globalLoaderTitle">–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶</p>
      <p class="sub" id="globalLoaderSub">Google Sheets –æ—Ç–≤–µ—á–∞–µ—Ç, —ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.</p>
    </div>
  </div>
</div>

</body>
</html>

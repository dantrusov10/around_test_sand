<!doctype html>
<html lang="ru">
<head>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https: data:; connect-src 'self' https://script.google.com https://script.googleusercontent.com; img-src 'self' data: https:; frame-src https://script.google.com https://script.googleusercontent.com;">
  <script src="config.js"></script>
  <script>
function extractPayloadFromItem(item){
  let p = item;
  if(item && item.payload !== undefined) p = item.payload;
  if(typeof p === "string"){ try{ p = JSON.parse(p); }catch(e){} }
  if(p && typeof p === "object" && typeof p.payload === "string"){ try{ p.payload = JSON.parse(p.payload);}catch(e){} }
  if(p && typeof p === "object" && p.payload && typeof p.payload === "object") p = p.payload;
  return p;
}
function applyLoadedItem(item){
  const payload = extractPayloadFromItem(item);
  try{
    // IMPORTANT: these pages must apply FLAT payload from Sheets (not nested structured model).
    if(typeof applyPayload==="function"){
      applyPayload(payload);
    } else if(typeof apply==="function"){
      apply(payload);
    }
  }catch(e){
    console.warn("applyLoadedItem failed", e);
    try{ if(typeof applyPayload==="function") applyPayload(payload); }catch(_e){}
  }
  try{
    const btn = document.getElementById("btnRecalc");
    if(btn) btn.click();
  }catch(_e){}
  try{ if(typeof recalc==="function") recalc(); }catch(_e){}
}
</script>
<meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–ü—Ä–æ–¥—É–∫—Ç ‚Äî –ò–Ω—Ñ–µ—Ä–∏—Ç –ò–¢–ú–µ–Ω</title>
  <style>
    :root{
  --brand-red:#ff0000;
  --brand-red-2:#e21d35;
  --bg:#ffffff;
  --surface:#ffffff;
  --text:#111827;
  --muted:#6b7280;
  --border:#D1D1D1;
  --field:#E4E4E4;
  --field-focus:#ffffff;
  --shadow: 0 10px 30px rgba(0,0,0,.08);
  font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;

  --line: rgba(15,23,42,.12);
  --radius:16px;
  --card:#ffffff;
  --accent:#ef4444;
}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#f7f7f8 0%,#ffffff 60%);color:var(--text)}
    a{color:inherit; text-decoration:none}
    .wrap{max-width:1480px;margin:24px auto;padding:0 16px 40px}
    .card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow)}
    .pad{padding:14px}
    h1{margin:0;font-size:18px;font-weight:950}
    .sub{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.35}

    /* Table */
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 8px}
    .btn{appearance:none;border:none;background:var(--accent);color:#fff;padding:10px 12px;border-radius:12px;font-weight:900;cursor:pointer}
    .btn.ghost{background:#fff;color:var(--text);border:1px solid var(--line)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .tableWrap{overflow:auto;border:1px solid var(--line);border-radius:14px;background:#fff}
    table{border-collapse:collapse;width:100%;min-width:920px}
    th,td{padding:10px 12px;border-bottom:1px solid rgba(15,23,42,.06);text-align:left;font-size:13px;vertical-align:top}
    th{font-size:12px;color:var(--muted);font-weight:900;background:#fafbff;position:sticky;top:0}
    td textarea, td select{width:100%;border:1px solid var(--line);border-radius:12px;background:#f2f4f8;padding:10px;font-size:13px}
    td textarea{min-height:72px;resize:vertical}

    /* Status */
    .status{display:none;margin-top:10px;font-size:12px;color:#0ea5e9}

    /* QuickDock */
    .quickDock{position:fixed;left:16px;top:16px;width:320px;z-index:50}
    .quickDock .card{box-shadow:0 18px 50px rgba(15,23,42,.12)}
    .dockTitle{font-weight:950;font-size:14px;margin:0 0 10px}
    .dockSearchWrap{position:relative}
    .dockIcon{position:absolute;left:12px;top:50%;transform:translateY(-50%);opacity:.7}
    .dockSearch{width:100%;border:1px solid var(--line);background:#f2f4f8;padding:11px 12px 11px 38px;border-radius:12px;outline:none;font-size:14px}
    .dockSuggest{margin-top:8px;border:1px solid var(--line);border-radius:12px;overflow:hidden;display:none;background:#fff}
    .dockItem{padding:10px 12px;border-top:1px solid rgba(15,23,42,.06);cursor:pointer}
    .dockItem:first-child{border-top:none}
    .dockItem b{display:block}
    .toolGrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:10px}
    .tool{padding:12px;border:1px solid var(--line);border-radius:14px;background:#fff;display:flex;gap:10px;align-items:flex-start}
    .tIcon{width:28px;height:28px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.18)}
    .tName{font-weight:900;font-size:13px;line-height:1.15}
    .tDesc{font-size:12px;color:var(--muted);margin-top:3px}

    @media (max-width:1480px){
      .quickDock{position:static;width:auto;margin:0 0 14px}
    }
    @media (min-width:1101px){
      .wrap{padding-left:360px}
    }
  
#benchBadge,#benchTransparencyCard,#benchDetails,#benchProfileLabel{display:none!important;}

.dockLoadBtn{border:1px solid var(--border);background:var(--field);border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer}
.dockLoadBtn:hover{filter:brightness(0.98)}
.dockTop{display:flex;gap:10px;align-items:center}

/* Global loader */
#globalLoader{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:99999;background:rgba(255,255,255,.72);backdrop-filter: blur(6px);}
#globalLoader .box{background:#fff;border:1px solid rgba(15,23,42,.12);border-radius:16px;padding:14px 16px;box-shadow:0 18px 50px rgba(15,23,42,.12);font-weight:900}
</style>
</head>
<body>
  <div class="quickDock">
    <div class="card pad">
      <div class="dockTitle">–ë—ã—Å—Ç—Ä—ã–π –≤—Ö–æ–¥</div>
      <div class="dockSearchWrap dockTop">
        <div class="dockIcon">üîé</div>
        <input id="dockCompany" class="dockSearch" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–ø–∞–Ω–∏—é" autocomplete="off"/>
        <button id="dockLoadBtn" class="dockLoadBtn" type="button" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
      </div>
      <div id="dockSuggest" class="dockSuggest"></div>

      <div style="height:12px"></div>
      <div class="dockTitle" style="margin-bottom:0">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</div>
      <div class="toolGrid">
        <a class="tool" href="index.html"><div class="tIcon">üè†</div><div><div class="tName">–î–∞—à–±–æ—Ä–¥</div><div class="tDesc">PSI Control Center</div></div></a>
<a class="tool" href="view_1_indices.html"><div class="tIcon">üìä</div><div><div class="tName">–ò–Ω–¥–µ–∫—Å—ã</div><div class="tDesc">–±–æ—Ä–¥ –∏—Ç–æ–≥–æ–≤</div></div></a>
        <a class="tool" href="view_2_interview.html"><div class="tIcon">üéØ</div><div><div class="tName">–ò–Ω—Ç–µ—Ä–≤—å—é</div><div class="tDesc">1‚Äì3</div></div></a>
        <a class="tool" href="view_3_requirements.html"><div class="tIcon">üß™</div><div><div class="tName">–ü–∏–ª–æ—Ç</div><div class="tDesc">—Ä–∞–∑–¥–µ–ª 4</div></div></a>
        <a class="tool" href="view_3b_product.html"><div class="tIcon">üß©</div><div><div class="tName">–ü—Ä–æ–¥—É–∫—Ç</div><div class="tDesc">—Ä–∞–∑–¥–µ–ª 6</div></div></a>
        <a class="tool" href="view_4_psi.html"><div class="tIcon">üìà</div><div><div class="tName">–ü–°–ò</div><div class="tDesc">—Ä–∞–∑–¥–µ–ª 5</div></div></a>
        <a class="tool" href="view_5_full.html"><div class="tIcon">üìÑ</div><div><div class="tName">–ü–æ–ª–Ω–∞—è –∫–∞—Ä—Ç–∞</div><div class="tDesc">–≤—Å—ë —Ü–µ–ª–∏–∫–æ–º</div></div></a>
      </div>
    </div>
  </div>

  <div class="wrap">
<div style=\"display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:0 0 14px 0;\">
  <div style=\"font-weight:950;font-size:18px\">–ü—Ä–æ–¥—É–∫—Ç</div>
  <div style=\"flex:1\"></div>
  <div style=\"display:flex;gap:8px;align-items:center;\">
    <input id=\"qsInput\" placeholder=\"–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–ø–∞–Ω–∏—é‚Ä¶\" style=\"min-width:280px;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#fff\"/>
    <button id=\"qsLoad\" class=\"btn\" type=\"button\">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
  </div>
</div>
    <div class="card pad">

      <div class="card" style="padding:14px; margin-bottom:12px">
        <h2 style="margin:0;font-size:16px;font-weight:950">1) –ü–∞—Å–ø–æ—Ä—Ç –ø—Ä–æ–µ–∫—Ç–∞</h2>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px">
          <label style="display:block">
            <div style="font-size:12px;color:var(--muted);font-weight:900;margin-bottom:6px">–ö–æ–º–ø–∞–Ω–∏—è</div>
            <input id="companyName" class="dockSearch" style="padding-left:12px" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–ª–∏ –ø–æ–¥–≥—Ä—É–∑–∏—Ç–µ –∫–æ–º–ø–∞–Ω–∏—é"/>
          </label>
          <label style="display:block">
            <div style="font-size:12px;color:var(--muted);font-weight:900;margin-bottom:6px">–û—Ç—Ä–∞—Å–ª—å</div>
            <select id="industry" class="dockSearch" style="padding-left:12px">
              <option value="">‚Äî –≤—ã–±—Ä–∞—Ç—å ‚Äî</option>
              <option>–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å</option><option>–§–∏–Ω–∞–Ω—Å—ã</option><option>–†–∏—Ç–µ–π–ª</option><option>–¢–µ–ª–µ–∫–æ–º</option>
              <option>–ì–æ—Å—Å–µ–∫—Ç–æ—Ä</option><option>–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞</option><option>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç/–õ–æ–≥–∏—Å—Ç–∏–∫–∞</option>
              <option>–ú–µ–¥–∏—Ü–∏–Ω–∞</option><option>–ò–¢/–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞</option><option>–î—Ä—É–≥–æ–µ</option>
            </select>
          </label>
        </div>
      </div>

      <h1>–ü—Ä–æ–¥—É–∫—Ç</h1>
      <div class="sub">–§–∏–∫—Å–∏—Ä—É–µ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø—Ä–æ–¥—É–∫—Ç—É (roadmap/–æ—Ü–µ–Ω–∫–∞). –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ —Å—Ç–∏—Ä–∞—é—Ç –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã: –º—ã –±–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞–ø–∏—Å—å –∏–∑ Google Sheets –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –±–ª–æ–∫ 6.</div>

      <div class="btns">
        <button class="btn ghost" id="btnLoadCompany">–ü–æ–¥–≥—Ä—É–∑–∏—Ç—å</button>
        <button class="btn" id="btnSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn ghost" id="btnAdd">+ –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ</button>
        <button class="btn ghost" id="btnClear">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th style="width:54px">‚Ññ</th>
              <th style="min-width:260px">–ë–∏–∑–Ω–µ—Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ</th>
              <th style="min-width:340px">–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ</th>
              <th style="width:160px">–¢–∏–ø</th>
              <th style="width:140px">–û–±—è–∑–∞—Ç.</th>
              <th style="width:220px">–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div id="status" class="status">‚Äî</div>
    </div>
  </div>

<script>
  const WEBAPP_URL = (window.GS_WEBAPP_URL || window.GOOGLE_SHEETS_WEBAPP_URL || "").trim();

  function jsonp(url, timeoutMs=15000){
    return new Promise((resolve, reject)=>{
      const cb = "cb_" + Math.random().toString(36).slice(2);
      const s = document.createElement('script');
      const t = setTimeout(()=>{ cleanup(); reject(new Error('JSONP timeout')); }, timeoutMs);
      function cleanup(){
        clearTimeout(t);
        try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
        if(s.parentNode) s.parentNode.removeChild(s);
      }
      window[cb] = (data)=>{ cleanup(); resolve(data); };
      const sep = url.includes('?') ? '&' : '?';
      s.src = url + sep + 'callback=' + encodeURIComponent(cb);
      s.onerror = ()=>{ cleanup(); reject(new Error('JSONP error')); };
      document.body.appendChild(s);
    });
  }

  function setStatus(msg, ok=true){
    const el = document.getElementById('status');
    el.style.display = 'block';
    el.style.color = ok ? '#16a34a' : '#ef4444';
    el.textContent = msg;
  }

  const TYPES = ["–¢–µ—Ö","–ü—Ä–æ—Ü","–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è","–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å","–û—Ç—á–µ—Ç","–î—Ä—É–≥–æ–µ"];
  const MUST = ["–î–∞","–ù–µ—Ç"];
  const FEAS = ["–ï—Å—Ç—å","–ß–∞—Å—Ç–∏—á–Ω–æ","–ù–µ—Ç"];

  const tbody = document.getElementById('tbody');
  let loadedBase = null; // full payload from last record
  let loadedCompany = "";

  function rowTpl(i, r={}){
    const typeOpts = ['<option value=""></option>'].concat(TYPES.map(x=>`<option ${r.type===x?'selected':''}>${x}</option>`)).join('');
    const mustOpts = ['<option value=""></option>'].concat(MUST.map(x=>`<option ${r.must===x?'selected':''}>${x}</option>`)).join('');
    const feasOpts = ['<option value=""></option>'].concat(FEAS.map(x=>`<option ${r.feas===x?'selected':''}>${x}</option>`)).join('');
    return `\
      <tr>\
        <td>${i+1}</td>\
        <td><textarea data-k="biz">${(r.biz||'').replaceAll('\\n','\n')}</textarea></td>\
        <td><textarea data-k="func">${(r.func||'').replaceAll('\\n','\n')}</textarea></td>\
        <td><select data-k="type">${typeOpts}</select></td>\
        <td><select data-k="must">${mustOpts}</select></td>\
        <td><select data-k="feas">${feasOpts}</select></td>\
      </tr>`;
  }

  function render(rows){
    tbody.innerHTML = rows.map((r,i)=>rowTpl(i,r)).join('');
  }

  function collect(){
    const out = [];
    [...tbody.querySelectorAll('tr')].forEach(tr=>{
      const biz = tr.querySelector('[data-k="biz"]').value.trim();
      const func = tr.querySelector('[data-k="func"]').value.trim();
      const type = tr.querySelector('[data-k="type"]').value;
      const must = tr.querySelector('[data-k="must"]').value;
      const feas = tr.querySelector('[data-k="feas"]').value;
      if(!biz && !func && !type && !must && !feas) return;
      out.push({biz, func, type, must, feas});
    });
    return out;
  }

  function getCompanyFromUrl(){
    const u = new URL(location.href);
    return (u.searchParams.get('company')||'').trim();
  }

  async function loadCompany(company){
    if(!WEBAPP_URL) { setStatus('GS_WEBAPP_URL –ø—É—Å—Ç–æ–π. –ü—Ä–æ–≤–µ—Ä—å config.js', false); return; }
    if(!company) return;

    setStatus('–ó–∞–≥—Ä—É–∂–∞—é –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞–ø–∏—Å—å‚Ä¶', true);
    const data = await jsonp(WEBAPP_URL + '?action=get&company=' + encodeURIComponent(company));
    if(!data || !data.ok || !data.payload){ setStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ (action=get)', false); return; }

    const p = data.payload;
    const parsed = p._payload_parsed && typeof p._payload_parsed === 'object' ? p._payload_parsed : null;
    loadedBase = parsed || { company: (p.company||company) };
    loadedCompany = (p.company || company);

    const cn = document.getElementById('companyName');
    if(cn) cn.value = loadedCompany;
    const ind = document.getElementById('industry');
    if(ind && (loadedBase.industry||loadedBase.industryName)) ind.value = (loadedBase.industry||loadedBase.industryName);

    const pr = loadedBase.productRequirements || loadedBase.prodRequirements || loadedBase.prodreq || [];
    render(Array.isArray(pr) ? pr : []);
    setStatus('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ' + loadedCompany);
  }

  async function save(){
    if(!WEBAPP_URL) { setStatus('GS_WEBAPP_URL –ø—É—Å—Ç–æ–π. –ü—Ä–æ–≤–µ—Ä—å config.js', false); return; }
    const company = (document.getElementById('companyName')?.value || loadedCompany || getCompanyFromUrl() || '').trim();
    if(!company){ setStatus('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –∫–æ–º–ø–∞–Ω–∏—é', false); return; }

    const prod = collect();

    // Merge into last loaded payload (so we don't wipe other sections)
    const base = loadedBase && typeof loadedBase === 'object' ? JSON.parse(JSON.stringify(loadedBase)) : { company };
    base.company = company;
    const ind = (document.getElementById('industry')?.value||'').trim();
    if(ind) base.industry = ind;
    base.productRequirements = prod;

    const baseNoPayload = JSON.parse(JSON.stringify(base));
    delete baseNoPayload.payload;

    // For sheet columns: store full JSON into `payload`
    const toSheet = {
      company,
      payload: JSON.stringify(baseNoPayload),
      _upsert: false
    };

    setStatus('‚è´ –°–æ—Ö—Ä–∞–Ω—è—é –≤ Google Sheets‚Ä¶', true);
    await fetch(WEBAPP_URL + (WEBAPP_URL.includes('?')?'&':'?') + 'action=save', {
      method:'POST', mode:'no-cors', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify(toSheet)
    });
    setStatus('‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Google Sheets');
  }

  // Buttons
  document.getElementById('btnAdd').addEventListener('click', ()=>{
    const rows = collect();
    rows.push({});
    render(rows);
  });
  document.getElementById('btnClear').addEventListener('click', ()=>render([]));
  document.getElementById('btnSave').addEventListener('click', ()=>save().catch(e=>setStatus('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: '+(e?.message||e), false)));


  document.getElementById('btnLoadCompany')?.addEventListener('click', ()=> {
    const c = (document.getElementById('dockCompany')?.value || document.getElementById('companyName')?.value || '').trim();
    if(!c) return setStatus('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –∫–æ–º–ø–∞–Ω–∏—é', false);
    const cn = document.getElementById('companyName'); if(cn) cn.value = c;
    loadCompany(c).catch(e=>setStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: '+(e?.message||e), false));
  });

  document.getElementById('dockLoadBtn')?.addEventListener('click', ()=> {
    const c = (document.getElementById('dockCompany')?.value || '').trim();
    if(!c) return;
    const u = new URL(location.href); u.searchParams.set('company', c);
    // –Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É ‚Äî –ø—Ä–æ—Å—Ç–æ –≥—Ä—É–∑–∏–º
    history.replaceState(null,'',u.toString());
    const cn = document.getElementById('companyName'); if(cn) cn.value = c;
    loadCompany(c).catch(e=>setStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: '+(e?.message||e), false));
  });


  // Dock search
  const dockCompany = document.getElementById('dockCompany');
  const dockSuggest = document.getElementById('dockSuggest');
  let dockTimer=null;

  dockCompany.value = getCompanyFromUrl();

  dockCompany.addEventListener('input', ()=>{
    clearTimeout(dockTimer);
    const q = dockCompany.value.trim();
    if(q.length < 3){ dockSuggest.style.display='none'; dockSuggest.innerHTML=''; return; }
    dockTimer = setTimeout(()=>dockSearch(q), 250);
  });

  async function dockSearch(q){
    if(!WEBAPP_URL) return;
    const data = await jsonp(WEBAPP_URL + '?action=search&q=' + encodeURIComponent(q) + '&limit=10');
    const items = (data && data.ok && Array.isArray(data.items)) ? data.items : [];
    if(!items.length){ dockSuggest.style.display='none'; dockSuggest.innerHTML=''; return; }
    dockSuggest.innerHTML = items.map(it=>`<div class="dockItem" data-company="${(it.company||'').replaceAll('"','&quot;')}"><b>${it.company||''}</b><span style="color:var(--muted);font-size:12px">${it.timestamp?('–æ–±–Ω–æ–≤–ª–µ–Ω–æ: '+it.timestamp):''}</span></div>`).join('');
    dockSuggest.style.display='block';
    dockSuggest.querySelectorAll('.dockItem').forEach(el=>{
      el.addEventListener('click', ()=>{
        const c = el.getAttribute('data-company')||'';
        dockSuggest.style.display='none';
        dockCompany.value = c;
        const u = new URL(location.href);
        u.searchParams.set('company', c);
        location.href = u.toString();
      });
    });
  }

  // Initial load
  const initialCompany = getCompanyFromUrl();
  if(initialCompany){ loadCompany(initialCompany).catch(e=>setStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: '+(e?.message||e), false)); }
  else render([]);
</script>


<script>
/* === Unified QuickDock + Sheets loader (no page reload) === */
(function(){
  const WEBAPP_URL = (window.GS_WEBAPP_URL || window.GOOGLE_SHEETS_WEBAPP_URL || "").trim();
  window.WEBAPP_URL = WEBAPP_URL; // expose for legacy code
  const dockCompany = document.getElementById("dockCompany");
  const dockSuggest = document.getElementById("dockSuggest");
  const dockLoadBtn = document.getElementById("dockLoadBtn");
  if(!dockCompany || !dockSuggest) return;

  function setUrlCompany(company){
    try{
      const u = new URL(location.href);
      if(company) u.searchParams.set("company", company); else u.searchParams.delete("company");
      history.replaceState(null, "", u.toString());
    }catch(e){}
  }

  function showGlobalLoader(title, sub){
    const gl = document.getElementById("globalLoader");
    if(!gl) return;
    const t = document.getElementById("globalLoaderTitle");
    const s = document.getElementById("globalLoaderSub");
    if(t && title) t.textContent = title;
    if(s && sub) s.textContent = sub;
    gl.style.display = "flex";
    gl.setAttribute("aria-hidden","false");
  }
  function hideGlobalLoader(){
    const gl = document.getElementById("globalLoader");
    if(!gl) return;
    gl.style.display = "none";
    gl.setAttribute("aria-hidden","true");
  }

  function jsonp(url, timeoutMs=20000){
    return new Promise((resolve, reject)=>{
      const cb = "cb_" + Math.random().toString(36).slice(2) + "_" + Date.now();
      const sep = url.includes("?") ? "&" : "?";
      const full = url + sep + "callback=" + encodeURIComponent(cb);
      const s = document.createElement("script");
      s.async = true;
      let done=false;
      const cleanup = ()=>{
        if(done) return; done=true;
        try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
        try{ s.remove(); }catch(e){}
      };
      const timer = setTimeout(()=>{ cleanup(); reject(new Error("JSONP timeout")); }, timeoutMs);
      window[cb] = (data)=>{ clearTimeout(timer); cleanup(); resolve(data); };
      s.onerror = ()=>{ clearTimeout(timer); cleanup(); reject(new Error("JSONP error")); };
      s.src = full;
      document.body.appendChild(s);
    });
  }
  window.__gs_jsonp = jsonp;

  async function gsSearch(q){
    if(!WEBAPP_URL) return [];
    const data = await jsonp(WEBAPP_URL + "?action=search&q=" + encodeURIComponent(q) + "&limit=10");
    return (data && data.ok && Array.isArray(data.items)) ? data.items : [];
  }
  async function gsGetRow(row){
    if(!WEBAPP_URL) throw new Error("WEBAPP_URL empty");
    const data = await jsonp(WEBAPP_URL + "?action=get&row=" + encodeURIComponent(row));
    return (data && (data.payload || data.item)) || null;
  }

  function applyAnyPayload(obj){
    if(!obj) return;
    try{
      if(typeof applyLoadedItem === "function"){ applyLoadedItem(obj); return; }
    }catch(e){}
    try{
      if(typeof applyPayload === "function"){ applyPayload(obj); }
      else if(typeof apply === "function"){ apply(obj); }
    }catch(e){ console.warn("applyAnyPayload failed", e); }
    try{ if(typeof recalc==="function") recalc(); }catch(e){}
  }

  async function loadCompanyByRow(row, companyLabel){
    showGlobalLoader("–ó–∞–≥—Ä—É–∂–∞—é –¥–∞–Ω–Ω—ã–µ‚Ä¶", "–ß–∏—Ç–∞—é –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ç—Ä–æ–∫—É –∏–∑ Google Sheets.");
    try{
      const item = await gsGetRow(row);
      applyAnyPayload(item);
      if(companyLabel){
        dockCompany.value = companyLabel;
        setUrlCompany(companyLabel);
        setCompanyInLinks(companyLabel);
      }
    }catch(e){
      console.error("Load company failed", e);
      alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google Sheets. –ü—Ä–æ–≤–µ—Ä—å –¥–æ—Å—Ç—É–ø –∫ WebApp –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ç–≤–µ—Ç–∞.");
    }finally{
      hideGlobalLoader();
    }
  }

  async function loadCompanyByName(name){
    const q = (name||"").trim();
    if(!q) return;
    showGlobalLoader("–ò—â—É –∫–æ–º–ø–∞–Ω–∏—é‚Ä¶", "–°–≤–µ—Ä—è—é –ø–æ —Å–ø–∏—Å–∫—É –≤ Google Sheets.");
    try{
      const items = await gsSearch(q);
      if(!items.length){ alert("–ö–æ–º–ø–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ Google Sheets"); return; }
      items.sort((a,b)=> (Number(b.row||0)-Number(a.row||0)));
      await loadCompanyByRow(items[0].row, items[0].company);
    }finally{
      hideGlobalLoader();
    }
  }
  window.loadCompanyByName = loadCompanyByName;

  function setCompanyInLinks(company){
    const qs = company ? ("?company="+encodeURIComponent(company)) : "";
    document.querySelectorAll(".quickDock a.tool").forEach(a=>{
      const href = a.getAttribute("href") || "";
      if(!href || href.startsWith("http")) return;
      a.setAttribute("href", href.split("?")[0] + qs);
    });
  }

  // UI behaviour
  let timer=null;
  dockCompany.addEventListener("input", ()=>{
    clearTimeout(timer);
    const q = dockCompany.value.trim();
    setUrlCompany(q);
    setCompanyInLinks(q);
    if(q.length < 2){
      dockSuggest.style.display="none"; dockSuggest.innerHTML="";
      return;
    }
    dockSuggest.style.display="block";
    dockSuggest.innerHTML = '<div class="dockItem"><b>–ü–æ–∏—Å–∫‚Ä¶</b><span style="color:#6b7280;font-size:12px">–æ–∂–∏–¥–∞–π—Ç–µ</span></div>';
    timer=setTimeout(async ()=>{
      try{
        const items = await gsSearch(q);
        if(!items.length){ dockSuggest.style.display="none"; dockSuggest.innerHTML=""; return; }
        dockSuggest.innerHTML = items.map(it=>{
          const name = String(it.company||"").replaceAll('"','&quot;');
          const meta = it.timestamp ? ('<span style="color:#6b7280;font-size:12px">–æ–±–Ω–æ–≤–ª–µ–Ω–æ: '+String(it.timestamp).replaceAll('<','&lt;')+'</span>') : '';
          return '<div class="dockItem" data-row="'+it.row+'" data-company="'+name+'"><b>'+name+'</b>'+meta+'</div>';
        }).join("");
        dockSuggest.style.display="block";
        dockSuggest.querySelectorAll(".dockItem").forEach(el=>{
          const row = Number(el.getAttribute("data-row")||0);
          const comp = el.getAttribute("data-company")||"";
          if(!row) return;
          el.addEventListener("click", ()=>{
            dockSuggest.style.display="none";
            dockSuggest.innerHTML="";
            loadCompanyByRow(row, comp);
          });
        });
      }catch(e){
        dockSuggest.style.display="none"; dockSuggest.innerHTML="";
      }
    }, 250);
  });

  dockCompany.addEventListener("keydown", (ev)=>{
    if(ev.key === "Enter"){
      ev.preventDefault();
      const name = dockCompany.value.trim();
      loadCompanyByName(name);
    }
  });

  if(dockLoadBtn){
    dockLoadBtn.addEventListener("click", ()=>{
      const name = dockCompany.value.trim();
      loadCompanyByName(name);
    });
  }

  // autoload from URL
  try{
    const u = new URL(location.href);
    const c = (u.searchParams.get("company")||"").trim();
    if(c){
      dockCompany.value = c;
      setCompanyInLinks(c);
      loadCompanyByName(c);
    }
  }catch(e){}
})();
</script>

<div id="globalLoader" aria-hidden="true">
  <div class="box" role="status" aria-live="polite">
    <div class="spinner"></div>
    <div>
      <p class="title" id="globalLoaderTitle">–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶</p>
      <p class="sub" id="globalLoaderSub">Google Sheets –æ—Ç–≤–µ—á–∞–µ—Ç, —ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.</p>
    </div>
  </div>
<script>
const TECH = [
  {label:"T1. –ï—Å—Ç—å –ª–∏ –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–º –ü–û?", mode:"both"},
  {label:"T2. –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω –ª–∏ —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –æ–± –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–µ (–±–µ–∑ —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞)?", mode:"both"},
  {label:"T3. –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ –ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –¥—É–±–ª–µ–π —É—Å—Ç—Ä–æ–π—Å—Ç–≤?", mode:"both"},
  {label:"T4. –ï—Å—Ç—å –ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –≤ —Å–µ—Ç–∏?", mode:"both"},
  {label:"T5. –û–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ª–∏ –¥–∞–Ω–Ω—ã–µ –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –∏ –ü–û –±–µ–∑ —Ä—É—á–Ω–æ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞?", mode:"both"},
  {label:"T6. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ª–∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –ü–û?", mode:"deep"},
  {label:"T7. –ï—Å—Ç—å –ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—è–≤–ª–µ–Ω–∏–µ –Ω–µ—Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–æ–≥–æ –∏–ª–∏ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω–æ–≥–æ –ü–û?", mode:"deep"},
  {label:"T8. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏ –¥–∞–Ω–Ω—ã–µ –æ–± –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏ –≤ –¥—Ä—É–≥–∏—Ö —Å–∏—Å—Ç–µ–º–∞—Ö (ITSM, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –ª–∏—Ü–µ–Ω–∑–∏—Ä–æ–≤–∞–Ω–∏–µ)?", mode:"deep"},
  {label:"T9. –û—Ö–≤–∞—á–µ–Ω—ã –ª–∏ —Å–±–æ—Ä–æ–º –¥–∞–Ω–Ω—ã—Ö –≤—Å–µ —Å–µ–≥–º–µ–Ω—Ç—ã –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (VDI, —Ñ–∏–ª–∏–∞–ª—ã, –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç—É—Ä—ã)?", mode:"deep"},
  {label:"T10. –í–æ–∑–º–æ–∂–Ω–æ –ª–∏ —Ä–∞—Å—à–∏—Ä—è—Ç—å –º–æ–¥–µ–ª—å —Å–æ–±–∏—Ä–∞–µ–º—ã—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –±–µ–∑ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏?", mode:"deep"}
];

const PROC = [
  {label:"P1. –§–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å —É—á–µ—Ç–∞ –ò–¢-–∞–∫—Ç–∏–≤–æ–≤?", mode:"both"},
  {label:"P2. –ù–∞–∑–Ω–∞—á–µ–Ω –ª–∏ –≤–ª–∞–¥–µ–ª–µ—Ü –ø—Ä–æ—Ü–µ—Å—Å–∞ —É—á–µ—Ç–∞ –∞–∫—Ç–∏–≤–æ–≤?", mode:"both"},
  {label:"P3. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏ –¥–∞–Ω–Ω—ã–µ –æ–± –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏?", mode:"both"},
  {label:"P4. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏ –¥–∞–Ω–Ω—ã–µ –æ–± –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞–º–∏?", mode:"both"},
  {label:"P5. –ï—Å—Ç—å –ª–∏ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç –∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –∏ –ü–û?", mode:"both"},
  {label:"P6. –ü—Ä–æ–≤–æ–¥–∏—Ç—Å—è –ª–∏ —Ä–µ–≥—É–ª—è—Ä–Ω–∞—è —Å–≤–µ—Ä–∫–∞ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å —É—á–µ—Ç–Ω–æ–π?", mode:"deep"},
  {label:"P7. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏ –¥–∞–Ω–Ω—ã–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–∫—É–ø–æ–∫ –ü–û?", mode:"deep"},
  {label:"P8. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã—Ö —Ä–∏—Å–∫–æ–≤?", mode:"deep"},
  {label:"P9. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–µ—â–µ–Ω–Ω–æ–≥–æ –ü–û?", mode:"deep"},
  {label:"P10. –ï—Å—Ç—å –ª–∏ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç —Ä–µ–∞–∫—Ü–∏–∏ –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ/–Ω–µ—É—á—Ç–µ–Ω–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞?", mode:"deep"}
];

const RISK = [
  {label:"–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–∞—è (–º–Ω–æ–≥–æ —Ñ–∏–ª–∏–∞–ª–æ–≤/–ø–ª–æ—â–∞–¥–æ–∫)", mode:"both"},
  {label:"–ü–∞—Ä–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –±—ã—Å—Ç—Ä–æ —Ä–∞—Å—Ç–µ—Ç/–º–µ–Ω—è–µ—Ç—Å—è", mode:"both"},
  {label:"–ú–Ω–æ–≥–æ —Ä—É—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —É—á–µ—Ç–µ –∞–∫—Ç–∏–≤–æ–≤", mode:"both"},
  {label:"–ï—Å—Ç—å —Ä–∏—Å–∫ –Ω–µ—É—á—Ç–µ–Ω–Ω—ã—Ö —É—Å—Ç–∞–Ω–æ–≤–æ–∫ –ü–û", mode:"both"},
  {label:"–ï—Å—Ç—å —á–∞—Å—Ç—ã–µ –∏–Ω—Ü–∏–¥–µ–Ω—Ç—ã/–ø—Ä–æ—Å—Ç–æ–∏ (–ø–æ –æ—â—É—â–µ–Ω–∏—è–º –±–∏–∑–Ω–µ—Å–∞)", mode:"both"},
  {label:"–ë—ã–ª–∏ –≤–Ω–µ—à–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –≥–æ–¥–∞", mode:"deep"},
  {label:"–ü–ª–∞–Ω–∏—Ä—É—é—Ç—Å—è –∫—Ä—É–ø–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≤ 12 –º–µ—Å—è—Ü–µ–≤ (–º–∏–≥—Ä–∞—Ü–∏–∏/—Å–ª–∏—è–Ω–∏—è)", mode:"deep"},
  {label:"–í—ã—Å–æ–∫–∞—è —Ç–µ–∫—É—á–µ—Å—Ç—å –ò–¢-–ø–µ—Ä—Å–æ–Ω–∞–ª–∞/—Å–º–µ–Ω–∞ –ø–æ–¥—Ä—è–¥—á–∏–∫–æ–≤", mode:"deep"}
];

const FEAS_OPTIONS = [
  { label: "‚Äî", score: null },
  { label: "–ü–æ–ª–Ω–æ—Å—Ç—å—é", score: 1.00 },
  { label: "–ß–∞—Å—Ç–∏—á–Ω–æ", score: 0.60 },
  { label: "–ù–µ—Ç", score: 0.00 },
  { label: "–ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏", score: 0.00 },
  { label: "–•–∞—Ä–¥ –∫–æ–¥ (—Å–∫–æ—Ä–æ)", score: 0.70 },
  { label: "–•–∞—Ä–¥ –∫–æ–¥ (–°–∫–æ—Ä–æ)", score: 0.70 },
  { label: "–•–∞—Ä–¥ –∫–æ–¥ (–Ω–µ —Å–∫–æ—Ä–æ)", score: 0.30 },
  { label: "–¢—Ä–µ–±—É–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç", score: 0.50 },
];

function fmtMoney(n){ if(!isFinite(n)) return "‚Äî"; return Math.round(n).toLocaleString("ru-RU")+" ‚ÇΩ"; }
function clampInt(v,min,max){ v=parseInt(v,10); if(isNaN(v)) v=min; return Math.min(max,Math.max(min,v)); }
function clamp(v,min,max){ v=+v; if(!isFinite(v)) return min; return Math.min(max, Math.max(min, v)); }
function debounce(fn,ms){ let t; return (...a)=>{clearTimeout(t); t=setTimeout(()=>fn(...a),ms)}; }
const avg = arr => arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0;


/* ===================== Benchmark engine (Iteration 1 + 2) ===================== */

// Benchmarks are *synthetic but realistic* ranges (P25‚ÄìP75) by Industry + Size bucket.
// NOTE: All values are percentages unless stated otherwise.
const BENCH = {
  "–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å": {
    "1-2k":   { manualPct:{m:34,p25:26,p75:44}, unusedPct:{m:18,p25:12,p75:27}, vmUnusedPct:{m:22,p25:15,p75:32},
              incidentsPerMonth:{m:14,p25:8,p75:22}, downtimeHours:{m:26,p25:14,p75:40}, downtimeCost:{m:350000,p25:120000,p75:650000},
              obsoletePct:{m:32,p25:22,p75:44}, keyPeopleRisk:{m:1,p25:1,p75:2}, docScore:{m:0.8,p25:0,p75:1} },
    "2-10k":  { manualPct:{m:38,p25:30,p75:50}, unusedPct:{m:20,p25:13,p75:30}, vmUnusedPct:{m:26,p25:18,p75:36},
              incidentsPerMonth:{m:22,p25:14,p75:35}, downtimeHours:{m:42,p25:24,p75:70}, downtimeCost:{m:550000,p25:220000,p75:1000000},
              obsoletePct:{m:35,p25:25,p75:48}, keyPeopleRisk:{m:1,p25:1,p75:2}, docScore:{m:0.7,p25:0,p75:1} },
    "10k+":   { manualPct:{m:42,p25:34,p75:54}, unusedPct:{m:22,p25:15,p75:34}, vmUnusedPct:{m:28,p25:20,p75:38},
              incidentsPerMonth:{m:30,p25:18,p75:45}, downtimeHours:{m:60,p25:36,p75:95}, downtimeCost:{m:900000,p25:350000,p75:1700000},
              obsoletePct:{m:30,p25:20,p75:42}, keyPeopleRisk:{m:1,p25:1,p75:2}, docScore:{m:0.9,p25:0,p75:2} }
  },
  "–§–∏–Ω–∞–Ω—Å—ã": {
    "1-2k":   { manualPct:{m:28,p25:20,p75:38}, unusedPct:{m:16,p25:10,p75:24}, vmUnusedPct:{m:20,p25:12,p75:30},
              incidentsPerMonth:{m:10,p25:6,p75:16}, downtimeHours:{m:18,p25:10,p75:28}, downtimeCost:{m:650000,p25:250000,p75:1300000},
              obsoletePct:{m:22,p25:14,p75:32}, keyPeopleRisk:{m:1,p25:1,p75:2}, docScore:{m:1.2,p25:1,p75:2} },
    "2-10k":  { manualPct:{m:32,p25:24,p75:42}, unusedPct:{m:18,p25:12,p75:27}, vmUnusedPct:{m:22,p25:14,p75:32},
              incidentsPerMonth:{m:16,p25:10,p75:26}, downtimeHours:{m:30,p25:18,p75:48}, downtimeCost:{m:1100000,p25:450000,p75:2200000},
              obsoletePct:{m:24,p25:16,p75:36}, keyPeopleRisk:{m:1,p25:1,p75:2}, docScore:{m:1.3,p25:1,p75:2} },
    "10k+":   { manualPct:{m:34,p25:26,p75:44}, unusedPct:{m:20,p25:13,p75:30}, vmUnusedPct:{m:24,p25:16,p75:34},
              incidentsPerMonth:{m:22,p25:14,p75:34}, downtimeHours:{m:44,p25:28,p75:70}, downtimeCost:{m:1800000,p25:800000,p75:3500000},
              obsoletePct:{m:20,p25:12,p75:30}, keyPeopleRisk:{m:1,p25:1,p75:2}, docScore:{m:1.5,p25:1,p75:2} }
  },
  "–¢–µ–ª–µ–∫–æ–º": {
    "1-2k":   { manualPct:{m:32,p25:24,p75:42}, unusedPct:{m:17,p25:11,p75:26}, vmUnusedPct:{m:24,p25:16,p75:34},
              incidentsPerMonth:{m:18,p25:10,p75:28}, downtimeHours:{m:34,p25:20,p75:52}, downtimeCost:{m:500000,p25:200000,p75:950000},
              obsoletePct:{m:28,p25:18,p75:40}, keyPeopleRisk:{m:1,p25:1,p75:2}, docScore:{m:0.9,p25:0,p75:2} },
    "2-10k":  { manualPct:{m:36,p25:28,p75:48}, unusedPct:{m:19,p25:12,p75:29}, vmUnusedPct:{m:28,p25:20,p75:38},
              incidentsPerMonth:{m:28,p25:16,p75:42}, downtimeHours:{m:55,p25:34,p75:85}, downtimeCost:{m:850000,p25:350000,p75:1600000},
              obsoletePct:{m:30,p25:20,p75:42}, keyPeopleRisk:{m:1,p25:1,p75:2}, docScore:{m:0.8,p25:0,p75:1} },
    "10k+":   { manualPct:{m:38,p25:30,p75:50}, unusedPct:{m:20,p25:13,p75:31}, vmUnusedPct:{m:30,p25:22,p75:40},
              incidentsPerMonth:{m:36,p25:22,p75:55}, downtimeHours:{m:80,p25:50,p75:120}, downtimeCost:{m:1400000,p25:650000,p75:2600000},
              obsoletePct:{m:26,p25:16,p75:38}, keyPeopleRisk:{m:1,p25:1,p75:2}, docScore:{m:1.0,p25:0,p75:2} }
  },
  "–†–∏—Ç–µ–π–ª": {
    "1-2k":   { manualPct:{m:36,p25:28,p75:46}, unusedPct:{m:19,p25:12,p75:28}, vmUnusedPct:{m:20,p25:12,p75:30},
              incidentsPerMonth:{m:16,p25:10,p75:26}, downtimeHours:{m:28,p25:16,p75:44}, downtimeCost:{m:250000,p25:90000,p75:500000},
              obsoletePct:{m:34,p25:24,p75:46}, keyPeopleRisk:{m:2,p25:1,p75:2}, docScore:{m:0.6,p25:0,p75:1} },
    "2-10k":  { manualPct:{m:40,p25:32,p75:52}, unusedPct:{m:22,p25:14,p75:34}, vmUnusedPct:{m:24,p25:16,p75:34},
              incidentsPerMonth:{m:24,p25:14,p75:38}, downtimeHours:{m:46,p25:28,p75:72}, downtimeCost:{m:420000,p25:160000,p75:850000},
              obsoletePct:{m:36,p25:26,p75:50}, keyPeopleRisk:{m:2,p25:1,p75:2}, docScore:{m:0.6,p25:0,p75:1} },
    "10k+":   { manualPct:{m:42,p25:34,p75:54}, unusedPct:{m:24,p25:16,p75:36}, vmUnusedPct:{m:26,p25:18,p75:36},
              incidentsPerMonth:{m:32,p25:20,p75:50}, downtimeHours:{m:70,p25:44,p75:110}, downtimeCost:{m:650000,p25:260000,p75:1300000},
              obsoletePct:{m:32,p25:22,p75:46}, keyPeopleRisk:{m:2,p25:1,p75:2}, docScore:{m:0.7,p25:0,p75:2} }
  },
  "–ì–æ—Å—Å–µ–∫—Ç–æ—Ä": {
    "1-2k":   { manualPct:{m:40,p25:32,p75:52}, unusedPct:{m:14,p25:9,p75:22}, vmUnusedPct:{m:18,p25:10,p75:28},
              incidentsPerMonth:{m:12,p25:7,p75:20}, downtimeHours:{m:22,p25:12,p75:36}, downtimeCost:{m:120000,p25:50000,p75:260000},
              obsoletePct:{m:42,p25:32,p75:55}, keyPeopleRisk:{m:2,p25:1,p75:2}, docScore:{m:0.7,p25:0,p75:1} },
    "2-10k":  { manualPct:{m:44,p25:36,p75:56}, unusedPct:{m:16,p25:10,p75:25}, vmUnusedPct:{m:20,p25:12,p75:30},
              incidentsPerMonth:{m:18,p25:10,p75:30}, downtimeHours:{m:36,p25:20,p75:60}, downtimeCost:{m:180000,p25:80000,p75:400000},
              obsoletePct:{m:45,p25:35,p75:60}, keyPeopleRisk:{m:2,p25:1,p75:2}, docScore:{m:0.7,p25:0,p75:1} },
    "10k+":   { manualPct:{m:46,p25:38,p75:58}, unusedPct:{m:18,p25:12,p75:28}, vmUnusedPct:{m:22,p25:14,p75:32},
              incidentsPerMonth:{m:24,p25:14,p75:40}, downtimeHours:{m:55,p25:34,p75:90}, downtimeCost:{m:260000,p25:120000,p75:550000},
              obsoletePct:{m:40,p25:30,p75:55}, keyPeopleRisk:{m:2,p25:1,p75:2}, docScore:{m:0.8,p25:0,p75:2} }
  },
  "–ò–¢/–∏–Ω—Ç–µ–≥—Ä–∞—Ç–æ—Ä": {
    "1-2k":   { manualPct:{m:30,p25:22,p75:40}, unusedPct:{m:21,p25:13,p75:32}, vmUnusedPct:{m:26,p25:18,p75:36},
              incidentsPerMonth:{m:14,p25:8,p75:22}, downtimeHours:{m:20,p25:12,p75:32}, downtimeCost:{m:220000,p25:90000,p75:500000},
              obsoletePct:{m:24,p25:16,p75:34}, keyPeopleRisk:{m:1,p25:1,p75:2}, docScore:{m:0.9,p25:0,p75:2} },
    "2-10k":  { manualPct:{m:34,p25:26,p75:46}, unusedPct:{m:24,p25:16,p75:36}, vmUnusedPct:{m:30,p25:22,p75:40},
              incidentsPerMonth:{m:20,p25:12,p75:32}, downtimeHours:{m:32,p25:20,p75:50}, downtimeCost:{m:350000,p25:150000,p75:800000},
              obsoletePct:{m:26,p25:18,p75:38}, keyPeopleRisk:{m:1,p25:1,p75:2}, docScore:{m:1.0,p25:0,p75:2} },
    "10k+":   { manualPct:{m:36,p25:28,p75:48}, unusedPct:{m:26,p25:18,p75:38}, vmUnusedPct:{m:32,p25:24,p75:42},
              incidentsPerMonth:{m:26,p25:16,p75:40}, downtimeHours:{m:44,p25:28,p75:70}, downtimeCost:{m:600000,p25:250000,p75:1300000},
              obsoletePct:{m:22,p25:14,p75:34}, keyPeopleRisk:{m:1,p25:1,p75:2}, docScore:{m:1.1,p25:0,p75:2} }
  }
};

function sizeBucket(totalEndpoints){
  const n = +totalEndpoints || 0;
  if(n <= 2000) return "1-2k";
  if(n <= 10000) return "2-10k";
  return "10k+";
}

function getProfile(){
  const industry = (document.getElementById("industry")?.value || "").trim() || "–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å";
  const workplaces = (+document.getElementById("workplaces")?.value || 0);
  const servers = (+document.getElementById("servers")?.value || 0);
  const total = workplaces + servers;
  const bucket = sizeBucket(total);
  const vdi = (document.getElementById("vdi")?.value || "").trim();
  const closed = (document.getElementById("closed")?.value || "").trim();
  const branches = (+document.getElementById("branches")?.value || 0);
  return {industry, bucket, total, workplaces, servers, vdi, closed, branches};
}


const BENCH_MATURITY = {
  "–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å": {"1-2k":{techMaturityPct:{m:52,p25:40,p75:64}, procMaturityPct:{m:46,p25:34,p75:58}, riskProb:{m:0.32,p25:0.22,p75:0.44}, feasibilityPct:{m:62,p25:50,p75:74}, changeMaturityPct:{m:42,p25:30,p75:55}, scalabilityPct:{m:50,p25:38,p75:62}, aiReadinessPct:{m:44,p25:32,p75:58}},
                     "2-10k":{techMaturityPct:{m:56,p25:44,p75:68}, procMaturityPct:{m:50,p25:38,p75:62}, riskProb:{m:0.36,p25:0.25,p75:0.48}, feasibilityPct:{m:60,p25:48,p75:72}, changeMaturityPct:{m:46,p25:34,p75:58}, scalabilityPct:{m:54,p25:42,p75:66}, aiReadinessPct:{m:46,p25:34,p75:60}},
                     "10k+":{techMaturityPct:{m:60,p25:48,p75:72}, procMaturityPct:{m:54,p25:42,p75:66}, riskProb:{m:0.34,p25:0.24,p75:0.46}, feasibilityPct:{m:58,p25:46,p75:70}, changeMaturityPct:{m:50,p25:38,p75:62}, scalabilityPct:{m:58,p25:46,p75:70}, aiReadinessPct:{m:50,p25:38,p75:64}} },
  "–§–∏–Ω–∞–Ω—Å—ã": {"1-2k":{techMaturityPct:{m:58,p25:46,p75:70}, procMaturityPct:{m:56,p25:44,p75:68}, riskProb:{m:0.38,p25:0.28,p75:0.52}, feasibilityPct:{m:64,p25:52,p75:76}, changeMaturityPct:{m:52,p25:40,p75:64}, scalabilityPct:{m:56,p25:44,p75:68}, aiReadinessPct:{m:52,p25:40,p75:66}},
             "2-10k":{techMaturityPct:{m:62,p25:50,p75:74}, procMaturityPct:{m:60,p25:48,p75:72}, riskProb:{m:0.40,p25:0.30,p75:0.54}, feasibilityPct:{m:62,p25:50,p75:74}, changeMaturityPct:{m:56,p25:44,p75:68}, scalabilityPct:{m:60,p25:48,p75:72}, aiReadinessPct:{m:56,p25:44,p75:70}},
             "10k+":{techMaturityPct:{m:66,p25:54,p75:78}, procMaturityPct:{m:64,p25:52,p75:76}, riskProb:{m:0.36,p25:0.26,p75:0.50}, feasibilityPct:{m:60,p25:48,p75:72}, changeMaturityPct:{m:60,p25:48,p75:72}, scalabilityPct:{m:62,p25:50,p75:74}, aiReadinessPct:{m:60,p25:48,p75:74}} },
  "–¢–µ–ª–µ–∫–æ–º": {"1-2k":{techMaturityPct:{m:56,p25:44,p75:68}, procMaturityPct:{m:50,p25:38,p75:62}, riskProb:{m:0.34,p25:0.24,p75:0.48}, feasibilityPct:{m:60,p25:48,p75:72}, changeMaturityPct:{m:48,p25:36,p75:60}, scalabilityPct:{m:56,p25:44,p75:68}, aiReadinessPct:{m:54,p25:42,p75:68}},
             "2-10k":{techMaturityPct:{m:60,p25:48,p75:72}, procMaturityPct:{m:54,p25:42,p75:66}, riskProb:{m:0.36,p25:0.26,p75:0.50}, feasibilityPct:{m:58,p25:46,p75:70}, changeMaturityPct:{m:52,p25:40,p75:64}, scalabilityPct:{m:60,p25:48,p75:72}, aiReadinessPct:{m:58,p25:46,p75:72}},
             "10k+":{techMaturityPct:{m:64,p25:52,p75:76}, procMaturityPct:{m:58,p25:46,p75:70}, riskProb:{m:0.34,p25:0.24,p75:0.48}, feasibilityPct:{m:56,p25:44,p75:68}, changeMaturityPct:{m:56,p25:44,p75:68}, scalabilityPct:{m:64,p25:52,p75:76}, aiReadinessPct:{m:62,p25:50,p75:76}} },
  "–†–∏—Ç–µ–π–ª": {"1-2k":{techMaturityPct:{m:50,p25:38,p75:62}, procMaturityPct:{m:44,p25:32,p75:56}, riskProb:{m:0.30,p25:0.20,p75:0.42}, feasibilityPct:{m:64,p25:52,p75:76}, changeMaturityPct:{m:40,p25:28,p75:52}, scalabilityPct:{m:52,p25:40,p75:64}, aiReadinessPct:{m:46,p25:34,p75:60}},
           "2-10k":{techMaturityPct:{m:54,p25:42,p75:66}, procMaturityPct:{m:48,p25:36,p75:60}, riskProb:{m:0.32,p25:0.22,p75:0.44}, feasibilityPct:{m:62,p25:50,p75:74}, changeMaturityPct:{m:44,p25:32,p75:56}, scalabilityPct:{m:56,p25:44,p75:68}, aiReadinessPct:{m:50,p25:38,p75:64}},
           "10k+":{techMaturityPct:{m:58,p25:46,p75:70}, procMaturityPct:{m:52,p25:40,p75:64}, riskProb:{m:0.30,p25:0.20,p75:0.42}, feasibilityPct:{m:60,p25:48,p75:72}, changeMaturityPct:{m:48,p25:36,p75:60}, scalabilityPct:{m:60,p25:48,p75:72}, aiReadinessPct:{m:54,p25:42,p75:68}} },
  "–ì–æ—Å—Å–µ–∫—Ç–æ—Ä": {"1-2k":{techMaturityPct:{m:48,p25:36,p75:60}, procMaturityPct:{m:46,p25:34,p75:58}, riskProb:{m:0.42,p25:0.32,p75:0.56}, feasibilityPct:{m:58,p25:46,p75:70}, changeMaturityPct:{m:44,p25:32,p75:56}, scalabilityPct:{m:46,p25:34,p75:58}, aiReadinessPct:{m:38,p25:28,p75:52}},
             "2-10k":{techMaturityPct:{m:52,p25:40,p75:64}, procMaturityPct:{m:50,p25:38,p75:62}, riskProb:{m:0.44,p25:0.34,p75:0.58}, feasibilityPct:{m:56,p25:44,p75:68}, changeMaturityPct:{m:48,p25:36,p75:60}, scalabilityPct:{m:50,p25:38,p75:62}, aiReadinessPct:{m:40,p25:30,p75:54}},
             "10k+":{techMaturityPct:{m:56,p25:44,p75:68}, procMaturityPct:{m:54,p25:42,p75:66}, riskProb:{m:0.40,p25:0.30,p75:0.54}, feasibilityPct:{m:54,p25:42,p75:66}, changeMaturityPct:{m:52,p25:40,p75:64}, scalabilityPct:{m:52,p25:40,p75:64}, aiReadinessPct:{m:44,p25:32,p75:58}} },
  "–ò–¢/–ò–Ω—Ç–µ–≥—Ä–∞—Ç–æ—Ä—ã": {"1-2k":{techMaturityPct:{m:62,p25:50,p75:74}, procMaturityPct:{m:54,p25:42,p75:66}, riskProb:{m:0.28,p25:0.18,p75:0.40}, feasibilityPct:{m:66,p25:54,p75:78}, changeMaturityPct:{m:54,p25:42,p75:66}, scalabilityPct:{m:62,p25:50,p75:74}, aiReadinessPct:{m:60,p25:48,p75:74}},
                   "2-10k":{techMaturityPct:{m:66,p25:54,p75:78}, procMaturityPct:{m:58,p25:46,p75:70}, riskProb:{m:0.30,p25:0.20,p75:0.42}, feasibilityPct:{m:64,p25:52,p75:76}, changeMaturityPct:{m:58,p25:46,p75:70}, scalabilityPct:{m:66,p25:54,p75:78}, aiReadinessPct:{m:64,p25:52,p75:78}},
                   "10k+":{techMaturityPct:{m:70,p25:58,p75:82}, procMaturityPct:{m:62,p25:50,p75:74}, riskProb:{m:0.28,p25:0.18,p75:0.40}, feasibilityPct:{m:62,p25:50,p75:74}, changeMaturityPct:{m:62,p25:50,p75:74}, scalabilityPct:{m:70,p25:58,p75:82}, aiReadinessPct:{m:68,p25:56,p75:82}} }
};

const DEFAULT_BENCH = {
  techMaturityPct:{m:56,p25:44,p75:68},
  procMaturityPct:{m:52,p25:40,p75:64},
  riskProb:{m:0.34,p25:0.24,p75:0.48},
  feasibilityPct:{m:60,p25:48,p75:72},
  changeMaturityPct:{m:50,p25:38,p75:62},
  scalabilityPct:{m:56,p25:44,p75:68},
  aiReadinessPct:{m:50,p25:38,p75:64}
};

// Small deterministic jitter (so the same profile gives stable output inside range).
function stableJitter(seedStr, p25, p75){
  const s = seedStr.split("").reduce((a,c)=>a + c.charCodeAt(0), 0);
  const t = (Math.sin(s*999) + 1) / 2; // 0..1
  return p25 + (p75 - p25) * t;
}

// Estimate parameter value using: client input -> (optional) interview mapping -> benchmark.
function estimateParam(key, opts={}){
  const mode = (opts && opts.forceBenchHint) ? "bench" : (document.getElementById("benchMode")?.value || "mixed"); // mixed|client|bench
  const prof = getProfile();
  const bench = (BENCH_MATURITY[prof.industry] && BENCH_MATURITY[prof.industry][prof.bucket] && BENCH_MATURITY[prof.industry][prof.bucket][key])
    || (BENCH[prof.industry] && BENCH[prof.industry][prof.bucket] && BENCH[prof.industry][prof.bucket][key])
    || (BENCH_MATURITY["–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å"] && BENCH_MATURITY["–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å"][prof.bucket] && BENCH_MATURITY["–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å"][prof.bucket][key])
    || (BENCH["–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å"] && BENCH["–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å"][prof.bucket] && BENCH["–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å"][prof.bucket][key])
    || DEFAULT_BENCH[key];

  const el = document.getElementById(opts.elId || key);
  const raw = (el && ("value" in el)) ? String(el.value).trim() : "";
  const hasClient = raw !== "" && isFinite(+raw);

  // Benchmark base with stable jitter inside P25‚ÄìP75
  const benchVal = stableJitter(`${prof.industry}|${prof.bucket}|${prof.total}|${key}`, bench.p25, bench.p75);

  // Adjustments (lightweight, to avoid "one number for all")
  let adj = 0;
  if(key === "manualPct"){
    if(prof.branches >= 10) adj += 4;
    if(prof.vdi === "–î–∞") adj -= 2;
    if(prof.closed === "–î–∞") adj += 2;
  }
  if(key === "incidentsPerMonth"){
    if(prof.branches >= 10) adj += 3;
    if(prof.closed === "–î–∞") adj += 2;
  }
  if(key === "unusedPct"){
    if(prof.vdi === "–î–∞") adj += 2;
  }
  if(key === "obsoletePct"){
    if(prof.closed === "–î–∞") adj += 3;
  }
  const benchAdj = benchVal + adj;

  if(mode === "bench"){
    return {v:benchAdj, src:"bench", range:[bench.p25+adj, bench.p75+adj], prof};
  }

  if(mode === "client"){
    if(hasClient) return {v:+raw, src:"client", range:null, prof};
    return {v:NaN, src:"missing", range:null, prof};
  }

  // mixed
  if(hasClient) return {v:+raw, src:"client", range:bench ? [bench.p25+adj, bench.p75+adj] : null, prof};
  return {v:benchAdj, src:"bench", range:[bench.p25+adj, bench.p75+adj], prof};
}

// Confidence scoring: client=1.0, interview=0.6 (reserved), bench=0.35, missing=0
function srcWeight(src){
  if(src==="client") return 1.0;
  if(src==="interview") return 0.6;
  if(src==="bench") return 0.35;
  return 0.0;
}

let LAST_EST = {params:{}, confidence:{}, accuracy:0};

function formatRange(r){
  if(!r || !isFinite(r[0]) || !isFinite(r[1])) return "‚Äî";
  const a = Math.round(r[0]);
  const b = Math.round(r[1]);
  return `${a}‚Äì${b}`;
}

function updateDataAccuracyUI(){
  const pill = document.getElementById("dataAccuracyPill");
  const pill2 = document.getElementById("dataSourcesPill");
  if(pill){
    const a = Math.round(LAST_EST.accuracy || 0);
    pill.textContent = `–¢–æ—á–Ω–æ—Å—Ç—å –æ—Ç—á—ë—Ç–∞: ${isFinite(a)?a:0}%`;
  }
  if(pill2){
    const c = Object.values(LAST_EST.params||{}).filter(p=>p.src==="client").length;
    const b = Object.values(LAST_EST.params||{}).filter(p=>p.src==="bench").length;
    pill2.textContent = `–ò—Å—Ç–æ—á–Ω–∏–∫–∏: üü¢${c} / üîµ${b}`;
  }
}

function updateTopQuestions(){
  const ol = document.getElementById("topQuestions");
  if(!ol) return;

  // Information gain approximated by how much a missing param influences weighted PSI.
  const impact = [
    {key:"manualPct", label:"% —Ä—É—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –ò–¢ (–æ—Ü–µ–Ω–∫–∞)", gain:0.20+0.08},
    {key:"unusedPct", label:"% –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ –ü–û/–ª–∏—Ü–µ–Ω–∑–∏–π (–æ—Ü–µ–Ω–∫–∞)", gain:0.15},
    {key:"vmUnusedPct", label:"% –ø—Ä–æ—Å—Ç–∞–∏–≤–∞—é—â–∏—Ö VM/–≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ (–æ—Ü–µ–Ω–∫–∞)", gain:0.15},
    {key:"incidentsPerMonth", label:"–ò–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤ –≤ –º–µ—Å—è—Ü (—Å—Ä–µ–¥–Ω–µ–µ)", gain:0.20+0.08},
    {key:"downtimeHours", label:"–ß–∞—Å–æ–≤ –ø—Ä–æ—Å—Ç–æ—è –≤ –≥–æ–¥ (–æ—Ü–µ–Ω–∫–∞)", gain:0.20},
    {key:"downtimeCost", label:"–°—Ç–æ–∏–º–æ—Å—Ç—å —á–∞—Å–∞ –ø—Ä–æ—Å—Ç–æ—è (‚ÇΩ/—á–∞—Å)", gain:0.20},
    {key:"obsoletePct", label:"–î–æ–ª—è —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –û–°/–ü–û (%)", gain:0.10},
    {key:"keyPeopleRisk", label:"–ï—Å—Ç—å –ª–∏ ¬´–Ω–µ–∑–∞–º–µ–Ω–∏–º—ã–µ¬ª —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã? (–î–∞/–ù–µ—Ç)", gain:0.10},
    {key:"docScore", label:"–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (–ù–µ—Ç/–ß–∞—Å—Ç–∏—á–Ω–æ/–î–∞)", gain:0.10}
  ];

  const missing = impact
    .map(x=>({ ...x, src: LAST_EST.params?.[x.key]?.src || "missing" }))
    .filter(x=>x.src==="missing")
    .sort((a,b)=>b.gain-a.gain)
    .slice(0,5);

  ol.innerHTML = "";
  if(missing.length===0){
    const li=document.createElement("li");
    li.textContent="–í—Å–µ –∫–ª—é—á–µ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã —É–∂–µ –¥–∞–Ω—ã ‚Äî —Ç–æ—á–Ω–æ—Å—Ç—å –±–ª–∏–∑–∫–∞ –∫ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π.";
    ol.appendChild(li);
    return;
  }
  missing.forEach(x=>{
    const li=document.createElement("li");
    li.innerHTML = `<b>${x.label}</b> ‚Äî –ø–æ–≤—ã—Å–∏—Ç —Ç–æ—á–Ω–æ—Å—Ç—å –∏ –∫–∞—á–µ—Å—Ç–≤–æ –≤—ã–≤–æ–¥–∞ –ø–æ PSI (–≤–ª–∏—è–Ω–∏–µ: ~${Math.round(x.gain*100)}%).`;
    ol.appendChild(li);
  });
}

function paintStat(elId, pct, higherBetter=true){
  const el=document.getElementById(elId);
  el.classList.remove("good","warn","bad");
  if(!isFinite(pct)) return;
  if(higherBetter){
    if(pct>=75) el.classList.add("good");
    else if(pct>=45) el.classList.add("warn");
    else el.classList.add("bad");
  } else {
    if(pct<=25) el.classList.add("good");
    else if(pct<=55) el.classList.add("warn");
    else el.classList.add("bad");
  }
}
function paintRisk(score){
  const el=document.getElementById("kRisk");
  el.classList.remove("good","warn","bad");
  if(!isFinite(score)) return;
  if(score<=1) el.classList.add("good");
  else if(score<=3) el.classList.add("warn");
  else el.classList.add("bad");
}

function createScoreRow(tbody,item,type){
  const label = (typeof item==="string") ? item : (item?.label||"");
  const mode = (typeof item==="string") ? "both" : (item?.mode||"both");
  const tr=document.createElement("tr");
  tr.dataset.mode = mode;

  tr.innerHTML = `
    <td>
      <span class="statusDot dotRed maturityDot" style="margin-right:10px" title="–ü–æ–ª–µ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ"></span>
      ${label}
    </td>
    <td>
      <select class="${type}-score" data-origin="">
        ${type==="risk"
          ? `<option value="">‚Äî</option><option value="0">–ù–µ—Ç</option><option value="1">–î–∞</option>`
          : `<option value="">‚Äî</option><option value="0">–ù–µ—Ç</option><option value="1">–ß–∞—Å—Ç–∏—á–Ω–æ</option><option value="2">–î–∞</option>`
        }
      </select>
    </td>
    <td><input class="${type}-note" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–ø–æ –∂–µ–ª–∞–Ω–∏—é)"></td>
  `;
  tbody.appendChild(tr);

  // dot behavior: red(empty) / green(user) / blue(synthetic)
  const dot = tr.querySelector(".maturityDot");
  const sel = tr.querySelector("select");
  const updateDot = ()=>{
    if(!dot || !sel) return;
    const v = (sel.value ?? "").toString().trim();
    if(!v){
      dot.classList.remove("dotBlue","dotGreen");
      dot.classList.add("dotRed");
      dot.title = "–ü–æ–ª–µ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ";
      return;
    }
    const synthetic = (sel.dataset.synthetic === "1") || (sel.dataset.origin === "synthetic");
    dot.classList.remove("dotRed","dotBlue","dotGreen");
    dot.classList.add(synthetic ? "dotBlue" : "dotGreen");
    dot.title = synthetic ? "–°–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ (–º–æ–∂–Ω–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å)" : "–ó–∞–ø–æ–ª–Ω–µ–Ω–æ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º";
  };

  // user edit -> user origin, clear synthetic
  sel.addEventListener("change", ()=>{
    sel.dataset.origin = "user";
    if(sel.dataset.synthetic === "1") delete sel.dataset.synthetic;
    updateDot();
  }, {passive:true});

  updateDot();
}

function ensureBaseTables(){
  const techTb=document.getElementById("techTbody");
  const procTb=document.getElementById("procTbody");
  const riskTb=document.getElementById("riskTbody");
  techTb.innerHTML=""; procTb.innerHTML=""; riskTb.innerHTML="";
  TECH.forEach(x=>createScoreRow(techTb,x,"tech"));
  PROC.forEach(x=>createScoreRow(procTb,x,"proc"));
  RISK.forEach(x=>createScoreRow(riskTb,x,"risk"));
}

function addReqRow(data){
  const tb=document.getElementById("reqTbody");
  const idx=tb.children.length+1;
  const feasOptions = FEAS_OPTIONS.map(o=>`<option value="${o.label}">${o.label}</option>`).join("");
  const tr=document.createElement("tr");
  tr.innerHTML = `
    <td class="right mono">${idx}</td>
    <td><textarea class="req-owner" placeholder="–ë–∏–∑–Ω–µ—Å –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å / –∑–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ?"></textarea></td>
    <td><textarea class="req-text" placeholder="–ß—Ç–æ –∏–º–µ–Ω–Ω–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–æ/–ø–æ–∫–∞–∑–∞–Ω–æ –Ω–∞ –ø–∏–ª–æ—Ç–µ?"></textarea></td>
    <td>
      <select class="req-type">
        <option>–¢–µ—Ö</option><option>–ò–ë</option><option>–ë–∏–∑–Ω–µ—Å</option><option>–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</option><option>–û—Ç—á–µ—Ç—ã</option>
      </select>
    </td>
    <td>
      <select class="req-must"><option value="–î–∞">–î–∞</option><option value="–ù–µ—Ç">–ù–µ—Ç</option></select>
    </td>
    <td><select class="req-feas">${feasOptions}</select></td>
    <td><textarea class="req-metric" placeholder="–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä—è–µ–º? (–º–µ—Ç—Ä–∏–∫–∞/–æ—Ç—á–µ—Ç/—Å–∫—Ä–∏–Ω)"></textarea></td>
  `;
  tb.appendChild(tr);

  if(data){
    tr.querySelector(".req-text").value = data.text || "";
    tr.querySelector(".req-type").value = data.type || "–¢–µ—Ö";
    tr.querySelector(".req-must").value = data.must || "–î–∞";
    tr.querySelector(".req-feas").value = data.feas || "‚Äî";
    tr.querySelector(".req-metric").value = data.metric || "";
    tr.querySelector(".req-owner").value = data.owner || "";
  }

  tr.querySelectorAll("input,select,textarea").forEach(el=>{
    el.addEventListener("input", debounce(recalc,120));
    el.addEventListener("change", recalc);
  });
  recalc();
}


const PROD_FEAS_OPTIONS = [
  { label: "‚Äî", score: null },
  { label: "–ü–æ–ª–Ω–æ—Å—Ç—å—é", score: 1.00 },
  { label: "–ß–∞—Å—Ç–∏—á–Ω–æ", score: 0.60 },
  { label: "–ù–µ—Ç", score: 0.00 },
  { label: "–•–∞—Ä–¥ –∫–æ–¥ (–°–∫–æ—Ä–æ)", score: 0.70 },
  { label: "–•–∞—Ä–¥ –∫–æ–¥ (—Å–∫–æ—Ä–æ)", score: 0.70 },
  { label: "–•–∞—Ä–¥ –∫–æ–¥ (–Ω–µ —Å–∫–æ—Ä–æ)", score: 0.30 },
  { label: "–¢—Ä–µ–±—É–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç", score: 0.50 },
];

function addProdReqRow(data){
  const tb=document.getElementById("prodReqTbody");
  if(!tb) return;
  const idx=tb.children.length+1;
  const feasOptions = PROD_FEAS_OPTIONS.map(o=>`<option value="${o.label}">${o.label}</option>`).join("");
  const tr=document.createElement("tr");
  tr.innerHTML = `
    <td class="right mono">${idx}</td>
    <td><textarea class="prod-biz" placeholder="–ó–∞—á–µ–º –±–∏–∑–Ω–µ—Å—É? –∫–∞–∫—É—é —Ü–µ–Ω–Ω–æ—Å—Ç—å –¥–∞—ë—Ç?"></textarea></td>
    <td><textarea class="prod-func" placeholder="–ß—Ç–æ –∏–º–µ–Ω–Ω–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ –ø—Ä–æ–¥—É–∫—Ç–µ?"></textarea></td>
    <td>
      <select class="prod-type">
        <option>–¢–µ—Ö</option><option>–ò–ë</option><option>–ë–∏–∑–Ω–µ—Å</option><option>–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</option><option>–û—Ç—á–µ—Ç—ã</option>
      </select>
    </td>
    <td>
      <select class="prod-must"><option value="–î–∞">–î–∞</option><option value="–ù–µ—Ç">–ù–µ—Ç</option></select>
    </td>
    <td><select class="prod-feas">${feasOptions}</select></td>
  `;
  tb.appendChild(tr);

  if(data){
    tr.querySelector(".prod-biz").value = data.biz || data.owner || "";
    tr.querySelector(".prod-func").value = data.func || data.text || "";
    tr.querySelector(".prod-type").value = data.type || "–¢–µ—Ö";
    tr.querySelector(".prod-must").value = data.must || "–î–∞";
    tr.querySelector(".prod-feas").value = data.feas || "‚Äî";
  }

  tr.querySelectorAll("input,select,textarea").forEach(el=>{
    el.addEventListener("input", debounce(recalc,120));
    el.addEventListener("change", recalc);
  });
  recalc();
}

function addPsiRow(data){
  const tb=document.getElementById("psiTbody");
  const idx=tb.children.length+1;
  const tr=document.createElement("tr");
  tr.innerHTML = `
    <td class="right mono">${idx}</td>
    <td><textarea class="psi-req" placeholder="–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ / —á—Ç–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º?"></textarea></td>
    <td><textarea class="psi-scn" placeholder="–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º? (—Ñ—É–Ω–∫—Ü–∏—è/—Å—Ü–µ–Ω–∞—Ä–∏–π)"></textarea></td>
    <td><textarea class="psi-exp" placeholder="–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç"></textarea></td>
    <td><textarea class="psi-act" placeholder="–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç"></textarea></td>
    <td>
      <select class="psi-ok"><option value="">‚Äî</option><option value="–î–∞">–î–∞</option><option value="–ù–µ—Ç">–ù–µ—Ç</option></select>
    </td>
    <td>
      <select class="psi-acc"><option value="">‚Äî</option><option value="–î–∞">–î–∞</option><option value="–ù–µ—Ç">–ù–µ—Ç</option></select>
    </td>
    <td><textarea class="psi-note" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π/–∑–∞–º–µ—á–∞–Ω–∏—è"></textarea></td>
  `;
  tb.appendChild(tr);

  if(data){
    tr.querySelector(".psi-req").value = data.req || "";
    tr.querySelector(".psi-scn").value = data.scn || "";
    tr.querySelector(".psi-exp").value = data.exp || "";
    tr.querySelector(".psi-act").value = data.act || "";
    tr.querySelector(".psi-ok").value = data.ok || "";
    tr.querySelector(".psi-acc").value = data.acc || "";
    tr.querySelector(".psi-note").value = data.note || "";
  }
  tr.querySelectorAll("input,select,textarea").forEach(el=>{
    el.addEventListener("input", debounce(recalc,120));
    el.addEventListener("change", recalc);
  });
  recalc();
}


function painLevelLabel(pct){
  if(!isFinite(pct)) return "‚Äî";
  if(pct >= 75) return "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ";
  if(pct >= 50) return "–í—ã—Å–æ–∫–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ";
  if(pct >= 25) return "–°—Ä–µ–¥–Ω–µ–µ –¥–∞–≤–ª–µ–Ω–∏–µ";
  return "–ù–∏–∑–∫–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ";
}
function readinessLabel(pct){
  if(!isFinite(pct)) return "‚Äî";
  if(pct >= 90) return "–ì–æ—Ç–æ–≤ –∫ –ü–°–ò";
  if(pct >= 70) return "–ì–æ—Ç–æ–≤";
  if(pct >= 40) return "–£—Å–ª–æ–≤–Ω–æ –≥–æ—Ç–æ–≤";
  return "–ù–µ –≥–æ—Ç–æ–≤";
}
function probabilityLabel(pct){
  if(!isFinite(pct)) return "‚Äî";
  if(pct >= 80) return "–ü–æ—á—Ç–∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ";
  if(pct >= 60) return "–í—ã—Å–æ–∫–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å";
  if(pct >= 30) return "–°—Ä–µ–¥–Ω—è—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å";
  return "–ù–∏–∑–∫–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å";
}


function computePSIFromDom(){
  // Robust PSI fallback: compute from already-rendered KPI values so PSI never stays "‚Äî%"
  const numFromEl = (id)=>{
    const el=document.getElementById(id);
    if(!el) return NaN;
    const t=(el.textContent||"").replace("%","").replace(/\s+/g," ").trim();
    const n=parseFloat(t.replace(",","."));
    return Number.isFinite(n)?n:NaN;
  };
  const tech=numFromEl("techIndex");
  const proc=numFromEl("procIndex");
  const recover=numFromEl("recoverIndex");
  const bus=numFromEl("busIndex");
  const obsol=numFromEl("obsolIndex");
  const ai=numFromEl("aiIndex");

  // If we have at least tech/proc, compute; otherwise leave as ‚Äî
  const parts=[
    {v:tech, w:0.30},   // proxy for "control" and tech maturity
    {v:proc, w:0.20},   // process maturity
    {v:recover, w:0.15},
    {v:bus, w:0.10},
    {v:obsol, w:0.10},
    {v:ai, w:0.15},
  ];
  const valid=parts.filter(p=>Number.isFinite(p.v) && p.w>0);
  if(!valid.length){ return NaN; }
  const sumW=valid.reduce((a,p)=>a+p.w,0);
  let psi=valid.reduce((a,p)=>a+p.v*p.w,0)/sumW;
  psi=Math.round(clamp(psi,0,100));
  const scoreEl=document.getElementById("psi2Score");
  const labelEl=document.getElementById("psi2Label");
  if(scoreEl) scoreEl.textContent = `${psi}%`;
  if(labelEl) labelEl.textContent = (psi>=75 ? "–ó–µ–ª—ë–Ω–∞—è –∑–æ–Ω–∞" : (psi>=45 ? "–ñ—ë–ª—Ç–∞—è –∑–æ–Ω–∞" : "–ö—Ä–∞—Å–Ω–∞—è –∑–æ–Ω–∞"));
  try{ paintStat("kPSI", psi, true); }catch(_e){}
  return psi;
}


/* ===== Quick interview: synthetic defaults for hidden (deep) fields ===== */
function applyQuickSynthetics(){
  const mode = document.getElementById("interviewMode")?.value || "quick";
  const isQuick = (mode === "quick");

  // Helpers for maturity tables
  const setRowScoreByLabel = (tbodyId, labelStartsWith, val)=>{
    const tb = document.getElementById(tbodyId);
    if(!tb) return;
    const rows = [...tb.querySelectorAll("tr")];
    const tr = rows.find(r=>{
      const td = r.querySelector("td");
      const txt = (td?.innerText || "").replace(/\s+/g," ").trim();
      return txt.startsWith(labelStartsWith);
    });
    if(!tr) return;
    const sel = tr.querySelector("select");
    if(!sel) return;
    const cur = (sel.value ?? "").trim();
    if(cur !== "" && cur !== "0" && sel.dataset.synthetic !== "1") return;
    sel.value = String(val);
    sel.dataset.synthetic = "1";
    sel.dataset.origin = "synthetic";
  };

  // In QUICK mode: default all hidden deep maturity rows to 0 unless user filled
  if(isQuick){
    ["techTbody","procTbody","riskTbody"].forEach(tbid=>{
      const tb=document.getElementById(tbid);
      if(!tb) return;
      tb.querySelectorAll("tr").forEach(tr=>{
        if(tr.dataset.mode !== "deep") return;
        const sel = tr.querySelector("select");
        if(!sel) return;
        const cur = (sel.value ?? "").trim();
        if(cur !== "" && cur !== "0" && sel.dataset.synthetic !== "1") return;
        sel.value = "0";
        sel.dataset.synthetic = "1";
        sel.dataset.origin = "synthetic";
      });
    });
  }

  // Read passport values for synthetic logic
  const workplaces = Number(document.getElementById("workplaces")?.value || 0);
  const servers = Number(document.getElementById("servers")?.value || 0);
  const endpoints = Math.max(0, workplaces + servers);
  const branches = Number(document.getElementById("branches")?.value || 0);

  // Infrastructure synthetic defaults
  const setSynthSelect = (id, v)=>{
    const el = document.getElementById(id);
    if(!el) return;
    const cur = (el.value ?? "").toString().trim();
    if(cur !== "" && el.dataset.synthetic !== "1") return;
    el.value = v;
    el.dataset.synthetic = "1";
    el.dataset.origin = "synthetic";
  };
  setSynthSelect("hostingModel", "On‚Äëprem");
  setSynthSelect("netSeg", "Prod/Test/Dev –†–∞–∑–¥–µ–ª–µ–Ω—ã");

  // Risk synthetics (as requested)
  setRowScoreByLabel("riskTbody", "–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–∞—è", branches > 1 ? 1 : 0);
  setRowScoreByLabel("riskTbody", "–ü–∞—Ä–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –±—ã—Å—Ç—Ä–æ —Ä–∞—Å—Ç–µ—Ç/–º–µ–Ω—è–µ—Ç—Å—è", 0);
  setRowScoreByLabel("riskTbody", "–ü–ª–∞–Ω–∏—Ä—É—é—Ç—Å—è –∫—Ä—É–ø–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã", endpoints > 5000 ? 1 : 0);
  setRowScoreByLabel("riskTbody", "–í—ã—Å–æ–∫–∞—è —Ç–µ–∫—É—á–µ—Å—Ç—å –ò–¢-–ø–µ—Ä—Å–æ–Ω–∞–ª–∞", 0);

  // Finance synthetic defaults
  const setSynthField = (id, v)=>{
    const el = document.getElementById(id);
    if(!el) return;
    const cur = (el.value ?? "").toString().trim();
    if(cur !== "" && cur !== "0" && el.dataset.synthetic !== "1") return;
    el.value = String(v);
    el.dataset.synthetic = "1";
    el.dataset.origin = "synthetic";
  };
  setSynthField("salary", 300000);
  setSynthField("manualPct", 20);
  setSynthField("unusedPct", 10);
  setSynthField("vmUnusedPct", 10);
  setSynthField("downtimeHours", 120);
  setSynthField("downtimeCost", 150000);
  setSynthField("incidentsPerMonth", 4);
  setSynthField("obsoletePct", 15);

  setSynthSelect("serviceDesk", "–î–∞");
  setSynthSelect("keyPeopleRisk", "–î–∞");

  // Endpoint budgets synthetic mapping (SW/HW) using provided table
  const virtStr = (document.getElementById("virt")?.value || "").toString();
  const hasVirt = virtStr && !virtStr.includes("–ù–µ—Ç");
  const band = (n)=>{
    if(n>=20000) return "20000+";
    if(n>=5000) return "5000-20000";
    if(n>=1000) return "1000-5000";
    return "100-1000";
  };
  const COSTS = {
    "100-1000":   { noVirt:{sw:17000, hw:37000}, virt:{sw:19040, hw:31450} },
    "1000-5000":  { noVirt:{sw:15300, hw:33300}, virt:{sw:17136, hw:28305} },
    "5000-20000": { noVirt:{sw:13600, hw:29600}, virt:{sw:15232, hw:25160} },
    "20000+":     { noVirt:{sw:11900, hw:25900}, virt:{sw:13328, hw:22015} }
  };
  const b = band(endpoints);
  const c = (COSTS[b] || COSTS["100-1000"])[hasVirt ? "virt" : "noVirt"];
  setSynthField("licBudget", Math.round(endpoints * c.sw));
  setSynthField("hwBudget", Math.round(endpoints * c.hw));
}

/* ===== Synthetic marker UX: blue dot + auto-clear on manual edits ===== */
function applySyntheticTitles(){
  document.querySelectorAll('input[data-synthetic="1"], select[data-synthetic="1"], textarea[data-synthetic="1"]').forEach(el=>{
    if(!el.title) el.title = "–°–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ (–±—ã—Å—Ç—Ä–æ–µ –∏–Ω—Ç–µ—Ä–≤—å—é). –ò–∑–º–µ–Ω–∏—Ç–µ –≤—Ä—É—á–Ω—É—é ‚Äî –º–µ—Ç–∫–∞ –∏—Å—á–µ–∑–Ω–µ—Ç.";
  });
}

// Clear marker once user changes value manually
function installSyntheticAutoClear(){
  const clear = (el)=>{
    if(!el || !el.dataset) return;
    if(el.dataset.synthetic === "1"){
      delete el.dataset.synthetic;
      el.title = "";
    }
  };
  document.addEventListener("input", (e)=>clear(e.target), true);
  document.addEventListener("change", (e)=>clear(e.target), true);
}
installSyntheticAutoClear();

// Ensure titles are applied after quick synthetics
try{
  const __origApplyQuickSynthetics = applyQuickSynthetics;
  applyQuickSynthetics = function(){
    __origApplyQuickSynthetics();
    applySyntheticTitles();
  };
}catch(_e){}


// If user edits a field we previously filled synthetically ‚Äî stop treating it as synthetic.
document.addEventListener("input",(e)=>{
  const t = e.target;
  if(t && t.dataset && t.dataset.synthetic === "1"){
    t.dataset.synthetic = "0";
  }
},{capture:true});
/* ====================================================================== */

function recalc(){
  console.log("recalc() clicked", new Date().toISOString());
  try{ applyQuickSynthetics(); }catch(e){}


// maturity indices (with benchmark fallback)
const techSel=[...document.querySelectorAll(".tech-score")];
const procSel=[...document.querySelectorAll(".proc-score")];
const riskSel=[...document.querySelectorAll(".risk-score")];

const techAnswered=techSel.filter(s=>String(s.value).trim()!=="").map(s=>clampInt(s.value,0,2));
const procAnswered=procSel.filter(s=>String(s.value).trim()!=="").map(s=>clampInt(s.value,0,2));
const riskAnswered=riskSel.filter(s=>String(s.value).trim()!=="").map(s=>clampInt(s.value,0,1));
const riskScores = riskAnswered;

const modeTop = (document.getElementById("benchMode")?.value || "mixed"); // mixed|client|bench

// benchmark-based fallbacks for maturity/risk (segment-aware)
const estM = {};
estM.techMaturityPct = estimateParam("techMaturityPct", {elId:"__none__"});
estM.procMaturityPct = estimateParam("procMaturityPct", {elId:"__none__"});
estM.riskProb = estimateParam("riskProb", {elId:"__none__"});

const techIndex = (techAnswered.length>0)
  ? Math.round((avg(techAnswered)/2)*100)
  : (modeTop==="client" ? NaN : Math.round(estM.techMaturityPct.v));

const procIndex = (procAnswered.length>0)
  ? Math.round((avg(procAnswered)/2)*100)
  : (modeTop==="client" ? NaN : Math.round(estM.procMaturityPct.v));

const riskIndex = (riskAnswered.length>0)
  ? riskAnswered.reduce((a,b)=>a+b,0)
  : (modeTop==="client" ? NaN : Math.round(clamp(estM.riskProb.v,0,1)*riskSel.length));

  document.getElementById("techIndex").textContent = isFinite(techIndex)? `${techIndex}%` : "‚Äî%";
  document.getElementById("procIndex").textContent = isFinite(procIndex)? `${procIndex}%` : "‚Äî%";
  document.getElementById("riskIndex").textContent = isFinite(riskIndex)? `${riskIndex}` : "‚Äî";

  paintStat("kTech", techIndex, true);
  paintStat("kProc", procIndex, true);
  paintRisk(riskIndex);

  // ===== Data estimation (client + benchmark) =====
  const est = {};
  est.manualPct = estimateParam("manualPct", {elId:"manualPct"});
  est.unusedPct = estimateParam("unusedPct", {elId:"unusedPct"});
  est.vmUnusedPct = estimateParam("vmUnusedPct", {elId:"vmUnusedPct"});
  est.downtimeHours = estimateParam("downtimeHours", {elId:"downtimeHours"});
  est.downtimeCost = estimateParam("downtimeCost", {elId:"downtimeCost"});
  est.incidentsPerMonth = estimateParam("incidentsPerMonth", {elId:"incidentsPerMonth"});
  est.obsoletePct = estimateParam("obsoletePct", {elId:"obsoletePct"});
  est.keyPeopleRisk = estimateParam("keyPeopleRisk", {elId:"keyPeopleRisk"});
  est.docScore = estimateParam("docScore", {elId:"docScore"});

  // store last estimates for UI + modal
  LAST_EST.params = est;

  // overall accuracy proxy (0..100)
  const accKeys = ["manualPct","unusedPct","vmUnusedPct","downtimeHours","downtimeCost","incidentsPerMonth","obsoletePct","keyPeopleRisk","docScore"];
  const acc = accKeys.reduce((a,k)=>a + srcWeight(est[k]?.src||"missing"),0) / accKeys.length;
  LAST_EST.accuracy = Math.round(acc*100);

  updateDataAccuracyUI();
  updateTopQuestions();

  // Cost of inaction
  const salary=+document.getElementById("salary").value||0;
  const itCount=+document.getElementById("itCount").value||0;
  const manualPct=(isFinite(est.manualPct.v)?est.manualPct.v:0)/100;
  const licBudget=+document.getElementById("licBudget").value||0;
  const unusedPct=(isFinite(est.unusedPct.v)?est.unusedPct.v:0)/100;
  const downtimeHours=isFinite(est.downtimeHours.v)?est.downtimeHours.v:0;
  const downtimeCost=isFinite(est.downtimeCost.v)?est.downtimeCost.v:0;

  const lossManual=salary*12*itCount*manualPct;
  const lossUnused=licBudget*unusedPct;
  const lossDowntime=downtimeHours*downtimeCost;
  const lossTotal=lossManual+lossUnused+lossDowntime;

  document.getElementById("coiTotal").textContent = fmtMoney(lossTotal);
  document.getElementById("coiBreakdown").textContent =
    `–†—É—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏: ${fmtMoney(lossManual)} ¬∑ –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–µ –ü–û: ${fmtMoney(lossUnused)} ¬∑ –ü—Ä–æ—Å—Ç–æ–∏: ${fmtMoney(lossDowntime)}`;
  paintStat("kCoI", lossTotal>0 ? 10 : NaN, false); // just adds outline if filled

  // Feasibility from requirements
  const reqRows=[...document.querySelectorAll("#reqTbody tr")];
  const feasVals=[];
  let totalReq=0, mustReq=0;
  reqRows.forEach(r=>{
    const text=(r.querySelector(".req-text")?.value||"").trim();
    if(!text) return;
    totalReq += 1;
    const must = r.querySelector(".req-must")?.value || "–î–∞";
    if(must==="–î–∞") mustReq += 1;
    const feas = r.querySelector(".req-feas")?.value || "‚Äî";
    const opt = FEAS_OPTIONS.find(o=>o.label===feas);
    if(opt && typeof opt.score === "number") feasVals.push(opt.score);
  });
  const estFeas = estimateParam("feasibilityPct", {elId:"__none__"});
  const feasPct = feasVals.length ? Math.round(avg(feasVals)*100) : ((modeTop==="client")?NaN:Math.round(estFeas.v));
  document.getElementById("feasScore").textContent = isFinite(feasPct) ? `${feasPct}%` : "‚Äî%";
  paintStat("kFeas", isFinite(feasPct)?feasPct:NaN, true);

  // Product requirements feasibility (section 6)
  const prodReqRows=[...document.querySelectorAll("#prodReqTbody tr")];
  const prodFeasVals=[];
  prodReqRows.forEach(r=>{
    const func=(r.querySelector(".prod-func")?.value||"").trim();
    const biz=(r.querySelector(".prod-biz")?.value||"").trim();
    if(!func && !biz) return;
    const feas = r.querySelector(".prod-feas")?.value || "‚Äî";
    const opt = PROD_FEAS_OPTIONS.find(o=>o.label===feas);
    if(opt && typeof opt.score === "number") prodFeasVals.push(opt.score);
  });
  const prodFeasPct = prodFeasVals.length ? Math.round(avg(prodFeasVals)*100) : NaN;
  const prodEl=document.getElementById("prodFeasScore");
  if(prodEl) prodEl.textContent = isFinite(prodFeasPct) ? `${prodFeasPct}%` : "‚Äî%";
  if(document.getElementById("kProdFeas")) paintStat("kProdFeas", isFinite(prodFeasPct)?prodFeasPct:NaN, true);

  // ----- Criticality & client summary -----
  const maturityAvg = Math.round((techIndex + procIndex) / 2);
  const crit = computeCriticality(lossTotal, riskIndex, maturityAvg);
  const critLbl = criticalityLabel(crit);

  const critScoreEl=document.getElementById("critScore"); if(critScoreEl) critScoreEl.textContent = isFinite(crit) ? (crit + "%") : "‚Äî%";
  const critLabelEl=document.getElementById("critLabel"); if(critLabelEl) critLabelEl.textContent = critLbl;

  const mLvl = maturityLevel(maturityAvg);
  const coiText = fmtMoney(lossTotal);
  const maturityLevelTextEl=document.getElementById("maturityLevelText"); if(maturityLevelTextEl) maturityLevelTextEl.value = mLvl;
  const critLabelClientEl=document.getElementById("critLabelClient"); if(critLabelClientEl) critLabelClientEl.value = critLbl;
  const coiClientEl=document.getElementById("coiClient"); if(coiClientEl) coiClientEl.value = coiText;
  const clientOneLinerEl=document.getElementById("clientOneLiner"); if(clientOneLinerEl) clientOneLinerEl.value = `–ó—Ä–µ–ª–æ—Å—Ç—å: ${mLvl}. –ü–æ—Ç–µ—Ä–∏: ${coiText}/–≥–æ–¥. –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${critLbl}.`;

  try{
// ----- Project risks table (internal control) -----
  const risks = [];
  risks.push({name:"–ó—Ä–µ–ª–æ—Å—Ç—å", cond:"–°—Ä–µ–¥–Ω—è—è –∑—Ä–µ–ª–æ—Å—Ç—å < 40%", hit: maturityAvg < 40, note:`–°–µ–π—á–∞—Å: ${maturityAvg}%`});
  risks.push({name:"–†–∏—Å–∫-–ø—Ä–æ—Ñ–∏–ª—å", cond:"–ò–Ω–¥–µ–∫—Å —Ä–∏—Å–∫–∞ ‚â• 3", hit: riskIndex >= 3, note:`–°–µ–π—á–∞—Å: ${riskIndex}`});
  risks.push({name:"–†–µ–∞–ª–∏–∑—É–µ–º–æ—Å—Ç—å", cond:"–ò–Ω–¥–µ–∫—Å —Ä–µ–∞–ª–∏–∑—É–µ–º–æ—Å—Ç–∏ < 60%", hit: isFinite(feasPct) ? (feasPct < 60) : true, note:`–°–µ–π—á–∞—Å: ${isFinite(feasPct)?feasPct:"‚Äî"}%`});
  const reqFilled = [...document.querySelectorAll("#reqTbody tr")].some(r=> (r.querySelector(".req-text")?.value||"").trim());
  risks.push({name:"–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è", cond:"–ù–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π", hit: !reqFilled, note: reqFilled ? "OK" : "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ä–µ–µ—Å—Ç—Ä —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π"});
  const hasLpr = ((document.getElementById("lpr")?.value||"").trim().length > 0);
  risks.push({name:"–õ–ü–†", cond:"–ù–µ —É–∫–∞–∑–∞–Ω –õ–ü–†/–∫–æ–Ω—Ç–∞–∫—Ç", hit: !hasLpr, note: hasLpr ? "OK" : "–£–∫–∞–∂–∏—Ç–µ –õ–ü–†"});

  const hitCount = risks.filter(r=>r.hit).length;
  const riskLevel = hitCount >= 3 ? "–í—ã—Å–æ–∫–∏–π" : (hitCount === 2 ? "–°—Ä–µ–¥–Ω–∏–π" : "–ù–∏–∑–∫–∏–π");
  const riskLevelEl = document.getElementById("riskLevelText");
  if(riskLevelEl) riskLevelEl.value = `${riskLevel} (—Ç—Ä–∏–≥–≥–µ—Ä–æ–≤: ${hitCount})`;

  const tb = document.getElementById("projectRisks");
  if(tb){
    tb.innerHTML = "";
    risks.forEach(r=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `<td><b>${r.name}</b></td><td>${r.cond}</td><td>${r.hit ? "‚ö†Ô∏è –ï—Å—Ç—å —Ä–∏—Å–∫" : "‚úÖ –û–ö"}</td><td>${r.note||""}</td>`;
      tb.appendChild(tr);
    });
  }


  // ----- Indices: Pain / Readiness / Deal probability -----
  const projCostBase = ( (+document.getElementById("workplaces")?.value||0) + (+document.getElementById("servers")?.value||0) ) * 1300;
  const capPain = projCostBase > 0 ? projCostBase : 5_000_000;
  const painScore = ((lossTotal/capPain)*0.6) + (manualPct*0.2) + ((lossDowntime/capPain)*0.2);
  const painPct = Math.round(clamp(painScore, 0, 2) * 50); // 0..100
  document.getElementById("painIndex").textContent = isFinite(painPct) ? `${painPct}%` : "‚Äî%";
  document.getElementById("painLabel").textContent = painLevelLabel(painPct);
  paintStat("kPain", isFinite(painPct)?painPct:NaN, true);

  const missingNow = validateRequired();
  const hasCompany = !missingNow.includes("–ö–æ–º–ø–∞–Ω–∏—è");
  const hasSources = ((document.getElementById("sources")?.value||"").trim().length > 0);
  const hasReq = reqFilled;
  const hasPsi2 = !missingNow.some(x=>x.startsWith("–ü–°–ò:"));
  const feasOk = isFinite(feasPct) ? (feasPct >= 50) : false;
  const riskOk = riskIndex <= 3;
  const readinessParts = [hasCompany, hasSources, hasReq, hasPsi2, feasOk, riskOk];
  const readyPct = Math.round(100 * (readinessParts.filter(Boolean).length / readinessParts.length));
  document.getElementById("readyIndex").textContent = isFinite(readyPct) ? `${readyPct}%` : "‚Äî%";
  document.getElementById("readyLabel").textContent = readinessLabel(readyPct);
  paintStat("kReady", isFinite(readyPct)?readyPct:NaN, true);

  const riskNorm = clamp(riskIndex/5, 0, 1);
  const prob = ( (isFinite(feasPct)?feasPct/100:0) * 0.35 ) +
               ( (1 - riskNorm) * 0.25 ) +
               ( (isFinite(painPct)?painPct/100:0) * 0.25 ) +
               ( (isFinite(procIndex)?procIndex/100:0) * 0.15 );
  const probPct = Math.round(clamp(prob, 0, 1) * 100);
  document.getElementById("probIndex").textContent = isFinite(probPct) ? `${probPct}%` : "‚Äî%";
  document.getElementById("probLabel").textContent = probabilityLabel(probPct);
  paintStat("kProb", isFinite(probPct)?probPct:NaN, true);

  // ===== Additional indices (PSI 2.0) =====
  const vmUnusedPct = (+document.getElementById("vmUnusedPct")?.value || 0);
  const keyPeopleRiskStr = (document.getElementById("keyPeopleRisk")?.value || "");
  let keyPeopleRisk = keyPeopleRiskStr === "–î–∞" ? 1 : (keyPeopleRiskStr === "–ù–µ—Ç" ? 0 : NaN);
  if(!isFinite(keyPeopleRisk) && isFinite(est.keyPeopleRisk.v)) keyPeopleRisk = est.keyPeopleRisk.v >= 0.5 ? 1 : 0;
  const docScoreRaw = (document.getElementById("docScore")?.value || "").trim();
  let docScore = docScoreRaw==="" ? NaN : clampInt(docScoreRaw, 0, 2);
  if(!isFinite(docScore) && isFinite(est.docScore.v)) docScore = clampInt(String(Math.round(est.docScore.v)), 0, 2);
  const obsoletePct = isFinite(est.obsoletePct.v)?est.obsoletePct.v:(+document.getElementById("obsoletePct")?.value || 0);

  // Recoverable Budget Index (licenses + VM) ‚Äî higher is better
  const L = clamp((isFinite(est.unusedPct.v)?est.unusedPct.v:(+document.getElementById("unusedPct").value || 0))/100, 0, 1);
  const V = clamp((isFinite(est.vmUnusedPct.v)?est.vmUnusedPct.v:vmUnusedPct)/100, 0, 1);
  const L_norm = clamp(L/0.25, 0, 1);
  const V_norm = clamp(V/0.30, 0, 1);
  let recover = 100 * (1 - (0.6*L_norm + 0.4*V_norm));
  recover = Math.round(clamp(recover, 0, 100));
  document.getElementById("recoverIndex").textContent = isFinite(recover) ? `${recover}%` : "‚Äî%";
  document.getElementById("recoverLabel").textContent = recover>=75 ? "–í—ã—Å–æ–∫–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª" : (recover>=45 ? "–°—Ä–µ–¥–Ω–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª" : "–ù–∏–∑–∫–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª");
  paintStat("kRecover", isFinite(recover)?recover:NaN, true);

  // Bus-factor Index ‚Äî higher is better
  let bus = NaN;
  if(isFinite(keyPeopleRisk)) {
    bus = 100 - (keyPeopleRisk*40 + (2 - docScore)*20);
    bus = Math.round(clamp(bus, 0, 100));
  }
  document.getElementById("busIndex").textContent = isFinite(bus) ? `${bus}%` : "‚Äî%";
  document.getElementById("busLabel").textContent = isFinite(bus) ? (bus>=75 ? "–ù–∏–∑–∫–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å" : (bus>=45 ? "–°—Ä–µ–¥–Ω—è—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å" : "–í—ã—Å–æ–∫–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å")) : "‚Äî";
  paintStat("kBus", isFinite(bus)?bus:NaN, true);

  // Tech Obsolescence Index ‚Äî higher is better
  const ageSel = (document.getElementById("hwAge")?.value || "");
  const ageFactor = (ageSel==="–¥–æ 3 –ª–µ—Ç") ? 10 : (ageSel==="3‚Äì5 –ª–µ—Ç" ? 25 : (ageSel==="5+ –ª–µ—Ç" ? 45 : 0));
  let obsol = 100 - (clamp(obsoletePct,0,100)*1.2 + ageFactor);
  obsol = Math.round(clamp(obsol, 0, 100));
  document.getElementById("obsolIndex").textContent = isFinite(obsol) ? `${obsol}%` : "‚Äî%";
  document.getElementById("obsolLabel").textContent = obsol>=75 ? "–û–ö" : (obsol>=45 ? "–ù—É–∂–Ω–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è" : "–í—ã—Å–æ–∫–∏–π —Ç–µ—Ö–¥–æ–ª–≥");
  paintStat("kObsol", isFinite(obsol)?obsol:NaN, true);

  // AI Readiness Index ‚Äî higher is better (tech+proc+richness of sources)
  const sourcesStr = (document.getElementById("sources")?.value || "");
  const srcCount = sourcesStr.split(",").map(s=>s.trim()).filter(Boolean).length;
  const srcNorm = clamp(srcCount/6, 0, 1);
  let ai = ( (isFinite(techIndex)?techIndex:0) * 0.50 ) + ( (isFinite(procIndex)?procIndex:0) * 0.30 ) + (srcNorm * 100 * 0.20);
  ai = Math.round(clamp(ai, 0, 100));
  document.getElementById("aiIndex").textContent = isFinite(ai) ? `${ai}%` : "‚Äî%";
  document.getElementById("aiLabel").textContent = ai>=75 ? "–ì–æ—Ç–æ–≤–æ" : (ai>=45 ? "–ß–∞—Å—Ç–∏—á–Ω–æ –≥–æ—Ç–æ–≤–æ" : "–ù—É–∂–Ω–æ –Ω–∞–≤–µ—Å—Ç–∏ –ø–æ—Ä—è–¥–æ–∫ –≤ –¥–∞–Ω–Ω—ã—Ö");
  paintStat("kAI", isFinite(ai)?ai:NaN, true);

  // Cost of Inaction score for PSI (normalize by baseline spend, 0‚Äì4% = ok)
  const hwBudget = (+document.getElementById("hwBudget")?.value || 0);
  const baseline = (salary*12*itCount) + licBudget + hwBudget;
  let coiScore = NaN;
  if(baseline>0){
    const share = clamp(lossTotal / baseline, 0, 1);
    coiScore = 100 * (1 - clamp(share/0.04, 0, 1)); // 4% = 0 score, 0% = 100
    coiScore = Math.round(clamp(coiScore, 0, 100));
  }

  // Regulatory readiness proxy (based on risk flags: audits + unaccounted software)
  const auditIdx = RISK.findIndex(x=>x.label && x.label.toLowerCase().includes("–ø—Ä–æ–≤–µ—Ä"));
  const unlicensedIdx = RISK.findIndex(x=>x.label && x.label.toLowerCase().includes("–Ω–µ—É—á—Ç–µ–Ω–Ω—ã—Ö —É—Å—Ç–∞–Ω–æ–≤–æ–∫"));
  const auditFlag = auditIdx>=0 ? (riskScores[auditIdx]||0) : 0;
  const unlicensedFlag = unlicensedIdx>=0 ? (riskScores[unlicensedIdx]||0) : 0;
  const reg = Math.round(clamp(100 - (auditFlag*40 + unlicensedFlag*60), 0, 100));

  // IT Reactivity proxy (incidents + manual ops)
  const incidentsPerMonth = isFinite(est.incidentsPerMonth.v)?est.incidentsPerMonth.v:(+document.getElementById("incidentsPerMonth")?.value || 0);
  const incNorm = clamp(incidentsPerMonth/30, 0, 1);
  const manNorm = clamp((isFinite(est.manualPct.v)?est.manualPct.v:(+document.getElementById("manualPct").value||0))/60, 0, 1);
  const reactivity = Math.round(100 * (1 - clamp(0.6*incNorm + 0.4*manNorm, 0, 1)));

  // Change maturity proxy (use process maturity)
  const change = Math.round(clamp(procIndex,0,100));

  // Scalability proxy (branches + growth risk flag)
  const branches = (+document.getElementById("branches")?.value || 0);
  const growthIdx = RISK.findIndex(x=>x.label && x.label.toLowerCase().includes("—Ä–∞—Å—Ç–µ—Ç/–º–µ–Ω—è–µ—Ç—Å—è"));
  const growthFlag = growthIdx>=0 ? (riskScores[growthIdx]||0) : 0;
  const brNorm = clamp(branches/20, 0, 1);
  const scalability = Math.round(clamp( (techIndex*0.5 + procIndex*0.3 + (1 - (0.6*brNorm + 0.4*growthFlag))*100*0.2), 0, 100));

  // PSI 2.0 weighted score (0‚Äì100)
  const w = {
    coi:0.20, recover:0.15, control:0.15, bus:0.10, reg:0.10,
    obsol:0.10, react:0.08, change:0.05, scale:0.04, ai:0.03
  };
  const control = Math.round(clamp(techIndex,0,100));
  const parts = [
    {v:coiScore, w:w.coi},
    {v:recover, w:w.recover},
    {v:control, w:w.control},
    {v:bus, w:w.bus},
    {v:reg, w:w.reg},
    {v:obsol, w:w.obsol},
    {v:reactivity, w:w.react},
    {v:change, w:w.change},
    {v:scalability, w:w.scale},
    {v:ai, w:w.ai},
  ];
  const normalizedParts = parts.map(p=>({v:Number(p.v), w:Number(p.w)}));
  const valid = normalizedParts.filter(p=>Number.isFinite(p.v) && Number.isFinite(p.w) && p.w>0);
  const sumW = valid.reduce((a,p)=>a+p.w,0);
  let psi2 = NaN;
  if(sumW>0){
    psi2 = valid.reduce((a,p)=>a + p.v*p.w,0) / sumW;
    psi2 = Math.round(clamp(psi2, 0, 100));
  } else {
    // fallback: if everything missing, at least anchor PSI to visible core indices
    const core = [techIndex, procIndex].map(Number).filter(Number.isFinite);
    if(core.length) psi2 = Math.round(core.reduce((a,b)=>a+b,0)/core.length);
  }
  document.getElementById("psi2Score").textContent = isFinite(psi2) ? `${psi2}%` : "‚Äî%";
  document.getElementById("psi2Label").textContent = isFinite(psi2) ? (psi2>=75 ? "–ó–µ–ª—ë–Ω–∞—è –∑–æ–Ω–∞" : (psi2>=45 ? "–ñ—ë–ª—Ç–∞—è –∑–æ–Ω–∞" : "–ö—Ä–∞—Å–Ω–∞—è –∑–æ–Ω–∞")) : "‚Äî";
  try{ paintStat("kPSI", Number.isFinite(psi2)?psi2:NaN, true); }catch(_e){}
  try{ renderBenchHints(); }catch(_e){}

}catch(e){ console.error('recalc tail error', e); }
// Required fields gate (PDF)

  // Always recompute PSI from DOM as a final fallback
  try{ if(!isFinite(parseFloat((document.getElementById('psi2Score')?.textContent||'').replace('%','')))) computePSIFromDom(); }catch(_e){}
  updateRequiredUI();
}

function collect(){
  const get=id=>document.getElementById(id)?.value ?? "";
  return {
    meta:{
      company:get("company"), industry:get("industry"), sales_manager:get("sales_manager"), presale_manager:get("presale_manager"), lpr:get("lpr"),
      workplaces:+get("workplaces")||0, servers:+get("servers")||0, branches:+get("branches")||0,
      vdi:get("vdi"), closed:get("closed"), sources:get("sources"), envNote:get("envNote"), benchMode:get("benchMode"), interviewMode:get("interviewMode"), pdfMode:get("pdfMode"),
      virt:get("virt"), hostingModel:get("hostingModel"), adDomains:get("adDomains"), netSeg:get("netSeg"), terminalFarms:get("terminalFarms"), hwAge:get("hwAge"), hwAccounting:get("hwAccounting"), redundancy:get("redundancy")
    },
    maturity:{
      tech: TECH.map((k,i)=>({key:k, score: clampInt(document.querySelectorAll(".tech-score")[i].value,0,2), note: document.querySelectorAll(".tech-note")[i].value||""})),
      proc: PROC.map((k,i)=>({key:k, score: clampInt(document.querySelectorAll(".proc-score")[i].value,0,2), note: document.querySelectorAll(".proc-note")[i].value||""})),
      risk: RISK.map((k,i)=>({key:k, score: clampInt(document.querySelectorAll(".risk-score")[i].value,0,1), note: document.querySelectorAll(".risk-note")[i].value||""})),
    },
    finance:{
      salary:+get("salary")||0, itCount:+get("itCount")||0, manualPct:+get("manualPct")||0,
      licBudget:+get("licBudget")||0, unusedPct:+get("unusedPct")||0, vmUnusedPct:+get("vmUnusedPct")||0,
      hwBudget:+get("hwBudget")||0, hwPlan:get("hwPlan"),
      downtimeHours:+get("downtimeHours")||0, downtimeCost:+get("downtimeCost")||0,
      incidentsPerMonth:+get("incidentsPerMonth")||0, serviceDesk:get("serviceDesk"),
      keyPeopleRisk:get("keyPeopleRisk"), docScore:clampInt(get("docScore"),0,2), obsoletePct:+get("obsoletePct")||0,
      note:get("finNote")
    },
    requirements:[...document.querySelectorAll("#reqTbody tr")].map(r=>({
      text:r.querySelector(".req-text")?.value||"",
      type:r.querySelector(".req-type")?.value||"–¢–µ—Ö",
      must:r.querySelector(".req-must")?.value||"–î–∞",
      feas:r.querySelector(".req-feas")?.value||"‚Äî",
      metric:r.querySelector(".req-metric")?.value||"",
      owner:r.querySelector(".req-owner")?.value||"",
    })),
    productRequirements:[...document.querySelectorAll("#prodReqTbody tr")].map(r=>({
      biz:r.querySelector(".prod-biz")?.value||"",
      func:r.querySelector(".prod-func")?.value||"",
      type:r.querySelector(".prod-type")?.value||"–¢–µ—Ö",
      must:r.querySelector(".prod-must")?.value||"–î–∞",
      feas:r.querySelector(".prod-feas")?.value||"‚Äî",
    })),
    psi:[...document.querySelectorAll("#psiTbody tr")].map(r=>({
      req:r.querySelector(".psi-req")?.value||"",
      scn:r.querySelector(".psi-scn")?.value||"",
      exp:r.querySelector(".psi-exp")?.value||"",
      act:r.querySelector(".psi-act")?.value||"",
      ok:r.querySelector(".psi-ok")?.value||"",
      acc:r.querySelector(".psi-acc")?.value||"",
      note:r.querySelector(".psi-note")?.value||"",
    })),
    pilot:{
      goal:get("pilotGoal"), tasks:get("pilotTasks_removed"), kpi:get("pilotKpi_removed"), scope:get("pilotScope"),
      summary:get("pilotSummary"), decision:get("pilotDecision"), recommendedConfig:get("recommendedConfig")
    },
    projectRisks:{
      level:(document.getElementById("riskLevelText")?.value||""),
      notes:(document.getElementById("riskNotes")?.value||""),
      table:[...document.querySelectorAll("#projectRisks tr")].map(r=>({
        indicator:(r.querySelector("td:nth-child(1)")?.innerText||"").trim(),
        condition:(r.querySelector("td:nth-child(2)")?.innerText||"").trim(),
        status:(r.querySelector("td:nth-child(3)")?.innerText||"").trim(),
        comment:(r.querySelector("td:nth-child(4)")?.innerText||"").trim(),
      }))
    },
    kpi:{
      psi2:(document.getElementById("psi2Score")?.textContent||"").trim(),
      psi2Zone:(document.getElementById("psi2Label")?.textContent||"").trim(),
      tech:(document.getElementById("techIndex")?.textContent||"").trim(),
      proc:(document.getElementById("procIndex")?.textContent||"").trim(),
      risk:(document.getElementById("riskIndex")?.textContent||"").trim(),
      coi:(document.getElementById("coiTotal")?.textContent||"").trim(),
      feas:(document.getElementById("feasScore")?.textContent||"").trim(),
      prodFeas:(document.getElementById("prodFeasScore")?.textContent||"").trim(),
      pain:(document.getElementById("painIndex")?.textContent||"").trim(),
      ready:(document.getElementById("readyIndex")?.textContent||"").trim(),
      prob:(document.getElementById("probIndex")?.textContent||"").trim(),
      recover:(document.getElementById("recoverIndex")?.textContent||"").trim(),
      bus:(document.getElementById("busIndex")?.textContent||"").trim(),
      obsol:(document.getElementById("obsolIndex")?.textContent||"").trim(),
      ai:(document.getElementById("aiIndex")?.textContent||"").trim(),
      crit:(document.getElementById("critScore")?.textContent||"").trim(),
      critLabel:(document.getElementById("critLabel")?.textContent||"").trim(),
    },
    audit:{
      savedAt:new Date().toISOString(),
      version:"v7.0 (excel+gsync)"
    }
  };
}


function flattenForSheets(raw){
  // –î–µ–ª–∞–µ—Ç –ø–ª–æ—Å–∫–∏–π –æ–±—ä–µ–∫—Ç –¥–ª—è Google Sheets: –∫–ª—é—á–∏ –∏–∑ —à–∞–ø–∫–∏ (1-—è —Å—Ç—Ä–æ–∫–∞) –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞—Å—Ç—å.
  // 1) meta.* –ø–æ–¥–Ω–∏–º–∞–µ–º –Ω–∞ –≤–µ—Ä—Ö–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å (company, industry, ...).
  // 2) –¢–∞–∫–∂–µ –∫–ª–∞–¥–µ–º –≤—Å–µ –ø—É—Ç–∏ –≤–∏–¥–∞ a.b.c (–µ—Å–ª–∏ –≤ —à–∏—Ç–µ —Ç–∞–∫ –Ω–∞–∑–≤–∞–ª–∏ –∫–æ–ª–æ–Ω–∫—É).
  // 3) –ü–æ–ª–Ω—ã–π –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π payload –¥—É–±–ª–∏—Ä—É–µ–º –≤ –ø–æ–ª–µ 'payload' (–µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å –≤ —à–∞–ø–∫–µ).
  const out = {};
  const seenLeaf = new Map(); // leafKey -> count

  function walk(cur, prefix){
    if(cur === null || cur === undefined) return;
    if(Array.isArray(cur)){
      out[prefix] = JSON.stringify(cur);
      return;
    }
    if(typeof cur === "object"){
      for(const k in cur){
        const key = prefix ? (prefix + "." + k) : k;
        walk(cur[k], key);
      }
      return;
    }
    out[prefix] = cur;
    const leaf = String(prefix).split(".").pop();
    seenLeaf.set(leaf, (seenLeaf.get(leaf)||0) + 1);
  }

  if(raw && typeof raw === "object"){
    walk(raw, "");
    // lift meta.*
    if(raw.meta && typeof raw.meta === "object"){
      for(const k in raw.meta){ out[k] = raw.meta[k]; }
    }
    // optional: lift KPI to simple names too
    if(raw.kpi && typeof raw.kpi === "object"){
      for(const k in raw.kpi){
        out[k] = out[k] ?? raw.kpi[k];         // if sheet uses 'psi2Score' etc
        out["kpi."+k] = raw.kpi[k];            // if sheet uses dot notation
      }
    }
    // include full payload
    out.payload = raw;
  }
  // Remove accidental empty key if any
  if(out[""] !== undefined) delete out[""];
  return out;
}




function apply(data){
  if(!data) return;
  const set=(id,v)=>{const el=document.getElementById(id); if(el) el.value = v ?? "";};

  const m=data.meta||{};
  set("company",m.company); set("industry",m.industry); set("lpr",m.lpr); set("sources",m.sources); set("envNote",m.envNote);
  set("workplaces",m.workplaces); set("servers",m.servers); set("branches",m.branches); set("vdi",m.vdi); set("closed",m.closed);
  set("benchMode",m.benchMode); set("interviewMode",m.interviewMode); set("pdfMode",m.pdfMode);

  const mat=data.maturity||{};
  if(mat.tech) mat.tech.forEach((x,i)=>{const s=document.querySelectorAll(".tech-score")[i]; const n=document.querySelectorAll(".tech-note")[i]; if(s) s.value=String(x.score??0); if(n) n.value=x.note??"";});
  if(mat.proc) mat.proc.forEach((x,i)=>{const s=document.querySelectorAll(".proc-score")[i]; const n=document.querySelectorAll(".proc-note")[i]; if(s) s.value=String(x.score??0); if(n) n.value=x.note??"";});
  if(mat.risk) mat.risk.forEach((x,i)=>{const s=document.querySelectorAll(".risk-score")[i]; const n=document.querySelectorAll(".risk-note")[i]; if(s) s.value=String(x.score??0); if(n) n.value=x.note??"";});

  const f=data.finance||{};
  set("salary",f.salary); set("itCount",f.itCount); set("manualPct",f.manualPct);
  set("licBudget",f.licBudget); set("unusedPct",f.unusedPct); set("vmUnusedPct",f.vmUnusedPct);
  set("hwBudget",f.hwBudget); set("hwPlan",f.hwPlan);
  set("downtimeHours",f.downtimeHours); set("downtimeCost",f.downtimeCost);
  set("incidentsPerMonth",f.incidentsPerMonth); set("serviceDesk",f.serviceDesk);
  set("keyPeopleRisk",f.keyPeopleRisk); set("docScore",f.docScore); set("obsoletePct",f.obsoletePct);
  set("finNote",f.note);

  // requirements
  const __reqTb=document.getElementById("reqTbody");
  if(__reqTb) __reqTb.innerHTML="";
  (data.requirements||[]).forEach(r=>addReqRow(r));
  // product requirements
  const prTb=document.getElementById("prodReqTbody");
  if(prTb){ prTb.innerHTML=""; (data.productRequirements||[]).forEach(r=>addProdReqRow(r)); }
  // psi
  const __psiTb=document.getElementById("psiTbody");
  if(__psiTb) __psiTb.innerHTML="";
  (data.psi||[]).forEach(r=>addPsiRow(r));
  const p=data.pilot||{};
  set("pilotGoal",p.goal); set("pilotTasks_removed",p.tasks); set("pilotKpi_removed",p.kpi); set("pilotScope",p.scope);
  set("pilotSummary",p.summary); set("pilotDecision",p.decision); set("recommendedConfig",p.recommendedConfig);

  const pr=(data.projectRisks||{});
  set("riskLevelText", pr.level);
  set("riskNotes", pr.notes);

  recalc();
}

function seedReq(){
  const presets=[
    {text:"–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ Active Directory / FreeIPA –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤", type:"–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏", must:"–î–∞", feas:"–ü–æ–ª–Ω–æ—Å—Ç—å—é", metric:"–û—Ç—á–µ—Ç/—Å–∫—Ä–∏–Ω –ø–æ –Ω–∞–π–¥–µ–Ω–Ω—ã–º –æ–±—ä–µ–∫—Ç–∞–º", owner:"–ö–ª–∏–µ–Ω—Ç+–ü—Ä–µ—Å–µ–π–ª"},
    {text:"–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è –ø–∏–ª–æ—Ç–Ω–æ–π –∑–æ–Ω—ã (‚â•95% —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –≤ –ø–µ—Ä–∏–º–µ—Ç—Ä–µ)", type:"–¢–µ—Ö", must:"–î–∞", feas:"–ü–æ–ª–Ω–æ—Å—Ç—å—é", metric:"–û—Ç—á–µ—Ç –ø–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º + —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å —ç—Ç–∞–ª–æ–Ω–æ–º", owner:"–ü—Ä–µ—Å–µ–π–ª"},
    {text:"–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –ü–û (–¥–æ–ª—è –Ω–µ—Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–æ–≥–æ ‚â§5%)", type:"–¢–µ—Ö", must:"–î–∞", feas:"–ß–∞—Å—Ç–∏—á–Ω–æ", metric:"–û—Ç—á–µ—Ç –ø–æ –ü–û", owner:"–ü—Ä–µ—Å–µ–π–ª"},
    {text:"–û—Ç—á–µ—Ç –ø–æ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω–æ–º—É/–Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ–º—É –ü–û", type:"–ò–ë", must:"–ù–µ—Ç", feas:"–¢—Ä–µ–±—É–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç", metric:"–°–ø–∏—Å–æ–∫/–æ—Ç—á–µ—Ç", owner:"–ü—Ä–µ—Å–µ–π–ª"},
  ];
  presets.forEach(p=>addReqRow(p));
}
function seedPsi(){
  const presets=[
    {req:"", scn:"–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –≤ –ø–∏–ª–æ—Ç–Ω–æ–π –∑–æ–Ω–µ", exp:"–°–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–µ—Ä–∏–º–µ—Ç—Ä—É, ‚â•95% –ø–æ–∫—Ä—ã—Ç–∏–µ", act:"", ok:"", acc:"", note:""},
    {req:"", scn:"–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –ü–û", exp:"–ù–µ—Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–æ–µ –ü–û ‚â§5% –∏ –≤—ã–¥–µ–ª–µ–Ω–æ –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–ø–∏—Å–∫–æ–º", act:"", ok:"", acc:"", note:""},
    {req:"", scn:"–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç—á–µ—Ç–∞ –ø–æ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω–æ–º—É –ü–û", exp:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω –æ—Ç—á–µ—Ç/—Å–ø–∏—Å–æ–∫ –ø–æ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º", act:"", ok:"", acc:"", note:""},
  ];
  presets.forEach(p=>addPsiRow(p));
}

document.getElementById("btnRecalc").addEventListener("click", recalc);
// ===== v7: Excel export + Google Sheets sync =====
const GOOGLE_SHEETS_WEBAPP_URL = (window.GS_WEBAPP_URL || "").trim();
console.log("‚úÖ Using Google Sheets WebApp URL:", GOOGLE_SHEETS_WEBAPP_URL);

function showLoader(title, sub){
  try{
    const el = document.getElementById("globalLoader");
    if(!el) return;
    const t = document.getElementById("globalLoaderTitle");
    const s = document.getElementById("globalLoaderSub");
    if(t) t.textContent = title || "–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶";
    if(s) s.textContent = sub || "Google Sheets –æ—Ç–≤–µ—á–∞–µ—Ç, —ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.";
    el.style.display = "flex";
    el.setAttribute("aria-hidden","false");
  }catch(_e){}
}
function hideLoader(){
  try{
    const el = document.getElementById("globalLoader");
    if(!el) return;
    el.style.display = "none";
    el.setAttribute("aria-hidden","true");
  }catch(_e){}
}

// –ï—Å–ª–∏ —É —Ç–µ–±—è –¥—Ä—É–≥–æ–π URL ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–º–µ–Ω—è–π —Å—Ç—Ä–æ–∫—É –≤—ã—à–µ.

function safeNum(v){
  const n = Number(String(v).replace(/[‚ÇΩ\s]/g,'').replace(',', '.').replace('%',''));
  return Number.isFinite(n) ? n : null;
}
function aoaSheet(rows){ return (window.XLSX ? XLSX.utils.aoa_to_sheet(rows) : null); }

function buildExcelWorkbook(payload){
  if(!window.XLSX) throw new Error("SheetJS (XLSX) –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è. –ü—Ä–æ–≤–µ—Ä—å –¥–æ—Å—Ç—É–ø –∫ CDN.");
  const wb = XLSX.utils.book_new();

  // Sheet: –ü–∞—Å–ø–æ—Ä—Ç + –§–∏–Ω–∞–Ω—Å—ã + KPI
  const m = payload.meta||{};
  const f = payload.finance||{};
  const k = payload.kpi||{};
  const s1 = [
    ["–†–∞–∑–¥–µ–ª","–ü–∞—Ä–∞–º–µ—Ç—Ä","–ó–Ω–∞—á–µ–Ω–∏–µ"],
    ["1) –ü–∞—Å–ø–æ—Ä—Ç","–ö–æ–º–ø–∞–Ω–∏—è", m.company||""],
    ["1) –ü–∞—Å–ø–æ—Ä—Ç","–û—Ç—Ä–∞—Å–ª—å", m.industry||""],
    ["1) –ü–∞—Å–ø–æ—Ä—Ç","–õ–ü–† / –∫–æ–Ω—Ç–∞–∫—Ç", m.lpr||""],
    ["1) –ü–∞—Å–ø–æ—Ä—Ç","–ò—Å—Ç–æ—á–Ω–∏–∫–∏", m.sources||""],
    ["1) –ü–∞—Å–ø–æ—Ä—Ç","–ü—Ä–∏–º–µ—á–∞–Ω–∏—è –ø–æ —Å—Ä–µ–¥–µ", m.envNote||""],
    ["1) –ü–∞—Å–ø–æ—Ä—Ç","–ö–æ–ª-–≤–æ —Ä–∞–±–æ—á–∏—Ö –º–µ—Å—Ç", m.workplaces??""],
    ["1) –ü–∞—Å–ø–æ—Ä—Ç","–ö–æ–ª-–≤–æ —Å–µ—Ä–≤–µ—Ä–æ–≤", m.servers??""],
    ["1) –ü–∞—Å–ø–æ—Ä—Ç","–ö–æ–ª-–≤–æ —Ñ–∏–ª–∏–∞–ª–æ–≤", m.branches??""],
    ["1) –ü–∞—Å–ø–æ—Ä—Ç","VDI", m.vdi||""],
    ["1) –ü–∞—Å–ø–æ—Ä—Ç","–ó–∞–∫—Ä—ã—Ç—ã–π –∫–æ–Ω—Ç—É—Ä", m.closed||""],
["1) –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞","–í–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è", m.virt||""],
    ["1) –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞","–ú–æ–¥–µ–ª—å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è", m.hostingModel||""],
    ["1) –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞","–î–æ–º–µ–Ω—ã AD / –∫–∞—Ç–∞–ª–æ–≥–æ–≤ (–∫–æ–ª-–≤–æ)", m.adDomains??""],
    ["1) –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞","–°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è —Å–µ—Ç–∏", m.netSeg||""],
    ["1) –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞","–¢–µ—Ä–º–∏–Ω–∞–ª—å–Ω—ã–µ —Ñ–µ—Ä–º—ã / RDS / VDI farms", m.terminalFarms||""],
    ["1) –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞","–í–æ–∑—Ä–∞—Å—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∂–µ–ª–µ–∑–∞", m.hwAge||""],
    ["1) –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞","–£—á–µ—Ç –∂–µ–ª–µ–∑–∞ (–∫–∞–∫ —Å–µ–π—á–∞—Å)", m.hwAccounting||""],
    ["1) –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞","–†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤", m.redundancy||""],
    ["","", ""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","–°—Ä–µ–¥–Ω—è—è –∑–∞—Ä–ø–ª–∞—Ç–∞ IT (‚ÇΩ/–º–µ—Å) GROSS", f.salary??""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","–ö–æ–ª-–≤–æ IT —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤", f.itCount??""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","% —Ä—É—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π", f.manualPct??""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","–ë—é–¥–∂–µ—Ç –Ω–∞ –ª–∏—Ü–µ–Ω–∑–∏–∏ (‚ÇΩ/–≥–æ–¥)", f.licBudget??""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","% –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ –ü–û", f.unusedPct??""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","% –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö VM", f.vmUnusedPct??""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","–ë—é–¥–∂–µ—Ç –Ω–∞ –∂–µ–ª–µ–∑–æ (‚ÇΩ/–≥–æ–¥)", f.hwBudget??""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","–ü–ª–∞–Ω –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∂–µ–ª–µ–∑–∞", f.hwPlan||""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","–ß–∞—Å–æ–≤ –ø—Ä–æ—Å—Ç–æ—è –≤ –≥–æ–¥", f.downtimeHours??""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","–°—Ç–æ–∏–º–æ—Å—Ç—å —á–∞—Å–∞ –ø—Ä–æ—Å—Ç–æ—è (‚ÇΩ/—á–∞—Å)", f.downtimeCost??""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","–ò–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤ –≤ –º–µ—Å—è—Ü", f.incidentsPerMonth??""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","–°–µ—Ä–≤–∏—Å-–¥–µ—Å–∫", f.serviceDesk||""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","Bus-factor ‚â§2 (–µ—Å—Ç—å?)", f.keyPeopleRisk||""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å (0‚Äì2)", f.docScore??""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","% —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –û–°/–ü–û", f.obsoletePct??""],
    ["3) –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞–∑–∞","–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π", f.note||""],
    ["","", ""],
    ["KPI (—à–∞–ø–∫–∞)","PSI 2.0", k.psi2||""],
    ["KPI (—à–∞–ø–∫–∞)","–ó–æ–Ω–∞ PSI", k.psi2Zone||""],
    ["KPI (—à–∞–ø–∫–∞)","–ò–Ω–¥–µ–∫—Å —Ç–µ—Ö. –∑—Ä–µ–ª–æ—Å—Ç–∏", k.tech||""],
    ["KPI (—à–∞–ø–∫–∞)","–ò–Ω–¥–µ–∫—Å –ø—Ä–æ—Ü. –∑—Ä–µ–ª–æ—Å—Ç–∏", k.proc||""],
    ["KPI (—à–∞–ø–∫–∞)","–ò–Ω–¥–µ–∫—Å —Ä–∏—Å–∫–∞", k.risk||""],
    ["KPI (—à–∞–ø–∫–∞)","Cost of Inaction (‚ÇΩ/–≥–æ–¥)", k.coi||""],
    ["KPI (—à–∞–ø–∫–∞)","–†–µ–∞–ª–∏–∑—É–µ–º–æ—Å—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π", k.feas||""],
    ["KPI (—à–∞–ø–∫–∞)","–≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ", k.pain||""],
    ["KPI (—à–∞–ø–∫–∞)","–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø–∏–ª–æ—Ç—É", k.ready||""],
    ["KPI (—à–∞–ø–∫–∞)","–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Å–¥–µ–ª–∫–∏", k.prob||""],
    ["KPI (—à–∞–ø–∫–∞)","–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –≤–æ–∑–≤—Ä–∞—Ç–∞ –±—é–¥–∂–µ—Ç–∞", k.recover||""],
    ["KPI (—à–∞–ø–∫–∞)","–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –ª—é–¥–µ–π", k.bus||""],
    ["KPI (—à–∞–ø–∫–∞)","–¢–µ—Ö. —Å—Ç–∞—Ä–µ–Ω–∏–µ", k.obsol||""],
    ["KPI (—à–∞–ø–∫–∞)","–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ò–ò", k.ai||""],
    ["KPI (—à–∞–ø–∫–∞)","–ö–∞—Ç–µ–≥–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞", k.crit||""],
    ["KPI (—à–∞–ø–∫–∞)","–ö–∞—Ç–µ–≥–æ—Ä–∏—è (–ª–µ–π–±–ª)", k.critLabel||""],
  ];
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(s1), "01_–ü–∞—Å–ø–æ—Ä—Ç+KPI");

  // Sheet: 2.1
  const tech = (payload.maturity?.tech||[]).map(x=>[x.key?.label||"", x.score, x.note||""]);
  tech.unshift(["–ö—Ä–∏—Ç–µ—Ä–∏–π","–ë–∞–ª–ª (0‚Äì2)","–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"]);
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(tech), "02_–¢–µ—Ö_2.1");

  // Sheet: 2.2
  const proc = (payload.maturity?.proc||[]).map(x=>[x.key?.label||"", x.score, x.note||""]);
  proc.unshift(["–ö—Ä–∏—Ç–µ—Ä–∏–π","–ë–∞–ª–ª (0‚Äì2)","–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"]);
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(proc), "03_–ü—Ä–æ—Ü_2.2");

  // Sheet: 2.3
  const risk = (payload.maturity?.risk||[]).map(x=>[x.key?.label||"", x.score, x.note||""]);
  risk.unshift(["–§–∞–∫—Ç–æ—Ä","–ï—Å—Ç—å? (0/1)","–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"]);
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(risk), "04_–†–∏—Å–∫–∏_2.3");

  // Sheet: 4 –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
  const req = (payload.requirements||[]).map((r,i)=>[i+1, r.text||"", r.type||"", r.must||"", r.feas||"", r.metric||"", r.owner||""]);
  req.unshift(["‚Ññ","–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞","–¢–∏–ø","–û–±—è–∑–∞—Ç.","–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å","–ú–µ—Ç—Ä–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏","–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π"]);
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(req), "05_–¢—Ä–µ–±_4");

  // Sheet: 5 –ü–°–ò
  const psi = (payload.psi||[]).map((r,i)=>[i+1, r.scn||"", r.exp||"", r.act||"", r.ok||"", r.acc||"", r.note||""]);
  psi.unshift(["‚Ññ","–°—Ü–µ–Ω–∞—Ä–∏–π","–û–∂–∏–¥–∞–Ω–∏–µ","–§–∞–∫—Ç","–°–æ–æ—Ç–≤.","–ü—Ä–∏–Ω—è–ª–∏?","–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"]);
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(psi), "06_–ü–°–ò_5");

  // Sheet: 5.1 –†–∏—Å–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞
  const pr = payload.projectRisks||{};
  const prHead = [
    ["–ü–∞—Ä–∞–º–µ—Ç—Ä","–ó–Ω–∞—á–µ–Ω–∏–µ"],
    ["–£—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ (–∏—Ç–æ–≥)", pr.level||""],
    ["–ß—Ç–æ –º–æ–∂–µ—Ç –ø–æ–π—Ç–∏ –Ω–µ —Ç–∞–∫ (–∫—Ä–∞—Ç–∫–æ)", pr.notes||""],
    ["",""],
    ["–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä","–£—Å–ª–æ–≤–∏–µ","–°—Ç–∞—Ç—É—Å","–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"],
  ];
  const prRows = (pr.table||[]).map(x=>[x.indicator||"", x.condition||"", x.status||"", x.comment||""]);
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(prHead.concat(prRows)), "07_–†–∏—Å–∫–∏_5.1");

  return wb;
}

function exportExcel(){
  try{
    recalc();
    try{ const vboxes=document.querySelectorAll(".virt-wrapper input[type=checkbox]"); if(vboxes && vboxes.length){ const sel=[...vboxes].filter(b=>b.checked).map(b=>b.value).join("; "); const hv=document.getElementById("virt"); if(hv) hv.value=sel; } }catch(e){} // —á—Ç–æ–±—ã KPI –∏ —Ä–∏—Å–∫–∏ —Ç–æ—á–Ω–æ –æ–±–Ω–æ–≤–∏–ª–∏—Å—å
    const payload = collect();
    const wb = buildExcelWorkbook(payload);
    const nameBase = (payload.meta?.company||"ITMen_PSI").replace(/[^\p{L}\p{N}_\- ]/gu,"").trim().slice(0,60) || "ITMen_PSI";
    const fname = `${nameBase}_PSI_v7.xlsx`;
    XLSX.writeFile(wb, fname);
  }catch(e){
    console.error(e);
    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–≥—Ä—É–∑–∏—Ç—å Excel: " + (e?.message||e));
  }
}

let _gsyncTimer = null;
async function syncToGoogleSheets(reason){
  // GitHub Pages CSP —á–∞—Å—Ç–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç fetch/beacon –Ω–∞ –≤–Ω–µ—à–Ω–∏–µ –¥–æ–º–µ–Ω—ã (connect-src 'self').
  // –ü–æ—ç—Ç–æ–º—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ —Å–∫—Ä—ã—Ç—É—é HTML-—Ñ–æ—Ä–º—É –≤ iframe (—ç—Ç–æ –Ω–µ fetch –∏ –æ–±—ã—á–Ω–æ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è).
  clearTimeout(_gsyncTimer);
  _gsyncTimer = setTimeout(async ()=>{
    try{
      try{ recalc(); }catch(_e){}
      const payloadRaw = collect();
      payloadRaw.audit = payloadRaw.audit || {};
      payloadRaw.audit.syncReason = reason || "manual";
      payloadRaw.audit.syncedAt = new Date().toISOString();
      const payload = flattenForSheets(payloadRaw);

      const st = document.getElementById("gsyncStatus");
      const url = (typeof GOOGLE_SHEETS_WEBAPP_URL === "string" ? GOOGLE_SHEETS_WEBAPP_URL : "") || "";
      if(!url) throw new Error("GOOGLE_SHEETS_WEBAPP_URL is not set");

      if(st){
        st.style.display="block";
        st.style.color="#0ea5e9";
        st.textContent="‚è´ –û—Ç–ø—Ä–∞–≤–ª—è—é –≤ Google Sheets‚Ä¶";
      }

      const form = document.getElementById("gsyncForm");
      const frame = document.getElementById("gsyncFrame");
      if(!form || !frame) throw new Error("gsync form/iframe not found");

      form.action = url;
      const payloadInput = form.querySelector('input[name="payload"]');
      payloadInput.value = JSON.stringify(payload);

      let done = false;
      const onload = () => {
        if(done) return;
        done = true;
        try{ frame.removeEventListener("load", onload); }catch(_){}
        if(st){
          st.style.color = "#16a34a";
          st.textContent = "‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Google Sheets.";
          setTimeout(()=>{ try{ st.style.display='none'; }catch(_e){} }, 3500);
        }
      };
      try{ frame.addEventListener("load", onload); }catch(_){}

      form.submit();

      setTimeout(()=>{
        if(done) return;
        done = true;
        if(st){
          st.style.color = "#16a34a";
          st.textContent = "‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ).";
          setTimeout(()=>{ try{ st.style.display='none'; }catch(_e){} }, 3500);
        }
      }, 1500);

    }catch(err){
      console.error("gsync error", err);
      const st = document.getElementById("gsyncStatus");
      if(st){
        st.style.display="block";
        st.style.color="#b91c1c";
        st.textContent="‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: " + ((err && err.message) ? err.message : err);
        setTimeout(()=>{ try{ st.style.display='none'; }catch(_e){} }, 6500);
      }
    }
  }, 200);
}

document.getElementById("btnExportXlsx")?.addEventListener("click", exportExcel);

// –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å = —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å (–ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
document.getElementById("btnRecalc").addEventListener("click", ()=>{ try{ recalc(); }catch(e){ console.warn("recalc() failed", e); } });

// –ü–µ—á–∞—Ç—å / –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ PDF = —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≤ Google Sheets
document.getElementById("btnPrint").addEventListener("click", ()=>{ try{ syncToGoogleSheets("pdf"); }catch(e){ console.warn("syncToGoogleSheets failed", e); } window.print(); });

document.getElementById("btnCLevel").addEventListener("click", ()=>{
  try{
    recalc(); // ensure latest
    const company = (document.getElementById("company").value || "–ö–æ–º–ø–∞–Ω–∏—è").trim();
    const psi2 = document.getElementById("psi2Score").textContent.replace("%","").trim();
    const psi2n = parseInt(psi2,10);
    const zone = document.getElementById("psi2Label").textContent;

    const coi = document.getElementById("coiTotal").textContent;
    const rec = document.getElementById("recoverIndex").textContent;
    const bus = document.getElementById("busIndex").textContent;
    const ob = document.getElementById("obsolIndex").textContent;
    const ai = document.getElementById("aiIndex").textContent;

    const topGaps = [];
    const pushGap = (name, val, hint)=>{
      const n = parseInt(String(val).replace("%","").trim(),10);
      if(isFinite(n) && n < 45) topGaps.push({name, n, hint});
    };
    pushGap("–£–ø—Ä–∞–≤–ª—è–µ–º–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö (—Ç–µ—Ö. –∑—Ä–µ–ª–æ—Å—Ç—å)", document.getElementById("techIndex").textContent, "–ù—É–∂–µ–Ω –µ–¥–∏–Ω—ã–π —Ä–µ–µ—Å—Ç—Ä –∞–∫—Ç–∏–≤–æ–≤ –∏ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π —Å–±–æ—Ä.");
    pushGap("–ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å –≤–Ω–µ–¥—Ä–µ–Ω–∏—è (–ø—Ä–æ—Ü. –∑—Ä–µ–ª–æ—Å—Ç—å)", document.getElementById("procIndex").textContent, "–ù—É–∂–Ω—ã —Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã –∏ —Ä–æ–ª–∏: –∫—Ç–æ –≤–ª–∞–¥–µ–ª–µ—Ü –¥–∞–Ω–Ω—ã—Ö/–ø—Ä–æ—Ü–µ—Å—Å–æ–≤.");
    pushGap("–í–æ–∑–≤—Ä–∞—Ç –±—é–¥–∂–µ—Ç–∞", rec, "–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ª–∏—Ü–µ–Ω–∑–∏–π/VM –¥–∞—ë—Ç –±—ã—Å—Ç—Ä—ã–π —ç—Ñ—Ñ–µ–∫—Ç.");
    pushGap("–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –ª—é–¥–µ–π", bus, "–°–Ω–∏–∑–∏—Ç—å bus-factor: –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è, —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã, –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∞–∫—Ç–∏–≤–æ–≤.");
    pushGap("–¢–µ—Ö–¥–æ–ª–≥", ob, "–ü–ª–∞–Ω –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –û–°/–ü–û –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –≤–µ—Ä—Å–∏–π/–ø–æ–¥–¥–µ—Ä–∂–∫–∏.");
    pushGap("–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏/–ò–ò", ai, "–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏ –µ–¥–∏–Ω—ã–π —Å–ª–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π.");

    topGaps.sort((a,b)=>a.n-b.n);
    const gapsText = topGaps.slice(0,4).map(g=>`‚Ä¢ ${g.name}: ${g.n}% ‚Äî ${g.hint}`).join("\n");

    const nextStep = "–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –ø–∏–ª–æ—Ç 4‚Äì6 –Ω–µ–¥–µ–ª—å –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –ø–µ—Ä–∏–º–µ—Ç—Ä–µ (–æ—Ñ–∏—Å/—Ñ–∏–ª–∏–∞–ª/VDI) —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞ –∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º –µ–¥–∏–Ω–æ–≥–æ —Ä–µ–µ—Å—Ç—Ä–∞ –∞–∫—Ç–∏–≤–æ–≤.";
    const text =
`C-level summary ‚Äî ${company}

PSI 2.0: ${isFinite(psi2n)?psi2n+"%":"‚Äî"} (${zone})

–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —ç—Ñ—Ñ–µ–∫—Ç (–æ—Ü–µ–Ω–∫–∞):
‚Ä¢ Cost of Inaction: ${coi} –≤ –≥–æ–¥ (—Ä—É—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ + –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–µ –ü–û + –ø—Ä–æ—Å—Ç–æ–∏)
‚Ä¢ –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –≤–æ–∑–≤—Ä–∞—Ç–∞ –±—é–¥–∂–µ—Ç–∞: ${rec}

–ö–ª—é—á–µ–≤—ã–µ –∑–æ–Ω—ã –ø—Ä–æ—Å–∞–¥–∫–∏ (—Ö—É–∂–µ ¬´–∑–¥–æ—Ä–æ–≤–æ–≥–æ —Ä—ã–Ω–∫–∞¬ª):
${gapsText || "‚Ä¢ –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –∫–ª—é—á–µ–≤—ã—Ö —Ä–∞–∑—Ä—ã–≤–æ–≤ ‚Äî –∑–∞–ø–æ–ª–Ω–∏—Ç–µ 3‚Äì5 –ø–æ–ª–µ–π (–ª–∏—Ü–µ–Ω–∑–∏–∏/VM/—Ç–µ—Ö–¥–æ–ª–≥/bus-factor)."}

–ß—Ç–æ –¥–∞—Å—Ç –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ:
‚Ä¢ –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ–± –ò–¢-–∞–∫—Ç–∏–≤–∞—Ö –∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
‚Ä¢ –°–Ω–∏–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–ø–ª–∞—Ç—ã –∑–∞ –ª–∏—Ü–µ–Ω–∑–∏–∏/—Ä–µ—Å—É—Ä—Å—ã –∏ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ —Ä—É—á–Ω—ã—Ö —Ç—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç
‚Ä¢ –°–Ω–∏–∂–µ–Ω–∏–µ —Ä–∏—Å–∫–æ–≤ –ø—Ä–æ–≤–µ—Ä–æ–∫ –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤

${nextStep}
`;
    const block = document.getElementById("cLevelBlock");
    const ta = document.getElementById("cLevelText");
    if(block && ta){
      ta.value = text;
      block.style.display = "block";
      block.scrollIntoView({behavior:"smooth", block:"start"});
    }
  }catch(e){
    console.error(e);
    alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –≤—ã–≤–æ–¥: " + e);
  }
});

document.getElementById("btnCopyCLevel").addEventListener("click", async ()=>{
  const ta=document.getElementById("cLevelText");
  if(!ta) return;
  try{ await navigator.clipboard.writeText(ta.value||""); }
  catch(e){ ta.select(); document.execCommand("copy"); }
});

document.getElementById("btnHideCLevel").addEventListener("click", ()=>{
  const block=document.getElementById("cLevelBlock");
  if(block) block.style.display="none";
});

document.getElementById("btnAddReq").addEventListener("click", ()=>addReqRow());
if(document.getElementById("btnAddProdReq")) document.getElementById("btnAddProdReq").addEventListener("click", ()=>addProdReqRow());
document.getElementById("btnClearReq").addEventListener("click", ()=>{
  if(confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è?")){ const __reqTb=document.getElementById("reqTbody");
  if(__reqTb) __reqTb.innerHTML=""; recalc(); }
});
if(document.getElementById("btnClearProdReq")) document.getElementById("btnClearProdReq").addEventListener("click", ()=>{
  if(confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø—Ä–æ–¥—É–∫—Ç—É?")){ const __prodTb=document.getElementById("prodReqTbody");
  if(__prodTb) __prodTb.innerHTML=""; recalc(); }
});
document.getElementById("btnAddPsi").addEventListener("click", ()=>addPsiRow());
document.getElementById("btnClearPsi").addEventListener("click", ()=>{
  if(confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –ü–°–ò?")){ const __psiTb=document.getElementById("psiTbody");
  if(__psiTb) __psiTb.innerHTML=""; recalc(); }
});

ensureBaseTables();
recalc();

const pdfModeEl = document.getElementById("pdfMode");
if(pdfModeEl){
  pdfModeEl.addEventListener("change", (e)=>{ setMode(e.target.value); recalc(); });
  setMode(pdfModeEl.value || "internal");
} else {
  setMode("internal");
}
updateRequiredUI();

const interviewModeEl = document.getElementById("interviewMode");
if(interviewModeEl){
  interviewModeEl.addEventListener("change",(e)=>{ setInterviewMode(e.target.value); recalc(); });
  setInterviewMode(interviewModeEl.value || "quick");
} else {
  setInterviewMode("quick");

const benchModeEl = document.getElementById("benchMode");
if(benchModeEl){
  benchModeEl.addEventListener("change",(e)=>{ recalc(); });
  if(!benchModeEl.value) benchModeEl.value = "mixed";
} else {
  // noop
}

}


/* ===================== Governance V2 additions ===================== */
function maturityLevel(maturityPct){
  if(!isFinite(maturityPct)) return "‚Äî";
  if(maturityPct >= 75) return "–í—ã—Å–æ–∫–∞—è";
  if(maturityPct >= 50) return "–°—Ä–µ–¥–Ω—è—è";
  if(maturityPct >= 35) return "–ù–∏–∂–µ —Å—Ä–µ–¥–Ω–µ–≥–æ";
  return "–ù–∏–∑–∫–∞—è";
}
function criticalityLabel(score){
  if(!isFinite(score)) return "‚Äî";
  if(score >= 75) return "–°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∞—è";
  if(score >= 50) return "–í—ã—Å–æ–∫–∞—è";
  if(score >= 25) return "–ó–Ω–∞—á–∏–º–∞—è";
  return "–ù–∏–∑–∫–∞—è";
}
function computeCriticality(coiRub, riskIdx01to5, maturityAvgPct){
  const projCostBase2 = ( (+document.getElementById("workplaces")?.value||0) + (+document.getElementById("servers")?.value||0) ) * 1300;
  const cap = projCostBase2 > 0 ? projCostBase2 : 5_000_000; // –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –ø—Ä–∞–≤–∏–ª—É: 5 –º–ª–Ω = 100 –±–∞–ª–ª–æ–≤
  const coiScore = Math.min(100, (coiRub / cap) * 100);
  const riskScale = Math.min(5, Math.max(1, riskIdx01to5 || 0)); // 1..5
  const crit = (coiScore * riskScale * (100 - maturityAvgPct)) / 500; // ~0..100
  return Math.max(0, Math.min(100, Math.round(crit)));
}
function setMode(mode){
  document.body.classList.remove("client-mode","internal-mode");
  document.body.classList.add(mode === "client" ? "client-mode" : "internal-mode");
}

function setInterviewMode(mode){
  document.body.classList.remove("quick-mode","deep-mode");
  document.body.classList.add(mode === "deep" ? "deep-mode" : "quick-mode");
}

function validateRequired(){
  const missing = [];
  const v = (id)=> (document.getElementById(id)?.value || "").trim();
  if(!v("company")) missing.push("–ö–æ–º–ø–∞–Ω–∏—è");
const psiRows = [...document.querySelectorAll("#psiTbody tr")];
  const hasPsi = psiRows.some(r=>{
    const scn=(r.querySelector(".psi-scn")?.value||"").trim();
    const exp=(r.querySelector(".psi-exp")?.value||"").trim();
    return scn && exp;
  });
  if(!hasPsi) missing.push("–ü–°–ò: —Ö–æ—Ç—è –±—ã 1 —Å—Ü–µ–Ω–∞—Ä–∏–π (—Å—Ü–µ–Ω–∞—Ä–∏–π + –æ–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç)");
  return missing;
}
function updateRequiredUI(){
  const missing = validateRequired();
  const btnPrint = document.getElementById("btnPrint");
  const st = document.getElementById("reqStatus");
  const ok = missing.length === 0;
  if(btnPrint){
    btnPrint.disabled = !ok;
    btnPrint.style.opacity = ok ? "1" : ".45";
    btnPrint.style.cursor = ok ? "pointer" : "not-allowed";
  }
  if(st){
    st.style.display = ok ? "none" : "block";
    st.textContent = "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: " + missing.join(", ");
  }
}
/* =================================================================== */


/* ===== KPI Explain Modal logic (safe, no impact on calculations) ===== *

/* Helpers for showing data sources + uncertainty */
function kpiParamKeys(kpiId){
  switch(kpiId){
    case "kCOI": return ["manualPct","unusedPct","downtimeHours","downtimeCost"];
    case "kRecover": return ["unusedPct","vmUnusedPct"];
    case "kBus": return ["keyPeopleRisk","docScore"];
    case "kObsol": return ["obsoletePct"];
    case "kReady": return ["manualPct","incidentsPerMonth"];
    case "kPSI": return ["manualPct","unusedPct","vmUnusedPct","downtimeHours","downtimeCost","incidentsPerMonth","obsoletePct","keyPeopleRisk","docScore"];
    default: return [];
  }
}
function kpiConfidencePct(kpiId){
  const keys = kpiParamKeys(kpiId);
  if(!keys.length) return NaN;
  const sum = keys.reduce((a,k)=>a + srcWeight(LAST_EST.params?.[k]?.src||"missing"),0);
  return Math.round(100*sum/keys.length);
}
function srcBadge(src){
  if(src==="client") return "üü¢ –∫–ª–∏–µ–Ω—Ç";
  if(src==="bench") return "üîµ –±–µ–Ω—á–º–∞—Ä–∫";
  if(src==="interview") return "üü° –∏–Ω—Ç–µ—Ä–≤—å—é";
  return "‚Äî";
}
function kpiBuildDataHtml(kpiId){
  const keys = kpiParamKeys(kpiId);
  if(!keys.length) return `<span class="small">–î–ª—è —ç—Ç–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ –Ω–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Å–∏–Ω—Ç–µ—Ç–∏–∫–∏.</span>`;
  const rows = keys.map(k=>{
    const p = LAST_EST.params?.[k];
    const v = p && isFinite(p.v) ? p.v : NaN;
    const labelMap = {
      manualPct:"–†—É—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, %",
      unusedPct:"–ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–µ –ü–û/–ª–∏—Ü–µ–Ω–∑–∏–∏, %",
      vmUnusedPct:"–ü—Ä–æ—Å—Ç–∞–∏–≤–∞—é—â–∏–µ VM, %",
      downtimeHours:"–ü—Ä–æ—Å—Ç–æ–∏, —á–∞—Å–æ–≤/–≥–æ–¥",
      downtimeCost:"–°—Ç–æ–∏–º–æ—Å—Ç—å —á–∞—Å–∞ –ø—Ä–æ—Å—Ç–æ—è, ‚ÇΩ/—á–∞—Å",
      incidentsPerMonth:"–ò–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤/–º–µ—Å",
      obsoletePct:"–£—Å—Ç–∞—Ä–µ–≤—à–µ–µ –û–°/–ü–û, %",
      keyPeopleRisk:"–ù–µ–∑–∞–º–µ–Ω–∏–º—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ (0/1)",
      docScore:"–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å (0‚Äì2)"
    };
    const lab = labelMap[k] || k;
    const range = p?.range ? formatRange(p.range) : "‚Äî";
    const vTxt = isFinite(v) ? (k.includes("Cost") ? fmtMoney(v) : Math.round(v).toString()) : "‚Äî";
    const src = srcBadge(p?.src);
    return `<tr><td>${lab}</td><td class="mono" style="text-align:right">${vTxt}</td><td class="mono" style="text-align:right">${range}</td><td style="text-align:right">${src}</td></tr>`;
  }).join("");
  const conf = kpiConfidencePct(kpiId);
  return `
    <div class="small" style="margin-bottom:8px">–î–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç—å –∏–Ω–¥–µ–∫—Å–∞: <b>${isFinite(conf)?conf:0}%</b> (—á–µ–º –±–æ–ª—å—à–µ üü¢, —Ç–µ–º —Ç–æ—á–Ω–µ–µ).</div>
    <table style="width:100%;border-collapse:collapse;font-size:13px">
      <thead>
        <tr style="opacity:.75">
          <th style="text-align:left;padding:6px 0;border-bottom:1px solid var(--border)">–ü–∞—Ä–∞–º–µ—Ç—Ä</th>
          <th style="text-align:right;padding:6px 0;border-bottom:1px solid var(--border)">–û—Ü–µ–Ω–∫–∞</th>
          <th style="text-align:right;padding:6px 0;border-bottom:1px solid var(--border)">P25‚ÄìP75</th>
          <th style="text-align:right;padding:6px 0;border-bottom:1px solid var(--border)">–ò—Å—Ç–æ—á–Ω–∏–∫</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

// Uncertainty range for Recover index (computed from benchmark ranges if present)
function recoverRange(){
  const pL = LAST_EST.params?.unusedPct;
  const pV = LAST_EST.params?.vmUnusedPct;
  if(!pL?.range || !pV?.range) return null;
  const calc = (L,V)=>{
    const Lr = clamp((L/100)/0.25, 0, 1);
    const Vr = clamp((V/100)/0.30, 0, 1);
    return Math.round(clamp(100*(1-(0.6*Lr+0.4*Vr)),0,100));
  };
  const lo = calc(pL.range[1], pV.range[1]); // worse case (higher waste)
  const hi = calc(pL.range[0], pV.range[0]); // best case
  return [Math.min(lo,hi), Math.max(lo,hi)];
}
const KPI_META = {
  kPSI: {
    title: "PSI 2.0 (–∏—Ç–æ–≥)",
    sub: "–°–≤–æ–¥–Ω—ã–π –∏–Ω–¥–µ–∫—Å –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏/—Ä–∏—Å–∫–æ–≤/—ç–∫–æ–Ω–æ–º–∏–∫–∏ –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏—è –æ –ø–∏–ª–æ—Ç–µ.",
    what: "–≠—Ç–æ ¬´–æ–±—â–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞¬ª –ø—Ä–æ–µ–∫—Ç–∞: –Ω–∞—Å–∫–æ–ª—å–∫–æ –≤—Å—ë –≥–æ—Ç–æ–≤–æ –¥–ª—è –ø–∏–ª–æ—Ç–∞ –∏ –≥–¥–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–≤–∞–ª—ã (–¥–∞–Ω–Ω—ã–µ, –ø—Ä–æ—Ü–µ—Å—Å—ã, —Ä–∏—Å–∫–∏, —ç–∫–æ–Ω–æ–º–∏–∫–∞).",
    how: "–°—á–∏—Ç–∞–µ—Ç—Å—è –∫–∞–∫ –≤–∑–≤–µ—à–µ–Ω–Ω–∞—è —Å—É–º–º–∞ –∏–Ω–¥–µ–∫—Å–æ–≤: —Ç–µ—Ö. –∑—Ä–µ–ª–æ—Å—Ç—å, –ø—Ä–æ—Ü–µ—Å—Å–Ω–∞—è –∑—Ä–µ–ª–æ—Å—Ç—å, —Ä–∏—Å–∫, —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ, —Ä–µ–∞–ª–∏–∑—É–µ–º–æ—Å—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π, –≤–æ–∑–≤—Ä–∞—Ç –±—é–¥–∂–µ—Ç–∞, –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –ª—é–¥–µ–π, —Ç–µ—Ö. —Å—Ç–∞—Ä–µ–Ω–∏–µ, AI –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å. –í–µ—Å–∞–º–∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç –º–æ–¥–µ–ª—å (–≤—à–∏—Ç–∞ –≤ –∫–æ–¥).",
    impact: "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è: ¬´–∏–¥—ë–º –≤ –ø–∏–ª–æ—Ç / —á—Ç–æ —Ñ–∏–∫—Å–∏—Ä—É–µ–º –¥–æ –ø–∏–ª–æ—Ç–∞ / –∫–∞–∫–æ–π —Å–æ—Å—Ç–∞–≤ –ø–∏–ª–æ—Ç–∞¬ª. –¢–∞–∫–∂–µ –≤–ª–∏—è–µ—Ç –Ω–∞ ¬´–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Å–¥–µ–ª–∫–∏¬ª (—á–µ—Ä–µ–∑ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å/—Ä–∏—Å–∫–∏).",
    doHtml: `
      <ul>
        <li><b>0‚Äì39%</b>: –ø–∏–ª–æ—Ç —Ä–∏—Å–∫–æ–≤–∞–Ω ‚Äî —Å–Ω–∞—á–∞–ª–∞ –∑–∞–∫—Ä—ã—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏/–ø—Ä–æ—Ü–µ—Å—Å—ã (—Å–ø–∏—Å–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π –Ω–∏–∂–µ –ø–æ –ø—Ä–æ–≤–∞–ª—å–Ω—ã–º –∏–Ω–¥–µ–∫—Å–∞–º), –∑–∞—Ç–µ–º –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è –∫ –ø–∏–ª–æ—Ç—É.</li>
        <li><b>40‚Äì69%</b>: –ø–∏–ª–æ—Ç –≤–æ–∑–º–æ–∂–µ–Ω ‚Äî –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–∏–ª–æ—Ç —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –æ–±—ä—ë–º–∞ –∏ —á—ë—Ç–∫–∏–º–∏ –∫—Ä–∏—Ç–µ—Ä–∏—è–º–∏ —É—Å–ø–µ—Ö–∞.</li>
        <li><b>70‚Äì100%</b>: –º–æ–∂–Ω–æ –∏–¥—Ç–∏ –≤ –ø–∏–ª–æ—Ç —É–≤–µ—Ä–µ–Ω–Ω–æ ‚Äî —Ä–∞—Å—à–∏—Ä—è—Ç—å –æ—Ö–≤–∞—Ç, –¥–æ–±–∞–≤–ª—è—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∏ KPI.</li>
      </ul>`
  },
  kTech: {
    title: "–ò–Ω–¥–µ–∫—Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –∑—Ä–µ–ª–æ—Å—Ç–∏",
    sub: "–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –ø–æ –¥–∞–Ω–Ω—ã–º –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º (AD/SCCM/VMware/SNMP –∏ —Ç.–¥.).",
    what: "–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω–æ —Å–æ–±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–∏–ª–æ—Ç–∞ –±—ã—Å—Ç—Ä–æ –∏ –±–µ–∑ –±–æ–ª–∏: –µ—Å—Ç—å –ª–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∏, –¥–æ—Å—Ç—É–ø—ã, —Å–ø–æ—Å–æ–±—ã —Å–±–æ—Ä–∞.",
    how: "–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞ –ø–æ —Å–ø–∏—Å–∫—É –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ —Ä–∞–∑–¥–µ–ª–∞ 2.1 (0=–Ω–µ—Ç, 1=—á–∞—Å—Ç–∏—á–Ω–æ, 2=–µ—Å—Ç—å), –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–Ω–∞—è –≤ –ø—Ä–æ—Ü–µ–Ω—Ç—ã.",
    impact: "–í–ª–∏—è–µ—Ç –Ω–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø–∏–ª–æ—Ç—É, —Å—Ä–æ–∫–∏ –∏ –æ–±—ä—ë–º —Ä–∞–±–æ—Ç –ø–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤. –ö–æ—Å–≤–µ–Ω–Ω–æ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ç–æ—á–Ω–æ—Å—Ç—å —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏—Ö —Ä–∞—Å—á—ë—Ç–æ–≤.",
    doHtml: `
      <ul>
        <li><b>0‚Äì39%</b>: –Ω–∞—á–∏–Ω–∞—Ç—å —Å ¬´–º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç—É—Ä–∞¬ª (AD + 1 –∏—Å—Ç–æ—á–Ω–∏–∫ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏), —Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø—ã/–æ–∫–Ω–∞, –≤—ã–±—Ä–∞—Ç—å –ø–∏–ª–æ—Ç–Ω—É—é –∑–æ–Ω—É.</li>
        <li><b>40‚Äì69%</b>: –ø–æ–¥–∫–ª—é—á–∞—Ç—å 2‚Äì4 –∫–ª—é—á–µ–≤—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–∞, –≤–∫–ª—é—á–∏—Ç—å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é/–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é, —Å–æ–±—Ä–∞—Ç—å –ø–µ—Ä–≤—É—é ¬´–µ–¥–∏–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É¬ª.</li>
        <li><b>70‚Äì100%</b>: —Ä–∞—Å—à–∏—Ä—è—Ç—å –æ—Ö–≤–∞—Ç (—Ñ–∏–ª–∏–∞–ª—ã/VDI/—Å–µ—Ç–µ–≤–æ–µ), –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏ –æ—Ç—á—ë—Ç—ã.</li>
      </ul>`
  },
  kProc: {
    title: "–ò–Ω–¥–µ–∫—Å –ø—Ä–æ—Ü–µ—Å—Å–Ω–æ–π –∑—Ä–µ–ª–æ—Å—Ç–∏",
    sub: "–ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å –≤–Ω–µ–¥—Ä–µ–Ω–∏—è (—Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã, —Ä–æ–ª–∏, –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞).",
    what: "–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –±—É–¥–µ—Ç —É–ø—Ä–∞–≤–ª—è–µ–º—ã–º: –µ—Å—Ç—å –ª–∏ –≤–ª–∞–¥–µ–ª—å—Ü—ã, –ø—Ä–∞–≤–∏–ª–∞ —É—á—ë—Ç–∞, –∑–∞–∫—É–ø–æ–∫, –∏–∑–º–µ–Ω–µ–Ω–∏–π.",
    how: "–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞ –ø–æ —Ä–∞–∑–¥–µ–ª—É 2.2 (0/1/2), –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–Ω–∞—è –≤ –ø—Ä–æ—Ü–µ–Ω—Ç—ã.",
    impact: "–í–ª–∏—è–µ—Ç –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π, –∫–∞—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö (–∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å), —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∞ (—ç–∫–æ–Ω–æ–º–∏—è –Ω–µ ¬´—Å—ä–µ–¥–∞–µ—Ç—Å—è¬ª –æ–±—Ä–∞—Ç–Ω–æ).",
    doHtml: `
      <ul>
        <li><b>0‚Äì39%</b>: —Ñ–∏–∫—Å–∏—Ä—É–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ (–≤–ª–∞–¥–µ–ª–µ—Ü —É—á—ë—Ç–∞, —Ä–µ–≥–ª–∞–º–µ–Ω—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ) ‚Äî –∏–Ω–∞—á–µ –ø–∏–ª–æ—Ç –¥–∞—Å—Ç ¬´–∫—Ä–∞—Å–∏–≤—ã–µ —Ü–∏—Ñ—Ä—ã¬ª, –Ω–æ –Ω–µ –∑–∞–∫—Ä–µ–ø–∏—Ç—Å—è.</li>
        <li><b>40‚Äì69%</b>: –æ–ø–∏—Å—ã–≤–∞–µ–º 2‚Äì3 –ø—Ä–æ—Ü–µ—Å—Å–∞ (—É—á—ë—Ç, –∑–∞–∫—É–ø–∫–∞, –≤—ã–≤–æ–¥), –≤–≤–æ–¥–∏–º —Ä–µ–≥—É–ª—è—Ä–Ω—É—é —Å–≤–µ—Ä–∫—É/–∞—É–¥–∏—Ç.</li>
        <li><b>70‚Äì100%</b>: –¥–æ–±–∞–≤–ª—è–µ–º KPI, –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ–º –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –∞–∫—Ç–∏–≤–æ–≤ –∏ –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç—å.</li>
      </ul>`
  },
  kRisk: {
    title: "–ò–Ω–¥–µ–∫—Å —Ä–∏—Å–∫–∞",
    sub: "–°—É–º–º–∞ —Ä–∏—Å–∫‚Äë—Ñ–∞–∫—Ç–æ—Ä–æ–≤ (0‚Äì5): 0‚Äì1 –Ω–∏–∑–∫–∏–π, 2‚Äì3 —Å—Ä–µ–¥–Ω–∏–π, 4‚Äì5 –≤—ã—Å–æ–∫–∏–π.",
    what: "–≠—Ç–æ –±—ã—Å—Ç—Ä—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä, –Ω–∞—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–µ–∫—Ç —Å–ª–æ–∂–Ω—ã–π/–æ–ø–∞—Å–Ω—ã–π –∏–∑‚Äë–∑–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç—å, –∏–∑–º–µ–Ω–µ–Ω–∏—è, —Ä—É—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —Ç.–¥.",
    how: "–°—á–∏—Ç–∞–µ—Ç—Å—è –∫–∞–∫ —Å—É–º–º–∞ –æ—Ç–º–µ—á–µ–Ω–Ω—ã—Ö —Ä–∏—Å–∫‚Äë—Ñ–∞–∫—Ç–æ—Ä–æ–≤ –≤ —Ä–∞–∑–¥–µ–ª–µ 2.3 (0/1).",
    impact: "–í–ª–∏—è–µ—Ç –Ω–∞ –ø–ª–∞–Ω –ø–∏–ª–æ—Ç–∞ (–æ–±—ä—ë–º, —Å—Ä–æ–∫–∏, –±—É—Ñ–µ—Ä—ã), —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –¥–æ–ø. –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è.",
    doHtml: `
      <ul>
        <li><b>0‚Äì1</b>: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–∏–ª–æ—Ç.</li>
        <li><b>2‚Äì3</b>: –ø–∏–ª–æ—Ç —Å –±—É—Ñ–µ—Ä–æ–º –ø–æ —Å—Ä–æ–∫–∞–º + —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Ä–∏—Å–∫–∏ –≤ –ø–ª–∞–Ω–µ (–¥–æ—Å—Ç—É–ø—ã, —Ñ–∏–ª–∏–∞–ª—ã, –ò–ë).</li>
        <li><b>4‚Äì5</b>: —Å–Ω–∞—á–∞–ª–∞ ¬´–ø–∏–ª–æ—Ç –ø–∏–ª–æ—Ç–∞¬ª (—É–∑–∫–∞—è –∑–æ–Ω–∞), –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º –∫—Ä–∏—Ç–∏—á–Ω—ã–µ —Ä–∏—Å–∫–∏ (–ò–ë, –¥–æ—Å—Ç—É–ø—ã, –∏—Å—Ç–æ—á–Ω–∏–∫–∏, —Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã).</li>
      </ul>`
  },
  kCoI: {
    title: "Cost of Inaction (‚ÇΩ/–≥–æ–¥)",
    sub: "–û—Ü–µ–Ω–∫–∞ –ø–æ—Ç–µ—Ä—å –æ—Ç –±–µ–∑–¥–µ–π—Å—Ç–≤–∏—è: —Ä—É—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ + –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–µ –ü–û + –ø—Ä–æ—Å—Ç–æ–∏.",
    what: "–°–∫–æ–ª—å–∫–æ –¥–µ–Ω–µ–≥ –≤ –≥–æ–¥ ¬´—É—Ç–µ–∫–∞–µ—Ç¬ª –∏–∑‚Äë–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—è (–¥–∞–∂–µ –±–µ–∑ –ø–æ–∫—É–ø–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–∞).",
    how: "–†—É—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ = –ó–ü√ó–ò–¢‚Äë—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏√ó%—Ä—É—á–Ω√ó12; –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–µ –ü–û = –±—é–¥–∂–µ—Ç –ª–∏—Ü–µ–Ω–∑–∏–π√ó%–Ω–µ–∏—Å–ø; –ü—Ä–æ—Å—Ç–æ–∏ = —á–∞—Å—ã –ø—Ä–æ—Å—Ç–æ—è√ó—Å—Ç–æ–∏–º–æ—Å—Ç—å —á–∞—Å–∞. –í—Å—ë —Å—É–º–º–∏—Ä—É–µ—Ç—Å—è.",
    impact: "–°–∏–ª—å–Ω—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç –¥–ª—è CFO/CEO: –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞ –Ω–∞ –ø–∏–ª–æ—Ç/–≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞.",
    doHtml: `
      <ul>
        <li><b>0‚Äì5 –º–ª–Ω</b>: —Ñ–æ–∫—É—Å –Ω–∞ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É –¥–∞–Ω–Ω—ã—Ö –∏ ¬´–±—ã—Å—Ç—Ä—ã–µ –ø–æ–±–µ–¥—ã¬ª (—É—á—ë—Ç, –±–∞–∑–æ–≤—ã–µ –æ—Ç—á—ë—Ç—ã).</li>
        <li><b>5‚Äì20 –º–ª–Ω</b>: –ø–∏–ª–æ—Ç –Ω–∞ —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π —ç—Ñ—Ñ–µ–∫—Ç (–ª–∏—Ü–µ–Ω–∑–∏–∏ + –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è + –∫–æ–Ω—Ç—Ä–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∏–π).</li>
        <li><b>20+ –º–ª–Ω</b>: –±—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç, —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –æ—Ö–≤–∞—Ç–∞, –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–æ–ª—è.</li>
      </ul>`
  },
  kCrit: {
    title: "–ö–∞—Ç–µ–≥–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞",
    sub: "–û—Ü–µ–Ω–∫–∞ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏/–º–∞—Å—à—Ç–∞–±–∞ –ø—Ä–æ–µ–∫—Ç–∞ (–ø—Ä–æ—Ü–µ–Ω—Ç + –º–µ—Ç–∫–∞).",
    what: "–ù–∞—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–µ–∫—Ç ¬´–±–æ–ª—å—à–æ–π¬ª –ø–æ –º–∞—Å—à—Ç–∞–±—É/—Å–ª–æ–∂–Ω–æ—Å—Ç–∏ ‚Äî —á—Ç–æ–±—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤—ã–±—Ä–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç –ø–∏–ª–æ—Ç–∞ –∏ —Ä–µ—Å—É—Ä—Å—ã.",
    how: "–°—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –ø–∞—Å–ø–æ—Ä—Ç–∞ (–æ–±—ä—ë–º—ã, —Ñ–∏–ª–∏–∞–ª—ã, VDI/–∑–∞–∫—Ä—ã—Ç—ã–π –∫–æ–Ω—Ç—É—Ä/–≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è –∏ –¥—Ä.) –∏ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é.",
    impact: "–í–ª–∏—è–µ—Ç –Ω–∞ –æ–±—ä—ë–º –ø–∏–ª–æ—Ç–∞, –ø–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è, –Ω—É–∂–Ω—ã–µ —Ä–æ–ª–∏ –∏ —Å—Ä–æ–∫–∏.",
    doHtml: `
      <ul>
        <li><b>0‚Äì33%</b>: –ª—ë–≥–∫–∏–π –ø–∏–ª–æ—Ç (1 –ø–ª–æ—â–∞–¥–∫–∞/–ø–æ–¥—Å–µ—Ç—å, 1‚Äì2 –∏—Å—Ç–æ—á–Ω–∏–∫–∞).</li>
        <li><b>34‚Äì66%</b>: —Å—Ä–µ–¥–Ω–∏–π –ø–∏–ª–æ—Ç (–Ω–µ—Å–∫–æ–ª—å–∫–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤, —á–∞—Å—Ç—å —Ñ–∏–ª–∏–∞–ª–æ–≤/VDI –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏).</li>
        <li><b>67‚Äì100%</b>: –∫—Ä—É–ø–Ω—ã–π –ø–∏–ª–æ—Ç (—Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è, –ò–ë, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏, –ø–æ—ç—Ç–∞–ø–Ω–æ—Å—Ç—å).</li>
      </ul>`
  },
  kFeas: {
    title: "–ò–Ω–¥–µ–∫—Å —Ä–µ–∞–ª–∏–∑—É–µ–º–æ—Å—Ç–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π",
    sub: "–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª ¬´–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏¬ª –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π.",
    what: "–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –ø–∏–ª–æ—Ç–∞ –≤—ã–ø–æ–ª–Ω–∏–º—ã –≤ —Ç–µ–∫—É—â–µ–º –∫–æ–Ω—Ç—É—Ä–µ (–∏—Å—Ç–æ—á–Ω–∏–∫–∏, –¥–æ—Å—Ç—É–ø—ã, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ò–ë).",
    how: "–ë–µ—Ä—ë—Ç—Å—è —Å—Ä–µ–¥–Ω–∏–π score –ø–æ –ø–æ–ª—é ¬´–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å¬ª (—Ä–∞–∑–¥–µ–ª —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π) –∏ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è –≤ –ø—Ä–æ—Ü–µ–Ω—Ç—ã.",
    impact: "–í–ª–∏—è–µ—Ç –Ω–∞ –ø–ª–∞–Ω –ø–∏–ª–æ—Ç–∞: –∫–∞–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –±–µ—Ä—ë–º –≤ –ø–∏–ª–æ—Ç, –∫–∞–∫–∏–µ ‚Äî –≤ —ç—Ç–∞–ø 2.",
    doHtml: `
      <ul>
        <li><b>0‚Äì49%</b>: —Å—É–∑–∏—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –ø–∏–ª–æ—Ç–∞ –¥–æ –±–∞–∑–æ–≤–æ–≥–æ –∫–æ–Ω—Ç—É—Ä–∞, —Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–æ—Å—Ç—É–ø—ã.</li>
        <li><b>50‚Äì79%</b>: –ø–∏–ª–æ—Ç –ø–æ –æ—Å–Ω–æ–≤–Ω—ã–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º + 1‚Äì2 ¬´–ø—Ä–µ–º–∏—É–º¬ª –∫–µ–π—Å–∞.</li>
        <li><b>80‚Äì100%</b>: –º–æ–∂–Ω–æ –±—Ä–∞—Ç—å —à–∏—Ä–æ–∫–∏–π —Å–ø–∏—Å–æ–∫ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∏ –¥–µ–ª–∞—Ç—å –¥–µ–º–æ‚Äë–æ—Ç—á—ë—Ç—ã.</li>
      </ul>`
  },
      kProdFeas: {
        title:"–ò–Ω–¥–µ–∫—Å —Ä–µ–∞–ª–∏–∑—É–µ–º–æ—Å—Ç–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ –ø—Ä–æ–¥—É–∫—Ç—É",
        what:"–û—Ü–µ–Ω–∫–∞ —Ç–æ–≥–æ, –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø—Ä–æ–¥—É–∫—Ç—É —Ä–µ–∞–ª–∏–∑—É–µ–º—ã –≤ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏/–ø–ª–∞–Ω–∞—Ö.",
        how:"–°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ –∫–æ–ª–æ–Ω–∫–µ ¬´–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å¬ª –≤ —Ä–∞–∑–¥–µ–ª–µ 6, –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö.",
        data:"–û—Å–Ω–æ–≤–∞–Ω–æ –Ω–∞ —Ä–µ–µ—Å—Ç—Ä–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ –ø—Ä–æ–¥—É–∫—Ç—É (—Ä–∞–∑–¥–µ–ª 6).",
        impact:"–í–ª–∏—è–µ—Ç –Ω–∞ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç—å –æ–∂–∏–¥–∞–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–∞ –∏ –Ω–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ roadmap.",
        do:"–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ä–∞–∑–¥–µ–ª 6. –ï—Å–ª–∏ –∏–Ω–¥–µ–∫—Å –Ω–∏–∑–∫–∏–π ‚Äî —Ñ–∏–∫—Å–∏—Ä—É–π—Ç–µ –æ–∂–∏–¥–∞–Ω–∏—è, –ø–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∏ roadmap, –∏–ª–∏ —É—Ç–æ—á–Ω—è–π—Ç–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è."
      },
  kPain: {
    title: "–ò–Ω–¥–µ–∫—Å —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–≥–æ –¥–∞–≤–ª–µ–Ω–∏—è",
    sub: "–ù–∞—Å–∫–æ–ª—å–∫–æ –æ—Å—Ç—Ä–æ –±–∏–∑–Ω–µ—Å—É –Ω—É–∂–Ω–æ —Å–Ω–∏–∑–∏—Ç—å –∑–∞—Ç—Ä–∞—Ç—ã/—Ä–∏—Å–∫–∏ —Å–µ–π—á–∞—Å.",
    what: "–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç ¬´–Ω–∞—Å–∫–æ–ª—å–∫–æ –±–æ–ª–∏—Ç¬ª —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏: –±—é–¥–∂–µ—Ç—ã, —Ä—É—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, –ø—Ä–æ—Å—Ç–æ–∏ –∏ —Ç.–ø.",
    how: "–°—á–∏—Ç–∞–µ—Ç—Å—è –∏–∑ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –±–ª–æ–∫–∞ (—Ä—É—á–Ω–æ–π —Ç—Ä—É–¥, –±—é–¥–∂–µ—Ç –ª–∏—Ü–µ–Ω–∑–∏–π, –Ω–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ, –ø—Ä–æ—Å—Ç–æ–∏) –ø–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π —à–∫–∞–ª–µ.",
    impact: "–í–ª–∏—è–µ—Ç –Ω–∞ –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—é: –µ—Å–ª–∏ –¥–∞–≤–ª–µ–Ω–∏–µ –≤—ã—Å–æ–∫–æ–µ ‚Äî –¥–µ–ª–∞–µ–º –ø–∏–ª–æ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ ¬´–¥–µ–Ω–µ–∂–Ω—ã–º¬ª.",
    doHtml: `
      <ul>
        <li><b>0‚Äì33%</b>: –ø–∏–ª–æ—Ç –±–æ–ª—å—à–µ –ø—Ä–æ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å/–∫–æ–Ω—Ç—Ä–æ–ª—å.</li>
        <li><b>34‚Äì66%</b>: –ø–∏–ª–æ—Ç –ø—Ä–æ —ç–∫–æ–Ω–æ–º–∏—é (–ª–∏—Ü–µ–Ω–∑–∏–∏ + –∞–∫—Ç–∏–≤—ã) –∏ –±—ã—Å—Ç—Ä—ã–µ –æ—Ç—á—ë—Ç—ã.</li>
        <li><b>67‚Äì100%</b>: –ø–∏–ª–æ—Ç –∫–∞–∫ –∞–Ω—Ç–∏–∫—Ä–∏–∑–∏—Å–Ω—ã–π –ø—Ä–æ–µ–∫—Ç: –±—ã—Å—Ç—Ä—ã–µ –¥–µ–Ω—å–≥–∏ + –∫–æ–Ω—Ç—Ä–æ–ª—å —Ä–∏—Å–∫–æ–≤.</li>
      </ul>`
  },
  kReady: {
    title: "–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø–∏–ª–æ—Ç—É",
    sub: "–ò–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å –ø–∏–ª–æ—Ç.",
    what: "–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –º–æ–∂–Ω–æ –ª–∏ –Ω–∞—á–∏–Ω–∞—Ç—å –ø–∏–ª–æ—Ç –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å –∏–ª–∏ —Å–Ω–∞—á–∞–ª–∞ –Ω–∞–¥–æ –∑–∞–∫—Ä—ã—Ç—å –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É–Ω–∫—Ç—ã.",
    how: "–ö–æ–º–±–∏–Ω–∞—Ü–∏—è —Ç–µ—Ö. –∑—Ä–µ–ª–æ—Å—Ç–∏, –ø—Ä–æ—Ü–µ—Å—Å–Ω–æ–π –∑—Ä–µ–ª–æ—Å—Ç–∏, —Ä–µ–∞–ª–∏–∑—É–µ–º–æ—Å—Ç–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∏ —Ä–∏—Å–∫‚Äë—Ñ–∞–∫—Ç–æ—Ä–æ–≤ (–≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞).",
    impact: "–í–ª–∏—è–µ—Ç –Ω–∞ —Ä–µ—à–µ–Ω–∏–µ ¬´—Å—Ç–∞—Ä—Ç—É–µ–º/–≥–æ—Ç–æ–≤–∏–º¬ª –∏ –Ω–∞ –æ–±—ä—ë–º –ø–∏–ª–æ—Ç–∞.",
    doHtml: `
      <ul>
        <li><b>0‚Äì49%</b>: –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (–¥–æ—Å—Ç—É–ø—ã, –∏—Å—Ç–æ—á–Ω–∏–∫–∏, —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è), –∑–∞—Ç–µ–º —Å—Ç–∞—Ä—Ç.</li>
        <li><b>50‚Äì79%</b>: –º–æ–∂–Ω–æ —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å –ø–∏–ª–æ—Ç –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –∑–æ–Ω–µ.</li>
        <li><b>80‚Äì100%</b>: –º–æ–∂–Ω–æ —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å –ø–∏–ª–æ—Ç —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è–º–∏.</li>
      </ul>`
  },
  kProb: {
    title: "–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Å–¥–µ–ª–∫–∏",
    sub: "–û—Ü–µ–Ω–∫–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–Ω–¥–µ–∫—Å–æ–≤ (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π KPI –ø—Ä–µ—Å–µ–π–ª–∞).",
    what: "–≠—Ç–æ –Ω–µ ¬´–º–∞–≥–∏—è¬ª, –∞ —É–¥–æ–±–Ω—ã–π –æ—Ä–∏–µ–Ω—Ç–∏—Ä: –Ω–∞—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–µ–∫—Ç –≤—ã–≥–ª—è–¥–∏—Ç ¬´–∂–∏–≤—ã–º¬ª –ø–æ –¥–∞–Ω–Ω—ã–º, –ø—Ä–æ—Ü–µ—Å—Å–∞–º –∏ —ç–∫–æ–Ω–æ–º–∏–∫–µ.",
    how: "–ö–æ–º–±–∏–Ω–∏—Ä—É–µ—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø–∏–ª–æ—Ç—É, —Ä–∏—Å–∫‚Äë–ø—Ä–æ—Ñ–∏–ª—å –∏ —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ (–≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞).",
    impact: "–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è –ø—Ä–æ–¥–∞–∂: –≥–¥–µ —É—Å–∏–ª–∏–≤–∞—Ç—å –ø—Ä–µ—Å–µ–π–ª, –≥–¥–µ –ø—Ä–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ, –≥–¥–µ –∑–∞–∫—Ä—ã–≤–∞—Ç—å —Ä–∏—Å–∫–∏.",
    doHtml: `
      <ul>
        <li><b>0‚Äì39%</b>: —É—Å–∏–ª–∏–≤–∞–µ–º –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—é, —É—Ç–æ—á–Ω—è–µ–º –õ–ü–†/–±–æ–ª—å/–¥–∞–Ω–Ω—ã–µ, —Ñ–∏–∫—Å–∏—Ä—É–µ–º next step.</li>
        <li><b>40‚Äì69%</b>: –≥–æ—Ç–æ–≤–∏–º –ø–∏–ª–æ—Ç–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º —ç–∫–æ–Ω–æ–º–∏–∫—É –∏ –¥–æ—Å—Ç—É–ø—ã.</li>
        <li><b>70‚Äì100%</b>: —É—Å–∫–æ—Ä—è–µ–º—Å—è: —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –ø–∏–ª–æ—Ç–∞/–ö–ü, –∫–∞–ª–µ–Ω–¥–∞—Ä—å —Ä–∞–±–æ—Ç, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ.</li>
      </ul>`
  },
  kRecover: {
    title: "–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –≤–æ–∑–≤—Ä–∞—Ç–∞ –±—é–¥–∂–µ—Ç–∞",
    sub: "–≠–∫–æ–Ω–æ–º–∏—è –Ω–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ª–∏—Ü–µ–Ω–∑–∏—è—Ö –∏ –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–∞—Ö.",
    what: "–°–∫–æ–ª—å–∫–æ –±—é–¥–∂–µ—Ç–∞ –º–æ–∂–Ω–æ ¬´–≤–µ—Ä–Ω—É—Ç—å¬ª –∑–∞ —Å—á—ë—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ª–∏—Ü–µ–Ω–∑–∏–π –∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã.",
    how: "–ë–µ—Ä—ë—Ç—Å—è % –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ –ü–û (–∏ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ ‚Äî –∏–∑–±—ã—Ç–æ—á–Ω–æ—Å—Ç—å VM) –∏ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è –≤ –∏–Ω–¥–µ–∫—Å: —á–µ–º –±–æ–ª—å—à–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ, —Ç–µ–º –Ω–∏–∂–µ —Ç–µ–∫—É—â–∞—è –∑—Ä–µ–ª–æ—Å—Ç—å –∏ —Ç–µ–º –≤—ã—à–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª —ç–∫–æ–Ω–æ–º–∏–∏.",
    impact: "–ü—Ä—è–º–∞—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–∏–ª–æ—Ç–∞: –Ω–∞ —ç—Ç–æ–º –∏–Ω–¥–µ–∫—Å–µ –ø—Ä–æ—â–µ –≤—Å–µ–≥–æ –ø–æ–∫–∞–∑–∞—Ç—å –±—ã—Å—Ç—Ä—ã–π —ç—Ñ—Ñ–µ–∫—Ç.",
    doHtml: `
      <ul>
        <li><b>0‚Äì39%</b>: –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª —ç–∫–æ–Ω–æ–º–∏–∏ –Ω–∏–∑–∫–∏–π ‚Äî —Ñ–æ–∫—É—Å –Ω–∞ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å, –Ω–µ –æ–±–µ—â–∞–µ–º ¬´–º–Ω–æ–≥–æ –¥–µ–Ω–µ–≥¬ª.</li>
        <li><b>40‚Äì69%</b>: –µ—Å—Ç—å –æ—â—É—Ç–∏–º–∞—è —ç–∫–æ–Ω–æ–º–∏—è ‚Äî –ø–∏–ª–æ—Ç –Ω–∞ –ª–∏—Ü–µ–Ω–∑–∏–∏ + –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é + –æ—Ç—á—ë—Ç—ã.</li>
        <li><b>70‚Äì100%</b>: –≤—ã—Å–æ–∫–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª ‚Äî –Ω–∞—á–∏–Ω–∞–µ–º —Å SAM/usage –∏ –±—ã—Å—Ç—Ä—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π (–ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ/—Å–Ω—è—Ç–∏–µ).</li>
      </ul>`
  },
  kBus: {
    title: "–ò–Ω–¥–µ–∫—Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ª—é–¥–µ–π (Bus‚Äëfactor)",
    sub: "–†–∏—Å–∫ ¬´–¥–µ—Ä–∂–∏—Ç—Å—è –Ω–∞ 1‚Äì2 –ª—é–¥—è—Ö¬ª + –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.",
    what: "–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ –∑–Ω–∞–Ω–∏—è –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –∞–∫—Ç–∏–≤–∞–º–∏ –∑–∞–≤—è–∑–∞–Ω—ã –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞—Ö/–ø–æ–¥—Ä—è–¥—á–∏–∫–∞—Ö.",
    how: "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –æ—Ç–≤–µ—Ç—ã –ø—Ä–æ ¬´–Ω–µ–∑–∞–º–µ–Ω–∏–º—ã—Ö¬ª –∏ —É—Ä–æ–≤–µ–Ω—å –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏/—Ä–µ–≥–ª–∞–º–µ–Ω—Ç–æ–≤ (–¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –ø–æ–ª—è) + –ø—Ä–æ—Ü–µ—Å—Å–Ω—É—é –∑—Ä–µ–ª–æ—Å—Ç—å.",
    impact: "–í–ª–∏—è–µ—Ç –Ω–∞ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å: –±–µ–∑ —Å–Ω–∏–∂–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —ç—Ñ—Ñ–µ–∫—Ç –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –±—É–¥–µ—Ç –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–º.",
    doHtml: `
      <ul>
        <li><b>0‚Äì39%</b>: –≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ ‚Äî —Ñ–æ—Ä–º–∞–ª–∏–∑—É–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, –æ–ø–∏—Å—ã–≤–∞–µ–º –º–∏–Ω–∏–º—É–º –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, —Ñ–∏–∫—Å–∏—Ä—É–µ–º –∑–Ω–∞–Ω–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ.</li>
        <li><b>40‚Äì69%</b>: —Å—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫ ‚Äî –≤–≤–æ–¥–∏–º —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –æ—Ç—á—ë—Ç—ã/–∞—É–¥–∏—Ç, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–æ–ª–∏.</li>
        <li><b>70‚Äì100%</b>: –Ω–∏–∑–∫–∏–π —Ä–∏—Å–∫ ‚Äî –º–æ–∂–Ω–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –±–µ–∑ —Å—Ç—Ä–∞—Ö–∞ ¬´–ø–æ—Ç–µ—Ä—è—Ç—å –∫–ª—é—á–µ–≤–æ–≥–æ¬ª.</li>
      </ul>`
  },
  kObsol: {
    title: "–ò–Ω–¥–µ–∫—Å —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ —Å—Ç–∞—Ä–µ–Ω–∏—è",
    sub: "–£—Å—Ç–∞—Ä–µ–≤—à–∏–µ –û–°/–ü–û + –≤–æ–∑—Ä–∞—Å—Ç –ø–∞—Ä–∫–∞.",
    what: "–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥: —Å–∫–æ–ª—å–∫–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —É—Å—Ç–∞—Ä–µ–ª–æ –∏ –ø–æ–≤—ã—à–∞–µ—Ç —Ä–∏—Å–∫–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏/–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.",
    how: "–ë–µ—Ä—ë—Ç—Å—è % —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –û–°/–ü–û (–µ—Å–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ) + —Ñ–∞–∫—Ç–æ—Ä –≤–æ–∑—Ä–∞—Å—Ç–∞ –∂–µ–ª–µ–∑–∞ (–ø–æ–ª–µ ¬´–í–æ–∑—Ä–∞—Å—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∂–µ–ª–µ–∑–∞¬ª).",
    impact: "–í–ª–∏—è–µ—Ç –Ω–∞ —Ä–∏—Å–∫–∏ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤, —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏.",
    doHtml: `
      <ul>
        <li><b>0‚Äì39%</b>: –∫—Ä–∏—Ç–∏—á–Ω–æ ‚Äî –ø–ª–∞–Ω –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö —Å–µ–≥–º–µ–Ω—Ç–æ–≤, –∫–æ–Ω—Ç—Ä–æ–ª—å –≤–µ—Ä—Å–∏–π –∏ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω–æ–≥–æ –ü–û.</li>
        <li><b>40‚Äì69%</b>: —É–º–µ—Ä–µ–Ω–Ω–æ ‚Äî —Å–æ—Å—Ç–∞–≤–ª—è–µ–º roadmap –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏ –≤–≤–æ–¥–∏–º –∫–æ–Ω—Ç—Ä–æ–ª—å –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞.</li>
        <li><b>70‚Äì100%</b>: —Ö–æ—Ä–æ—à–æ ‚Äî –º–æ–∂–Ω–æ —Å–º–µ—â–∞—Ç—å —Ñ–æ–∫—É—Å –Ω–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é.</li>
      </ul>`
  },
  kAI: {
    title: "–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ò–ò / –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏",
    sub: "–ù–∞—Å–∫–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ –∏ –∫–æ–Ω—Ç—É—Ä –≥–æ—Ç–æ–≤—ã –∫ –≤–Ω–µ–¥—Ä–µ–Ω–∏—é –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏/–∞–Ω–∞–ª–∏—Ç–∏–∫–∏.",
    what: "–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –º–æ–∂–Ω–æ –ª–∏ —Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é/–∞–Ω–∞–ª–∏—Ç–∏–∫—É/–ò–ò –ø–æ–≤–µ—Ä—Ö –¥–∞–Ω–Ω—ã—Ö ‚Äî –∏–ª–∏ —Å–Ω–∞—á–∞–ª–∞ –Ω—É–∂–µ–Ω –ø–æ—Ä—è–¥–æ–∫ –≤ –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è.",
    how: "–ö–æ–º–±–∏–Ω–∞—Ü–∏—è —Ç–µ—Ö. –∑—Ä–µ–ª–æ—Å—Ç–∏ –∏ –ø—Ä–æ—Ü–µ—Å—Å–Ω–æ–π –∑—Ä–µ–ª–æ—Å—Ç–∏ + –Ω–∞–ª–∏—á–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤/—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö (–≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞).",
    impact: "–í–ª–∏—è–µ—Ç –Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–µ–ª–∞—Ç—å –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É (heatmap –ü–û, –ø—Ä–æ–≥–Ω–æ–∑—ã, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∏).",
    doHtml: `
      <ul>
        <li><b>0‚Äì39%</b>: —Å–Ω–∞—á–∞–ª–∞ –ø–æ—Ä—è–¥–æ–∫ –≤ –¥–∞–Ω–Ω—ã—Ö (–∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è, –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è, –µ–¥–∏–Ω—ã–π —Ä–µ–µ—Å—Ç—Ä).</li>
        <li><b>40‚Äì69%</b>: –º–æ–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å —Å –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–æ–≤/–ø—Ä–∞–≤–∏–ª –∏ –ø—Ä–æ—Å—Ç—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.</li>
        <li><b>70‚Äì100%</b>: –º–æ–∂–Ω–æ —Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ (–ø—Ä–µ–¥–∏–∫—Ç–∏–≤–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, –∞–≤—Ç–æ–ø–æ–ª–∏—Ç–∏–∫–∏).</li>
      </ul>`
  }
};

function kpiModalOpen(kpiId){
  const meta = KPI_META[kpiId];
  if(!meta) return;
  const m = document.getElementById("kpiModal");
  if(!m) return;
  // Defensive: modal markup may vary across pages
  const tEl = document.getElementById("kpiModalTitle");
  if(tEl) tEl.textContent = meta.title || "–ò–Ω–¥–µ–∫—Å";
  const sEl = document.getElementById("kpiModalSub");
  if(sEl) sEl.textContent = meta.sub || "";
  const wEl = document.getElementById("kpiModalWhat");
  if(wEl) wEl.textContent = meta.what || "‚Äî";
  const hEl = document.getElementById("kpiModalHow");
  if(hEl) hEl.textContent = meta.how || "‚Äî";
  const iEl = document.getElementById("kpiModalImpact");
  if(iEl) iEl.textContent = meta.impact || "‚Äî";
  const dEl = document.getElementById("kpiModalDo");
  if(dEl) dEl.innerHTML = meta.doHtml || "‚Äî";
  // Data + confidence (synthetic benchmarks)
  const dataEl = document.getElementById("kpiModalData");
  if(dataEl) dataEl.innerHTML = kpiBuildDataHtml(kpiId);

  const unc = document.getElementById("kpiModalUnc");
  const rngEl = document.getElementById("kpiModalRange");
  const barEl = document.getElementById("kpiModalRangeBar");
  if(unc && rngEl && barEl){
    let r = null;
    if(kpiId === "kRecover") r = recoverRange();
    if(r){
      unc.style.display = "block";
      rngEl.textContent = `${r[0]}‚Äì${r[1]}%`;
      // visualize as 0..100
      const w = Math.max(2, Math.min(100, r[1]-r[0]));
      barEl.style.width = `${w}%`;
      barEl.style.marginLeft = `${Math.max(0, Math.min(98, r[0]))}%`;
      barEl.style.background = "rgba(59,130,246,.65)";
    } else {
      unc.style.display = "none";
    }
  }

  const nEl = document.getElementById("kpiModalNote");
  if(nEl) nEl.textContent = meta.note || "";
  m.setAttribute("aria-hidden","false");
  // focus close for accessibility
  const closeBtn = document.getElementById("kpiModalClose");
  closeBtn && closeBtn.focus && closeBtn.focus();
}

function kpiModalClose(){
  const m = document.getElementById("kpiModal");
  if(!m) return;
  m.setAttribute("aria-hidden","true");
}

function setupKpiExplain(){
  const bar = document.querySelector(".kpiBar");
  if(!bar) return;

  // make KPI cards clearly clickable
  bar.querySelectorAll(".stat[id]").forEach(el=>{
    el.classList.add("kpi-clickable");
    el.setAttribute("role","button");
    el.setAttribute("tabindex","0");
    el.setAttribute("aria-label","–û—Ç–∫—Ä—ã—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞");
  });

  // robust click/tap delegation
  bar.addEventListener("click",(e)=>{
      // Prevent KPI modal from opening when user interacts with expandable lists / controls inside cards
      if(e?.target?.tagName==="SUMMARY" || e?.target?.closest?.("details.demoDetails")) return;
      const stat = e.target.closest(".stat[id]");
      if(!stat) return;
      kpiModalOpen(stat.id);
    });

  // keyboard open (Enter/Space)
  bar.addEventListener("keydown",(e)=>{
    if(e.key !== "Enter" && e.key !== " ") return;
    const stat = e.target.closest?.(".stat[id]");
    if(!stat) return;
    e.preventDefault();
    kpiModalOpen(stat.id);
  });

  // hover open (only on devices that support hover)
  const canHover = window.matchMedia && window.matchMedia("(hover:hover)").matches;
  if(canHover){
    let t=null, lastId=null;
    bar.addEventListener("pointerover",(e)=>{
      const stat = e.target.closest(".stat[id]");
      if(!stat) return;
      lastId = stat.id;
      clearTimeout(t);
      t = setTimeout(()=>{ if(lastId) kpiModalOpen(lastId); }, 550);
    });
    bar.addEventListener("pointerout",()=>{ clearTimeout(t); lastId=null; });
  }

  // modal close handlers
  const closeBtn = document.getElementById("kpiModalClose");
  closeBtn && closeBtn.addEventListener("click", kpiModalClose);
  const modal = document.getElementById("kpiModal");
  modal && modal.addEventListener("click",(e)=>{
    if(e.target && e.target.getAttribute && e.target.getAttribute("data-kpi-close")==="1") kpiModalClose();
  });
  document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") kpiModalClose(); });
}

document.addEventListener("DOMContentLoaded", ()=>{ try{ setupKpiExplain(); }catch(e){ console.error("KPI modal init error", e); } });

document.addEventListener("DOMContentLoaded", ()=>{ try{ recalc(); }catch(e){ console.error(e); } });

/* ===== Benchmark transparency (manager visibility) ===== */
function fmtRange(r){
  if(!r || !isFinite(r[0]) || !isFinite(r[1])) return "‚Äî";
  const a = Math.round(r[0]); const b = Math.round(r[1]);
  return `${a}‚Äì${b}`;
}
function fmtVal(v, key){
  if(!isFinite(v)) return "‚Äî";
  const vv = (key.endsWith("Pct") ? Math.round(v) : (Number.isInteger(v) ? v : Math.round(v*10)/10));
  return key.endsWith("Pct") ? `${vv}%` : `${vv}`;
}
function benchKeyLabel(key){
  const map = {
    manualPct:"–î–æ–ª—è —Ä—É—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –ò–¢",
    unusedPct:"–ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ª–∏—Ü–µ–Ω–∑–∏–∏ (–æ—Ü–µ–Ω–∫–∞)",
    vmUnusedPct:"–ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ VM/—Ä–µ—Å—É—Ä—Å—ã",
    incidentsPerMonth:"–ò–Ω—Ü–∏–¥–µ–Ω—Ç—ã –≤ –º–µ—Å—è—Ü (–æ—Ü–µ–Ω–∫–∞)",
    downtimeHours:"–ü—Ä–æ—Å—Ç–æ–∏ (—á/–≥–æ–¥, –æ—Ü–µ–Ω–∫–∞)",
    downtimeCost:"–°—Ç–æ–∏–º–æ—Å—Ç—å —á–∞—Å–∞ –ø—Ä–æ—Å—Ç–æ—è (‚ÇΩ)",
    obsoletePct:"–£—Å—Ç–∞—Ä–µ–≤—à–∏–µ –û–°/–ü–û (–æ—Ü–µ–Ω–∫–∞)",
    keyPeopleRisk:"–ù–µ–∑–∞–º–µ–Ω–∏–º—ã–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã (0/1)",
    docScore:"–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (0‚Äì2)",
    techMaturityPct:"–¢–µ—Ö. –∑—Ä–µ–ª–æ—Å—Ç—å (–±–µ–Ω—á–º–∞—Ä–∫, %)",
    procMaturityPct:"–ü—Ä–æ—Ü. –∑—Ä–µ–ª–æ—Å—Ç—å (–±–µ–Ω—á–º–∞—Ä–∫, %)",
    riskProb:"–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ä–∏—Å–∫–æ–≤ (–±–µ–Ω—á–º–∞—Ä–∫, –¥–æ–ª—è)",
    feasibilityPct:"–†–µ–∞–ª–∏–∑—É–µ–º–æ—Å—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π (–±–µ–Ω—á–º–∞—Ä–∫, %)",
    changeMaturityPct:"–ó—Ä–µ–ª–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–π (–±–µ–Ω—á–º–∞—Ä–∫, %)",
    scalabilityPct:"–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å (–±–µ–Ω—á–º–∞—Ä–∫, %)",
    aiReadinessPct:"AI –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å (–±–µ–Ω—á–º–∞—Ä–∫, %)"
  };
  return map[key] || key;
}
function updateBenchTransparency(){
  try{
    const prof = getProfile();
    const keys = [
      {key:"manualPct", elId:"manualPct"},
      {key:"unusedPct", elId:"unusedPct"},
      {key:"vmUnusedPct", elId:"vmUnusedPct"},
      {key:"incidentsPerMonth", elId:"incidentsPerMonth"},
      {key:"downtimeHours", elId:"downtimeHours"},
      {key:"downtimeCost", elId:"downtimeCost"},
      {key:"obsoletePct", elId:"obsoletePct"},
      {key:"keyPeopleRisk", elId:"keyPeopleRisk"},
      {key:"docScore", elId:"docScore"},
      {key:"techMaturityPct", elId:"__none__"},
      {key:"procMaturityPct", elId:"__none__"},
      {key:"riskProb", elId:"__none__"},
      {key:"feasibilityPct", elId:"__none__"},
      {key:"changeMaturityPct", elId:"__none__"},
      {key:"scalabilityPct", elId:"__none__"},
      {key:"aiReadinessPct", elId:"__none__"},
    ];

    const rows = [];
    let benchCount = 0;
    let totalCount = 0;

    for(const k of keys){
      const est = estimateParam(k.key, {elId:k.elId});
      const src = est.src;
      const v = est.v;
      const range = est.range;
      // count only when value used and sourced from bench
      totalCount++;
      if(src==="bench") benchCount++;

      rows.push({
        key:k.key,
        label: benchKeyLabel(k.key),
        value: fmtVal(v, k.key),
        range: fmtRange(range),
        src: src==="bench" ? "üîµ –±–µ–Ω—á–º–∞—Ä–∫" : (src==="client" ? "üü¢ –∫–ª–∏–µ–Ω—Ç" : "‚Äî")
      });
    }

    // badge
    const countEl = document.getElementById("benchCount");
    if(countEl) countEl.textContent = String(benchCount);
    const profEl = document.getElementById("benchProfileLabel");
    if(profEl){
      const bucket = prof.bucket || "‚Äî";
      profEl.textContent = `(${prof.industry || "‚Äî"}, ${bucket})`;
    }

    // details table
    const meta = document.getElementById("benchDetailsMeta");
    if(meta){
      meta.textContent = `–ü—Ä–æ—Ñ–∏–ª—å –±–µ–Ω—á–º–∞—Ä–∫–∞: ${prof.industry || "‚Äî"} / ${prof.bucket || "‚Äî"}; –º–∞—Å—à—Ç–∞–±: ${prof.total || "‚Äî"}; —Ñ–∏–ª–∏–∞–ª—ã: ${prof.branches || "‚Äî"}. –°–∏–Ω—Ç–µ—Ç–∏–∫–∞ –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω–∞ –¥–ª—è ${benchCount} –∏–∑ ${totalCount} –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.`;
    }
    const tbody = document.getElementById("benchDetailsTbody");
    if(tbody){
      tbody.innerHTML = rows.map(r=>`
        <tr>
          <td>${r.label}</td>
          <td class="mono">${r.value}</td>
          <td class="mono">${r.range}</td>
          <td>${r.src}</td>
        </tr>
      `).join("");
    }
  }catch(e){
    console.warn("updateBenchTransparency failed", e);
  }
}

// hook into existing recalc safely
try{
  const __recalc = recalc;
  recalc = function(){
    const out = __recalc();
    updateBenchTransparency();
    return out;
  };
  // update on mode change
  const bm = document.getElementById("benchMode");
  if(bm) bm.addEventListener("change", ()=>{ try{recalc();}catch(e){} });
  // initial
  updateBenchTransparency();
}catch(e){
  console.warn("bench transparency hook failed", e);
}

function renderBenchHints(){
  const mode = document.getElementById("benchMode")?.value || "mixed";
  const hintMap = [
    // key, elementId, unit
    ["manualPct","manualPct","%"],
    ["unusedPct","unusedPct","%"],
    ["vmUnusedPct","vmUnusedPct","%"],
    ["obsoletePct","obsoletePct","%"],
    ["incidentsPerMonth","incidentsPerMonth","/–º–µ—Å"],
    ["downtimeHours","downtimeHours","—á/–≥–æ–¥"],
    ["downtimeCost","downtimeCost","‚ÇΩ/—á"],
    ["docScore","docScore","/2"],
    ["keyPeopleRisk","keyPeopleRisk",""],
    ["techMaturityPct","techMaturityPct","%"],
    ["procMaturityPct","procMaturityPct","%"],
    ["riskProb","riskProb",""],
    ["feasibilityPct","feasibilityPct","%"],
    ["changeMaturityPct","changeMaturityPct","%"],
    ["scalabilityPct","scalabilityPct","%"],
    ["aiReadinessPct","aiReadinessPct","%"]
  ];

  function fmtRange(key, est){
    const v = est?.v;
    const p25 = est?.p25;
    const p75 = est?.p75;
    if(!Number.isFinite(v)) return "";
    const unit = (key==="incidentsPerMonth") ? "/–º–µ—Å" : (key==="downtimeHours" ? "—á/–≥–æ–¥" : (key==="downtimeCost" ? "‚ÇΩ/—á" : (key.endsWith("Pct") ? "%" : "")));
    const vv = key.endsWith("Pct") ? Math.round(v) : Math.round(v);
    const r25 = Number.isFinite(p25) ? (key.endsWith("Pct") ? Math.round(p25) : Math.round(p25)) : null;
    const r75 = Number.isFinite(p75) ? (key.endsWith("Pct") ? Math.round(p75) : Math.round(p75)) : null;
    const range = (r25!==null && r75!==null) ? ` (${r25}‚Äì${r75}${unit})` : "";
    return `${vv}${unit}${range}`;
  }

  for(const [key, elId] of hintMap){
    const el = document.getElementById(elId);
    if(!el) continue;

    // determine if "empty" from UI perspective
    let isEmpty = false;
    if(el.tagName==="INPUT" || el.tagName==="TEXTAREA"){
      isEmpty = (String(el.value||"").trim()==="");
    } else if(el.tagName==="SELECT"){
      const v = String(el.value||"").trim();
      isEmpty = (v==="" || v==="na" || v==="unknown");
    }

    // compute benchmark estimate regardless of mode (so it's a hint even in "only client")
    const est = (typeof estimateParam==="function") ? estimateParam(key, /*forceBenchHint*/ true) : null;

    // Create or find hint node
    let hint = el.parentElement?.querySelector(`.bench-hint[data-for="${elId}"]`);
    if(!hint){
      hint = document.createElement("div");
      hint.className = "bench-hint";
      hint.dataset.for = elId;
      hint.style.marginTop = "6px";
      hint.style.fontSize = "12px";
      hint.style.opacity = "0.85";
      hint.style.color = "#6b7280";
      // try to place after element within same cell
      if(el.parentElement) el.parentElement.appendChild(hint);
    }

    // Decide what to show
    if(!isEmpty){
      // if user filled, still show "—Ä—ã–Ω–æ–∫ –æ–±—ã—á–Ω–æ ..." lightly
      if(est && Number.isFinite(est.v)){
        hint.textContent = `‚ÑπÔ∏è –†—ã–Ω–æ–∫: ${fmtRange(key, est)}`;
        hint.style.color = "#6b7280";
      } else {
        hint.textContent = "";
      }
      continue;
    }

    if(!est || !Number.isFinite(est.v)){
      hint.textContent = "";
      continue;
    }

    const used = (mode!=="client"); // in mixed/bench we actually use it
    hint.textContent = used ? `üîµ –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ–Ω—á–º–∞—Ä–∫: ${fmtRange(key, est)}` : `üîµ –ü–æ–¥—Å–∫–∞–∑–∫–∞ –±–µ–Ω—á–º–∞—Ä–∫–∞: ${fmtRange(key, est)}`;
    hint.style.color = used ? "#2563eb" : "#6b7280";
  }
}


/* ===== v7.6 PATCH: exact Google Sheets header mapping ===== */
const SHEET_KEYS = (`run_id	timestamp	pdfMode	interviewMode	benchMode	cLevelText	company	industry	lpr	sources	workplaces	servers	branches	vdi	closed	envNote	virt	hostingModel	adDomains	netSeg	terminalFarms	hwAge	hwAccounting	redundancy	salary	itCount	manualPct	licBudget	unusedPct	finNote	vmUnusedPct	keyPeopleRisk	docScore	obsoletePct	hwBudget	hwPlan	downtimeHours	downtimeCost	incidentsPerMonth	serviceDesk	riskLevelText	riskNotes	psi2Score	psi2Label	techIndex	procIndex	riskIndex	coiTotal	recoverIndex	busIndex	obsolIndex	aiIndex	painIndex	feasScore	readyIndex	readyLabel	probIndex	probLabel	benchCount	benchProfileLabel	req_count	psi_count	project_risks_count	project_risk_level	project_risk_notes	tech_count	proc_count	risk_count	tech_01_label	tech_01_score	tech_01_note	tech_02_label	tech_02_score	tech_02_note	tech_03_label	tech_03_score	tech_03_note	tech_04_label	tech_04_score	tech_04_note	tech_05_label	tech_05_score	tech_05_note	tech_06_label	tech_06_score	tech_06_note	tech_07_label	tech_07_score	tech_07_note	tech_08_label	tech_08_score	tech_08_note	tech_09_label	tech_09_score	tech_09_note	tech_10_label	tech_10_score	tech_10_note	proc_01_label	proc_01_score	proc_01_note	proc_02_label	proc_02_score	proc_02_note	proc_03_label	proc_03_score	proc_03_note	proc_04_label	proc_04_score	proc_04_note	proc_05_label	proc_05_score	proc_05_note	proc_06_label	proc_06_score	proc_06_note	proc_07_label	proc_07_score	proc_07_note	proc_08_label	proc_08_score	proc_08_note	proc_09_label	proc_09_score	proc_09_note	proc_10_label	proc_10_score	proc_10_note	risk_01_label	risk_01_val	risk_01_note	risk_02_label	risk_02_val	risk_02_note	risk_03_label	risk_03_val	risk_03_note	risk_04_label	risk_04_val	risk_04_note	risk_05_label	risk_05_val	risk_05_note	risk_06_label	risk_06_val	risk_06_note	risk_07_label	risk_07_val	risk_07_note	risk_08_label	risk_08_val	risk_08_note	req_01_text	req_01_type	req_01_must	req_01_feas	req_01_metric	req_01_owner	req_02_text	req_02_type	req_02_must	req_02_feas	req_02_metric	req_02_owner	req_03_text	req_03_type	req_03_must	req_03_feas	req_03_metric	req_03_owner	req_04_text	req_04_type	req_04_must	req_04_feas	req_04_metric	req_04_owner	req_05_text	req_05_type	req_05_must	req_05_feas	req_05_metric	req_05_owner	req_06_text	req_06_type	req_06_must	req_06_feas	req_06_metric	req_06_owner	req_07_text	req_07_type	req_07_must	req_07_feas	req_07_metric	req_07_owner	req_08_text	req_08_type	req_08_must	req_08_feas	req_08_metric	req_08_owner	req_09_text	req_09_type	req_09_must	req_09_feas	req_09_metric	req_09_owner	req_10_text	req_10_type	req_10_must	req_10_feas	req_10_metric	req_10_owner	req_11_text	req_11_type	req_11_must	req_11_feas	req_11_metric	req_11_owner	req_12_text	req_12_type	req_12_must	req_12_feas	req_12_metric	req_12_owner	req_13_text	req_13_type	req_13_must	req_13_feas	req_13_metric	req_13_owner	req_14_text	req_14_type	req_14_must	req_14_feas	req_14_metric	req_14_owner	req_15_text	req_15_type	req_15_must	req_15_feas	req_15_metric	req_15_owner	req_16_text	req_16_type	req_16_must	req_16_feas	req_16_metric	req_16_owner	req_17_text	req_17_type	req_17_must	req_17_feas	req_17_metric	req_17_owner	req_18_text	req_18_type	req_18_must	req_18_feas	req_18_metric	req_18_owner	req_19_text	req_19_type	req_19_must	req_19_feas	req_19_metric	req_19_owner	req_20_text	req_20_type	req_20_must	req_20_feas	req_20_metric	req_20_owner	psi_01_scn	psi_01_exp	psi_01_act	psi_01_ok	psi_01_acc	psi_01_note	psi_02_scn	psi_02_exp	psi_02_act	psi_02_ok	psi_02_acc	psi_02_note	psi_03_scn	psi_03_exp	psi_03_act	psi_03_ok	psi_03_acc	psi_03_note	psi_04_scn	psi_04_exp	psi_04_act	psi_04_ok	psi_04_acc	psi_04_note	psi_05_scn	psi_05_exp	psi_05_act	psi_05_ok	psi_05_acc	psi_05_note	psi_06_scn	psi_06_exp	psi_06_act	psi_06_ok	psi_06_acc	psi_06_note	psi_07_scn	psi_07_exp	psi_07_act	psi_07_ok	psi_07_acc	psi_07_note	psi_08_scn	psi_08_exp	psi_08_act	psi_08_ok	psi_08_acc	psi_08_note	psi_09_scn	psi_09_exp	psi_09_act	psi_09_ok	psi_09_acc	psi_09_note	psi_10_scn	psi_10_exp	psi_10_act	psi_10_ok	psi_10_acc	psi_10_note	psi_11_scn	psi_11_exp	psi_11_act	psi_11_ok	psi_11_acc	psi_11_note	psi_12_scn	psi_12_exp	psi_12_act	psi_12_ok	psi_12_acc	psi_12_note	psi_13_scn	psi_13_exp	psi_13_act	psi_13_ok	psi_13_acc	psi_13_note	psi_14_scn	psi_14_exp	psi_14_act	psi_14_ok	psi_14_acc	psi_14_note	psi_15_scn	psi_15_exp	psi_15_act	psi_15_ok	psi_15_acc	psi_15_note	psi_16_scn	psi_16_exp	psi_16_act	psi_16_ok	psi_16_acc	psi_16_note	psi_17_scn	psi_17_exp	psi_17_act	psi_17_ok	psi_17_acc	psi_17_note	psi_18_scn	psi_18_exp	psi_18_act	psi_18_ok	psi_18_acc	psi_18_note	psi_19_scn	psi_19_exp	psi_19_act	psi_19_ok	psi_19_acc	psi_19_note	psi_20_scn	psi_20_exp	psi_20_act	psi_20_ok	psi_20_acc	psi_20_note	project_risk_01_name	project_risk_01_condition	project_risk_01_status	project_risk_01_note	project_risk_02_name	project_risk_02_condition	project_risk_02_status	project_risk_02_note	project_risk_03_name	project_risk_03_condition	project_risk_03_status	project_risk_03_note	project_risk_04_name	project_risk_04_condition	project_risk_04_status	project_risk_04_note	project_risk_05_name	project_risk_05_condition	project_risk_05_status	project_risk_05_note	project_risk_06_name	project_risk_06_condition	project_risk_06_status	project_risk_06_note	project_risk_07_name	project_risk_07_condition	project_risk_07_status	project_risk_07_note	project_risk_08_name	project_risk_08_condition	project_risk_08_status	project_risk_08_note	project_risk_09_name	project_risk_09_condition	project_risk_09_status	project_risk_09_note	project_risk_10_name	project_risk_10_condition	project_risk_10_status	project_risk_10_note	project_risk_11_name	project_risk_11_condition	project_risk_11_status	project_risk_11_note	project_risk_12_name	project_risk_12_condition	project_risk_12_status	project_risk_12_note	project_risk_13_name	project_risk_13_condition	project_risk_13_status	project_risk_13_note	project_risk_14_name	project_risk_14_condition	project_risk_14_status	project_risk_14_note	project_risk_15_name	project_risk_15_condition	project_risk_15_status	project_risk_15_note	project_risk_16_name	project_risk_16_condition	project_risk_16_status	project_risk_16_note	project_risk_17_name	project_risk_17_condition	project_risk_17_status	project_risk_17_note	project_risk_18_name	project_risk_18_condition	project_risk_18_status	project_risk_18_note	project_risk_19_name	project_risk_19_condition	project_risk_19_status	project_risk_19_note	project_risk_20_name	project_risk_20_condition	project_risk_20_status	project_risk_20_note`).split(/\t/);

function _el(id){ return document.getElementById(id); }
function _val(id){
  const el=_el(id);
  if(!el) return "";
  const tag=(el.tagName||"").toLowerCase();
  if(tag==="input" || tag==="select" || tag==="textarea") return (el.value ?? "");
  return (el.textContent ?? "").trim();
}
function _cellVal(cell){
  if(!cell) return "";
  const inp = cell.querySelector("textarea,input,select");
  if(inp) return (inp.value ?? "");
  return (cell.textContent ?? "").trim();
}
function _numFromText(t){
  if(t===null || t===undefined) return "";
  const s=String(t).replace(/\s/g,"").replace(/‚ÇΩ/g,"").replace(/%/g,"").replace(/,/g,".");
  const m=s.match(/-?\d+(\.\d+)?/);
  return m ? m[0] : "";
}

function buildSheetPayloadExact(){
  // Ensure KPI up to date
  try{ if(typeof recalc==="function") recalc(); }catch(_){}
  const out = {};

  // Basic scalar ids (match your headers 1:1)
  const scalarIds = ["pdfMode","interviewMode","benchMode","cLevelText","company","industry","lpr","sources",
    "workplaces","servers","branches","vdi","closed","envNote","virt","hostingModel","adDomains","netSeg",
    "terminalFarms","hwAge","hwAccounting","redundancy","salary","itCount","manualPct","licBudget","unusedPct",
    "finNote","vmUnusedPct","keyPeopleRisk","docScore","obsoletePct","hwBudget","hwPlan","downtimeHours",
    "downtimeCost","incidentsPerMonth","serviceDesk","riskLevelText","riskNotes"
  ];
  scalarIds.forEach(id=> out[id]=_val(id));

  // virt (supports native checkboxes UI)
  try{
    const vboxes = document.querySelectorAll(".virt-wrapper input[type=checkbox]");
    if(vboxes && vboxes.length){
      const selected = Array.from(vboxes).filter(b=>b.checked).map(b=>b.value);
      out.virt = selected.join("; ");
      const hiddenVirt = document.getElementById("virt");
      if(hiddenVirt) hiddenVirt.value = out.virt;
    }
  }catch(e){}


  // KPI values (as numbers where appropriate)
  const kpiIds = ["psi2Score","psi2Label","techIndex","procIndex","riskIndex","coiTotal","recoverIndex","busIndex",
    "obsolIndex","aiIndex","painIndex","feasScore","readyIndex","readyLabel","probIndex","probLabel","benchCount","benchProfileLabel"
  ];
  kpiIds.forEach(id=>{
    const raw=_val(id);
    out[id] = (id.endsWith("Label") || id==="psi2Label" || id==="readyLabel" || id==="probLabel" || id==="benchProfileLabel")
      ? raw
      : _numFromText(raw);
  });

  // Counts
  const techRows=[...document.querySelectorAll("#techTbody tr")];
  const procRows=[...document.querySelectorAll("#procTbody tr")];
  const riskRows=[...document.querySelectorAll("#riskTbody tr")];
  const reqRows=[...document.querySelectorAll("#reqTbody tr")];
  const psiRows=[...document.querySelectorAll("#psiTbody tr")];
  const prRows=[...document.querySelectorAll("#projectRisks tr")];

  out.tech_count = techRows.length;
  out.proc_count = procRows.length;
  out.risk_count = riskRows.length;
  out.req_count = reqRows.length;
  out.psi_count = psiRows.length;
  out.project_risks_count = prRows.length;

  // Project risks summary fields (match your headers)
  out.project_risk_level = out.riskLevelText || "";
  out.project_risk_notes = out.riskNotes || "";

  // TECH/PROC/RISK detailed
  function fillMaturity(prefix, rows, labelsArr, scoreKey, noteKey){
    for(let i=0;i<10;i++){
      const idx=i+1;
      const keyL = `${prefix}_${String(idx).padStart(2,"0")}_label`;
      const keyS = `${prefix}_${String(idx).padStart(2,"0")}_${scoreKey}`;
      const keyN = `${prefix}_${String(idx).padStart(2,"0")}_${noteKey}`;
      const r = rows[i];
      out[keyL] = (labelsArr && labelsArr[i] && labelsArr[i].label) ? labelsArr[i].label : (r?.cells?.[0]?.textContent||"").trim();
      out[keyS] = r ? (r.querySelector("select")?.value ?? "") : "";
      out[keyN] = r ? (r.querySelector("textarea")?.value ?? "") : "";
    }
  }
  fillMaturity("tech", techRows, (typeof TECH!=="undefined"?TECH:null), "score", "note");
  fillMaturity("proc", procRows, (typeof PROC!=="undefined"?PROC:null), "score", "note");

  // Risk has val 0/1
  for(let i=0;i<8;i++){
    const idx=i+1;
    const keyL = `risk_${String(idx).padStart(2,"0")}_label`;
    const keyV = `risk_${String(idx).padStart(2,"0")}_val`;
    const keyN = `risk_${String(idx).padStart(2,"0")}_note`;
    const r = riskRows[i];
    out[keyL] = (typeof RISK!=="undefined" && RISK[i] && RISK[i].label) ? RISK[i].label : (r?.cells?.[0]?.textContent||"").trim();
    out[keyV] = r ? (r.querySelector("select")?.value ?? "") : "";
    out[keyN] = r ? (r.querySelector("textarea")?.value ?? "") : "";
  }

  // Requirements (up to 20)
  for(let i=0;i<20;i++){
    const idx=i+1;
    const r=reqRows[i];
    out[`req_${String(idx).padStart(2,"0")}_text`]   = r ? _cellVal(r.cells[1]) : "";
    out[`req_${String(idx).padStart(2,"0")}_type`]   = r ? _cellVal(r.cells[2]) : "";
    out[`req_${String(idx).padStart(2,"0")}_must`]   = r ? _cellVal(r.cells[3]) : "";
    out[`req_${String(idx).padStart(2,"0")}_feas`]   = r ? _cellVal(r.cells[4]) : "";
    out[`req_${String(idx).padStart(2,"0")}_metric`] = r ? _cellVal(r.cells[5]) : "";
    out[`req_${String(idx).padStart(2,"0")}_owner`]  = r ? _cellVal(r.cells[6]) : "";
  }

  // PSI (up to 20)
  for(let i=0;i<20;i++){
    const idx=i+1;
    const r=psiRows[i];
    out[`psi_${String(idx).padStart(2,"0")}_scn`]  = r ? _cellVal(r.cells[1]) : "";
    out[`psi_${String(idx).padStart(2,"0")}_exp`]  = r ? _cellVal(r.cells[2]) : "";
    out[`psi_${String(idx).padStart(2,"0")}_act`]  = r ? _cellVal(r.cells[3]) : "";
    out[`psi_${String(idx).padStart(2,"0")}_ok`]   = r ? _cellVal(r.cells[4]) : "";
    out[`psi_${String(idx).padStart(2,"0")}_acc`]  = r ? _cellVal(r.cells[5]) : "";
    out[`psi_${String(idx).padStart(2,"0")}_note`] = r ? _cellVal(r.cells[6]) : "";
  }

  // Project risk table (up to 20)
  for(let i=0;i<20;i++){
    const idx=i+1;
    const r=prRows[i];
    out[`project_risk_${String(idx).padStart(2,"0")}_name`]      = r ? _cellVal(r.cells[0]) : "";
    out[`project_risk_${String(idx).padStart(2,"0")}_condition`] = r ? _cellVal(r.cells[1]) : "";
    out[`project_risk_${String(idx).padStart(2,"0")}_status`]    = r ? _cellVal(r.cells[2]) : "";
    out[`project_risk_${String(idx).padStart(2,"0")}_note`]      = r ? _cellVal(r.cells[3]) : "";
  }

  // Ensure run_id and timestamp
  if(!out.run_id) out.run_id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now());
  if(!out.timestamp) out.timestamp = new Date().toISOString();

  // Also include full JSON snapshot if someone adds "payload" column later
  out.payload = JSON.stringify(out);

  // Return only keys the sheet expects (safe)
  const trimmed = {};
  SHEET_KEYS.forEach(k=>{ trimmed[k]= (out[k]===undefined? "": out[k]); });
  return trimmed;
}

// Override sync to Sheets to use exact payload
async function syncToGoogleSheets(){
  const url = (typeof GOOGLE_SHEETS_WEBAPP_URL!=="undefined" && GOOGLE_SHEETS_WEBAPP_URL) ? GOOGLE_SHEETS_WEBAPP_URL : null;
  if(!url){
    console.warn("Google Sheets URL is not set");
    return;
  }
  const payload = buildSheetPayloadExact();
  const body = JSON.stringify(payload);

  // 1) Beacon (no CORS / no preflight)
  try{
    if(navigator.sendBeacon){
      const ok = navigator.sendBeacon(url, new Blob([body], {type:"text/plain;charset=utf-8"}));
      if(ok){ console.log("‚úÖ Sheets sync sent (beacon)"); return; }
    }
  }catch(e){ console.warn("Beacon failed", e); }

  // 2) Fetch no-cors fallback
  try{
    await fetch(url, {method:"POST", mode:"no-cors", body, headers: {"Content-Type":"text/plain;charset=utf-8"}});
    console.log("‚úÖ Sheets sync sent (fetch no-cors)");
  }catch(e){
    console.error("‚ùå Sheets sync failed", e);
  }
}
/* ===== end patch ===== */

</script>
</body>
</html>
